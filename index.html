<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"gudqs7.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="å¿ƒç´¯æ²¡é’±èººå°¸ä¸­">
<meta property="og:type" content="website">
<meta property="og:title" content="gudqs7&#39;s note">
<meta property="og:url" content="https://gudqs7.github.io/index.html">
<meta property="og:site_name" content="gudqs7&#39;s note">
<meta property="og:description" content="å¿ƒç´¯æ²¡é’±èººå°¸ä¸­">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="gudqs7">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://gudqs7.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>gudqs7's note</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">gudqs7's note</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">å¿ƒç´¯æ²¡é’±èººå°¸ä¸­</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://gudqs7.github.io/2021/01/23/source-code-spring/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="gudqs7">
      <meta itemprop="description" content="å¿ƒç´¯æ²¡é’±èººå°¸ä¸­">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="gudqs7's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/23/source-code-spring/" class="post-title-link" itemprop="url">Spring æºç ç¬”è®°</a>
        </h2>

        <div class="post-meta">
			
				<i class="fa fa-thumb-tack"></i>
				<font color="RED">ç½®é¡¶</font>
				<span class="post-meta-divider">|</span>
			
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-01-23 18:28:28" itemprop="dateCreated datePublished" datetime="2021-01-23T18:28:28+08:00">2021-01-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-01-25 23:18:44" itemprop="dateModified" datetime="2021-01-25T23:18:44+08:00">2021-01-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SourceCode/" itemprop="url" rel="index"><span itemprop="name">SourceCode</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/2021/01/23/source-code-spring/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/01/23/source-code-spring/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Springæºç åˆ†æ"><a href="#Springæºç åˆ†æ" class="headerlink" title="Springæºç åˆ†æ"></a>Springæºç åˆ†æ</h1><h2 id="å…³é”®ç±»ä»‹ç»"><a href="#å…³é”®ç±»ä»‹ç»" class="headerlink" title="å…³é”®ç±»ä»‹ç»"></a>å…³é”®ç±»ä»‹ç»</h2><h3 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">ä¸‡èƒ½çš„ applicationContext, ä½†å®é™…ä¸Šå„ç§èƒ½åŠ›éƒ½æ˜¯ä¾èµ–äºå…¶ä»–çš„ç±», æ¯”å¦‚ getBean æ˜¯ beanFactory çš„, publishEvent æ˜¯äº‹ä»¶å¹¿æ’­å™¨çš„, ç­‰ç­‰. å…¶æœ¬èº«æ˜¯ä¸€ä¸ªç»¼åˆä½“, æ•´åˆè¿™äº›èƒ½åŠ›, ä¾¿äºå¼€å‘è€…è°ƒç”¨å’Œç†è§£.</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹é¢åˆ—ä¸€ä¸‹ç›¸å…³çš„æ¥å£, æŠ½è±¡ç±», å’Œå…·ä½“ç±»</span></span><br><span class="line">ApplicationContext</span><br><span class="line">	æ˜¯ä¸€ä¸ªåªè¯»çš„ bean å®¹å™¨</span><br><span class="line">	å¯ä»¥åŠ è½½è§£æé…ç½®æ–‡ä»¶(å¦‚xml)</span><br><span class="line">	å¯ä»¥å‘å¸ƒäº‹ä»¶å’Œæ³¨å†Œç›‘å¬</span><br><span class="line">	å…·æœ‰å›½é™…åŒ–æ¶ˆæ¯å¤„ç†èƒ½åŠ›</span><br><span class="line">ConfigurableApplicationContext</span><br><span class="line">	æ˜¯ä¸€ä¸ªå…·æœ‰å¯é…ç½®èƒ½åŠ›çš„ å®¹å™¨(å¯è®¾ç½®å„ä¸ªå‚æ•°, å¦‚id, çˆ¶å®¹å™¨)</span><br><span class="line">	å…·æœ‰å®¹å™¨ç”Ÿå‘½å‘¨æœŸæ¦‚å¿µ, å¦‚å¯åŠ¨,åœæ­¢,å…³é—­.</span><br><span class="line">AbstractApplicationContext</span><br><span class="line">	æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„æŠ½è±¡ç±», å®šä¹‰äº†å®¹å™¨çš„æ¨¡æ¿(refreshæ–¹æ³•), ä½†ç”±å…·ä½“çš„å­ç±»å®ç°éƒ¨åˆ†æ–¹æ³•</span><br><span class="line">	ç®¡ç†Beanå’ŒBeanFactoryçš„PostProcessor</span><br><span class="line">	ç®¡ç†äº‹ä»¶çš„ç›‘å¬å’Œå¤„ç†</span><br><span class="line">AbstractRefreshableApplicationContext</span><br><span class="line">	ä¸ºå¯é‡å¤åˆ·æ–°çš„å®¹å™¨æä¾›åŸºç±»</span><br><span class="line">	åŠ å…¥äº†BeanFactoryçš„ç®¡ç†(åˆ›å»º/å…³é—­ç­‰)</span><br><span class="line">AbstractRefreshableConfigApplicationContext</span><br><span class="line">	åŠ å…¥äº†configLocationå­—æ®µ, ç”¨äºæŸäº›å®¹å™¨åˆå§‹åŒ–BeanFactoryå’ŒBean</span><br><span class="line">AbstractXmlApplicationContext</span><br><span class="line">	å®šä¹‰äº†è¯»å–xmlé…ç½®æ–‡ä»¶æ¥åŠ è½½BeanFactoryçš„ä»£ç , ä½¿å¾—å­ç±»åªéœ€æä¾›é…ç½®æ–‡ä»¶åœ°å€æˆ–Resource</span><br><span class="line">ClassPathXmlApplicationContext</span><br><span class="line">	ç»§æ‰¿åŸºç±», æä¾›é…ç½®æ–‡ä»¶åœ°å€çš„æ„é€ æ–¹æ³•, è°ƒç”¨refreshåŠ è½½BeanFactory</span><br></pre></td></tr></table></figure>

<h3 id="BeanFactory"><a href="#BeanFactory" class="headerlink" title="BeanFactory"></a>BeanFactory</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">1.æ ¸å¿ƒä¸­çš„æ ¸å¿ƒ, åŠ è½½å’Œç®¡ç† beanDefinitions(Beané…ç½®ä¿¡æ¯), åˆ›å»ºå’Œç®¡ç† bean å¯¹è±¡å®ä¾‹, æ³¨å†Œå’Œç®¡ç† BeanPostProcessor(Beanæ‰©å±•)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹é¢åˆ—ä¸€ä¸‹ç›¸å…³çš„æ¥å£, æŠ½è±¡ç±», å’Œå…·ä½“ç±»</span></span><br><span class="line">BeanFactory</span><br><span class="line">  å®šä¹‰äº† Bean çš„åŸºç¡€æ“ä½œæ¥å£, å¦‚ getBean, getType, isSingleton ç­‰</span><br><span class="line"></span><br><span class="line">SingletonBeanRegistry</span><br><span class="line">  å®šä¹‰äº†å•ä¾‹å¯¹è±¡çš„æ“ä½œæ¥å£ (æ³¨å†Œ/è·å–/æ˜¯å¦å·²å­˜åœ¨) </span><br><span class="line"></span><br><span class="line">HierarchicalBeanFactory</span><br><span class="line">  å®šä¹‰äº†çˆ¶ BeanFactory çš„ç›¸å…³æ“ä½œæ¥å£(è·å–)</span><br><span class="line"></span><br><span class="line">ConfigurableBeanFactory</span><br><span class="line">  å®šä¹‰äº†å¯¹ BeanFactory åšå„ç§é…ç½®çš„æ“ä½œæ¥å£, åŒ…æ‹¬ BeanPostProcessor, setParentBeanFactory, destroyBean, registerAlias, resolveAliases ç­‰</span><br><span class="line"></span><br><span class="line">DefaultSingletonBeanRegistry</span><br><span class="line">  å®ç°äº† SingletonBeanRegistry æ¥å£, å³å®ç°äº†å•ä¾‹å¯¹è±¡çš„ç¼“å­˜ç®¡ç†, åŒ…æ‹¬ä¸€çº§/äºŒçº§/ä¸‰çº§(äºŒçº§ä¸‰çº§åªä¾èµ–å¾ªç¯ç”¨ä¸Šçš„ä¸¤ä¸ªç¼“å­˜)</span><br><span class="line">  </span><br><span class="line">FactoryBeanRegistrySupport</span><br><span class="line">  ç»§æ‰¿äº† DefaultSingletonBeanRegistry</span><br><span class="line">	å®ç°å¯¹ä½¿ç”¨ FactoryBean å­˜å‚¨å’Œè·å– bean å¯¹è±¡å®ä¾‹æ–¹å¼çš„æ”¯æŒ</span><br><span class="line">	</span><br><span class="line">AbstractBeanFactory</span><br><span class="line">  ç»§æ‰¿äº† FactoryBeanRegistrySupport</span><br><span class="line">  å®ç°äº† BeanFactory/HierarchicalBeanFactory/ConfigurableBeanFactory å®šä¹‰çš„æ¥å£</span><br><span class="line">  å®ç°äº†å…·ä½“ getBean, åŒ…æ‹¬ç¼“å­˜ç®¡ç†ç­‰</span><br><span class="line">  </span><br><span class="line">AutowireCapableBeanFactory</span><br><span class="line">  å®šä¹‰äº†æ ¹æ® class ç±»å‹è·å– BeanDefinition ä¿¡æ¯ä»¥åŠ Bean å¯¹è±¡çš„æ¥å£</span><br><span class="line"></span><br><span class="line">AbstractAutowireCapableBeanFactory</span><br><span class="line">  ç»§æ‰¿è‡ª AbstractBeanFactory </span><br><span class="line">  å®ç°äº† AutowireCapableBeanFactory ä¸­å®šä¹‰çš„æ–¹æ³•(å°±æ˜¯å®ç°äº†æ ¹æ® class è·å– bean æˆ– BeanDefinition)</span><br><span class="line">  å®ç°äº† createBean, ä¹Ÿå°±æ˜¯çœŸæ­£çš„å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡çš„è¿‡ç¨‹, åŒ…æ‹¬å®ä¾‹åŒ–, ä¸ºéœ€è¦èµ‹å€¼çš„å­—æ®µæ³¨å…¥ç›¸åº”çš„å€¼</span><br><span class="line">  åŒæ—¶è§¦å‘äº† BeanPostProcessor çš„æ–¹æ³•è°ƒç”¨</span><br><span class="line">  </span><br><span class="line">BeanDefinitionRegistry</span><br><span class="line">  å®šä¹‰äº† BeanDefinition çš„æ³¨å†Œ/è·å–/ç§»é™¤</span><br><span class="line">  </span><br><span class="line">ListableBeanFactory</span><br><span class="line">	å®šä¹‰äº† BeanDefinition çš„å¯éå†æ€§</span><br><span class="line">  </span><br><span class="line">ConfigurableListableBeanFactory</span><br><span class="line">  ç»“åˆ ListableBeanFactory å’Œ ConfigurableBeanFactory å¹¶è¡¥å……å®Œå–„äº†å‡ ä¸ªç›¸å…³æ¥å£ (å¦‚ getBeanNamesIterator æ¥å£ )</span><br><span class="line"></span><br><span class="line">DefaultListableBeanFactory</span><br><span class="line">  ç»§æ‰¿äº† AbstractAutowireCapableBeanFactory</span><br><span class="line">  å®ç°äº† BeanDefinitionRegistry/ConfigurableListableBeanFactory çš„æ¥å£</span><br><span class="line"> </span><br><span class="line"><span class="comment"># æ€»ç»“:</span></span><br><span class="line">å®šä¹‰å¤„:</span><br><span class="line">BeanFactory(getBean)</span><br><span class="line">SingletonBeanRegistry(addSingleton)</span><br><span class="line">HierarchicalBeanFactory(getParentBeanFactory)</span><br><span class="line">ConfigurableBeanFactory(addBeanPostProcessor)</span><br><span class="line">AutowireCapableBeanFactory(autowireBean)</span><br><span class="line">BeanDefinitionRegistry(registerBeanDefinition)</span><br><span class="line">ListableBeanFactory(getBeanDefinitionNames)</span><br><span class="line">ConfigurableListableBeanFactory(getBeanNamesIterator)</span><br><span class="line"></span><br><span class="line">å®ç°å¤„:</span><br><span class="line">DefaultSingletonBeanRegistry(registerSingleton)</span><br><span class="line">FactoryBeanRegistrySupport(getObjectFromFactoryBean)</span><br><span class="line">AbstractBeanFactory(doGetBean)</span><br><span class="line">AbstractAutowireCapableBeanFactory(createBean)</span><br><span class="line">DefaultListableBeanFactory(registerBeanDefinition)</span><br></pre></td></tr></table></figure>





<h2 id="å®¹å™¨åˆå§‹åŒ–è¿‡ç¨‹"><a href="#å®¹å™¨åˆå§‹åŒ–è¿‡ç¨‹" class="headerlink" title="å®¹å™¨åˆå§‹åŒ–è¿‡ç¨‹"></a>å®¹å™¨åˆå§‹åŒ–è¿‡ç¨‹</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1.setParent(): å¤„ç†çˆ¶å®¹å™¨ </span><br><span class="line">2.setConfigLocations(): è§£æå¹¶è®¾ç½®xmlé…ç½®æ–‡ä»¶è·¯å¾„</span><br><span class="line">3.refresh(): åˆ›å»º beanFactory å¯¹è±¡å¹¶åˆå§‹åŒ–, è¯»å– xml é…ç½®æ–‡ä»¶å¾—åˆ° beanDefinitions, æ¥ç€å¤„ç†ä¸¤ç§ PostProcessor, ç„¶åæ·»åŠ å›½é™…åŒ–å¤„ç†å™¨å’Œäº‹ä»¶å¹¿æ’­å™¨ä»¥åŠç›¸åº”çš„åˆå§‹åŒ–å’Œä¸€äº›å¤„ç†, æœ€åå®ä¾‹åŒ–å•ä¾‹çš„ bean ç­‰ç­‰.</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¤–åœˆç»“æŸ, å†çœ‹ refresh() é‡Œé¢çš„æ¯ä¸ªæ–¹æ³•</span></span><br><span class="line">1.prepareRefresh(): å‡†å¤‡å·¥ä½œ, ä¸€äº›å­—æ®µå€¼çš„è®¾ç½®å’Œå¤„ç†.</span><br><span class="line">2.obtainFreshBeanFactory(): åˆ›å»ºä¸€ä¸ª beanFactory å¯¹è±¡å¹¶æ³¨å†Œåˆ° applicationContext (å³èµ‹å€¼åˆ°å­—æ®µä¸Š), ç„¶åè§£æ xml é…ç½®æ–‡ä»¶(æˆ–æ³¨è§£é…ç½®)çš„ä¿¡æ¯, è§£æå¾—åˆ° beanDefinitions å¹¶æ³¨å†Œåˆ°å®¹å™¨ä¸­.</span><br><span class="line">3.ç„¶åæ˜¯ä¸€äº›å¯¹ beanFactory å¯¹è±¡çš„å®Œå–„é…ç½®çš„ä»£ç </span><br><span class="line">4.æ‰«æå¹¶æ‰§è¡Œ BeanFactoryPostProcessor(å…¶ä½œç”¨æ˜¯ä¸ºbeanFactoryå¯¹è±¡æ·»åŠ ä¸œè¥¿æä¾›æ‰©å±•æ€§), å…¶ä¸­æˆ‘è®¤è¯†çš„å°±åªæœ‰ ConfigurationClassPostProcessor(è¿™ä¸ªç±»ä½œç”¨å°±æ˜¯è§£æ @Configuration/@Component/@Import/@ImportSource/@ComponentScanç­‰åŸºç¡€æ³¨è§£).</span><br><span class="line">5.æ‰«æå®ç°äº† BeanPostProcessor æ¥å£çš„ bean å¹¶æ³¨å†Œåˆ° beanFactory ä¸­å­˜èµ·æ¥, ç­‰ createBean åˆ›å»ºå¯¹è±¡æ—¶ä¼šåœ¨å¯¹åº”çš„æ—¶æœºæ‰§è¡Œä¸€äº›å¯¹åº”çš„æ–¹æ³•(é’©å­). å¸¸è§çš„å„ç§ XxxAware å°±æ˜¯é è¿™ä¸ªå®ç°çš„å’¯.</span><br><span class="line">6.æ¥ç€, åˆå§‹åŒ–å›½é™…åŒ–èµ„æºå¤„ç†å™¨, äº‹ä»¶å¹¿æ’­å™¨, å¹¶æ³¨å†Œä¸€äº›éœ€è¦æ³¨å†Œçš„äº‹ä»¶(ä¹Ÿæ³¨å†Œå®¹å™¨å†…å®ç°å¯¹åº”æ¥å£çš„ bean)</span><br><span class="line">7.å¤„ç†ä¸€äº› beanFactory çš„é…ç½®, æ¥ç€ä¸ºæ‰€æœ‰å•ä¾‹ä¸”éæ‡’åŠ è½½çš„(ä¸å°±æ˜¯é»˜è®¤ç­–ç•¥å˜›) bean åˆ›å»ºå®ä¾‹, ç¼“å­˜èµ·æ¥.</span><br><span class="line">8.å¹¿æ’­å®¹å™¨åŠ è½½å®Œæˆäº†çš„äº‹ä»¶. ä»¥åŠå¤„ç†ç”Ÿå‘½å‘¨æœŸ.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æœ€åæ€»ç»“ä¸‹, å…ˆåˆ›å»ºå®¹å™¨, å†å°†æ ¹æ®é…ç½®æ–‡ä»¶è§£æå¾—åˆ° BeanDefinition æ³¨å†Œåˆ°å®¹å™¨ä¸­, ç„¶åå¤„ç†ä¸¤å¤§æ‰©å±•(BeanFactoryPostProcessor/BeanPostProcessor), æ¥ç€æ˜¯Springçš„å›½é™…åŒ–, ä»¥åŠç›¸å½“æœ‰ç”¨çš„äº‹ä»¶å¹¿æ’­å™¨, æœ€åå®ä¾‹åŒ– bean. æ•´ä½“æ„Ÿè§‰å…¶å®å¾ˆç®€å•, ä½†å…¶å®æœ‰å¤§é‡çš„å·¥ä½œäº¤ç»™äº† BeanPostProcessor.</p>
</blockquote>
<h3 id="è¶…é•¿æºç åˆ†æè¿‡ç¨‹"><a href="#è¶…é•¿æºç åˆ†æè¿‡ç¨‹" class="headerlink" title="è¶…é•¿æºç åˆ†æè¿‡ç¨‹"></a>è¶…é•¿æºç åˆ†æè¿‡ç¨‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…ˆéšä¾¿å†™ä¸ª main æ–¹æ³•, å¦‚æˆ‘å†™çš„, å¯æµ‹è¯•ä¾èµ–å¾ªç¯é—®é¢˜å’Œäº‹ä»¶ç›‘å¬:</span></span><br><span class="line"><span class="comment">// åŒ…å: cn.gudqs7.spring.tests, æ”¹åŠ¨åˆ™éœ€åŒæ­¥ä¿®æ”¹xmlå“¦</span></span><br><span class="line"><span class="comment">// è¿›å…¥å¯¹åº”ç±»ä»£ç : å¿«æ·é”® Cmd+Option+é¼ æ ‡ç‚¹å‡» (æˆ– Ctrl+Alt+é¼ æ ‡å·¦é”® ); å¦‚æœæ˜¯æ¥å£æ¾å¼€ Option(æˆ–Alt)é”®</span></span><br><span class="line"></span><br><span class="line">Test.java</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		ApplicationContext xmlContext = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"application-wq.xml"</span>);</span><br><span class="line">		UserServiceImpl userService = xmlContext.getBean(UserServiceImpl<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		userService.sayHi();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">application-wq.xml</span><br><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> ?&gt;</span><br><span class="line">&lt;beans xmlns:xsi=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line">       xmlns=<span class="string">"http://www.springframework.org/schema/beans"</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span> <span class="keyword">default</span>-autowire=<span class="string">"byName"</span>&gt;</span><br><span class="line"></span><br><span class="line">	&lt;bean name=<span class="string">"userService"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"cn.gudqs7.spring.tests.UserServiceImpl"</span>&gt;</span><br><span class="line">		&lt;property name="starter"&gt;&lt;ref bean="serverStarter"/&gt;&lt;/property&gt;</span><br><span class="line">	&lt;/bean&gt;</span><br><span class="line">	&lt;bean name=<span class="string">"serverStarter"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"cn.gudqs7.spring.tests.ServerStarter"</span>&gt;</span><br><span class="line">		&lt;property name="userService"&gt;&lt;ref bean="userService"/&gt;&lt;/property&gt;</span><br><span class="line">	&lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">UserServiceImpl.java</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Resource</span></span><br><span class="line">	<span class="keyword">private</span> ServerStarter starter;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(starter);</span><br><span class="line">		System.out.println(<span class="string">"Hello Spring!"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStarter</span><span class="params">(ServerStarter starter)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.starter = starter;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ServerStarter.java</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerStarter</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">ContextRefreshedEvent</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Inject</span></span><br><span class="line">	<span class="keyword">private</span> UserServiceImpl userService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ContextRefreshedEvent event)</span> </span>&#123;</span><br><span class="line">		String applicationName = event.getApplicationContext().getApplicationName();</span><br><span class="line">		System.out.println(applicationName);</span><br><span class="line">		System.out.println(userService);</span><br><span class="line">		System.out.println(<span class="string">"========== started by gudqs7 =============="</span>);</span><br><span class="line">		System.out.println(<span class="string">"========== started by gudqs7 =============="</span>);</span><br><span class="line">		System.out.println(<span class="string">"========== started by gudqs7 =============="</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserService</span><span class="params">(UserServiceImpl userService)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.userService = userService;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¥ä¸‹æ¥, è¿›å…¥ClassPathXmlApplicationContext#ClassPathXmlApplicationContext(java.lang.String) æ–¹æ³•ä¸­</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¶è·³è½¬åˆ°äº†</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ClassPathXmlApplicationContext</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">			String[] configLocations, <span class="keyword">boolean</span> refresh, @Nullable ApplicationContext parent)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// ä¸ºå®¹å™¨çš„ parent å­—æ®µèµ‹å€¼, è‹¥ parent ä¸ä¸ºç©º, ä¸”æœ‰ ConfigurableEnvironment, åˆ™åˆå¹¶æ•°æ®(å°†çˆ¶å®¹å™¨æœ‰çš„åŠ åˆ°å­å®¹å™¨ä¸­)</span></span><br><span class="line">		<span class="comment">// å³æ‰§è¡Œäº† org.springframework.context.support.AbstractApplicationContext.setParent()</span></span><br><span class="line">		<span class="keyword">super</span>(parent);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// ä¸º configLocations å­—æ®µèµ‹å€¼(å‘ŠçŸ¥é…ç½®æ–‡ä»¶ä½ç½®), èµ‹å€¼å‰ä¼šæ ¹æ®ç¯å¢ƒå˜é‡è§£æ(æ­¤æ—¶ç¯å¢ƒå˜é‡ä¸­åªæœ‰ç³»ç»Ÿç¯å¢ƒå˜é‡: å¦‚JAVA_HOME).</span></span><br><span class="line">		setConfigLocations(configLocations);</span><br><span class="line">		<span class="keyword">if</span> (refresh) &#123;</span><br><span class="line">			<span class="comment">// æ³¨é‡Šåœ¨ä¸‹é¢</span></span><br><span class="line">      refresh();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç„¶åå…·ä½“çš„çœ‹ refresh æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</span><br><span class="line">		<span class="comment">// 1.è®¾ç½®å®¹å™¨åˆå§‹çš„ä¸€äº›å±æ€§(æ—¶é—´,çŠ¶æ€)ï¼Œåˆå§‹åŒ–å ä½ç¬¦æ•°æ®æºå¹¶æ ¡éªŒæ‰€æœ‰ bean æ‰€ä½¿ç”¨çš„å ä½ç¬¦æ˜¯å¦å­˜åœ¨, æ¸…ç©ºäº‹ä»¶å’Œç›‘å¬</span></span><br><span class="line">		<span class="comment">// 2.æ¸…ç©ºé‡ç½®æ—§çš„ beanFactory, å†åˆ›å»ºæ–°çš„ beanFactory å¹¶é€šè¿‡è§£æ xmlæˆ–æ³¨è§£ åŠ è½½ beanDefinitions</span></span><br><span class="line">		<span class="comment">// 3.è®¾ç½®äº†ä¸€äº› beanFactory çš„å±æ€§, æ·»åŠ äº†å‡ ä¸ªæœ‰ç”¨çš„ BeanPostProcessor, è¿˜æ·»åŠ äº†å‡ ä¸ª bean åˆ°å®¹å™¨ä¸­(éƒ½æ˜¯ç¯å¢ƒç›¸å…³çš„ bean)</span></span><br><span class="line">		<span class="comment">// 4.å­ç±»å¯¹beanFactory æ·»åŠ è‡ªå·±çš„ç‰¹æ®Šçš„ BeanPostProcessor (å¦‚servletContxt/servletConfigæ³¨å…¥)</span></span><br><span class="line">		<span class="comment">// 5.æ‰«æå®¹å™¨ä¸­å®ç°äº† BeanFactoryPostProcessor æ¥å£çš„ bean å°†å…¶æ³¨å†Œåˆ° beanFactory ä¸­å¹¶æ‰§è¡Œ</span></span><br><span class="line">		<span class="comment">// 6.æ‰«æå®¹å™¨ä¸­å®ç°äº† BeanPostProcessor æ¥å£çš„ bean å°†å…¶æ³¨å†Œåˆ° beanFactory ä½†ä¸æ‰§è¡Œ(å®ä¾‹åŒ– bean å¯¹è±¡é‚£ä¼šæœ‰å‡ ä¸ªæ‰§è¡Œæ—¶æœº)</span></span><br><span class="line">		<span class="comment">// 7.åˆ›å»ºä¸€ä¸ªå›½é™…åŒ–èµ„æºè§£æå™¨å¹¶æ³¨å†Œåˆ° beanFactory; åˆ›å»ºä¸€ä¸ªäº‹ä»¶å¹¿æ’­å™¨å¹¶æ³¨å†Œåˆ° beanFactory.</span></span><br><span class="line">		<span class="comment">// 8.è°ƒç”¨å­ç±»çš„å…¶ä»–åˆ·æ–°æ—¶éœ€è¦åšçš„äº‹æƒ…(æ¨¡æ¿æ–¹æ³•)</span></span><br><span class="line">		<span class="comment">// 9.æ‰«æå®¹å™¨ä¸­å®ç°äº† ApplicationListener æ¥å£çš„ bean, å°†å…¶é¢„å­˜åˆ°å¹¿æ’­å™¨ä¸­ä½†ä¸æ‰§è¡Œ</span></span><br><span class="line">		<span class="comment">//10.å®Œæˆ beanFactory çš„ä¸€äº›é…ç½®(åŒ…æ‹¬ç»ˆç»“ä¸€äº›ä¸œè¥¿, å¦‚ setTempClassLoader(null) ); å°†å•ä¾‹çš„ bean åˆ›å»ºå‡ºæ¥æ”¾å…¥å®¹å™¨ä¸­(æœªè®¾ç½®lazy-init=true)çš„ bean</span></span><br><span class="line">		<span class="comment">//11.å¹¿æ’­ ContextRefreshedEvent äº‹ä»¶ï¼Œ åˆå§‹åŒ–LifeCycleProcessoråŠè°ƒç”¨å…¶ onRefresh æ–¹æ³•.</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">			<span class="comment">// Prepare this context for refreshing.</span></span><br><span class="line">			<span class="comment">// è®¾ç½®å®¹å™¨åˆå§‹çš„ä¸€äº›å±æ€§(æ—¶é—´,çŠ¶æ€)ï¼Œåˆå§‹åŒ–å ä½ç¬¦æ•°æ®æºå¹¶æ ¡éªŒæ‰€æœ‰ bean æ‰€ä½¿ç”¨çš„å ä½ç¬¦æ˜¯å¦å­˜åœ¨, æ¸…ç©ºäº‹ä»¶å’Œç›‘å¬</span></span><br><span class="line">			prepareRefresh();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Tell the subclass to refresh the internal bean factory.</span></span><br><span class="line">			<span class="comment">// æ¸…ç©ºé‡ç½®æ—§çš„ beanFactory, å†åˆ›å»ºæ–°çš„ beanFactory å¹¶è§£æ xmlæˆ–æ³¨è§£ åŠ è½½ beanDefinitions</span></span><br><span class="line">			ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Prepare the bean factory for use in this context.</span></span><br><span class="line">			<span class="comment">// è®¾ç½®äº†ä¸€äº› beanFactory çš„å±æ€§, æ·»åŠ äº†å‡ ä¸ªæœ‰ç”¨çš„ BeanPostProcessor, è¿˜æ·»åŠ äº†å‡ ä¸ª bean åˆ°å®¹å™¨ä¸­(éƒ½æ˜¯ç¯å¢ƒç›¸å…³çš„ bean)</span></span><br><span class="line">			prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="comment">// Allows post-processing of the bean factory in context subclasses.</span></span><br><span class="line">				<span class="comment">// å­ç±»å¯¹beanFactory æ·»åŠ è‡ªå·±çš„ç‰¹æ®Šçš„ BeanPostProcessor (å¦‚servletContxt/servletConfigæ³¨å…¥)</span></span><br><span class="line">				postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Invoke factory processors registered as beans in the context.</span></span><br><span class="line">				<span class="comment">// æ‰«æå®¹å™¨ä¸­å®ç°äº† BeanFactoryPostProcessor æ¥å£çš„ bean å°†å…¶æ³¨å†Œåˆ° beanFactory ä¸­å¹¶æ‰§è¡Œ</span></span><br><span class="line">				<span class="comment">//   æ‰«æ6æ¬¡, 2(BeanDefinitionRegistry/BeanFactory) x 3(ä¼˜å…ˆçº§:é«˜/ä¸­/å…¶ä»–)</span></span><br><span class="line">				invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Register bean processors that intercept bean creation.</span></span><br><span class="line">				<span class="comment">// æ‰«æå®¹å™¨ä¸­å®ç°äº† BeanPostProcessor æ¥å£çš„ bean å°†å…¶æ³¨å†Œåˆ° beanFactory ä½†ä¸æ‰§è¡Œ; æ‰«æ6æ¬¡: 2(MergedBeanDefinitionPostProcessor/å…¶ä»–) x 3(ä¼˜å…ˆçº§: é«˜/ä¸­/å…¶ä»–)</span></span><br><span class="line">				registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Initialize message source for this context.</span></span><br><span class="line">				<span class="comment">// åˆ›å»ºä¸€ä¸ªå›½é™…åŒ–èµ„æºè§£æå™¨å¹¶æ³¨å†Œåˆ° beanFactory.</span></span><br><span class="line">				initMessageSource();</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Initialize event multicaster for this context.</span></span><br><span class="line">				<span class="comment">// åˆ›å»ºä¸€ä¸ªäº‹ä»¶å¹¿æ’­å™¨å¹¶æ³¨å†Œåˆ° beanFactory.</span></span><br><span class="line">				initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Initialize other special beans in specific context subclasses.</span></span><br><span class="line">				<span class="comment">// è°ƒç”¨å­ç±»çš„å…¶ä»–åˆ·æ–°æ—¶éœ€è¦åšçš„äº‹æƒ…(æ¨¡æ¿æ–¹æ³•)</span></span><br><span class="line">				onRefresh();</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Check for listener beans and register them.</span></span><br><span class="line">				<span class="comment">// å°†å¯èƒ½å­˜åœ¨çš„ applicationListeners æ³¨å†Œåˆ°äº‹ä»¶å¹¿æ’­å™¨ä¸­(æ–°å»ºæ—¶æ˜¯ä¸å­˜åœ¨çš„),</span></span><br><span class="line">				<span class="comment">// ç„¶åæ‰«æå®¹å™¨ä¸­å®ç°äº† ApplicationListener æ¥å£çš„ bean, å°†å…¶é¢„å­˜åˆ°å¹¿æ’­å™¨ä¸­ä½†ä¸æ‰§è¡Œ</span></span><br><span class="line">				<span class="comment">// å°†ä¹‹å‰ publishEvent() æƒ³å¹¿æ’­çš„äº‹ä»¶å¹¿æ’­å‡ºå», ç„¶åå­—æ®µ earlyApplicationEvents èµ‹å€¼ä¸ºç©º(ä»£è¡¨ä¹‹åå¯ç«‹å³å¹¿æ’­)</span></span><br><span class="line">				registerListeners();</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Instantiate all remaining (non-lazy-init) singletons.</span></span><br><span class="line">				<span class="comment">// å®Œæˆ beanFactory çš„ä¸€äº›é…ç½®(åŒ…æ‹¬ç»ˆç»“ä¸€äº›ä¸œè¥¿, å¦‚ setTempClassLoader(null) )</span></span><br><span class="line">				<span class="comment">// æ³¨å†Œé»˜è®¤çš„è¡¨è¾¾å¼è§£æå™¨(è‹¥æ— ç›¸åº”çš„beanå­˜åœ¨)</span></span><br><span class="line">				<span class="comment">// æ‰«æå®¹å™¨ä¸­å®ç°äº† LoadTimeWeaverAware æ¥å£çš„ bean, å¹¶è§¦å‘(getBean)ä¹‹å‰æ³¨å†Œè¿‡çš„ BeanPostProcessor</span></span><br><span class="line">				<span class="comment">// å°†å•ä¾‹çš„ bean åˆ›å»ºå‡ºæ¥æ”¾å…¥å®¹å™¨ä¸­(æœªè®¾ç½®lazy-init=true)çš„ bean</span></span><br><span class="line">				finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Last step: publish corresponding event.</span></span><br><span class="line">				<span class="comment">// å¹¿æ’­ ContextRefreshedEvent äº‹ä»¶ï¼Œ åˆå§‹åŒ–LifeCycleProcessoråŠè°ƒç”¨å…¶ onRefresh æ–¹æ³•.</span></span><br><span class="line">				finishRefresh();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">				<span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">					logger.warn(<span class="string">"Exception encountered during context initialization - "</span> +</span><br><span class="line">							<span class="string">"cancelling refresh attempt: "</span> + ex);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Destroy already created singletons to avoid dangling resources.</span></span><br><span class="line">				<span class="comment">// é”€æ¯ç¼“å­˜çš„å•ä¾‹å¯¹è±¡</span></span><br><span class="line">				destroyBeans();</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Reset 'active' flag.</span></span><br><span class="line">				<span class="comment">// å˜æ›´çŠ¶æ€</span></span><br><span class="line">				cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Propagate exception to caller.</span></span><br><span class="line">				<span class="keyword">throw</span> ex;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">finally</span> &#123;</span><br><span class="line">				<span class="comment">// Reset common introspection caches in Spring's core, since we</span></span><br><span class="line">				<span class="comment">// might not ever need metadata for singleton beans anymore...</span></span><br><span class="line">				<span class="comment">// æ¸…ç©ºå…¬å…±å·¥å…·äº§ç”Ÿçš„ç¼“å­˜(å†…å­˜æ¾ä¸€å£æ°”).</span></span><br><span class="line">				resetCommonCaches();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æˆ‘é”™äº†, ä»£ç éƒ½æ”¾ä¸Šå»ä¸å¦‚ç»™ä¸ªGitHubåœ°å€, æ¥ä¸‹æ¥çœç•¥ä»£ç å§, åªæ”¾æ³¨é‡ŠğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„ğŸ˜„</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŒ¨ä¸ªçœ‹é‡Œé¢çš„æ–¹æ³•</span></span><br><span class="line">org.springframework.context.support.AbstractApplicationContext#prepareRefresh</span><br><span class="line">    <span class="comment">// 1.è®¾ç½®å®¹å™¨åˆå§‹çš„ä¸€äº›å±æ€§, å¦‚å¯åŠ¨æ—¶é—´, å½“å‰çŠ¶æ€</span></span><br><span class="line">		<span class="comment">// 2.æ‰“å°å¼€å§‹æ—¥å¿—</span></span><br><span class="line">		<span class="comment">// 3.åˆå§‹åŒ–å ä½ç¬¦æ•°æ®æº</span></span><br><span class="line">		<span class="comment">// 4.æ ¡éªŒæ‰€æœ‰ bean æ‰€ä½¿ç”¨çš„å ä½ç¬¦æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">		<span class="comment">// 5.æ¸…ç©ºäº‹ä»¶å’Œç›‘å¬</span></span><br><span class="line">		<span class="comment">// Switch to active.</span></span><br><span class="line">  </span><br><span class="line">org.springframework.context.support.AbstractRefreshableApplicationContext#refreshBeanFactory</span><br><span class="line">    <span class="comment">// 1.å­˜åœ¨æ—§çš„åˆ™å…ˆæ‘§æ¯ bean å¯¹è±¡å®ä¾‹åŠç¼“å­˜æ•°æ®, å†å°†æ—§çš„ç½®ä¸º null</span></span><br><span class="line">		<span class="comment">// 2.åˆ›å»ºä¸€ä¸ªæ–°çš„ beanFactory å¯¹è±¡, å†è®¾ç½® idåŠä¸€äº›é…ç½®</span></span><br><span class="line">		<span class="comment">// 3.æ‰«æå¹¶åŠ è½½ beanDefinations</span></span><br><span class="line">		<span class="comment">// 4.è®¾ç½®è¿™ä¸ªæ–°çš„ beanFactory å¯¹è±¡ä¸º applicationContext çš„ beanFactory å­—æ®µå€¼.</span></span><br><span class="line">  </span><br><span class="line">org.springframework.context.support.AbstractApplicationContext#prepareBeanFactory</span><br><span class="line">    <span class="comment">// 1.è®¾ç½® beanFactory çš„ç±»åŠ è½½å™¨</span></span><br><span class="line">		<span class="comment">// 2.è®¾ç½® beanFactory çš„è¡¨è¾¾å¼è§£æå™¨</span></span><br><span class="line">		<span class="comment">// 3.1:æ³¨å†Œä¸€ä¸ª BeanPostProcessor ç”¨äºå°†å®ç°äº†ApplicationContextèƒ½åŠ›ç›¸å…³çš„Awareæ¥å£çš„ bean, è§¦å‘èµ‹å€¼setter æ³¨å…¥ applicationContext å¯¹è±¡</span></span><br><span class="line">		<span class="comment">// 3.2:è®¾ç½® beanFactory å¤„ç† bean æ—¶è¦å¿½ç•¥çš„æ¥å£(ä¸»è¦æ˜¯setteræ³¨å…¥æ—¶å¿½è§†ä¸€äº›ä¹Ÿæ˜¯setterçš„æ–¹æ³•, å› ä¸ºè¿™äº›æ–¹æ³•ä¼šç”± PostProcessor æ¥è§¦å‘)</span></span><br><span class="line">		<span class="comment">// 4.æ³¨å†Œä¸€äº›ç‰¹æ®Šçš„ bean(æ³¨å…¥è¿™äº›beanæ—¶ä¼šæ³¨å…¥ this å¯¹è±¡: å¤šåŠŸèƒ½å·¥å…·äºº ApplicationContext, å¯è§å…¶å’Œæ™®é€š bean çš„æ³¨å†Œæ–¹å¼ä¸ä¸€æ ·)</span></span><br><span class="line">		<span class="comment">// 5.æ³¨å†Œä¸€ä¸ª BeanPostProcessor ç”¨äºæ£€æµ‹åŠ è½½çš„ bean æ˜¯å¦å®ç°äº† ApplicationListener æ¥å£, è‹¥æ˜¯, åˆ™æ³¨å†Œåˆ°äº‹ä»¶å¹¿æ’­å™¨ä¸­(ä¸æ˜¯,æ˜¯æš‚å­˜åœ¨applicationListenerså­—æ®µä¸­, ç­‰äº‹ä»¶å¹¿æ’­å™¨åˆ›å»ºåæ‰æ³¨å†Œ)</span></span><br><span class="line">		<span class="comment">// 6.æ³¨å†Œä¸€ä¸ª BeanPostProcessor ç”¨äºè§¦å‘å®ç°äº† LoadTimeWeaverAware æ¥å£çš„ bean çš„ setLoadTimeWeaver() ç¤¾ä¼š LTW å®ä¾‹.</span></span><br><span class="line">		<span class="comment">// 7.æ³¨å†Œå‡ ä¸ªç¯å¢ƒç›¸å…³ bean åˆ°å®¹å™¨ä¸­(Springçš„ç¯å¢ƒå¯¹è±¡, ä»¥åŠç³»ç»Ÿç¯å¢ƒå˜é‡å’Œç³»ç»Ÿé…ç½®æ–‡ä»¶)</span></span><br><span class="line"></span><br><span class="line">org.springframework.context.support.PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors(org.springframework.beans.factory.config.ConfigurableListableBeanFactory, java.util.List&lt;org.springframework.beans.factory.config.BeanFactoryPostProcessor&gt;)</span><br><span class="line">    <span class="comment">// 1.è‹¥ beanFactory å®ç°äº† BeanDefinitionRegistry æ¥å£(new AnnotationConfigApplicationContext å°±å®ç°äº†)</span></span><br><span class="line">		<span class="comment">//    åˆ™æ‰«ææ‰€æœ‰å®ç°äº† BeanDefinitionRegistryPostProcessor æ¥å£çš„ bean, æ ¹æ®ä¼˜å…ˆçº§åˆ†ä¸‰ç±»(é«˜/ä¸­/å…¶ä»–)ä¾æ¬¡æ‰§è¡Œ</span></span><br><span class="line">		<span class="comment">// 2.ç„¶åæ‰«ææ‰€æœ‰å®ç°äº† BeanFactoryPostProcessor æ¥å£çš„ bean, ä¾æ—§æ˜¯æ ¹æ®ä¼˜å…ˆçº§åˆ†ä¸‰ç±»ä¾æ¬¡æ‰§è¡Œ.</span></span><br><span class="line">		<span class="comment">// 3.æ¯æ¬¡æ‰§è¡Œå‰éƒ½ä¼šæ ¹æ® Order ä¿¡æ¯æ’åº, å†éå†æ‰§è¡Œ</span></span><br><span class="line">  </span><br><span class="line">org.springframework.context.support.PostProcessorRegistrationDelegate#registerBeanPostProcessors(org.springframework.beans.factory.config.ConfigurableListableBeanFactory, org.springframework.context.support.AbstractApplicationContext)</span><br><span class="line">    <span class="comment">// 1.æ‰«æ6æ¬¡: 2(MergedBeanDefinitionPostProcessor/å…¶ä»–) x 3(ä¼˜å…ˆçº§: é«˜/ä¸­/å…¶ä»–)</span></span><br><span class="line">		<span class="comment">//    å°†å…¶åŠ å…¥åˆ° beanFactory çš„ beanPostProcessors é›†åˆä¸­</span></span><br><span class="line">		<span class="comment">// 2.å†æ¬¡åŠ å…¥ ApplicationListenerDetector (ç”¨äºå¤„ç†å®ç° ApplicationListener çš„ bean æ³¨å†Œåˆ°äº‹ä»¶å¹¿æ’­å™¨), ä¸»è¦æ˜¯ä½¿å…¶åœ¨é“¾æœ«å°¾, å¯ä»¥æœ€åæ‰§è¡Œ.</span></span><br><span class="line"></span><br><span class="line">org.springframework.context.support.AbstractApplicationContext#registerListeners</span><br><span class="line">    <span class="comment">// 1.å°†å¯èƒ½å­˜åœ¨çš„ applicationListeners æ³¨å†Œåˆ°äº‹ä»¶å¹¿æ’­å™¨ä¸­(æ–°å»ºæ—¶æ˜¯ä¸å­˜åœ¨çš„)</span></span><br><span class="line">		<span class="comment">// 2.æ‰«æå®¹å™¨ä¸­å®ç°äº† ApplicationListener æ¥å£çš„ bean, å°†å…¶é¢„å­˜åˆ°å¹¿æ’­å™¨ä¸­ä½†ä¸æ‰§è¡Œ</span></span><br><span class="line">		<span class="comment">// 3.å°†ä¹‹å‰ publishEvent() æƒ³å¹¿æ’­çš„äº‹ä»¶å¹¿æ’­å‡ºå», ç„¶åå­—æ®µ earlyApplicationEvents èµ‹å€¼ä¸ºç©º</span></span><br><span class="line">		<span class="comment">//    (å› ä¸º publishEvent() ä¸­æ ¹æ®æ˜¯å¦ä¸ºç©ºåˆ¤æ–­ç«‹åˆ»æ‰§è¡Œæˆ–å…ˆå­˜ç€) (å¦è¿™ä¹Ÿè§£é‡Šäº† prepareRefresh() ä¸­ä¸ºä½•è¦èµ‹å€¼ä¸€ä¸ªç©ºé›†åˆ)</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">org.springframework.context.support.AbstractApplicationContext#finishBeanFactoryInitialization</span><br><span class="line">    <span class="comment">// 1.å®Œæˆ beanFactory çš„ä¸€äº›é…ç½®</span></span><br><span class="line">		<span class="comment">// 2.æ³¨å†Œé»˜è®¤çš„è¡¨è¾¾å¼è§£æå™¨(è‹¥æ— ç›¸åº”çš„beanå­˜åœ¨)</span></span><br><span class="line">		<span class="comment">// 3.æ‰«æå®¹å™¨ä¸­å®ç°äº† LoadTimeWeaverAware æ¥å£çš„ bean, å¹¶è§¦å‘(getBean)ä¹‹å‰æ³¨å†Œè¿‡çš„ BeanPostProcessor</span></span><br><span class="line">		<span class="comment">// 4.å°†å•ä¾‹çš„ bean åˆ›å»ºå‡ºæ¥æ”¾å…¥å®¹å™¨ä¸­(æœªè®¾ç½®lazy-init=true)çš„ bean</span></span><br><span class="line"></span><br><span class="line">org.springframework.context.support.AbstractApplicationContext#finishRefresh</span><br><span class="line">    <span class="comment">// 1.æ¸…ç©ºèµ„æºç¼“å­˜</span></span><br><span class="line">		<span class="comment">// 2.åˆ›å»ºä¸€ä¸ªç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨(start, refresh, stopç­‰)å¹¶æ³¨å†Œåˆ° beanFactory</span></span><br><span class="line">		<span class="comment">// 3.è§¦å‘ç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨çš„ onRefresh()</span></span><br><span class="line">		<span class="comment">// 4.å¹¿æ’­å®¹å™¨åˆ·æ–°å®Œæˆçš„äº‹ä»¶</span></span><br><span class="line">		<span class="comment">// 5.ä¸º Spring Tool Suite æä¾›æŸäº›ä¾¿æ·(æ²¡ç”¨è¿‡, ä¸çŸ¥é“...)</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¯ç®—å¤åˆ¶å®Œäº†, å¦‚æœä½ æœ‰å¹¸ç›´æ¥è·³è¯»åˆ°è¿™é‡Œ, é‚£ä¹ˆé€ä¸Šåœ°å€ : <a href="https://github.com/gudqs7/spring-framework/tree/wq-comment" target="_blank" rel="noopener">æ³¨æ„åˆ†æ”¯å§</a> </p>
<p>å¦å¤–ä¸Šé¢æ–¹æ³•å‰å¸¦ä¸ª <strong>#</strong> çš„, å¤åˆ¶åˆ° IDEA åŒå‡» Shift ç„¶åç²˜è´´, é€‰æ‹© Symbols æœç´¢æ›´å‡†ç¡®å‘¢!</p>
</blockquote>
<h2 id="è·å–å®¹å™¨å¯¹è±¡è¿‡ç¨‹"><a href="#è·å–å®¹å™¨å¯¹è±¡è¿‡ç¨‹" class="headerlink" title="è·å–å®¹å™¨å¯¹è±¡è¿‡ç¨‹"></a>è·å–å®¹å™¨å¯¹è±¡è¿‡ç¨‹</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»getBean(Class type) ä¸­è¿›å…¥</span></span><br><span class="line">1.æ£€æŸ¥ applicationContext å’Œ beanFactory çš„çŠ¶æ€, è‹¥æœ‰å¼‚å¸¸åˆ™ç»™å‡ºå‡†ç¡®çš„é”™è¯¯.</span><br><span class="line">2.æ‰«æå®¹å™¨ä¸­æ‰€æœ‰æ­¤ <span class="built_in">type</span> çš„ beanName, éå†åˆ¤æ–­æ¯ä¸ª beanName æ˜¯å¦å¯ç”¨</span><br><span class="line">   å¯ç”¨åˆ™åˆ¤æ–­å¯ç”¨çš„ä¸ªæ•°æ˜¯å¦åˆšå¥½æ˜¯ä¸€ä¸ª, æ˜¯åˆ™ç›´æ¥è°ƒç”¨ getBean() è¿”å›å¯¹è±¡å®ä¾‹</span><br><span class="line">   è‹¥å¯ç”¨çš„ä¸ªæ•°è¶…è¿‡ä¸€ä¸ª, åˆ™æ ¹æ® beanDefinition çš„ isPrimary å’Œå¯¹æ¯”é…ç½®çš„ä¼˜å…ˆçº§æ˜¯å¦ä¸ºæœ‰æœ€é«˜çš„å†è¿”å›æœ€é«˜çš„</span><br><span class="line">   è‹¥éƒ½ä¸è¡Œ, åˆ™æŠ¥é”™.</span><br><span class="line">3.æ¥ç€çœ‹ getBean, å…ˆè¯•ç€ä»å•ä¾‹çš„ç¼“å­˜ä¸­è·å–, è‹¥å­˜åœ¨åˆ™è¿”å›.</span><br><span class="line">4.è‹¥ç¼“å­˜ä¸­ä¸å­˜åœ¨, åˆ™åˆ¤æ–­çˆ¶å®¹å™¨æ˜¯å¦å­˜, è‹¥å­˜åœ¨åˆ™ä»çˆ¶å®¹å™¨è·å–</span><br><span class="line">   è‹¥çˆ¶å®¹å™¨ä¸å­˜åœ¨, åˆ™è‡ªå·±æ–°å»º, å…ˆæ ‡è®° beanName åˆ° alreadyCreated ä¸­(è¡¨ç¤ºå·²ç»åˆ›å»ºäº†é˜²æ­¢é‡å¤åˆ›å»º) å†å¼€å§‹åˆ›å»ºä¸€ä¸ª bean.</span><br><span class="line">5.åˆ›å»ºä¸€ä¸ªæ–°çš„ bean å®ä¾‹, å…ˆå¤„ç† beanDefinition çš„ dependsOn å±æ€§(å³è‹¥å­˜åœ¨åˆ™å…ˆè°ƒç”¨ getBean è·å–ä¾èµ–çš„ bean)</span><br><span class="line">6.è‹¥ beanDefinition çš„è®¾ç½®æ˜¯å•ä¾‹, åˆ™é€šè¿‡é—­åŒ…å¯¹åˆ›å»ºå¯¹è±¡å‰åè¿›è¡Œä¸€äº›å¼‚å¸¸å¤„ç†å’Œç¼“å­˜å¤„ç†(ä¸»è¦æ˜¯å½»åº•åˆ›å»ºå®ŒååŠ å…¥åˆ°å•ä¾‹ä¸€çº§ç¼“å­˜, ç§»é™¤äºŒçº§å’Œä¸‰çº§ç¼“å­˜[å¾ªç¯ä¾èµ–ç›¸å…³çš„ä¸¤ä¸ªç¼“å­˜]).</span><br><span class="line">7.é€šè¿‡åå°„æ ¹æ® beanClass åˆ›å»ºä¸€ä¸ªå¯¹è±¡å®ä¾‹, ç„¶åå°†å…¶æ·»åŠ åˆ° singletonFactories ä¸­(è§£å†³ä¾èµ–å¾ªç¯é—®é¢˜)</span><br><span class="line">8.è°ƒç”¨ populateBean() ä¸ºå¯¹è±¡çš„å­—æ®µ(å±æ€§)æ³¨å…¥å®ƒæ‰€éœ€è¦çš„å€¼(å¯èƒ½æ˜¯@Resource, @Valueç­‰); (æ­¤æ—¶å¯èƒ½ä¼šé‡åˆ°ä¾èµ–å¾ªç¯é—®é¢˜, ä½†è§£å†³è¿™ä¸ªé—®é¢˜çš„ç¼“å­˜åœ¨æ­¤ä¹‹å‰å°±æ·»åŠ äº†, æ‰€ä»¥ä¸æ€•)</span><br><span class="line">9.æœ€åè°ƒç”¨ initializeBean() å®Œæˆ bean çš„åˆå§‹åŒ–(è°ƒç”¨ bean çš„ä¸€äº›æ–¹æ³•, å¦‚ afterPropertiesSet), è¿”å›å¯¹è±¡å®ä¾‹.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“: å…ˆæ ¹æ® type æ‰¾åˆ° beanName, æ‰¾åˆ°åæ ¹æ® beanName åˆ›å»ºå¯¹è±¡; åˆ›å»ºå¯¹è±¡å‰å…ˆæ£€æŸ¥ç¼“å­˜(å•ä¾‹), å†è€ƒè™‘çˆ¶å®¹å™¨, æœ€åæ‰æ˜¯è‡ªå·±åˆ›å»º, è‡ªå·±åˆ›å»ºä¼šå…ˆåˆ›å»º dependsOn çš„ bean å¯¹è±¡, ç„¶åæ‰é€šè¿‡åå°„å®ä¾‹åŒ–å‡ºä¸€ä¸ªå¯¹è±¡å®ä¾‹(è¿™é‡Œåå°„ç”¨åˆ°çš„classå’Œæ„é€ æ–¹æ³•, é€šè¿‡å®ç° SmartInstantiationAwareBeanPostProcessoræ¥å£éƒ½å¯è¿›è¡Œå¹²é¢„), å®ä¾‹åŒ–åå­˜åˆ°äºŒçº§ç¼“å­˜, å†ä¸ºå­—æ®µèµ‹å€¼(æ³¨å…¥); æœ€åè°ƒç”¨ bean çš„ init ç›¸å…³çš„æ¥å£(å¦‚afterPropertiesSet), å°±å¯ä»¥è¿”å›è¿™ä¸ªå¯¹è±¡å®ä¾‹äº†.</p>
</blockquote>
<h3 id="è¶…é•¿æºç åˆ†æè¿‡ç¨‹-1"><a href="#è¶…é•¿æºç åˆ†æè¿‡ç¨‹-1" class="headerlink" title="è¶…é•¿æºç åˆ†æè¿‡ç¨‹"></a>è¶…é•¿æºç åˆ†æè¿‡ç¨‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»è¿™ä¸ªæ–¹æ³•è¿›å…¥</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(Class&lt;T&gt; requiredType)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­å®¹å™¨çš„çŠ¶æ€, ç¡®ä¿ beanFactory å¯ç”¨.(ä¸»è¦æ˜¯è‹¥ä¸å¯ç”¨, æç¤ºçš„é”™è¯¯ä¿¡æ¯ä¼šæ¯”getBeanFacgtory()ä¸­æ›´å‡†ç¡®)</span></span><br><span class="line">  <span class="comment">// ä½¿ç”¨ beanFactory çš„ getBean æ–¹æ³•è·å–å¯¹è±¡å¹¶è¿”å›.</span></span><br><span class="line">  assertBeanFactoryActive();</span><br><span class="line">  <span class="keyword">return</span> getBeanFactory().getBean(requiredType);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç„¶åå…¶ä»–æ‰€æœ‰æ¶‰åŠçš„æ ¸å¿ƒæ–¹æ³•çš„æ³¨é‡Š</span></span><br><span class="line">org.springframework.beans.factory.support.DefaultListableBeanFactory#resolveBean</span><br><span class="line">    <span class="comment">// è°ƒç”¨ resolveNamedBean, å¦‚å­˜åœ¨ bean åˆ™ç›´æ¥è¿”å›. (æ ¸å¿ƒ)</span></span><br><span class="line">		<span class="comment">// è‹¥ä¸å­˜åœ¨åˆ™ä»çˆ¶å®¹å™¨ä¸­å¯»æ‰¾, çˆ¶å®¹å™¨å®ç°äº† DefaultListableBeanFactory åˆ™è°ƒä¸åŒå­å®¹å™¨ç›¸åŒçš„æ–¹æ³•</span></span><br><span class="line">		<span class="comment">// è‹¥æ²¡å®ç°åˆ™ é€šè¿‡ getBeanProvider è·å–.</span></span><br><span class="line">  </span><br><span class="line">org.springframework.beans.factory.support.DefaultListableBeanFactory#resolveNamedBean(org.springframework.core.ResolvableType, java.lang.Object[], boolean)</span><br><span class="line">    <span class="comment">// 1.è°ƒç”¨ getBeanNamesForType è·å–æ‰€æœ‰ä¸ type ç›¸åŒ¹é…çš„ beanName é›†åˆ.</span></span><br><span class="line">		<span class="comment">// 2.éå†åˆ¤æ–­æ¯ä¸ª beanName æ˜¯å¦å¯ç”¨</span></span><br><span class="line">		<span class="comment">// 3.è‹¥å¯ç”¨çš„ beanName åªæœ‰ä¸€ä¸ª, åˆ™è°ƒç”¨ getBean(beanName) è·å–å¯¹è±¡å®ä¾‹å¹¶è¿”å›</span></span><br><span class="line">		<span class="comment">//   è‹¥å¯ç”¨æ•°è¶…è¿‡ä¸€ä¸ª, åˆ™è¯•ç€æ ¹æ®æ˜¯å¦ä¸»è¦ä»¥åŠé«˜ä¼˜å…ˆçº§æ¥ç¡®å®šä¸€ä¸ª beanName å®ä¾‹, è‹¥èƒ½ç¡®å®šåˆ™è¿”å›, ä¸èƒ½åˆ™æŠ¥é”™.</span></span><br><span class="line"></span><br><span class="line">org.springframework.beans.factory.support.AbstractBeanFactory#doGetBean</span><br><span class="line">    <span class="comment">// 1.è·å–å®Œæ•´çš„ beanName</span></span><br><span class="line">		<span class="comment">// 2.è°ƒç”¨ getSingleton1() æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç¼“å­˜, è¿™å±‚æ£€æŸ¥å¯é˜²æ­¢ä¾èµ–å¾ªç¯.</span></span><br><span class="line">		<span class="comment">//     è‹¥å­˜åœ¨, åˆ™é€šè¿‡ getObjectForBeanInstance() åˆ¤æ–­ç¼“å­˜çš„æ˜¯ bean è¿˜æ˜¯ FactoryBean å¹¶è¿”å›ç›¸åº”çš„å¯¹è±¡å®ä¾‹.</span></span><br><span class="line">		<span class="comment">// 3.è‹¥ä¸å­˜åœ¨, å…ˆè¯•ç€ä»çˆ¶å®¹å™¨è·å–(å­å®¹å™¨ä¸å­˜åœ¨è¿™ä¸ª beanDefinition ä¸”çˆ¶å®¹å™¨ä¸ä¸ºç©º)</span></span><br><span class="line">		<span class="comment">//     æ²¡æœ‰çˆ¶å®¹å™¨åˆ™ è°ƒç”¨ markBeanAsCreated() æ ‡è®°è¿™ä¸ª beanå·²ç»åˆ›å»ºäº† (å…ˆæ ‡è®°, å†åˆ›å»º)</span></span><br><span class="line">		<span class="comment">//     è·å– beanDefinition, åˆ¤æ–­å…¶ dependsOn å±æ€§æ˜¯å¦å­˜åœ¨, å­˜åœ¨åˆ™ å…ˆè·å–ä¾èµ–çš„ bean</span></span><br><span class="line">		<span class="comment">//     è°ƒç”¨ getSingleton2() å¤„ç†å•ä¾‹ç¼“å­˜</span></span><br><span class="line">		<span class="comment">// 4.è€Œ getSingleton2() ä¸­çš„é—­åŒ…ä¸­ æ‰§è¡Œçš„ createBean() æ–¹æ³•ä¸­åˆ™æ‰æ˜¯åˆ›å»ºå®ä¾‹å¹¶è°ƒç”¨ BeanPostProcessor</span></span><br><span class="line"></span><br><span class="line">org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#getSingleton(java.lang.String, boolean)</span><br><span class="line">    <span class="comment">// 1.åˆ¤æ–­æ˜¯å¦å­˜åœ¨äº singletonObjects ä¸­</span></span><br><span class="line">		<span class="comment">// 2.è‹¥ä¸å­˜åœ¨åˆ™åˆ¤æ–­ bean æ˜¯å¦å¤„äºåˆ›å»ºä¸­(æœªåˆ›å»ºå®Œæˆ, å¦‚å¾ªç¯ä¾èµ–æ—¶)</span></span><br><span class="line">		<span class="comment">// 3.è‹¥å¤„äºåˆ›å»ºä¸­, åˆ™åŒæ­¥ååˆ¤æ–­æ˜¯å¦å­˜åœ¨äº earlySingletonObjects (ä¹Ÿå°±æ˜¯ singletonFactories ç§»é™¤åå­˜å…¥çš„åœ°æ–¹)</span></span><br><span class="line">		<span class="comment">//      (å› ä¸ºFactoryBeanå ç”¨ç©ºé—´å¤§, è·å–å¯¹è±¡éº»çƒ¦ä¸”é€Ÿåº¦æ›´æ…¢, è¿™æ˜¯ä¸ºäº†é˜²æ­¢å¦‚æœå¾ªç¯ä¾èµ–é“¾æ¡å¾ˆé•¿ å¤šæ¬¡è·å–æµªè´¹CPUçš„é—®é¢˜)</span></span><br><span class="line">		<span class="comment">// 4.ä¸å­˜äº earlySingletonObjects åˆ™ä»£è¡¨ç¬¬ä¸€æ¬¡(ä¹Ÿåªä¼šæœ‰ä¸€æ¬¡)å– singletonFactories</span></span><br><span class="line">		<span class="comment">//    å–å‡ºåè°ƒç”¨ getObject() å¹¶å°†å…¶å­˜å…¥åˆ° earlySingletonObjects, ç„¶åä» singletonFactories ä¸­ç§»é™¤. ä»¥åå°±å°‘èµ°å‡ è¡Œä»£ç äº†.</span></span><br><span class="line">  </span><br><span class="line">org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#getSingleton(java.lang.String, org.springframework.beans.factory.ObjectFactory&lt;?&gt;)</span><br><span class="line">    <span class="comment">// 1.å…ˆç¡®ä¿æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºå•ä¾‹å¯¹è±¡, é˜²æ­¢é‡å¤åˆ›å»º</span></span><br><span class="line">		<span class="comment">// 2.è¿›è¡Œä¸€äº›å¼‚å¸¸å¤„ç†</span></span><br><span class="line">		<span class="comment">// 3.è°ƒç”¨ singletonFactory.getObject() åˆ›å»ºå¯¹è±¡</span></span><br><span class="line">		<span class="comment">// 4.åˆ›å»ºå¯¹è±¡ç»“æŸæ·»åŠ å•ä¾‹ç¼“å­˜å’Œæ¸…ç©º singletonFactories / earlySingletonObjects ç¼“å­˜.</span></span><br><span class="line">  </span><br><span class="line">org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#createBean(java.lang.String, org.springframework.beans.factory.support.RootBeanDefinition, java.lang.Object[])</span><br><span class="line">    <span class="comment">// 1.è°ƒç”¨ resolveBeanClass è§£æå¾—åˆ°çœŸæ­£çš„ bean class, è‹¥è§£æä¸ä¸ºç©ºä¸”å¤„äºæŸäº›æƒ…å†µä¸‹, åˆ™å¤åˆ¶ä¸€ä»½ beanDefinition å¹¶è®¾ç½® beanClass ä¸ºè§£ææ‰€å¾—</span></span><br><span class="line">		<span class="comment">// 2.æ‰§è¡Œ BeanPostProcessor çš„ postProcessorsBeforeInstantiation() æ–¹æ³•</span></span><br><span class="line">		<span class="comment">// 3.è°ƒç”¨ doCreateBean() åˆ›å»ºå¯¹è±¡ å¹¶è¿”å›</span></span><br><span class="line"></span><br><span class="line">org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#doCreateBean</span><br><span class="line">    <span class="comment">// 1.è°ƒç”¨ createBeanInstance() è·å¾—ä¸€ä¸ª å¯¹è±¡å®ä¾‹çš„ åŒ…è£…ç±»</span></span><br><span class="line">		<span class="comment">// 2.åŒæ­¥é”ä¸‹æ‰§è¡Œ BeanFactoryPostProcessor çš„ postProcessMergedBeanDefinition().</span></span><br><span class="line">		<span class="comment">// 3.æ·»åŠ  singletonFactories ç¼“å­˜, ç§»é™¤ earlySingletonObjects; è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜.</span></span><br><span class="line">		<span class="comment">// 4.è°ƒç”¨ populateBean() æ£€æŸ¥å­—æ®µæ˜¯å¦éœ€è¦æ³¨å…¥å¯¹è±¡å®ä¾‹, æ˜¯åˆ™è·å–å¯¹åº”çš„ bean æ³¨å…¥. (å¯èƒ½å¼•èµ·å¾ªç¯ä¾èµ–)</span></span><br><span class="line">		<span class="comment">// 5.è°ƒç”¨ initializeBean() æ‰§è¡Œå¯¹è±¡çš„ä¸€äº› Aware å’Œ init æ–¹æ³•å’Œ BeanPostProcessor çš„ postProcessBeforeInitialization.</span></span><br><span class="line">		<span class="comment">// 6.æœ€åè¿”å›å¯¹è±¡å®ä¾‹.</span></span><br></pre></td></tr></table></figure>





<h2 id="å„ç§å®ç°çš„åŸç†"><a href="#å„ç§å®ç°çš„åŸç†" class="headerlink" title="å„ç§å®ç°çš„åŸç†"></a>å„ç§å®ç°çš„åŸç†</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1.ä¸ºä½•æˆ‘å†™çš„ class å®ç°ä¸€äº›æ¥å£(å¦‚ApplicationContextAware)åå¹¶æ”¾å…¥å®¹å™¨ä¸­, å°±å¯ä»¥è·å–åˆ°ä¸€äº›å¯¹è±¡(å¦‚applicationContext)?</span><br><span class="line">2.ä¸ºä½•æˆ‘å†™çš„ class å®ç° ApplicationListener&lt;XxxEvent&gt; åå¹¶æ”¾å…¥å®¹å™¨ä¸­, å°±èƒ½ç›‘å¬æˆ‘æƒ³çŸ¥é“çš„äº‹ä»¶?</span><br><span class="line">3.ä¸ºä½•Springä¸­é‡åˆ°å„ç§é¡ºåºé—®é¢˜, åªéœ€è¦å®ç° Ordered æ¥å£(æˆ–åŠ ä¸Š@Orderæ³¨è§£)å°±èƒ½ä½¿å…¶æœ‰åº?</span><br><span class="line">4.Springæ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„(æŒ‡ç”¨å­—æ®µæ³¨å…¥è€Œéæ„é€ æ–¹æ³•)?</span><br><span class="line">5.Springå¯ä»¥ç”¨æ³¨è§£æ›¿æ¢XMLé…ç½®æ–‡ä»¶äº†, æ˜¯å¦‚ä½•å®ç°çš„å‘¢(å¸¸ç”¨æ³¨è§£çš„å®ç°åŸç†)?</span><br><span class="line">6.Spring AOPæ˜¯å¦‚ä½•å®ç°çš„(æŒ‡@Aspect)?</span><br><span class="line">7.Spring äº‹åŠ¡æ˜¯å¦‚ä½•å®ç°çš„(æŒ‡@Transaction)?</span><br></pre></td></tr></table></figure>

<h3 id="ä¸ºä½•æˆ‘å†™çš„-class-å®ç°ä¸€äº›æ¥å£-å¦‚ApplicationContextAware-åå¹¶æ”¾å…¥å®¹å™¨ä¸­-å°±å¯ä»¥è·å–åˆ°ä¸€äº›å¯¹è±¡-å¦‚applicationContext"><a href="#ä¸ºä½•æˆ‘å†™çš„-class-å®ç°ä¸€äº›æ¥å£-å¦‚ApplicationContextAware-åå¹¶æ”¾å…¥å®¹å™¨ä¸­-å°±å¯ä»¥è·å–åˆ°ä¸€äº›å¯¹è±¡-å¦‚applicationContext" class="headerlink" title="ä¸ºä½•æˆ‘å†™çš„ class å®ç°ä¸€äº›æ¥å£(å¦‚ApplicationContextAware)åå¹¶æ”¾å…¥å®¹å™¨ä¸­, å°±å¯ä»¥è·å–åˆ°ä¸€äº›å¯¹è±¡(å¦‚applicationContext)?"></a>ä¸ºä½•æˆ‘å†™çš„ class å®ç°ä¸€äº›æ¥å£(å¦‚ApplicationContextAware)åå¹¶æ”¾å…¥å®¹å™¨ä¸­, å°±å¯ä»¥è·å–åˆ°ä¸€äº›å¯¹è±¡(å¦‚applicationContext)?</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1) é¦–å…ˆ AbstractApplicationContext#prepareBeanFactory ä¼šæ·»åŠ ä¸€ä¸ªApplicationContextAwareProcessor</span><br><span class="line">2) è¿™ä¸ª beanPostProcessor è´Ÿè´£åœ¨beanåˆå§‹åŒ–ä¹‹å‰æ³¨å…¥contextå¯¹è±¡.</span><br><span class="line">3) è¿™ä¸ª beanPostProcessor çš„æ‰§è¡Œæ—¶æœºæ˜¯åœ¨ doCreateBean ä¸­çš„ postProcessBeforeInitialization()</span><br></pre></td></tr></table></figure>



<h3 id="ä¸ºä½•æˆ‘å†™çš„-class-å®ç°-ApplicationListener-åå¹¶æ”¾å…¥å®¹å™¨ä¸­-å°±èƒ½ç›‘å¬æˆ‘æƒ³çŸ¥é“çš„äº‹ä»¶"><a href="#ä¸ºä½•æˆ‘å†™çš„-class-å®ç°-ApplicationListener-åå¹¶æ”¾å…¥å®¹å™¨ä¸­-å°±èƒ½ç›‘å¬æˆ‘æƒ³çŸ¥é“çš„äº‹ä»¶" class="headerlink" title="ä¸ºä½•æˆ‘å†™çš„ class å®ç° ApplicationListener åå¹¶æ”¾å…¥å®¹å™¨ä¸­, å°±èƒ½ç›‘å¬æˆ‘æƒ³çŸ¥é“çš„äº‹ä»¶?"></a>ä¸ºä½•æˆ‘å†™çš„ class å®ç° ApplicationListener<XxxEvent> åå¹¶æ”¾å…¥å®¹å™¨ä¸­, å°±èƒ½ç›‘å¬æˆ‘æƒ³çŸ¥é“çš„äº‹ä»¶?</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1) åœ¨ AbstractApplicationContext#registerListeners() ä¸­æ‰«æå®¹å™¨å†…æ‰€æœ‰ç›¸å…³å®ç°ç±»åŠ å…¥åˆ°äº‹ä»¶ç›‘å¬è€…é›†åˆä¸­</span><br><span class="line">2) ç„¶ååœ¨publishEventæ—¶ï¼Œéå†äº‹ä»¶ç›‘å¬è€…é›†åˆè°ƒç”¨beançš„æ–¹æ³•å³å¯ã€‚è§‚å¯Ÿè€…æ¨¡å¼ï¼</span><br><span class="line">3) å¦å¤–ä¹Ÿç”¨äº†BeanPostProcessorå»å®ç°, å« ApplicationListenerDetector, åŠ å…¥æ—¶æœºåŒ1, æ‰§è¡Œæ—¶æœºåŒ1.</span><br><span class="line">4) è‡³äºä¸ºä½•ä½¿ç”¨2ç§æœºåˆ¶, åº”è¯¥æ˜¯å› ä¸º registerListeners() æ—¶, æ‰«æåªæ˜¯å½“å‰çš„, åç»­å¯èƒ½å®¹å™¨å†…çš„ bean è¿˜ä¼šå¢åŠ (æˆ‘ä¹ŸçŒœä¸åˆ°å•¥å½¢å¼å¢åŠ , åæ­£ç®€å•å†™ä¸ªç±»è‚¯å®šä¸ä¼š), æ‰€ä»¥è¿˜æ˜¯éœ€è¦ ApplicationListenerDetector åœ¨è¿™ä¸ª Bean åˆå§‹åŒ–æ—¶åŠ å…¥åˆ°ç›‘å¬è€…ä¸­å».</span><br></pre></td></tr></table></figure>



<h3 id="ä¸ºä½•Springä¸­é‡åˆ°å„ç§é¡ºåºé—®é¢˜-åªéœ€è¦å®ç°-Ordered-æ¥å£-æˆ–åŠ ä¸Š-Orderæ³¨è§£-å°±èƒ½ä½¿å…¶æœ‰åº"><a href="#ä¸ºä½•Springä¸­é‡åˆ°å„ç§é¡ºåºé—®é¢˜-åªéœ€è¦å®ç°-Ordered-æ¥å£-æˆ–åŠ ä¸Š-Orderæ³¨è§£-å°±èƒ½ä½¿å…¶æœ‰åº" class="headerlink" title="ä¸ºä½•Springä¸­é‡åˆ°å„ç§é¡ºåºé—®é¢˜, åªéœ€è¦å®ç° Ordered æ¥å£(æˆ–åŠ ä¸Š@Orderæ³¨è§£)å°±èƒ½ä½¿å…¶æœ‰åº?"></a>ä¸ºä½•Springä¸­é‡åˆ°å„ç§é¡ºåºé—®é¢˜, åªéœ€è¦å®ç° Ordered æ¥å£(æˆ–åŠ ä¸Š@Orderæ³¨è§£)å°±èƒ½ä½¿å…¶æœ‰åº?</h3><blockquote>
<p>å› ä¸º Spring é¢„å…ˆåœ¨æ‰§è¡Œè¿™äº›ä¸œè¥¿ä¹‹å‰, è¿›è¡Œä¸€ä¸ªæ’åºåŠ¨ä½œ, ç„¶åæ‰éå†æ‰§è¡Œ. åŒ…æ‹¬AOP, BeanFactoryPostProcessor, BeanPostProcessor .</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1) æ¯”å¦‚è¯´ BeanPostProcesser, å®¹å™¨æ‰«æå, ä¼šåƒå¯¹beané›†åˆæ’åº, å†éå†æ‰§è¡Œ.</span><br><span class="line">2) è¯¦ç»†è¿‡ç¨‹è§ PostProcessorRegistrationDelegate#sortPostProcessors()</span><br></pre></td></tr></table></figure>



<h3 id="Springæ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„-æŒ‡ç”¨å­—æ®µæ³¨å…¥è€Œéæ„é€ æ–¹æ³•"><a href="#Springæ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„-æŒ‡ç”¨å­—æ®µæ³¨å…¥è€Œéæ„é€ æ–¹æ³•" class="headerlink" title="Springæ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„(æŒ‡ç”¨å­—æ®µæ³¨å…¥è€Œéæ„é€ æ–¹æ³•)?"></a>Springæ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„(æŒ‡ç”¨å­—æ®µæ³¨å…¥è€Œéæ„é€ æ–¹æ³•)?</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>) é¦–å…ˆï¼Œ å‡å®šæœ‰ä¸¤ä¸ªå•ä¾‹ bean A å’Œ B, A æŒæœ‰ B, B æŒæœ‰Aï¼Œ æ„æˆå¾ªç¯</span><br><span class="line"><span class="number">2</span>) æ­¤æ—¶ç¨‹åºè°ƒç”¨getBeanè·å–Aï¼Œåˆ™åœ¨ doCreateBean ä¸­ åˆ›å»ºåå°† bean ç¼“å­˜åˆ° singletonFactories ä¸­</span><br><span class="line"><span class="number">3</span>) ç„¶åè®¾ç½®å±æ€§B, è§£æå±æ€§, éœ€è¦è·å–Bå¯¹è±¡</span><br><span class="line"><span class="number">4</span>) è·å–B, åˆ™æ‰§è¡ŒdoCreateBean åæ‰§è¡Œè§£æå±æ€§, éœ€è¦è·å– Aå¯¹è±¡ (åˆä¸€æ¬¡)</span><br><span class="line"><span class="number">5</span>) è·å–A, è¿›å…¥ doGetBean ä¸­çš„ getSingleton, æ­¤æ—¶åˆ¤æ–­ singletonFactories ä¸­æœ‰A, åˆ™å¯ä»¥ç›´æ¥å–å‡ºA</span><br><span class="line"><span class="number">6</span>) è·å¾—Aå, å³å¯å®ŒæˆBçš„å±æ€§èµ‹å€¼, ç„¶åä¼šå®ŒæˆBçš„åˆ›å»º.</span><br><span class="line"><span class="number">7</span>) Båˆ›å»ºå®Œå, Aå°±èƒ½è·å¾—B, åˆ™Aä¹Ÿå®Œæˆäº†å±æ€§èµ‹å€¼, æœ€åå®Œæˆåˆ›å»ºA.</span><br><span class="line"><span class="number">8</span>) åˆ°æ­¤, è¿”å›å³å¯.</span><br><span class="line"></span><br><span class="line">&gt; æ€»ç»“: é¦–æ¬¡è·å–A, åˆ›å»ºAå¯¹è±¡åç¼“å­˜ä¸€ä¸ªå­˜å‚¨Aå¯¹è±¡çš„ ObjectFactory å®ä¾‹, å†è§£æå±æ€§æ—¶è§¦å‘ getBean(B), åŒç†ä¹Ÿä¼šåšç¼“å­˜, ç„¶åä¹Ÿè§£æå±æ€§, è§¦å‘getBean(A), ç¬¬äºŒæ¬¡è·å–A, è¿›å…¥å¦ä¸€ä¸ªé€»è¾‘, è¿”å› ObjectFactory å®ä¾‹ä¸­å­˜å‚¨çš„å¯¹è±¡A, å³å¯å®ŒæˆgetBean(A), ç„¶åå®ŒæˆgetBean(B), å†å®Œæˆå¤–å±‚çš„getBean(A).  </span><br><span class="line">  </span><br><span class="line">TIPS:</span><br><span class="line">æ­¥éª¤<span class="number">4</span>ä¸­, ä¼šå…ˆåˆ¤æ–­ earlySingletonObjects, ä¸å­˜åœ¨æ‰åˆ¤æ–­ singletonFactories, è€Œä» singletonFactories ä¸­å–å¾—å¯¹è±¡å, åˆ™ä¼šå°†å…¶ä» singletonFactories ç§»é™¤å¹¶åŠ å…¥ earlySingletonObjects</span><br><span class="line"></span><br><span class="line">è¿™æ˜¯å› ä¸º singletonFactories ç¼“å­˜çš„ FactoryBean, è‹¥åå¤è°ƒç”¨ getObject(), åˆ™æ¯æ¬¡è·å–éƒ½ä¼šè°ƒç”¨ org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#getEarlyBeanReference æ–¹æ³•, è€Œæ­¤æ–¹æ³•ä¼šæ‰§è¡Œ SmartInstantiationAwareBeanPostProcessor çš„ getEarlyBeanReference(), è¿™ä¼šå¯¼è‡´ BeanPostProcessor é‡å¤æ‰§è¡Œ, æ˜¾ç„¶æ˜¯ä¸è¡Œçš„.</span><br></pre></td></tr></table></figure>



<h3 id="Springå¯ä»¥ç”¨æ³¨è§£æ›¿æ¢XMLé…ç½®æ–‡ä»¶äº†-æ˜¯å¦‚ä½•å®ç°çš„å‘¢-å¸¸ç”¨æ³¨è§£çš„å®ç°åŸç†"><a href="#Springå¯ä»¥ç”¨æ³¨è§£æ›¿æ¢XMLé…ç½®æ–‡ä»¶äº†-æ˜¯å¦‚ä½•å®ç°çš„å‘¢-å¸¸ç”¨æ³¨è§£çš„å®ç°åŸç†" class="headerlink" title="Springå¯ä»¥ç”¨æ³¨è§£æ›¿æ¢XMLé…ç½®æ–‡ä»¶äº†, æ˜¯å¦‚ä½•å®ç°çš„å‘¢(å¸¸ç”¨æ³¨è§£çš„å®ç°åŸç†)?"></a>Springå¯ä»¥ç”¨æ³¨è§£æ›¿æ¢XMLé…ç½®æ–‡ä»¶äº†, æ˜¯å¦‚ä½•å®ç°çš„å‘¢(å¸¸ç”¨æ³¨è§£çš„å®ç°åŸç†)?</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">1) é¦–å…ˆæ˜¯æŒ‡å®šåŒ…åæˆ–æŒ‡å®šç±»å</span><br><span class="line">	å¦‚æŒ‡å®šåŒ…ååˆ™ scan æ—¶ä¼šæ‰§è¡Œ, å¦‚æŒ‡å®šç±»ååˆ™åœ¨æ„é€ æ–¹æ³•åˆå§‹åŒ– reader æ—¶æ‰§è¡Œ</span><br><span class="line">2) æ— è®ºå“ªç§, æœ€ç»ˆéƒ½ä¼šèµ°ä¸€æ®µä»£ç  AnnotationConfigUtils#registerAnnotationConfigProcessors()</span><br><span class="line">3) è¿™æ®µä»£ç ä¼šæ·»åŠ ä¸€äº› BeanFactoryPostProcessor</span><br><span class="line">	å¦‚ ConfigurationClassPostProcessor è´Ÿè´£è§£æ @Configuration&#x2F;@Import&#x2F;@Bean ç­‰æ³¨è§£</span><br><span class="line">    	ç„¶åç”± ConfigurationClassBeanDefinitionReader è´Ÿè´£å°†ä¿¡æ¯è½¬æ¢æˆBeanDefinitionå†æ³¨å†Œåˆ°å®¹å™¨ã€‚</span><br><span class="line">	å¦‚ AutowiredAnnotationBeanPostProcessor è´Ÿè´£è§£æ @Autowired&#x2F;@Value æ³¨è§£</span><br><span class="line">    å¦‚ CommonAnnotationBeanPostProcessor è´Ÿè´£è§£æ @Resource æ³¨è§£</span><br><span class="line">    è§£ææ”¾åœ¨ postProcessProperties() æ–¹æ³•ä¸­ï¼Œ å…ˆæ‰«æbeançš„å­—æ®µå’Œæ–¹æ³•ï¼Œ ç„¶åä¸€ä¸€è°ƒç”¨æ–¹æ³•å’Œä¸ºå­—æ®µæ³¨å…¥å€¼</span><br><span class="line">4) ä¹‹å, ä»–ä¼šå°†æ‰«æçš„ç±»æ”¾åˆ° beanDefinitions ä¸­(æˆ–æŒ‡å®šçš„ç±»æ³¨å†Œè¿›å»)</span><br><span class="line">5) BeanFactoryåŠ è½½å®Œæ¯•å, å›åˆ°AbstractApplicationContextçš„refreshé€»è¾‘</span><br><span class="line">	å¦‚ä¼šæ‰§è¡Œ postProcessBeanFactory(), è°ƒç”¨å‰é¢åŠ å…¥çš„ConfigurationClassPostProcessor</span><br><span class="line">	ç„¶åä¼šæ·»åŠ æ›´å¤šçš„ç±»åˆ°å®¹å™¨ä¸­.</span><br><span class="line">    </span><br><span class="line">æ³¨æ„äº‹é¡¹ï¼š</span><br><span class="line">    @Configuration å’Œ @Componentçš„åŒºåˆ«ï¼Ÿ</span><br><span class="line">    è§‚å¯Ÿå‘ç°ï¼Œå³ä½¿ä½¿ç”¨@Component å…¶ä¸‹å¸¦ @Bean çš„æ–¹æ³•ä¾ç„¶å¯ä»¥æ³¨å…¥åˆ°å®¹å™¨ä¸­ã€‚æ‰€ä»¥ä¼¼ä¹ä¸¤è€…æ²¡æœ‰åŒºåˆ«ï¼Ÿ</span><br><span class="line">    ä»”ç»†æŸ¥çœ‹æºç å’Œèµ„æ–™åï¼Œå‘ç° postProcessBeanFactory() æ–¹æ³•åœ¨ processConfigBeanDefinitions() åè¿˜ä¼šè°ƒç”¨ enhanceConfigurationClasses()</span><br><span class="line">    è€Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­, å¯¹å‰é¢è§£æäº†class æ˜¯ CONFIGURATION_CLASS_FULL (å³ä»£è¡¨@Configuration)çš„ç±»</span><br><span class="line">    ä¼šç”Ÿæˆä¸€ä¸ª cglib çš„ä»£ç†, è¿™æ ·è·å–@Beanæ³¨è§£çš„æ–¹æ³•çš„beanæ—¶,ä¸ä¼šæ¯æ¬¡è°ƒç”¨æ–¹æ³•new ä¸€ä¸ª, è€Œæ˜¯æœ‰ç¼“å­˜.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“: å°±æ˜¯åˆ©ç”¨ BeanFactoryPostProcessor å¯è·å– BeanDefinitionRegistry å¯¹è±¡, ç„¶åæ‰«æå®¹å™¨å†…å¸¦æœ‰æ³¨è§£çš„ bean, è§£æè¿™äº›æ³¨è§£å¾—åˆ°ä¸€äº› BeanDefinition, å†é€šè¿‡è·å¾—çš„ BeanDefinitionRegistryå¯¹è±¡æ³¨å†Œåˆ° BeanFactory ä¸­.</p>
</blockquote>
<h3 id="Spring-AOPæ˜¯å¦‚ä½•å®ç°çš„-æŒ‡-Aspect"><a href="#Spring-AOPæ˜¯å¦‚ä½•å®ç°çš„-æŒ‡-Aspect" class="headerlink" title="Spring AOPæ˜¯å¦‚ä½•å®ç°çš„(æŒ‡@Aspect)?"></a>Spring AOPæ˜¯å¦‚ä½•å®ç°çš„(æŒ‡@Aspect)?</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">1) ä½¿ç”¨ @EnableAspectJAutoProxy</span><br><span class="line">2) @EnableAspectJAutoProxy ä¸­ä½¿ç”¨äº† @Import(AspectJAutoProxyRegistrar.class)</span><br><span class="line">3) ConfigurationClassPostProcessor ä¼šè§£æ@Import, è¿›å…¥ registerBeanDefinitions() ä¸­</span><br><span class="line">4) registerBeanDefinitions() ä¸­æ·»åŠ äº† AnnotationAwareAspectJAutoProxyCreator åˆ°å®¹å™¨ä¸­</span><br><span class="line">5) AnnotationAwareAspectJAutoProxyCreator æœ¬è´¨ä¸Šæ—¶ä¸€ä¸ª BeanPostProcessor</span><br><span class="line">6) å› æ­¤åœ¨ createBean æ—¶, ä¼šè¢«è‡ªåŠ¨è°ƒç”¨. å…¶ä¸­ postProcessAfterInitialization() è´Ÿè´£åˆ›å»ºä»£ç†å¯¹è±¡</span><br><span class="line">7) è€Œ getAdvicesAndAdvisorsForBean() åˆ™è´Ÿè´£æŸ¥æ‰¾å¯¹åº”çš„å¢å¼º. ç„¶åä¼šè°ƒç”¨å­ç±»çš„findCandidateAdvisors</span><br><span class="line">8) å¦‚ AnnotationAwareAspectJAutoProxyCreator#findCandidateAdvisors() è´Ÿè´£æ³¨è§£ç¼–å†™å¢å¼º@Before&#x2F;@Afterç­‰</span><br><span class="line">9) ç®€å•è¯´ä¸‹é€»è¾‘, å°±æ˜¯æŸ¥æ‰¾å®¹å™¨æ‰€æœ‰ç±», åˆ¤æ–­è¿™ä¸ªç±»æœ‰æ²¡æœ‰ @Aspect æ³¨è§£, ç„¶åå…ˆæ‰¾å‡ºæ‰€æœ‰Pointcut</span><br><span class="line">	å†éå†æ‰€æœ‰æ–¹æ³•, æ‰¾å‡ºæ–¹æ³•ä¸Šå¸¦æœ‰@Beforeç­‰æ³¨è§£ä¸”æœ‰å…³è”çš„Pointcutçš„æ–¹æ³•,</span><br><span class="line">    ç„¶åä½¿ç”¨è¿™ä¸ªæ–¹æ³•å’Œå…³è”çš„Pointcut æ¥new ä¸€ä¸ªAdvisor, åŠ å…¥åˆ°Advisoré›†åˆä¸­, éå†ç»“æŸåè¿”å›å³å¯.</span><br><span class="line">10) æŸ¥æ‰¾åˆ°æ‰€æœ‰çš„å¢å¼ºå, å†æ¯”è¾ƒPointcutè¡¨è¾¾å¼æ˜¯å¦åŒ¹é…å½“å‰çš„bean, å¦‚å¯ä»¥åˆ™åŠ å…¥.</span><br><span class="line">11) æ ¹æ®æ‰¾åˆ°çš„Advisoré›†åˆ, åˆ›å»ºä¸€ä¸ªå¸¦é…ç½®(advisoré›†åˆç­‰)çš„ä»£ç†å¯¹è±¡, ä»£ç†å¯¹è±¡æ‰§è¡Œæ–¹æ³•å‰</span><br><span class="line">12) ä¼šå…ˆæ ¹æ®é…ç½®ä¸­çš„advisoré›†åˆç”Ÿæˆä¸€ä¸ªæ‰§è¡Œé“¾, ç„¶ååœ¨æ‹¦æˆªä»£ç†æ–¹æ³•å¤„è°ƒç”¨. æ‰§è¡Œé“¾ä¼šè´Ÿè´£æ‰§è¡Œé€šçŸ¥.</span><br><span class="line">13) ä¸åŒçš„é€šçŸ¥ç”±ä¸åŒçš„é€‚é…å™¨æ‰§è¡Œ.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“å°±æ˜¯é€šè¿‡ @EnableAspectJAutoProxy çš„@Import, ä½¿å¾—ç¨‹åºæœ€ç»ˆä¼šæ‰§è¡Œ AnnotationAwareAspectJAutoProxyCreator çš„ postProcessAfterInitialization(å¯¹è±¡åˆå§‹åŒ–åè°ƒç”¨) æ–¹æ³•, è¿™ä¸ªæ–¹æ³•åœ¨ BeanFactoryåˆ›å»ºå®Œå¯¹è±¡åè§¦å‘, æ­¤æ—¶ä¾¿å¯é€šè¿‡ CGlib ç­‰åŠ¨æ€ä»£ç†æŠ€æœ¯ä¸º åˆ›å»ºçš„ bean å¯¹è±¡åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡, ç„¶åè¿™ä¸ªä»£ç†å¯¹è±¡ä¼šæ ¹æ® Pointcut æ‰¾åˆ°å…³è”çš„ Advisor,  å¹¶åœ¨åˆé€‚çš„æ—¶æœºæ‰§è¡Œå¯¹åº”çš„ Advisor, å¦‚ @Beforeäº§ç”Ÿçš„Advisor ä¼šåœ¨æ‰§è¡Œäº† bean å¯¹è±¡çš„æŒ‡å®šæ–¹æ³•(çœ‹Pointcuté…ç½®)åæ‰§è¡Œ.</p>
</blockquote>
<h3 id="Spring-äº‹åŠ¡æ˜¯å¦‚ä½•å®ç°çš„-æŒ‡-Transaction"><a href="#Spring-äº‹åŠ¡æ˜¯å¦‚ä½•å®ç°çš„-æŒ‡-Transaction" class="headerlink" title="Spring äº‹åŠ¡æ˜¯å¦‚ä½•å®ç°çš„(æŒ‡@Transaction)?"></a>Spring äº‹åŠ¡æ˜¯å¦‚ä½•å®ç°çš„(æŒ‡@Transaction)?</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">0) äº‹åŠ¡æ˜¯ç”±AOPå®ç°çš„, æ‰€ä»¥éœ€è¦æ‰¾åˆ°å¯¹åº”çš„Pointcut å’Œ Advisor</span><br><span class="line">1) æ‰“å¼€äº† @EnableTransactionManagement æ³¨è§£</span><br><span class="line">2) ç„¶å@Import äº† TransactionManagementConfigurationSelector</span><br><span class="line">3) ä¹‹åå¯¼å…¥äº† ProxyTransactionManagementConfiguration åˆ°å®¹å™¨ä¸­</span><br><span class="line">4) ProxyTransactionManagementConfiguration å¸¦æœ‰ @Configuration</span><br><span class="line">5) @Bean æ³¨å…¥äº†ä¸€ä¸ªé€šç”¨çš„Advisor: BeanFactoryTransactionAttributeSourceAdvisor</span><br><span class="line">6) è¿™ä¸ªAdvisorçš„ Pointcut æ˜¯ç”± TransactionAttributeSourcePointcut å®ç°çš„</span><br><span class="line">	å®ç°é€»è¾‘æ˜¯ TransactionAttributeSourcePointcut çš„ matches()</span><br><span class="line">    è¿™ä¸ªæ–¹æ³•è°ƒç”¨äº† getTransactionAttributeSource() è·å– AnnotationTransactionAttributeSource</span><br><span class="line">    ç„¶åé€šè¿‡ getTransactionAttribute() è°ƒç”¨äº† findTransactionAttribute()</span><br><span class="line">    æœ€ç»ˆä½¿ç”¨SpringTransactionAnnotationParser ç±»åˆ¤æ–­æ–¹æ³•æ˜¯å¦æœ‰@Transactionalæ³¨è§£</span><br><span class="line">    å¹¶è§£ææ³¨è§£ä¿¡æ¯ç„¶åè¿”å›. å¦å¤–è¿™ä¸ªæ–¹æ³•è¿˜å¯ä»¥è·å–@Transactionalæ³¨è§£çš„ä¿¡æ¯, è€Œè¿™é‡Œåªç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦æ‹¦æˆªè¿™ä¸ªæ–¹æ³•.</span><br><span class="line">7) TransactionInterceptor æ˜¯ä¸€ä¸ªAdvisor</span><br><span class="line">    ä¹Ÿå¯ä»¥é€šè¿‡AnnotationTransactionAttributeSourceè·å–@Transactionalæ³¨è§£ä¸Šçš„ä¿¡æ¯</span><br><span class="line">    ç„¶ååœ¨invokeä¸­, æ‹¦æˆªæ–¹æ³•, æ‰“å¼€äº‹åŠ¡, åœ¨æ‰§è¡Œå®Œæ–¹æ³•å, æäº¤äº‹åŠ¡, æŠ¥é”™æ—¶å›æ»šäº‹åŠ¡</span><br><span class="line">    è¿™ä¸ª Advisor ä¸åŒäºä¼ ç»Ÿçš„å‰ç½®&#x2F;åç½®, è€Œæ˜¯æ›´å…·ä½“çš„ MethodInterceptor(åŠ¨æ€ä»£ç†ç›´æ¥ç›¸å…³).</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“: å°±æ˜¯åŸºäºAOPå®ç°çš„, åªéœ€æ‰¾åˆ°å¯¹åº”çš„ Pointcut å’Œ Advisor å³å¯. Pointcut å°±æ˜¯æ ¹æ® @Transaction æ³¨è§£åˆ¤æ–­æ–¹æ³•æ˜¯å¦éœ€è¦ä»£ç†, è¿™ä¸ªå¾ˆç®€å•; æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯ Advisor ä¸æ˜¯æˆ‘ä»¬å†™AOPé‚£ç§ @Before,@Aroundä¹‹ç±»çš„, è€Œæ˜¯æ›´æ¥è¿‘åŠ¨æ€ä»£ç†åŸå§‹çš„è¯­æ³•çš„ MethodInterceptor å³ TransactionInterceptor.</p>
</blockquote>
<h2 id="BeanFactoryPostProcessor-ç›¸å…³ç±»åˆ†æ"><a href="#BeanFactoryPostProcessor-ç›¸å…³ç±»åˆ†æ" class="headerlink" title="BeanFactoryPostProcessor ç›¸å…³ç±»åˆ†æ"></a>BeanFactoryPostProcessor ç›¸å…³ç±»åˆ†æ</h2><h3 id="BeanFactoryPostProcessor-ç”Ÿæ•ˆåŸç†"><a href="#BeanFactoryPostProcessor-ç”Ÿæ•ˆåŸç†" class="headerlink" title="BeanFactoryPostProcessor ç”Ÿæ•ˆåŸç†"></a>BeanFactoryPostProcessor ç”Ÿæ•ˆåŸç†</h3><blockquote>
<p>ç”Ÿæ•ˆåŸç†å°±æ˜¯, ApplicationContext çš„ refresh æ–¹æ³•ä¸­ä¼šæ‰«æå‡ºå®¹å™¨ä¸­å®ç°äº† BeanFactoryPostProcessor æ¥å£çš„ bean, å°†å…¶æ’åºåæ‰§è¡Œç›¸åº”çš„æ¥å£, è¿™æ ·æˆ‘ä»¬å†™çš„ç±»å®ç°çš„ç›¸åº”çš„æ¥å£çš„æ–¹æ³•å°±è¢«æ‰§è¡Œäº†.</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å¸¸ç”¨çš„ BeanFactoryPostProcessor</span><br><span class="line"><span class="comment"># ConfigurationClassPostProcessor</span></span><br><span class="line">è¿™ä¸ªç±»ä½œç”¨å°±æ˜¯è§£æ @Configuration/@Component/@Import/@ImportSource/@ComponentScan ç­‰åŸºç¡€æ³¨è§£. æ˜¯æ³¨è§£å¼€å‘çš„åŸºçŸ³, æ›´æ˜¯ Spring Boot çš„åŸºçŸ³.</span><br></pre></td></tr></table></figure>



<h2 id="BeanPostProcessor-ç›¸å…³ç±»åˆ†æ"><a href="#BeanPostProcessor-ç›¸å…³ç±»åˆ†æ" class="headerlink" title="BeanPostProcessor ç›¸å…³ç±»åˆ†æ"></a>BeanPostProcessor ç›¸å…³ç±»åˆ†æ</h2><h3 id="BeanPostProcessor-ç”Ÿæ•ˆåŸç†"><a href="#BeanPostProcessor-ç”Ÿæ•ˆåŸç†" class="headerlink" title="BeanPostProcessor ç”Ÿæ•ˆåŸç†"></a>BeanPostProcessor ç”Ÿæ•ˆåŸç†</h3><blockquote>
<p>åœ¨ refresh() ä¸­ä¼šæ‰«æå®¹å™¨ä¸­æ‰€æœ‰ å®ç°äº† BeanPostProcessor æ¥å£çš„ç±», æ·»åŠ åˆ° BeanFactory çš„ beanPostProcessors å­—æ®µä¸­(æ˜¯ä¸ªList[CopyOnWriteArrayListè‡ªå®šä¹‰ç‰ˆ, è‡ªå®šä¹‰åŠ å…¥äº†æ¸…ç©ºç¼“å­˜çš„é€»è¾‘]), ç„¶ååœ¨ BeanFactory åˆ›å»ºå¯¹è±¡æ—¶ createBean() åœ¨é€‚å½“çš„æ—¶æœºè°ƒç”¨å¯¹åº”çš„æ–¹æ³•.</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">æœ‰å“ªå‡ ç§ BeanPostProcessor (é»˜è®¤çš„+æ‰©å±•)</span><br><span class="line">1.InstantiationAwareBeanPostProcessor</span><br><span class="line">	postProcessAfterInstantiation: å¯¹è±¡å®ä¾‹åŒ–åè°ƒç”¨</span><br><span class="line">	postProcessBeforeInstantiation: å¯¹è±¡å®ä¾‹åŒ–å‰è°ƒç”¨</span><br><span class="line">	postProcessProperties: è®¾ç½®å±æ€§å€¼å‰</span><br><span class="line">	postProcessPropertyValues: è®¾ç½®å±æ€§å€¼å‰, è‹¥ä¸Šä¸ªæ–¹æ³•ä¸å¤„ç†(è¿”å›null)æ‰ä¼šè§¦å‘</span><br><span class="line"></span><br><span class="line">2.SmartInstantiationAwareBeanPostProcessor</span><br><span class="line">  predictBeanType: è·å–ä¸€ä¸ª bean çš„ class ç±»å‹å‰è°ƒç”¨</span><br><span class="line">  getEarlyBeanReference: è·å–ä¸€ä¸ªäºŒçº§ç¼“å­˜å¯¹è±¡(singletonFactoriesçš„getObject)æ—¶è°ƒç”¨</span><br><span class="line">  determineCandidateConstructors: å†³å®šä¸€ä¸ª bean å®ä¾‹åŒ–çš„æ„é€ å‚æ•°æ˜¯ä»€ä¹ˆæ—¶è°ƒç”¨</span><br><span class="line">	</span><br><span class="line">3.DestructionAwareBeanPostProcessor</span><br><span class="line">	postProcessBeforeDestruction: å¯¹è±¡é”€æ¯å‰è°ƒç”¨</span><br><span class="line">	requiresDestruction: åˆ¤æ–­è¿™ä¸ªç±»é’ˆå¯¹æŸä¸ª bean æ˜¯å¦æ‰§è¡Œ postProcessBeforeDestruction()</span><br><span class="line">	</span><br><span class="line">4.MergedBeanDefinitionPostProcessor</span><br><span class="line">  postProcessMergedBeanDefinition: åœ¨åˆ›å»ºå¯¹è±¡å‰è°ƒç”¨, å¯å¯¹ BeanDefinition åšä¿®æ”¹</span><br><span class="line">  resetBeanDefinition: åœ¨é‡ç½® BeanDefinition æ—¶è°ƒç”¨, ç”¨äºæ¸…ç©º PostProcessor å¯¹åº”çš„ç¼“å­˜</span><br><span class="line">	</span><br><span class="line">5.BeanPostProcessor(åŸºç¡€)</span><br><span class="line">  postProcessBeforeInitialization: åˆ›å»ºå¯¹è±¡å(ä¹Ÿè®¾ç½®å¥½äº†å­—æ®µ), åœ¨è°ƒç”¨ init ä¹‹å‰è°ƒç”¨</span><br><span class="line">  postProcessAfterInitialization: åœ¨åˆ›å»ºå¯¹è±¡æ—¶, è°ƒç”¨äº† init ä¹‹åè°ƒç”¨</span><br><span class="line">  </span><br><span class="line">æ€»ç»“: </span><br><span class="line">0.å¯¹ BeanDefinition åšå¹²é¢„</span><br><span class="line">1.å¯¹è±¡å®ä¾‹åŒ–è¿‡ç¨‹ä¸­(å¯¹class/æ„é€ å‚æ•°è¿›è¡Œå¹²é¢„)</span><br><span class="line">2.å¯¹è±¡å®ä¾‹åŒ–å‰å</span><br><span class="line">3.å¯¹è±¡è®¾ç½®å±æ€§å‰, å¯¹å±æ€§åšå¹²é¢„</span><br><span class="line">4.å¯¹è±¡åˆå§‹åŒ–(init)å‰å</span><br><span class="line">5.å¯¹è±¡é”€æ¯å‰</span><br></pre></td></tr></table></figure>

<h3 id="è°ƒç”¨æ—¶æœº"><a href="#è°ƒç”¨æ—¶æœº" class="headerlink" title="è°ƒç”¨æ—¶æœº"></a>è°ƒç”¨æ—¶æœº</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// 1.1: InstantiationAwareBeanPostProcessor çš„ postProcessAfterInstantiation()</span></span><br><span class="line"><span class="comment">//   åœ¨ org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.populateBean ç¬¬ä¸€æ®µ</span></span><br><span class="line"><span class="comment">// 1.2: InstantiationAwareBeanPostProcessor çš„ postProcessProperties()</span></span><br><span class="line"><span class="comment">//   åœ¨ org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.populateBean ç¬¬äºŒæ®µ</span></span><br><span class="line"><span class="comment">// 1.3: InstantiationAwareBeanPostProcessor çš„ postProcessPropertyValues</span></span><br><span class="line"><span class="comment">//   åœ¨ org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.populateBean ç¬¬ä¸‰æ®µ</span></span><br><span class="line"><span class="comment">// 1.4: InstantiationAwareBeanPostProcessor çš„ postProcessBeforeInstantiation()</span></span><br><span class="line"><span class="comment">//   åœ¨ org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.applyBeanPostProcessorsBeforeInstantiation ä¸­</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.1: SmartInstantiationAwareBeanPostProcessor çš„ predictBeanType()</span></span><br><span class="line"><span class="comment">//   åœ¨ org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.predictBeanType ä¸­</span></span><br><span class="line"><span class="comment">// 2.2: SmartInstantiationAwareBeanPostProcessor çš„ getEarlyBeanReference()</span></span><br><span class="line"><span class="comment">//   åœ¨ org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.getEarlyBeanReference ä¸­</span></span><br><span class="line"><span class="comment">// 2.3: SmartInstantiationAwareBeanPostProcessor çš„ determineCandidateConstructors()</span></span><br><span class="line"><span class="comment">//   åœ¨ org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.determineConstructorsFromBeanPostProcessors ä¸­</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.1: MergedBeanDefinitionPostProcessor çš„ postProcessMergedBeanDefinition()</span></span><br><span class="line"><span class="comment">//   åœ¨ org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.applyMergedBeanDefinitionPostProcessors ä¸­</span></span><br><span class="line"><span class="comment">// 3.2: MergedBeanDefinitionPostProcessor çš„ resetBeanDefinition()</span></span><br><span class="line"><span class="comment">//   åœ¨ org.springframework.beans.factory.support.DefaultListableBeanFactory.resetBeanDefinition ä¸­</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4.1: DestructionAwareBeanPostProcessor çš„ postProcessBeforeDestruction()</span></span><br><span class="line"><span class="comment">//   åœ¨ org.springframework.beans.factory.support.DisposableBeanAdapter.destroy ä¸­</span></span><br><span class="line"><span class="comment">// 4.2: DestructionAwareBeanPostProcessor çš„ requiresDestruction()</span></span><br><span class="line"><span class="comment">//   åœ¨ org.springframework.beans.factory.support.DisposableBeanAdapter.filterPostProcessors å’Œ org.springframework.beans.factory.support.DisposableBeanAdapter.hasApplicableProcessors ä¸­</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æœ‰å“ªäº›å¸¸ç”¨çš„ BeanPostProcessor</span></span><br><span class="line">1.AsyncAnnotationBeanPostProcessor: ç”¨äºåœ¨å°† @Async ç›¸åº”çš„ Advisor åŠ å…¥åˆ°å¯¹è±¡çš„ä»£ç†ä¸­</span><br><span class="line">2.ScheduledAnnotationBeanPostProcessor: ç”¨äºå¤„ç† @Scheduled æ³¨è§£, å°† bean ç”Ÿäº§ä»£ç†ç±»</span><br><span class="line">3.AnnotationAwareAspectJAutoProxyCreator: AOP å®ç°æ ¸å¿ƒç±»</span><br><span class="line">4.AutowiredAnnotationBeanPostProcessor: ç”¨äºå¤„ç† @Autowired æ³¨è§£</span><br><span class="line">5.ApplicationListenerDetector: ç”¨äºå¤„ç†å®ç° ApplicationListener æ¥å£çš„ bean å¯¹è±¡, å°†å…¶æ·»åŠ åˆ°äº‹ä»¶å¹¿æ’­å™¨çš„ç›‘å¬è€…é›†åˆä¸­.</span><br><span class="line">...</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://gudqs7.github.io/2020/05/20/interview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="gudqs7">
      <meta itemprop="description" content="å¿ƒç´¯æ²¡é’±èººå°¸ä¸­">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="gudqs7's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/20/interview/" class="post-title-link" itemprop="url">Java-Interview</a>
        </h2>

        <div class="post-meta">
			
				<i class="fa fa-thumb-tack"></i>
				<font color="RED">ç½®é¡¶</font>
				<span class="post-meta-divider">|</span>
			
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2020-05-20 08:48:14" itemprop="dateCreated datePublished" datetime="2020-05-20T08:48:14+08:00">2020-05-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-01-25 23:11:18" itemprop="dateModified" datetime="2021-01-25T23:11:18+08:00">2021-01-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MyBatis/" itemprop="url" rel="index"><span itemprop="name">MyBatis</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring-MVC/" itemprop="url" rel="index"><span itemprop="name">Spring-MVC</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/interview/" itemprop="url" rel="index"><span itemprop="name">interview</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/2020/05/20/interview/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/05/20/interview/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ä¸€å¥è¯"><a href="#ä¸€å¥è¯" class="headerlink" title="ä¸€å¥è¯"></a>ä¸€å¥è¯</h2><h3 id="è¯´ä¸€ä¸‹ä½ é‡æ„ä»£ç éƒ½åšäº†ä»€ä¹ˆ"><a href="#è¯´ä¸€ä¸‹ä½ é‡æ„ä»£ç éƒ½åšäº†ä»€ä¹ˆ" class="headerlink" title="è¯´ä¸€ä¸‹ä½ é‡æ„ä»£ç éƒ½åšäº†ä»€ä¹ˆ?"></a>è¯´ä¸€ä¸‹ä½ é‡æ„ä»£ç éƒ½åšäº†ä»€ä¹ˆ?</h3><blockquote>
<p>é¦–å…ˆæ˜¯ä¸¤å±‚æ”¹æˆä¸‰å±‚, æŠŠcontroller çš„ä»£ç å°½é‡è¿ç§»åˆ° service å±‚. ç„¶åå°†è¯·æ±‚é£æ ¼å’Œå“åº”æ•°æ®ç»“æ„ç»Ÿä¸€. è¿˜æœ‰å°±æ˜¯å¤„ç†å…¨å±€å¼‚å¸¸, æœ€åå¯¹æŸäº›é‡å¤ä»£ç å°è£…æˆå·¥å…·ç±». å¦å¤–è¿˜ä¼šæ ¹æ®å®é™…ä¸šåŠ¡åœºæ™¯ä½¿ç”¨ä¸€äº›è®¾è®¡æ¨¡å¼, æé«˜ä»£ç å¯æ‰©å±•æ€§, é™ä½ä»£ç ä¹‹é—´çš„è€¦åˆæ€§.</p>
</blockquote>
<h3 id="ä»€ä¹ˆæ˜¯-JVM"><a href="#ä»€ä¹ˆæ˜¯-JVM" class="headerlink" title="ä»€ä¹ˆæ˜¯ JVM?"></a>ä»€ä¹ˆæ˜¯ JVM?</h3><blockquote>
<p> JVM å°±æ˜¯ç”±ç¼–è¯‘å™¨, ç±»åŠ è½½å™¨, æ‰§è¡Œå¼•æ“, è¿è¡Œæ—¶æ•°æ®åŒºç»„æˆ. å…¶ä¸­æ•°æ®åŒºåŒ…å« å †,æ ˆ,æœ¬åœ°æ–¹æ³•æ ˆ, æ–¹æ³•åŒºå’Œç¨‹åºè®¡æ•°å™¨(PC å¯„å­˜å™¨), å…¶ä¸­æ ˆæ˜¯ç”±å±€éƒ¨å˜é‡è¡¨, æ“ä½œæ•°æ ˆ, åŠ¨æ€é“¾æ¥, è¿”å›åœ°å€ç»„æˆçš„.</p>
</blockquote>
<h3 id="ä½ æ˜¯æ€ä¹ˆå¯¹-jvm-åƒåœ¾å›æ”¶è¿›è¡Œä¼˜åŒ–çš„"><a href="#ä½ æ˜¯æ€ä¹ˆå¯¹-jvm-åƒåœ¾å›æ”¶è¿›è¡Œä¼˜åŒ–çš„" class="headerlink" title="ä½ æ˜¯æ€ä¹ˆå¯¹ jvm åƒåœ¾å›æ”¶è¿›è¡Œä¼˜åŒ–çš„?"></a>ä½ æ˜¯æ€ä¹ˆå¯¹ jvm åƒåœ¾å›æ”¶è¿›è¡Œä¼˜åŒ–çš„?</h3><blockquote>
<p>æ ¹æ®æœåŠ¡å™¨çš„é…ç½®, è°ƒæ•´é’å¹´ä»£å’Œè€å¹´ä»£çš„å†…å­˜å¤§å°åŠæ¯”ä¾‹, åœ¨å›æ”¶é¢‘ç‡å’Œå›æ”¶é€Ÿåº¦ä¸Šåšå–èˆ, ä½¿ç”¨ G1 åƒåœ¾å›æ”¶æœŸæ§åˆ¶ STW åœé¡¿æ—¶é—´, æé«˜ååé‡.</p>
</blockquote>
<h3 id="è¯´è¯´-MySQL-ä¼˜åŒ–"><a href="#è¯´è¯´-MySQL-ä¼˜åŒ–" class="headerlink" title="è¯´è¯´ MySQL ä¼˜åŒ–"></a>è¯´è¯´ MySQL ä¼˜åŒ–</h3><blockquote>
<p>é¦–å…ˆæ˜¯ SQL æŸ¥è¯¢ä¼˜åŒ–, é€šè¿‡å¯¹è”è¡¨å­—æ®µ, æŸ¥è¯¢æ¡ä»¶, åˆ†ç»„å­—æ®µ, æ’åºå­—æ®µè¿›è¡Œç»¼åˆåˆ†æ, æ ¹æ®æœ€å·¦åŸåˆ™å»ºç«‹ä¸€ä¸ªæˆ–å¤šä¸ªå¤åˆç´¢å¼•, ç„¶åä½¿ç”¨ explain åˆ†æSQLæ‰§è¡Œè®¡åˆ’, åˆ¤æ–­ç´¢å¼•ä½¿ç”¨æƒ…å†µ, æ ¹æ®åˆ†æç»“æœè¿›ä¸€æ­¥æ”¹è¿›ç´¢å¼•.</p>
<p>ç„¶åæ˜¯å¯¹äºæ•°æ®é‡å¤§çš„è¡¨, è€ƒè™‘å‚ç›´æˆ–æ°´å¹³åˆ†è¡¨, è¯»å¤šå†™å°‘çš„æƒ…å†µ, å¯ä»¥ä¸€ä¸»å¤šä»é›†ç¾¤. å¦å¤–å¯¹äºä¸€äº›ç»Ÿè®¡ç±»çš„æŸ¥è¯¢, å¯ä»¥ç”¨å®šæ—¶ä»»åŠ¡å°†ç»Ÿè®¡ç»“æœå­˜å‚¨èµ·æ¥, è€Œéå®æ—¶æŸ¥è¯¢.</p>
</blockquote>
<h3 id="ä½ ç”¨-Redis-åšäº†ä»€ä¹ˆ"><a href="#ä½ ç”¨-Redis-åšäº†ä»€ä¹ˆ" class="headerlink" title="ä½ ç”¨ Redis åšäº†ä»€ä¹ˆ?"></a>ä½ ç”¨ Redis åšäº†ä»€ä¹ˆ?</h3><blockquote>
<p>å°†é«˜è®¿é—®çš„é¦–é¡µå•†å“åˆ—è¡¨ç¼“å­˜åˆ° redis ä¸­, é¿å…æ•°æ®åº“ç“¶é¢ˆ, æé«˜å“åº”é€Ÿåº¦. </p>
<p>å•†å“åŒæ­¥é—®é¢˜: å®šæ—¶ä»»åŠ¡åˆ·æ–°. æˆ–ä¿®æ”¹å•†å“æ—¶æ›´æ–°, ç¼“å­˜è®¾ç½®å¤±æ•ˆæ—¶é—´, å¤±æ•ˆåè‡ªåŠ¨è¯»å–æ•°æ®åº“.</p>
<p>å°†è´­ç‰©è½¦æ•°æ®å­˜æ”¾åˆ° redis, æé«˜è´­ç‰©è½¦äº¤äº’ä½“éªŒ(åŠ å¿«å“åº”é€Ÿåº¦).</p>
</blockquote>
<h3 id="ä½ ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—åšäº†ä»€ä¹ˆ"><a href="#ä½ ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—åšäº†ä»€ä¹ˆ" class="headerlink" title="ä½ ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—åšäº†ä»€ä¹ˆ?"></a>ä½ ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—åšäº†ä»€ä¹ˆ?</h3><blockquote>
<p>è§£è€¦: å¦‚ä¸‹å•ç³»ç»Ÿè°ƒç”¨åº“å­˜ç³»ç»Ÿå‡åº“å­˜, è‹¥è°ƒç”¨æ—¶åº“å­˜ç³»ç»ŸæŒ‚äº†æˆ–å‡ºé”™äº†, ä¸‹å•ç³»ç»Ÿè¿˜éœ€è¦åšé‡è¯•å¤„ç†, å¼‚å¸¸å¤„ç†, æ­¤æ—¶å¯å°†å‡åº“å­˜è¯·æ±‚æ”¾åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­, åº“å­˜ç³»ç»Ÿè¯»å–æ¶ˆæ¯è¿›è¡Œå¤„ç†, è‹¥å‡ºé”™åˆ™æ”¾å›æ¶ˆæ¯é˜Ÿåˆ—é‡è¯•. è¿™æ ·å³ä½¿ä»£ç  bug å¯¼è‡´ä¸€ç›´ä¸æˆåŠŸä¹Ÿå¯åœ¨å‡çº§åè‡ªåŠ¨é‡è¯•, æ— éœ€äººå·¥å¹²é¢„. å¦å¾®ä¿¡æ”¯ä»˜å›è°ƒä¹Ÿå¯å¦‚æ­¤å¤„ç†.</p>
<p>å‰Šå³°: å¦‚ç§’æ€ç¬é—´è¯·æ±‚è¿‡é«˜, å¯å°†è¯·æ±‚æ”¾åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­, å¦ä¸€ç«¯ç¼“æ…¢æ¶ˆè´¹, å¯é˜²æ­¢ç³»ç»Ÿå¡ä½.</p>
<p>å¼‚æ­¥: æ¯”å¦‚ä¸‹å•åå‘é€ä¸‹å•é€šçŸ¥, æœ‰çŸ­ä¿¡é€šçŸ¥, å¾®ä¿¡å…¬ä¼—å·é€šçŸ¥ç­‰, ä¸€ä¸ªä¸€ä¸ªå‘é€ä¼šå¯¼è‡´ä¸‹å•è¿™ä¸ªè¯·æ±‚å“åº”å¾ˆæ…¢, å› æ­¤å¯ä»¥å°†å‡ ä¸ªé€šçŸ¥åšæˆä¸€ä¸ªæ¶ˆæ¯, æ”¾åˆ°æ¶ˆæ¯é˜Ÿåˆ—, ç”±å¦ä¸€å¤„ä»£ç å¼‚æ­¥æ‰§è¡Œ.</p>
</blockquote>
<h3 id="ä½ ä½¿ç”¨çº¿ç¨‹æ± åšäº†ä»€ä¹ˆ"><a href="#ä½ ä½¿ç”¨çº¿ç¨‹æ± åšäº†ä»€ä¹ˆ" class="headerlink" title="ä½ ä½¿ç”¨çº¿ç¨‹æ± åšäº†ä»€ä¹ˆ?"></a>ä½ ä½¿ç”¨çº¿ç¨‹æ± åšäº†ä»€ä¹ˆ?</h3><blockquote>
<p>å°†çº¿ç¨‹æ± å°è£…åˆ°ä¸€ä¸ªå·¥å…·ç±»ä¸­, å·¥å…·ç±»å†åšæˆå•ä¾‹æ¨¡å¼. è¿™æ ·ä½¿ç”¨åˆ°å¤šçº¿ç¨‹çš„åœ°æ–¹éƒ½å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªå…¬å…±çº¿ç¨‹æ± , å‡å°‘çº¿ç¨‹å¯¹è±¡åˆ›å»ºé”€æ¯. æé«˜çº¿ç¨‹çš„åˆ©ç”¨ç‡.</p>
<p>ä¸€äº›åœ°æ–¹å¼‚æ­¥æ“ä½œ, æ‹¦æˆªå™¨æ·»åŠ è¯·æ±‚æ—¥å¿—æ—¶å¼‚æ­¥æ·»åŠ .</p>
</blockquote>
<h3 id="ä½ åœ¨ä»£ç ä¸­ä½¿ç”¨äº†å“ªäº›è®¾è®¡æ¨¡å¼"><a href="#ä½ åœ¨ä»£ç ä¸­ä½¿ç”¨äº†å“ªäº›è®¾è®¡æ¨¡å¼" class="headerlink" title="ä½ åœ¨ä»£ç ä¸­ä½¿ç”¨äº†å“ªäº›è®¾è®¡æ¨¡å¼?"></a>ä½ åœ¨ä»£ç ä¸­ä½¿ç”¨äº†å“ªäº›è®¾è®¡æ¨¡å¼?</h3><blockquote>
<p>å•ä¾‹æ¨¡å¼, é™æ€å·¥å‚æ¨¡å¼, æ¨¡æ¿æ–¹æ³•, è§‚å¯Ÿè€…, è£…é¥°è€…, ç­–ç•¥æ¨¡å¼, çŠ¶æ€æ¨¡å¼, èŒè´£é“¾æ¨¡å¼.</p>
<p>è§‚å¯Ÿè€…: ç›‘å¬å•†å“ä¿¡æ¯æ›´æ–°, æ ¹æ®ä½£é‡‘å˜åŒ–å¹…åº¦å†³å®šæ˜¯å¦åˆ é™¤, æ ¹æ®ä½£é‡‘å˜åŒ–å’Œä»·æ ¼å˜åŒ–å¹…åº¦å†³å®šæ˜¯å¦é€šçŸ¥ç”¨æˆ·æ”¶è—å•†å“å˜åŒ–.</p>
<p>ç­–ç•¥æ¨¡å¼: è®¢å•ä¸åŒç±»å‹, å¯¹åº”çš„å•†å“æºä¸åŒ, æŸ¥è¯¢æ•°æ®æ–¹å¼ä¸åŒ, å› æ­¤ä½¿ç”¨ç­–ç•¥æ¨¡å¼, ä¾¿äºæ–°å¢ç±»å‹çš„æ‰©å±•.</p>
<p>çŠ¶æ€æ¨¡å¼: çº¢åŒ…çŠ¶æ€çš„å˜åŒ–, å¯ä»¥åšæˆçŠ¶æ€æ¨¡å¼, ä½¿å¾—çº¢åŒ…æ–°å¢çŠ¶æ€æ—¶æ‰©å±•æ›´ç®€å•.</p>
</blockquote>
<h2 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h2><h3 id="é‡æ„"><a href="#é‡æ„" class="headerlink" title="é‡æ„"></a>é‡æ„</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">é‡å¤ä»£ç é‡æ„, æŠ½è±¡å‡ºå·¥å…·ç±», è¿”å›å€¼&#x2F;è‡ªå®šä¹‰å¼‚å¸¸ æ•´ç†é‡æ„, ç»Ÿä¸€è¯·æ±‚é£æ ¼</span><br><span class="line">ä½¿ç”¨çŠ¶æ€æ¨¡å¼&#x2F;ç­–ç•¥æ¨¡å¼ä¼˜åŒ– if&#x2F;else</span><br><span class="line">ä½¿ç”¨å·¥å‚æ¨¡å¼ç»Ÿä¸€ç®¡ç†éœ€è¦çš„å®ä¾‹å¯¹è±¡, å¦‚å·¥å…·ç±», é‚®ä»¶æœåŠ¡ç­‰</span><br><span class="line">å°è£…é€šç”¨ CRUD æ¥å£åŠå®ç°, å‡å°‘ Dao å±‚ä»£ç </span><br><span class="line"></span><br><span class="line">æ¨¡å—çš„æ‹†åˆ†, æ•°æ®åº“åˆ†åº“åˆ†è¡¨, å¾®æœåŠ¡æ‹†åˆ†</span><br></pre></td></tr></table></figure>

<h3 id="é›†ç¾¤"><a href="#é›†ç¾¤" class="headerlink" title="é›†ç¾¤"></a>é›†ç¾¤</h3><h4 id="MySQL-é›†ç¾¤"><a href="#MySQL-é›†ç¾¤" class="headerlink" title="MySQL é›†ç¾¤"></a>MySQL é›†ç¾¤</h4><blockquote>
<p>MySQL é»˜è®¤æ”¯æŒä¸»ä»æ¶æ„é›†ç¾¤, å¯é…åˆ mycat å®ç°è¯»å†™åˆ†ç¦».</p>
</blockquote>
<h4 id="Redis-é›†ç¾¤"><a href="#Redis-é›†ç¾¤" class="headerlink" title="Redis é›†ç¾¤"></a>Redis é›†ç¾¤</h4><blockquote>
<p>Redis Cluster, Codis</p>
</blockquote>
<h4 id="Tomcat-é›†ç¾¤"><a href="#Tomcat-é›†ç¾¤" class="headerlink" title="Tomcat é›†ç¾¤"></a>Tomcat é›†ç¾¤</h4><blockquote>
<p>tomcat é›†ç¾¤ä¸€èˆ¬éœ€è¦è€ƒè™‘ session å…±äº«, å¯é€šè¿‡ redis å®ç° session å…±äº«.</p>
</blockquote>
<h3 id="åˆ†å¸ƒå¼"><a href="#åˆ†å¸ƒå¼" class="headerlink" title="åˆ†å¸ƒå¼"></a>åˆ†å¸ƒå¼</h3><h4 id="SpringCloud"><a href="#SpringCloud" class="headerlink" title="SpringCloud"></a>SpringCloud</h4><blockquote>
<p>Spring Cloud æ˜¯ä¸€å¥—åˆ†å¸ƒå¼å¼€å‘çš„è§£å†³æ–¹æ¡ˆ, é›†åˆäº†åˆ†å¸ƒå¼è°ƒç”¨, é“¾è·¯è¿½è¸ª, é™çº§å¤„ç†, æœåŠ¡æ³¨å†Œå‘ç°.</p>
</blockquote>
<h4 id="Dubbo"><a href="#Dubbo" class="headerlink" title="Dubbo"></a>Dubbo</h4><blockquote>
<p>Dubbo æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ RPC è°ƒç”¨æ¡†æ¶, åº•å±‚ä½¿ç”¨ netty æ¡†æ¶.</p>
</blockquote>
<h3 id="è¿ç»´"><a href="#è¿ç»´" class="headerlink" title="è¿ç»´"></a>è¿ç»´</h3><h4 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h4><blockquote>
<p>docker æ˜¯ä¸€ä¸ªå®¹å™¨, æä¾›äº†æ ‡å‡†åŒ–çš„æ¥å£, å¯ç”¨äºå¿«é€Ÿæ„å»ºéƒ¨ç½²ç¯å¢ƒ, ç®€åŒ–éƒ¨ç½²æµç¨‹</p>
</blockquote>
<h4 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker-compose"></a>docker-compose</h4><blockquote>
<p>docker-compose ä½¿ç”¨ yml æ–‡ä»¶æè¿°å®¹å™¨é—´çš„å…³ç³»ä»¥åŠå®¹å™¨çš„é…ç½®, å¯ç”¨äºå¿«é€Ÿæ„å»ºå¤æ‚çš„è¿è¡Œç¯å¢ƒ.</p>
</blockquote>
<h4 id="K8s"><a href="#K8s" class="headerlink" title="K8s"></a>K8s</h4><blockquote>
<p>K8s æ˜¯ä¸€ä¸ªæ ¹æ®å®¹å™¨å¿«é€Ÿæ­å»ºå’Œç®¡ç†é›†ç¾¤çš„å·¥å…·.</p>
</blockquote>
<h2 id="JVM"><a href="#JVM" class="headerlink" title="JVM"></a>JVM</h2><h3 id="JVM-å†…å­˜æ¨¡å‹"><a href="#JVM-å†…å­˜æ¨¡å‹" class="headerlink" title="JVM å†…å­˜æ¨¡å‹"></a>JVM å†…å­˜æ¨¡å‹</h3><blockquote>
<p>æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„å†…å­˜åŒºåŸŸ, å¤šçº¿ç¨‹ä¹‹é—´é€šä¿¡ä¸»è¦é€šè¿‡å…±äº«å†…å­˜æ¥å®ç°.</p>
</blockquote>
<ul>
<li>æœ‰åºæ€§: åœ¨ CPU æ‰§è¡ŒæŒ‡ä»¤æ—¶, å¯èƒ½ä¼šå¯¹é happens-before æŒ‡ä»¤è¿›è¡Œé‡æ’, ä¼˜åŒ–æ‰§è¡Œæ•ˆç‡. åœ¨å•çº¿ç¨‹æƒ…å†µ, å¾€å¾€ä¸ä¼šäº§ç”Ÿé—®é¢˜, ä½†æ¶‰åŠå¤šçº¿ç¨‹æ—¶, å¯èƒ½å¯¼è‡´ bug.</li>
<li>å¯è§æ€§: ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†ä¸€ä¸ªå…±äº«å˜é‡, å¦ä¸€ä¸ªçº¿ç¨‹ä¸ä¼šçŸ¥é“è¿™ä¸ªæ”¹å˜, è¿™å°±æ˜¯ä¸å¯è§, è¦ç¡®ä¿å¯è§æ€§, ä¸€èˆ¬ä½¿ç”¨ volatile å…³é”®è¯, å½“ç„¶, åŠ é”ä¹Ÿå¯ä»¥.</li>
<li>åŸå­æ€§: å³å¯¹äºæŸä»£ç , å®é™…æ‰§è¡Œæ—¶ä¼šåˆ†ä¸ºå¥½å‡ ä¸ªåŸå­æŒ‡ä»¤, ç¡®ä¿åŸå­æ€§å¿…é¡»åŠ é” (å¦‚synchronized) å¤„ç†</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">happens-before:</span><br><span class="line">è¯»åå†™</span><br><span class="line">å†™åå†™</span><br><span class="line">é”åè§£é”</span><br><span class="line">å¯ä¼ é€’æ€§</span><br></pre></td></tr></table></figure>

<h3 id="å¤šçº¿ç¨‹"><a href="#å¤šçº¿ç¨‹" class="headerlink" title="å¤šçº¿ç¨‹"></a>å¤šçº¿ç¨‹</h3><blockquote>
<p>çº¿ç¨‹æ˜¯ä¸€ä¸ªè¿›ç¨‹ä¸­çš„ä¸åŒæ‰§è¡Œè·¯å¾„, ä¸€ä¸ªè¿›ç¨‹è‡³å°‘æœ‰ä¸€ä¸ªä¸»çº¿ç¨‹.</p>
<p>è¿›ç¨‹æ˜¯ä¸€ä¸ªç¨‹åºçš„æŠ½è±¡, ä¸€ä¸ªç¨‹åºè¿è¡Œåä¸€èˆ¬ä¸ºä¸€ä¸ªè¿›ç¨‹.</p>
</blockquote>
<p>çº¿ç¨‹çŠ¶æ€:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1.New (æ–°å»º)</span><br><span class="line">2.Runnable (å°±ç»ª)</span><br><span class="line">3.Running (è¿è¡Œä¸­)</span><br><span class="line">4.Blocked (é˜»å¡)</span><br><span class="line">5.WAITING (ç­‰å¾…)</span><br><span class="line">6.TIMED_WAITING (è¶…æ—¶ç­‰å¾…)</span><br><span class="line">7.Dead (æ­»äº¡)</span><br><span class="line"></span><br><span class="line">[t:threadå¯¹è±¡, obj: åŒæ­¥å—ä¸­çš„å¯¹è±¡]</span><br><span class="line">New: new Thread()</span><br><span class="line">Runnable: t.start(), t.yield()</span><br><span class="line">Running: after t.start() and cpu run it</span><br><span class="line">Blocked: when enter synchronized block</span><br><span class="line">WAITING: obj.wait(), t.join(), LockSupport.park()</span><br><span class="line">TIMED_WAITING: Thread.sleep(x), obj.wait(x), t.join(x)</span><br><span class="line">Dead: when t.run() is over</span><br></pre></td></tr></table></figure>



<h3 id="JVM-å¯¹è±¡ç»“æ„"><a href="#JVM-å¯¹è±¡ç»“æ„" class="headerlink" title="JVM å¯¹è±¡ç»“æ„"></a>JVM å¯¹è±¡ç»“æ„</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">å¯¹è±¡å¤´:</span><br><span class="line">	Mark Word(hash, é”çŠ¶æ€, åˆ†ä»£å¹´é¾„)</span><br><span class="line">	ç±»å‹æŒ‡é’ˆ</span><br><span class="line">	[æ•°ç»„é•¿åº¦]</span><br><span class="line">å®ä¾‹æ•°æ®</span><br><span class="line">å¯¹é½</span><br></pre></td></tr></table></figure>



<h3 id="åƒåœ¾å›æ”¶"><a href="#åƒåœ¾å›æ”¶" class="headerlink" title="åƒåœ¾å›æ”¶"></a>åƒåœ¾å›æ”¶</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">æ ‡è®°ç®—æ³•:</span><br><span class="line">	1.å¼•ç”¨è®¡æ•°æ³•</span><br><span class="line">	2.å¯è¾¾æ€§åˆ†æç®—æ³•(æ ¹æœç´¢)(æ ¹å¯¹è±¡: æ ˆä¸­çš„å¯¹è±¡, é™æ€å±æ€§å¼•ç”¨å¯¹è±¡, å¸¸é‡å¼•ç”¨å¯¹è±¡)</span><br><span class="line">å›æ”¶ç®—æ³•:</span><br><span class="line">	1.æ ‡è®°-æ¸…é™¤ç®—æ³•</span><br><span class="line">	2.æ ‡è®°-æ•´ç†ç®—æ³•</span><br><span class="line">	3.æ ‡è®°-å¤åˆ¶ç®—æ³•</span><br><span class="line">	4.åˆ†ä»£ç®—æ³•( Eden åŒº(å¤åˆ¶ç®—æ³•)--&gt; Survivor åŒº(ç¼“å­˜, å¤åˆ¶ç®—æ³•) --&gt; Old åŒº(æ ‡è®°-æ•´ç†)</span><br><span class="line"></span><br><span class="line">å›æ”¶å™¨: (å‰ 3 ä¸ª Young GC ä½¿ç”¨, åé¢çš„ Full GC ä½¿ç”¨)</span><br><span class="line">	1.Serial (ä¸²è¡Œ, å¤åˆ¶ç®—æ³•)</span><br><span class="line">	2.ParNew (å¤šçº¿ç¨‹, å¤åˆ¶ç®—æ³•)</span><br><span class="line">	3.Parallel Scavenge (å¤šçº¿ç¨‹, æ”¹è¿›ç‰ˆ, å¯æ§åˆ¶ååé‡)</span><br><span class="line">	4.Serial Old(å•çº¿ç¨‹, æ ‡è®°-æ•´ç†)</span><br><span class="line">	5.Parallel Old (å¤šçº¿ç¨‹, æ§åˆ¶ååé‡, æ ‡è®°-æ•´ç†ç®—æ³•)</span><br><span class="line">	6.CMS (å¤šçº¿ç¨‹, ä½åœé¡¿, æ ‡è®°-æ¸…é™¤ç®—æ³•) : åˆå§‹(STW)-å¹¶å‘-é‡æ–°(STW)-æ¸…é™¤</span><br><span class="line">	7.G1 (å¤šçº¿ç¨‹, CMS å‡çº§ç‰ˆ, æ ‡è®°-æ•´ç†ç®—æ³•): åˆå§‹(STW)-å¹¶å‘-æœ€ç»ˆ(STW)-ç­›é€‰æ¸…é™¤(å¯æ§åˆ¶åœé¡¿æ—¶é—´)</span><br></pre></td></tr></table></figure>



<h2 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h2><h3 id="SQL-ä¼˜åŒ–"><a href="#SQL-ä¼˜åŒ–" class="headerlink" title="SQL ä¼˜åŒ–"></a>SQL ä¼˜åŒ–</h3><h4 id="ç´¢å¼•åŸç†"><a href="#ç´¢å¼•åŸç†" class="headerlink" title="ç´¢å¼•åŸç†"></a>ç´¢å¼•åŸç†</h4><blockquote>
<p>MySQL ç´¢å¼•ä¸€èˆ¬é€‰æ‹© B+æ ‘åšä¸ºæ•°æ®ç»“æ„å­˜å‚¨. B+ æ ‘çš„ä¼˜ç‚¹æ˜¯, å¯¹æ–‡ä»¶IOçš„è®¿é—®æ¬¡æ•°æ§åˆ¶åœ¨ 3 æ¬¡, ä¿è¯é€Ÿåº¦çš„åŒæ—¶, èƒ½å­˜å‚¨åƒä¸‡è¡Œæ•°æ®.</p>
</blockquote>
<h4 id="ç´¢å¼•"><a href="#ç´¢å¼•" class="headerlink" title="ç´¢å¼•"></a>ç´¢å¼•</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.å¯¹å¸¸ç”¨åˆ—æ·»åŠ ç´¢å¼•, è§†å…·ä½“æƒ…å†µé€‰æ‹©å•ä¸€ç´¢å¼•æˆ–å¤åˆç´¢å¼•(ä¸€èˆ¬ä¸ºå¤åˆ)</span><br><span class="line">2.é€šè¿‡ Explain è¯­å¥åˆ†ææ‰§è¡Œè®¡åˆ’, å°† type æå‡åˆ°è‡³å°‘ index çº§åˆ«.</span><br><span class="line">3.é€šè¿‡ Explain è¯­å¥åˆ†ææ‰§è¡Œè®¡åˆ’, å°† extra ä¸­ Using filesortæ¶ˆé™¤(æ’åºåˆ—åŠ ç´¢å¼•), Using join bufferæ¶ˆé™¤ (é€šè¿‡ç»™å…³è”è¡¨çš„å…³è”åˆ—åŠ ç´¢å¼•), Using temporary (ä¸€èˆ¬é€šè¿‡åˆ†ç»„åˆ—åŠ ç´¢å¼•), Using where(æ ¹æ®æœ€å·¦åŸåˆ™å¯¹æ¡ä»¶åˆ—åŠ å¤åˆç´¢å¼•)</span><br></pre></td></tr></table></figure>



<h3 id="äº‹åŠ¡"><a href="#äº‹åŠ¡" class="headerlink" title="äº‹åŠ¡"></a>äº‹åŠ¡</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ACID:</span><br><span class="line">A: åŸå­æ€§, å¤šä¸ªæ“ä½œè¦ä¹ˆéƒ½åš, è¦ä¹ˆéƒ½ä¸åš</span><br><span class="line">C: ä¸€è‡´æ€§, æ•°æ®åº“æ–‡ä»¶çš„çŠ¶æ€å¿…é¡»ä»ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€åˆ°å¦ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€.</span><br><span class="line">I: éš”ç¦»æ€§, äº‹ç‰©ä¹‹é—´ç›¸äº’éš”ç¦», äº’ä¸å½±å“.</span><br><span class="line">D: æŒç»­æ€§, ä¸€ä¸ªäº‹åŠ¡ä¸€ä½†æäº¤, åˆ™å¯¹æ•°æ®åº“çš„æ”¹å˜æ˜¯æ°¸ä¹…çš„.</span><br></pre></td></tr></table></figure>



<h3 id="æ•°æ®åº“éš”ç¦»çº§åˆ«"><a href="#æ•°æ®åº“éš”ç¦»çº§åˆ«" class="headerlink" title="æ•°æ®åº“éš”ç¦»çº§åˆ«"></a>æ•°æ®åº“éš”ç¦»çº§åˆ«</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.è¯»æœªæäº¤: å¯è¯»å–å…¶ä»–æœªæäº¤äº‹åŠ¡çš„æ‰§è¡Œç»“æœ(å¦‚æ›´æ–°äº†æŸä¸ªå­—æ®µ), å¯èƒ½ä¼šé€ æˆè¯»å–é”™è¯¯çš„æ•°æ®(æœªæäº¤çš„äº‹åŠ¡å›æ»šäº†), é€ æˆè„è¯».</span><br><span class="line">2.è¯»å·²æäº¤: å¯è¯»å–å…¶ä»–å·²æäº¤äº‹åŠ¡çš„æ‰§è¡Œç»“æœ, 2æ¬¡è¯»å–æ•°æ®è¿˜æ˜¯å¯èƒ½ä¸ä¸€è‡´(å…¶ä»–äº‹åŠ¡åˆæäº¤äº†), é€ æˆä¸å¯é‡å¤è¯».</span><br><span class="line">3.å¯é‡å¤è¯»: ç¡®ä¿åŒä¸€äº‹åŠ¡å†…å¤šæ¬¡è¯»å–æ•°æ®æ—¶, ä¼šçœ‹åˆ°ç›¸åŒçš„æ•°æ®. ä½†å¯èƒ½é€ æˆå¹»è¯», å¦‚æ‰¹é‡ä¿®æ”¹ç™»å½•å¯†ç å, å¦ä¸€ä¸ªäº‹åŠ¡æ–°å¢äº†ä¸€æ¡è®°å½•, å¯¼è‡´æ–°çºªå½•æœªä¿®æ”¹.</span><br><span class="line">4.ä¸²è¡ŒåŒ–: äº‹åŠ¡ä¸²è¡ŒåŒ–æ‰§è¡Œ, æ•ˆç‡ä½.</span><br></pre></td></tr></table></figure>

<h4 id="MySQL-é»˜è®¤éš”ç¦»çº§åˆ«"><a href="#MySQL-é»˜è®¤éš”ç¦»çº§åˆ«" class="headerlink" title="MySQL é»˜è®¤éš”ç¦»çº§åˆ«"></a>MySQL é»˜è®¤éš”ç¦»çº§åˆ«</h4><p><code>å¯é‡è¯»è¯»</code></p>
<h3 id="æ•°æ®åº“é”"><a href="#æ•°æ®åº“é”" class="headerlink" title="æ•°æ®åº“é”"></a>æ•°æ®åº“é”</h3><h4 id="é”åŸç†"><a href="#é”åŸç†" class="headerlink" title="é”åŸç†"></a>é”åŸç†</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¡Œé”: åˆ†ä¸ºæ’å®ƒé”(X) å’Œå…±äº«é”(S). å³å†™é”å’Œè¯»é”.</span><br><span class="line">è¡¨é”: åˆ†ä¸ºå…ƒæ•°æ®é”(MDL)å’Œè¡¨é”.</span><br></pre></td></tr></table></figure>

<h4 id="é”è§¦å‘æ–¹å¼"><a href="#é”è§¦å‘æ–¹å¼" class="headerlink" title="é”è§¦å‘æ–¹å¼"></a>é”è§¦å‘æ–¹å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¡Œé”: éšå¼(æ¡ä»¶å¸¦æœ‰ç´¢å¼•åˆ™é”å¯¹åº”åˆ—, ä¸å¸¦ç´¢å¼•åˆ™é”å…¨éƒ¨è¡Œ, RR æ€»ä¼šå¸¦æœ‰ GAP é”, RC ä¸ä¼š), æ˜¾å¼(ä½¿ç”¨ for update, lock in share mode)</span><br><span class="line">è¡¨é”: éšå¼(å¯¹æ•´ä¸ªè¡¨ä¸å¸¦æ¡ä»¶è¿›è¡Œå¢åˆ æ”¹, æˆ–ä»»ä½• DDL æ“ä½œ) æ˜¾ç¤º(ä½¿ç”¨ for update, lock in share mode)</span><br></pre></td></tr></table></figure>



<h2 id="æºç å’Œæ¡†æ¶"><a href="#æºç å’Œæ¡†æ¶" class="headerlink" title="æºç å’Œæ¡†æ¶"></a>æºç å’Œæ¡†æ¶</h2><h3 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a><code>ReentrantLock</code></h3><h4 id="åŠ é”æµç¨‹-lock"><a href="#åŠ é”æµç¨‹-lock" class="headerlink" title="åŠ é”æµç¨‹ lock()"></a>åŠ é”æµç¨‹ <code>lock()</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>) acquire(): å°è¯•è·å–ä¸€ä¸ªè®¸å¯è¯, è·å–æˆåŠŸåˆ™ç›´æ¥è¿”å›(lockç»“æŸ), è·å–å¤±è´¥åˆ™éœ€è¦æ’é˜Ÿ</span><br><span class="line"><span class="number">2</span>) tryAcquire(): åˆ¤æ–­å½“å‰è®¸å¯è¯æ•°é‡(state), è‹¥ä¸º<span class="number">0</span>åˆ™å°è¯•è·å–</span><br><span class="line">     åˆ†å…¬å¹³å’Œéå…¬å¹³, å…¬å¹³é”ä¼šåˆ¤æ–­ hasQueuedPredecessors, éå…¬å¹³åˆ™ç›´æ¥æŠ¢ compareAndSetState</span><br><span class="line">     è‹¥ä¸ä¸º<span class="number">0</span>, åˆ™åˆ¤æ–­æŒæœ‰é”çš„äººæ˜¯å¦ä¸ºæˆ‘æœ¬èº«, æ˜¯åˆ™å¢åŠ å½“å‰è®¸å¯è¯æ•°é‡, è¿”å›<span class="keyword">true</span>è·å–æˆåŠŸ</span><br><span class="line">     ä¸æ˜¯åˆ™ è¿”å› <span class="keyword">false</span>, è·å–å¤±è´¥(å°†æ’é˜Ÿ).</span><br><span class="line"><span class="number">3</span>) addWaiter(): AQS é˜Ÿåˆ—å°¾éƒ¨æ·»åŠ ä¸€ä¸ª Node(waiter=X[ç‹¬å é”]), è‹¥ tail ä¸å­˜åœ¨, åˆ™å…ˆåˆå§‹åŒ–ä¸€ä¸ª ç©ºhead[ç©ºæŒ‡ä¸ä»£è¡¨ä»»ä½•çº¿ç¨‹] åå†åŠ å…¥é˜Ÿåˆ—</span><br><span class="line"><span class="number">4</span>) acquireQueued: è¿›å…¥é˜Ÿåˆ—çš„èŠ‚ç‚¹, å°è¯•è·å–è®¸å¯è¯, å¤±è´¥åˆ™ park()</span><br><span class="line">     å…ˆåˆ¤æ–­nodeçš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦ä¸º head èŠ‚ç‚¹, è‹¥æ˜¯, åˆ™è¦å°è¯•è·å–ä¸€æ¬¡è®¸å¯è¯(å› ä¸ºè¿™è¯´æ˜ä¸Šä¸€ä¸ªçº¿ç¨‹å·²ç»åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­äº†, ä¹Ÿè®¸å·²ç»èµ°å®Œäº†unlock() æ–¹æ³•(å³å·²ç»è¿è¡Œè¿‡å”¤é†’é˜Ÿåˆ—ä¸‹ä¸€ä½çš„ä»£ç äº†,è€Œå› ä¸ºä½ é‚£æ—¶è¿˜ä¸åœ¨é˜Ÿåˆ—ä¸­æˆ–æ²¡è¿›å…¥ç¡çœ ä¸­, å”¤é†’ä»£ç æ˜¯æ— æ„ä¹‰çš„), è€Œä½ åˆ™åˆšåŠ å…¥é˜Ÿåˆ—, å¦‚æœä½ æ­¤æ—¶ç›´æ¥park()å»ç­‰å¾…å”¤é†’, åˆ™æ ¹æœ¬æ— äººå”¤é†’ä½ , åŒç†ä½ çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¹Ÿå°±ç­‰ä¸åˆ°ä½ å»å”¤é†’å®ƒ.)</span><br><span class="line">     å¦‚æœä¸æ˜¯, è®¾ç½®äº†ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„ waitStatus ä¸º SINGLE å, è‡ªå·±ç¡çœ  park(), ç­‰å¾…å”¤é†’</span><br><span class="line"></span><br><span class="line">å”¤é†’å:  </span><br><span class="line"><span class="number">5</span>) åˆ¤æ–­ä¸Šä¸€ä¸ªèŠ‚ç‚¹æ˜¯ä¸æ˜¯ head, ä¸€èˆ¬æ¥è¯´æ˜¯(å› ä¸ºunkockå”¤é†’çš„ä¸€èˆ¬å°±æ˜¯head.next)</span><br><span class="line">     å¦‚æœä¸æ˜¯åˆ™è¿›å…¥ shouldParkAfterFailedAcquire: å°†é˜Ÿåˆ—ä¸­ä¸€äº›å·²å–æ¶ˆçš„èŠ‚ç‚¹ä»é˜Ÿåˆ—ä¸­åˆ é™¤, é‡æ–°è®¾ç½®èŠ‚ç‚¹çš„prev</span><br><span class="line">     å› ä¸ºæ˜¯<span class="keyword">for</span>å¾ªç¯, æ‰€ä»¥åˆä¼šå†å›æ¥åˆ¤æ–­, è¿™æ—¶åº”è¯¥æ˜¯headäº†, å°è¯•è·å–è®¸å¯è¯, <span class="number">2</span>ç§å¯èƒ½, éå…¬å¹³æ—¶è¢«åˆšlockçš„äººæŠ¢äº†(æ¦‚ç‡è¾ƒå°å§), å¦ä¸€ç§å°±æ˜¯è·å–æˆåŠŸ</span><br><span class="line">     è·å–æˆåŠŸå, æŠŠåŸheadèŠ‚ç‚¹åˆ æ‰, è‡ªå·±è®¾ä¸ºheadèŠ‚ç‚¹(headè±¡å¾ä¸€ä¸ªæ‹¿åˆ°è®¸å¯è¯çš„èŠ‚ç‚¹,é™¤é˜Ÿåˆ—ç¬¬ä¸€æ¬¡åˆå§‹åŒ–), ç„¶åè¿”å›åˆ°acquire(), ä¸­é€”æ²¡æœ‰çº¿ç¨‹è¢«æ‰“æ–­å°±æ­£å¸¸å‡ºæ–¹æ³•, lockç»“æŸ</span><br><span class="line"></span><br><span class="line">æ€»ç»“:</span><br><span class="line">å¾—åˆ°æ–¹å¼<span class="number">1</span>: acquire æ—¶ state = <span class="number">0</span>, ä¸”æŠ¢åˆ°äº†.</span><br><span class="line">å¾—åˆ°æ–¹å¼<span class="number">2</span>: æ²¡æŠ¢åˆ°æˆ–ä¸è®©æŠ¢(å…¬å¹³é”), è¿›å…¥é˜Ÿåˆ—ç­‰ä¸Šä¸€ä¸ªæ¥å”¤é†’æˆ‘, ä¸Šä¸€ä¸ªç­‰ä¸Šä¸Šä¸ªæ¥å”¤é†’ä»–, ä¸Šä¸Šä¸ªç­‰ä¸Šä¸Šä¸Šä¸ªå”¤é†’....</span><br><span class="line">    unlock å”¤é†’é˜Ÿåˆ—ç¬¬äºŒä¸ªéå–æ¶ˆçš„çº¿ç¨‹å¹¶åˆ é™¤é˜Ÿåˆ—ç¬¬ä¸€ä¸ªå…ƒç´  [å…¶ä»–å…ƒç´ ç§»ä½]</span><br><span class="line">    è¿™æ ·ç¬¬äºŒä¸ªçº¿ç¨‹å°±å¯ä»¥å”¤é†’éå–æ¶ˆçš„ç¬¬ä¸‰ä¸ªçº¿ç¨‹[ç›¸å¯¹è€Œè¨€çš„ç¬¬ä¸‰ä¸ª,å®é™…ä¸Šå”¤é†’æ—¶è¿˜æ˜¯ç¬¬äºŒä¸ª, åªæ˜¯å”¤é†’åä¼šåˆ é™¤ç¬¬ä¸€ä¸ª, æ‰€ä»¥ç¬¬ä¸‰å˜ç¬¬äºŒ]</span><br></pre></td></tr></table></figure>

<h4 id="è§£é”æµç¨‹-unlock"><a href="#è§£é”æµç¨‹-unlock" class="headerlink" title="è§£é”æµç¨‹ unlock()"></a>è§£é”æµç¨‹ <code>unlock()</code></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1) release(): é‡Šæ”¾ä¸€ä¸ªè®¸å¯è¯, å¹¶æ ¹æ®å½“å‰è®¸å¯è¯æ•°é‡æ˜¯å¦ä¸º0 åˆ¤æ–­æ˜¯å¦å¯ä»¥å”¤é†’ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span><br><span class="line">2) tryRelease(): é‡Šæ”¾ä¸€ä¸ªè®¸å¯è¯, åˆ¤æ–­çº¿ç¨‹æ˜¯å¦æ­£ç¡®(æ˜¯ä¸æ˜¯å½“å‰ç‹¬å é”), è®¸å¯è¯å‡ä¸€</span><br><span class="line">	å½“å‰è®¸å¯è¯æ•°é‡æ˜¯å¦ä¸º 0 è¿”å›æ˜¯å¦å¯ä»¥å”¤é†’é˜Ÿåˆ—çš„ bool æ ‡è¯†.</span><br><span class="line">3) unparkSuccessor(): å”¤é†’é˜Ÿåˆ—ä¸­é™¤headå¤–ç¬¬ä¸€ä¸ªå¤„äºé˜»å¡(éå–æ¶ˆ)çš„èŠ‚ç‚¹(æŸ¥æ‰¾æ–¹å¼, å…ˆçœ‹next, nextçŠ¶æ€ä¸å¯¹åˆ™ä»åå¾€å‰æ‰¾æœ€å‰çš„éå–æ¶ˆçš„èŠ‚ç‚¹, å› ä¸ºnextå¦‚æœä¸ºnull, æ— æ³•æ‰¾nullçš„next).</span><br><span class="line">4) å”¤é†’å, ä¼šå°†headè®¾ç½®ä¸ºå”¤é†’çš„èŠ‚ç‚¹, ä»¥æ­¤è¾¾åˆ°ä¸‹æ¬¡å”¤é†’ä¸‹ä¸€ä¸ªçš„ç›®çš„.</span><br><span class="line"></span><br><span class="line">æ€»ç»“:</span><br><span class="line">å”¤é†’çš„é€»è¾‘å°±æ˜¯å°†æ’é˜Ÿçš„æ‰€æœ‰èŠ‚ç‚¹æŒ¨ä¸ªå”¤é†’, è€ŒèŠ‚ç‚¹è¢«å”¤é†’ååˆä¼šå‡ºé˜Ÿåˆ—; æ‰€ä»¥ä»£ç å°†å‡ºé˜Ÿåˆ—å’Œå”¤é†’é€»è¾‘ä¸€èµ·åš, å…ˆå”¤é†’ä¸‹ä¸€ä¸ª, ä¸‹ä¸€ä¸ªè´Ÿè´£æŠŠå‰ä¸€ä¸ªç§»å‡ºé˜Ÿåˆ—. ç„¶åå”¤é†’è‡ªå·±çš„ä¸‹ä¸€ä¸ª, ä»¥æ­¤ç±»æ¨, å°±å®ç°äº†å”¤é†’å’Œå‡ºé˜Ÿåˆ—çš„æ“ä½œ.</span><br></pre></td></tr></table></figure>

<h3 id="ReentrantReadWriteLock"><a href="#ReentrantReadWriteLock" class="headerlink" title="ReentrantReadWriteLock"></a><code>ReentrantReadWriteLock</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">è¯»é”</span><br><span class="line">	è·å–é” tryAcquireShared(), è‹¥å½“å‰æ²¡æœ‰å†™é”å­˜åœ¨, åˆ™ state + <span class="number">1</span>ä¸ªè¯»å•ä½, ç„¶åè¿”å›è·å–æˆåŠŸ. é˜²æ­¢è¿”å›è·å–å¤±è´¥, è¿›å…¥é˜Ÿåˆ—ä¼‘çœ .</span><br><span class="line">	é‡Šæ”¾é” tryReleaseShared(), state - <span class="number">1</span>ä¸ªè¯»å•ä½, ç„¶åæ ¹æ® state = <span class="number">0</span> åˆ¤æ–­è¿”å›æ˜¯å¦å¯ä»¥å”¤é†’é˜Ÿåˆ—.</span><br><span class="line">	</span><br><span class="line">å†™é”</span><br><span class="line">	è·å–é” tryAcquire(), è‹¥å­˜åœ¨è¯»é”, åˆ™å¤±è´¥, è‹¥å­˜åœ¨å†™é”, åˆ¤æ–­æ˜¯å¦é‡å…¥è·å–, æ˜¯åˆ™è¿”å›è·å–æˆåŠŸ. å¦åˆ™å¤±è´¥; å¤±è´¥å°±æ„å‘³ç€åŠ é˜Ÿåˆ—,ä¼‘çœ .</span><br><span class="line">    é‡Šæ”¾é” tryRelease(), state - <span class="number">1</span>, åˆ¤æ–­ state ä¸­å†™é”æ•°é‡æ˜¯å¦ä¸º<span class="number">0</span>, æ˜¯åˆ™å¯ä»¥å”¤é†’é˜Ÿåˆ—. å¦åˆ™ä»£è¡¨è¿™æ—¶ä¸€ä¸ªå¯é‡å…¥é”çš„é‡Šæ”¾é€»è¾‘.</span><br><span class="line">   </span><br><span class="line">æ€»ç»“: è¯»å†™é”ä¹Ÿå¥½, å¯é‡å…¥é”ä¹Ÿå¥½, CountDownLatch ç­‰å·¥å…·ç±»ä¹Ÿå¥½, éƒ½æ˜¯å¯¹ state æ“ä½œä¸ºå¤š, æˆ–è€…è¯´, å®ç°äº† AQSçš„å®ƒä»¬, åªè´Ÿè´£æ“ä½œ state, è€Œé˜Ÿåˆ—, å”¤é†’, éƒ½äº¤ç»™ AQS æ¥å¤„ç†.</span><br></pre></td></tr></table></figure>



<h3 id="CountDownLatch"><a href="#CountDownLatch" class="headerlink" title="CountDownLatch"></a><code>CountDownLatch</code></h3><h4 id="countDown"><a href="#countDown" class="headerlink" title="countDown()"></a><code>countDown()</code></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1) state æ•°é‡å‡ä¸€, ç„¶ååˆ¤æ–­ state æ•°é‡æ˜¯å¦ä¸º0, è‹¥æ˜¯åˆ™å”¤é†’ç­‰å¾…é˜Ÿåˆ—çš„çº¿ç¨‹.</span><br></pre></td></tr></table></figure>

<h4 id="await"><a href="#await" class="headerlink" title="await()"></a><code>await()</code></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1) new ä¹‹å, state æ•°é‡å¤§äº0, æ‰€ä»¥ä¼šè¿›å…¥ç­‰å¾…é˜Ÿåˆ—, ç„¶åçº¿ç¨‹ä¼šè¿›å…¥ä¼‘çœ .</span><br><span class="line">2) ç­‰å¾…countDowné‡Šæ”¾é”, é‡Šæ”¾åˆ°è®¸å¯è¯ä¸º0æ—¶, å”¤é†’ç­‰å¾…é˜Ÿåˆ—çš„çº¿ç¨‹.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“:</p>
<p>åˆ©ç”¨äº†åŠ å…±äº«é”è¿›å…¥é˜Ÿåˆ—ç­‰å¾…ç‰¹æ€§å®ç° <code>await()</code></p>
<p>é‡Šæ”¾å…±äº«é”å‡å°‘è®¸å¯è¯æ•°é‡ä¸”å”¤é†’é˜Ÿåˆ—ä¸­çš„ç­‰å¾…çš„çº¿ç¨‹ å®ç° <code>countDown()</code></p>
</blockquote>
<h3 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a><code>Semaphore</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ä¸ CountDownLatch ç›¸å, åˆå§‹æ•°é‡ä¸€èˆ¬ä¸º 0, acquire() æ—¶åˆ¤æ–­æ˜¯å¦æœ‰è®¸å¯è¯, æœ‰åˆ™æˆåŠŸ, æ— åˆ™é˜Ÿåˆ—ä¼‘çœ </span><br><span class="line">è€Œ release åˆ™æ˜¯æ·»åŠ ä¸€ä¸ªè®¸å¯è¯, æ·»åŠ åæ€»æ˜¯å”¤é†’é˜Ÿåˆ—.</span><br></pre></td></tr></table></figure>

<h3 id="CycleBarrier"><a href="#CycleBarrier" class="headerlink" title="CycleBarrier"></a><code>CycleBarrier</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å«ä¹‰: å‡‘è¶³ä¸€å®šä¸ªæ•°çº¿ç¨‹, ç„¶åæ‰¹é‡å”¤é†’.</span><br><span class="line">await(): åˆ©ç”¨ ReenrantLock çš„ lock å’Œ condition çš„ await è¿›å…¥ä¼‘çœ </span><br><span class="line">å½“å‡‘è¶³åï¼Œç”¨condition çš„ singleAll å”¤é†’æ‰€æœ‰ await çš„çº¿ç¨‹.</span><br></pre></td></tr></table></figure>





<h3 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a><code>HashMap</code></h3><h4 id="è¯·ç®€è¿°-HashMap-çš„åº•å±‚æ•°æ®ç»“æ„"><a href="#è¯·ç®€è¿°-HashMap-çš„åº•å±‚æ•°æ®ç»“æ„" class="headerlink" title="è¯·ç®€è¿° HashMap çš„åº•å±‚æ•°æ®ç»“æ„"></a>è¯·ç®€è¿° <code>HashMap</code> çš„åº•å±‚æ•°æ®ç»“æ„</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. ä½¿ç”¨äº†æ•°ç»„åŠ é“¾è¡¨, ä»¥æ•°ç»„ä¸ºä¸», é“¾è¡¨åŠ çº¢é»‘æ ‘ä¸ºè¡¥å……çš„æ•°æ®ç»“æ„æ¥å­˜å‚¨é”®å€¼å¯¹.</span><br><span class="line">2. å½“é”®å‘é€å†²çª(ç¢°æ’)æ—¶, æ•°æ®å°†ä¸²æˆé“¾è¡¨å­˜äºæ•°ç»„ä¸­, å½“é“¾è¡¨é•¿åº¦è¶…è¿‡æŒ‡å®šå€¼(é»˜è®¤ 8)æ—¶, é“¾è¡¨è½¬æˆçº¢é»‘æ ‘, å½“çº¢é»‘æ ‘é•¿åº¦å°äºæŒ‡å®šå€¼æ—¶(é»˜è®¤ 6), åˆ™åˆè½¬æˆé“¾è¡¨</span><br></pre></td></tr></table></figure>

<h4 id="ä¸ºä»€ä¹ˆ-HashMap-çš„åˆå§‹å®¹é‡ä»¥åŠæ‰©å®¹åçš„å®¹é‡å‡ä¸º-2-çš„æŒ‡æ•°å¹‚"><a href="#ä¸ºä»€ä¹ˆ-HashMap-çš„åˆå§‹å®¹é‡ä»¥åŠæ‰©å®¹åçš„å®¹é‡å‡ä¸º-2-çš„æŒ‡æ•°å¹‚" class="headerlink" title="ä¸ºä»€ä¹ˆ HashMap çš„åˆå§‹å®¹é‡ä»¥åŠæ‰©å®¹åçš„å®¹é‡å‡ä¸º 2 çš„æŒ‡æ•°å¹‚"></a>ä¸ºä»€ä¹ˆ <code>HashMap</code> çš„åˆå§‹å®¹é‡ä»¥åŠæ‰©å®¹åçš„å®¹é‡å‡ä¸º 2 çš„æŒ‡æ•°å¹‚</h4><blockquote>
<p>å› ä¸ºè®¡ç®—æœºåšè¿ç®—æ—¶, å–æ¨¡è¿ç®—é€Ÿåº¦è¿œè¿œæ…¢äºä½è¿ç®—, è€Œè‹¥å®¹é‡å§‹ç»ˆä¸º 2 çš„æŒ‡æ•°å¹‚, åˆ™æ ¹æ® hash è·å–æ•°ç»„ä¸‹æ ‡æ—¶åªéœ€è¦ ä½¿ç”¨ <code>(æ•°ç»„é•¿åº¦-1) &amp; hash å€¼</code> å³å¯ç¡®å®šæ•°ç»„ä¸‹æ ‡, ä¸å–æ¨¡å¾—åˆ°çš„ä¸‹æ ‡ä¸€æ ·å¯é .</p>
<p>è€Œæ‰©å®¹åå, å› ä¸ºéœ€è¦è¿›è¡Œ rehash è¿ç®—æ¥ç¡®å®š æ•°æ®çš„æ–°ä¸‹æ ‡, å¤šæ¬¡è¿›è¡Œå–æ•°ç»„ä¸‹æ ‡åˆ™æ›´èƒ½ä½“ç°ä½è¿ç®—çš„ä¼˜åŠ¿.</p>
</blockquote>
<h4 id="ä¸ºä»€ä¹ˆ-HashMap-çš„åŠ è½½å› å­æ˜¯-0-75-3-4"><a href="#ä¸ºä»€ä¹ˆ-HashMap-çš„åŠ è½½å› å­æ˜¯-0-75-3-4" class="headerlink" title="ä¸ºä»€ä¹ˆ HashMap çš„åŠ è½½å› å­æ˜¯ 0.75 (3/4)"></a>ä¸ºä»€ä¹ˆ <code>HashMap</code> çš„åŠ è½½å› å­æ˜¯ 0.75 (3/4)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ä½¿ç”¨æ’é™¤æ³•:</span><br><span class="line">1.è‹¥åŠ è½½å› å­ä¸º 1. åˆ™æ¯æ¬¡ HashMap æ»¡äº†æ‰è¿›è¡Œæ‰©å®¹, å¿…å°†æœ‰æ›´é«˜çš„å‡ ç‡è§¦å‘ hash ç¢°æ’å¯¼è‡´æ•°ç»„ä¸‹æ ‡ä¸€è‡´éœ€è¦è½¬æˆé“¾è¡¨æˆ–çº¢é»‘æ ‘, å¯¼è‡´è¯»å–å’Œæ›´æ–°é€Ÿåº¦é™ä½.</span><br><span class="line">2.è‹¥åŠ è½½å› å­ä¸º 0.5. åˆ™æ¯æ¬¡ HashMap éƒ½æœ‰ä¸€åŠå®¹é‡å‰©ä½™, ç©ºé—´å¤§å¤§æµªè´¹, å¯¹å†…å­˜å¼€é”€å¤ªå¤§. å®¹æ˜“å¼•å‘ OOM äº‹æ•….</span><br><span class="line"></span><br><span class="line">å¦å¤–:</span><br><span class="line">0.5-1 ä¹‹é—´é‚£ä¹ˆå¤šå¯èƒ½, é€‰å“ªä¸ªéƒ½è¡Œ, ä½†ä½œä¸º HashMap çš„é»˜è®¤å€¼, é€‰ä¸­é—´çš„ 0.75, èµ°ä¸­åº¸ä¹‹è·¯, ä¹Ÿæ˜¯è§£é‡Šçš„é€šçš„.</span><br></pre></td></tr></table></figure>

<h4 id="ä¸ºä»€ä¹ˆ-HashMap-1-8-æ‰©å®¹æ— éœ€-rehash"><a href="#ä¸ºä»€ä¹ˆ-HashMap-1-8-æ‰©å®¹æ— éœ€-rehash" class="headerlink" title="ä¸ºä»€ä¹ˆ HashMap 1.8 æ‰©å®¹æ— éœ€ rehash"></a>ä¸ºä»€ä¹ˆ <code>HashMap</code> 1.8 æ‰©å®¹æ— éœ€ rehash</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. å› ä¸º1.8çš„è·å– hash å€¼çš„ç®—æ³•ä¼˜åŒ–äº†. æ— éœ€ä¸€ä¸ª hashSeed è¿›è¡Œè¾…åŠ©è¿ç®— (ä¸»å› )</span><br><span class="line">2. ç”±äº hash å€¼ä¸å˜, åŸé“¾è¡¨ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹åªæœ‰ 2 ç§å¯èƒ½:</span><br><span class="line">	ä¸€æ˜¯ hash å€¼é«˜äºåŸæ•°ç»„é•¿åº¦, åˆ™å±äºé«˜ä½, è¿™äº›é«˜ä½çš„èŠ‚ç‚¹, æ–°çš„ä¸‹æ ‡ä¸€å®šæ˜¯ (å½“å‰ä¸‹æ ‡ + æ—§æ•°ç»„é•¿åº¦). </span><br><span class="line">	å¦ä¸€ç§æ˜¯ hash å€¼ä½äºåŸæ•°ç»„é•¿åº¦, å±äºä½ä½, è¿™äº›èŠ‚ç‚¹çš„ä¸‹æ ‡æ— éœ€é‡æ–°è®¡ç®—, å¿…ç„¶ä¸å½“å‰ä¸‹æ ‡ä¸€è‡´</span><br><span class="line">	(ä¸ä¿¡è‡ªå·±é‚£å‡ ä¸ªç¤ºä¾‹æ•°æ®ç”¨ç”»å‡ºå®Œæ•´äºŒè¿›åˆ¶è®¡ç®—ä¸€ä¸‹)(ç¥å¥‡çš„ä½è¿ç®—)</span><br><span class="line">3. é‡æ–°è®¡ç®—ä¸‹æ ‡æ—¶, æ ¹æ®ç¬¬ 2 ç‚¹å¯çŸ¥, å…¶ä¸‹æ ‡å¤§å°ä¸€å®šä¸é«˜äº(å½“å‰ä¸‹æ ‡+æ—§æ•°ç»„é•¿åº¦), å³ä¸‹ä¸€æ¬¡å¾ªç¯çš„ä¸‹æ ‡å¿…ç„¶æ¯”ä¸Šä¸€æ¬¡å¾ªç¯çš„ä¸‹æ ‡è¦é«˜, æ‰€ä»¥ 1.8 æºç  resize è¿›è¡Œé«˜ä½ä½åˆ†ç»„ç„¶åè½¬ç§»æ•°æ®æ—¶, æ— éœ€æ‹…å¿ƒä¸‹ä¸€æ¬¡å¾ªç¯ä¼šå°†åˆšåˆšæ”¾åˆ°æ–°æ•°ç»„çš„å€¼è¦†ç›–(ä¸‹æ ‡ç›¸åŒåˆ™ä¼šè¦†ç›–)</span><br><span class="line">4. 1.8 çš„ resize ä¼˜åŒ–äº†ç®—æ³•, ä¿æŒäº†åŸæœ‰çš„é“¾è¡¨é¡ºåº(ä¸çŸ¥é“æœ‰å•¥ç”¨)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»å¾—æ¥è¯´, 1.8 ä¼˜åŒ–äº† hash ç®—æ³•, ä½¿ <code>hashcode</code> çš„é«˜ 16 ä½ä¸ ä½ 16 ä½è¿›è¡Œå¼‚æˆ–è¿ç®—, é™ä½äº†ç¢°æ’ç‡</p>
<p>è€Œ resize ç®—æ³•ä¹Ÿä¼˜åŒ–é“¾è¡¨èŠ‚ç‚¹çš„è¿ç§», é¿å…äº† 1.7 çš„é“¾ç¯äº§ç”Ÿ</p>
<p>æœ€å¤§çš„åŒºåˆ«å°±æ˜¯, 1.7 æ²¡æœ‰å°†äºŒè¿›åˆ¶çš„ç¥å¥‡å‘æŒ¥åˆ°æè‡´, ä¾ç„¶åƒæ™®é€š java ç¨‹åºä¸€èˆ¬é€»è¾‘. è€Œ 1.8 åˆ™å……åˆ†åˆ©ç”¨äº†äºŒè¿›åˆ¶çš„ä¼˜ç‚¹(ä¹Ÿå……åˆ†çš„è®©äººå¤´æ™•), æé«˜äº† <code>HashMap</code> çš„æ•ˆç‡.</p>
</blockquote>
<h4 id="ä¸ºä»€ä¹ˆ-HashMap-ä»é“¾è¡¨è¾¾åˆ°-8-ä¸ªæ—¶è½¬æˆçº¢é»‘æ ‘-è¾¾åˆ°-6-ä¸ªæ—¶è½¬å›é“¾è¡¨"><a href="#ä¸ºä»€ä¹ˆ-HashMap-ä»é“¾è¡¨è¾¾åˆ°-8-ä¸ªæ—¶è½¬æˆçº¢é»‘æ ‘-è¾¾åˆ°-6-ä¸ªæ—¶è½¬å›é“¾è¡¨" class="headerlink" title="ä¸ºä»€ä¹ˆ HashMap ä»é“¾è¡¨è¾¾åˆ° 8 ä¸ªæ—¶è½¬æˆçº¢é»‘æ ‘, è¾¾åˆ° 6 ä¸ªæ—¶è½¬å›é“¾è¡¨?"></a>ä¸ºä»€ä¹ˆ <code>HashMap</code> ä»é“¾è¡¨è¾¾åˆ° 8 ä¸ªæ—¶è½¬æˆçº¢é»‘æ ‘, è¾¾åˆ° 6 ä¸ªæ—¶è½¬å›é“¾è¡¨?</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.æ ¹æ® Poisson distribution å®šå¾‹, å‡‘é½8ä¸ªèŠ‚ç‚¹ç¢°æ’åˆ°åŒä¸€ä¸ªä¸‹æ ‡, ç»„æˆé•¿åº¦ä¸º 8 çš„é“¾è¡¨æ¦‚ç‡æä½, çº¦ä¸º 0.00000006, è€Œè¶…è¿‡ 8 ä¸ªçš„å‡ ç‡åˆ™æ›´ä½, å¤§çº¦ä¸ºåƒä¸‡åˆ†ä¹‹ä¸€. æ‰€ä»¥å°†é˜ˆå€¼è®¾ç½®ä¸º 8, å› ä¸ºè¿™ç§æ¦‚ç‡æä½. å› æ­¤å¯ä»¥å‡å°‘é“¾è¡¨è½¬çº¢é»‘æ ‘çš„, æé«˜å¢åˆ æ”¹æ•ˆç‡.</span><br><span class="line">2.è‹¥è¾¾åˆ° 7 ä¸ªæ—¶è½¬å›é“¾è¡¨, åˆ™å¯èƒ½ä¼šå¯¼è‡´HashMap ä¸åœçš„åœ¨é“¾è¡¨å’Œçº¢é»‘æ ‘ä¹‹é—´è½¬æ¢, æ‰€ä»¥é˜ˆå€¼è®¾ç½®ä¸º 6, å¯èµ·åˆ°ç¼“å†²æ•ˆæœ.</span><br></pre></td></tr></table></figure>



<h3 id="Spring"><a href="#Spring" class="headerlink" title="Spring"></a>Spring</h3><h4 id="å…³é”®ç±»è§£æ"><a href="#å…³é”®ç±»è§£æ" class="headerlink" title="å…³é”®ç±»è§£æ"></a>å…³é”®ç±»è§£æ</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext</span><br><span class="line">	æ˜¯ä¸€ä¸ªåªè¯»çš„ bean å®¹å™¨</span><br><span class="line">	å¯ä»¥åŠ è½½è§£æé…ç½®æ–‡ä»¶(å¦‚xml)</span><br><span class="line">	å¯ä»¥å‘å¸ƒäº‹ä»¶å’Œæ³¨å†Œç›‘å¬</span><br><span class="line">	å…·æœ‰å›½é™…åŒ–æ¶ˆæ¯å¤„ç†èƒ½åŠ›</span><br><span class="line">ConfigurableApplicationContext</span><br><span class="line">	æ˜¯ä¸€ä¸ªå…·æœ‰å¯é…ç½®èƒ½åŠ›çš„ å®¹å™¨(å¯è®¾ç½®å„ä¸ªå‚æ•°, å¦‚id, çˆ¶å®¹å™¨)</span><br><span class="line">	å…·æœ‰å®¹å™¨ç”Ÿå‘½å‘¨æœŸæ¦‚å¿µ, å¦‚å¯åŠ¨,åœæ­¢,å…³é—­.</span><br><span class="line">AbstractApplicationContext</span><br><span class="line">	æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„æŠ½è±¡ç±», å®šä¹‰äº†å®¹å™¨çš„æ¨¡æ¿(refreshæ–¹æ³•), ä½†ç”±å…·ä½“çš„å­ç±»å®ç°éƒ¨åˆ†æ–¹æ³•</span><br><span class="line">	ç®¡ç†Beanå’ŒBeanFactoryçš„PostProcessor</span><br><span class="line">	ç®¡ç†äº‹ä»¶çš„ç›‘å¬å’Œå¤„ç†</span><br><span class="line">AbstractRefreshableApplicationContext</span><br><span class="line">	ä¸ºå¯é‡å¤åˆ·æ–°çš„å®¹å™¨æä¾›åŸºç±»</span><br><span class="line">	åŠ å…¥äº†BeanFactoryçš„ç®¡ç†(åˆ›å»º&#x2F;å…³é—­ç­‰)</span><br><span class="line">AbstractRefreshableConfigApplicationContext</span><br><span class="line">	åŠ å…¥äº†configLocationå­—æ®µ, ç”¨äºæŸäº›å®¹å™¨åˆå§‹åŒ–BeanFactoryå’ŒBean</span><br><span class="line">AbstractXmlApplicationContext</span><br><span class="line">	å®šä¹‰äº†è¯»å–xmlé…ç½®æ–‡ä»¶æ¥åŠ è½½BeanFactoryçš„ä»£ç , ä½¿å¾—å­ç±»åªéœ€æä¾›é…ç½®æ–‡ä»¶åœ°å€æˆ–Resource</span><br><span class="line">ClassPathXmlApplicationContext</span><br><span class="line">	ç»§æ‰¿åŸºç±», æä¾›é…ç½®æ–‡ä»¶åœ°å€çš„æ„é€ æ–¹æ³•, è°ƒç”¨refreshåŠ è½½BeanFactory</span><br><span class="line">						</span><br><span class="line">BeanFactoryPostProcessor</span><br><span class="line">	ç”¨äºç»™BeanFactoryæ·»åŠ æ’ä»¶å¼åŠŸèƒ½, å¦‚é…ç½®æ–‡ä»¶è§£æ $&#123;&#125; å ä½ç¬¦</span><br><span class="line">	å¦‚ConfigurationClassPostProcessor å°†@Configurationç±»ä¸‹çš„å¸¦@Beançš„methodè¿”å›å€¼æ³¨å†Œåˆ°beanDefinitions ä¸­</span><br><span class="line"></span><br><span class="line">BeanPostProcessor</span><br><span class="line">	ç”¨äºç»™beanæ·»åŠ åŠŸèƒ½, å¦‚ApplicationContextAwareçš„è‡ªåŠ¨æ³¨å…¥å°±æ˜¯å¦‚æ­¤å®ç°çš„</span><br></pre></td></tr></table></figure>

<h4 id="å®¹å™¨åˆå§‹åŒ–æµç¨‹"><a href="#å®¹å™¨åˆå§‹åŒ–æµç¨‹" class="headerlink" title="å®¹å™¨åˆå§‹åŒ–æµç¨‹"></a>å®¹å™¨åˆå§‹åŒ–æµç¨‹</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1) ä»XmlClassPathApplicationContextæ„é€ æ–¹æ³•ä¸­è¿›å…¥ refresh æ–¹æ³•</span><br><span class="line">2) å…ˆè®¾ç½®å®¹å™¨çŠ¶æ€</span><br><span class="line">3) è°ƒç”¨å­ç±»åˆå§‹åŒ– BeanFactory</span><br><span class="line">4) è®¾ç½®BeanFactory ä¸€äº›å±æ€§,æ·»åŠ ä¸€äº›å†…ç½®çš„PostProcessor æ³¨å†Œä¸€äº› environment ç›¸å…³çš„bean</span><br><span class="line">5) å­ç±»è®¾ç½®ä¸€äº›å†…ç½®çš„PostProcessor</span><br><span class="line">6) æ‰«ææ·»åŠ å¹¶æ‰§è¡Œå®¹å™¨å†…çš„ BeanFactoryPostProcessor</span><br><span class="line">7) æ‰«æå®¹å™¨å†…çš„ BeanPostProcessor å¹¶æ³¨å†Œ</span><br><span class="line">8) åˆå§‹åŒ–å›½é™…åŒ–æ¶ˆæ¯å¤„ç†å™¨</span><br><span class="line">9) åˆå§‹åŒ–äº‹ä»¶å¹¿æ’­å¤„ç†å™¨</span><br><span class="line">10) æ‰§è¡Œå­ç±»çš„ refresh é€»è¾‘</span><br><span class="line">11) æ‰«æå®¹å™¨å†…çš„ ApplicationEvent (æŒ‡å®ç°ç±») å¹¶æ³¨å†Œåˆ°äº‹ä»¶å¹¿æ’­å¤„ç†å™¨</span><br><span class="line">12) å®ŒæˆBeanFactoryçš„åˆå§‹åŒ–, å¹¶åŠ è½½ä¸€äº›å•ä¾‹å¯¹è±¡(è®¾ç½®äº†æ€¥äºåŠ è½½çš„bean)</span><br><span class="line">13) åˆå§‹åŒ–LifcycleProcessor, è°ƒç”¨onRefreshæ–¹æ³•, å‘å¸ƒ ContextRefreshedEvent äº‹ä»¶.</span><br><span class="line">14) æ¸…é™¤ä¸€äº›ç¼“å­˜(å¦‚åå°„ç¼“å­˜, æ³¨è§£ç­‰)</span><br></pre></td></tr></table></figure>

<h4 id="æŸäº›å®ç°åŸç†"><a href="#æŸäº›å®ç°åŸç†" class="headerlink" title="æŸäº›å®ç°åŸç†"></a>æŸäº›å®ç°åŸç†</h4><h5 id="å®ç°-ApplicationContextAware-ä¸ºä½•ä¼šè‡ªåŠ¨æ³¨å…¥-applicationContext"><a href="#å®ç°-ApplicationContextAware-ä¸ºä½•ä¼šè‡ªåŠ¨æ³¨å…¥-applicationContext" class="headerlink" title="å®ç° ApplicationContextAware ä¸ºä½•ä¼šè‡ªåŠ¨æ³¨å…¥ applicationContext?"></a>å®ç° <code>ApplicationContextAware</code> ä¸ºä½•ä¼šè‡ªåŠ¨æ³¨å…¥ <code>applicationContext</code>?</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1) é¦–å…ˆ AbstractApplicationContext#prepareBeanFactory ä¼šæ·»åŠ ä¸€ä¸ªApplicationContextAwareProcessor</span><br><span class="line"><span class="number">2</span>) è¿™ä¸ª beanPostProcessor è´Ÿè´£åœ¨beanåˆå§‹åŒ–ä¹‹å‰æ³¨å…¥contextå¯¹è±¡.</span><br><span class="line"><span class="number">3</span>) è¿™ä¸ª beanPostProcessor çš„æ‰§è¡Œæ—¶æœºæ˜¯åœ¨ doCreateBean ä¸­çš„ postProcessBeforeInitialization()</span><br></pre></td></tr></table></figure>

<h5 id="å®ç°-ApplicationListener-ä¸ºä½•ä¼šåœ¨äº‹ä»¶è§¦å‘æ—¶è‡ªåŠ¨æ‰§è¡Œæˆ‘ä»¬å®ç°çš„æ–¹æ³•"><a href="#å®ç°-ApplicationListener-ä¸ºä½•ä¼šåœ¨äº‹ä»¶è§¦å‘æ—¶è‡ªåŠ¨æ‰§è¡Œæˆ‘ä»¬å®ç°çš„æ–¹æ³•" class="headerlink" title="å®ç° ApplicationListener ä¸ºä½•ä¼šåœ¨äº‹ä»¶è§¦å‘æ—¶è‡ªåŠ¨æ‰§è¡Œæˆ‘ä»¬å®ç°çš„æ–¹æ³•?"></a>å®ç° <code>ApplicationListener</code> ä¸ºä½•ä¼šåœ¨äº‹ä»¶è§¦å‘æ—¶è‡ªåŠ¨æ‰§è¡Œæˆ‘ä»¬å®ç°çš„æ–¹æ³•?</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1) åœ¨ AbstractApplicationContext#registerListeners() ä¸­æ‰«æå®¹å™¨å†…æ‰€æœ‰ç›¸å…³å®ç°ç±»åŠ å…¥åˆ°äº‹ä»¶ç›‘å¬è€…é›†åˆä¸­</span><br><span class="line"><span class="number">2</span>) ç„¶ååœ¨publishEventæ—¶ï¼Œéå†äº‹ä»¶ç›‘å¬è€…é›†åˆè°ƒç”¨beançš„æ–¹æ³•å³å¯ã€‚è§‚å¯Ÿè€…æ¨¡å¼ï¼</span><br><span class="line"><span class="number">3</span>) å¦å¤–ä¹Ÿç”¨äº†BeanPostProcessorå»å®ç°, å« ApplicationListenerDetector, åŠ å…¥æ—¶æœºåŒ<span class="number">1</span>, æ‰§è¡Œæ—¶æœºåŒ<span class="number">1</span>.</span><br><span class="line"><span class="number">4</span>) è‡³äºä¸ºä½•ä½¿ç”¨<span class="number">2</span>ç§æœºåˆ¶ï¼Œä¸å¤šä¾‹æœ‰å…³å§ï¼(scope=<span class="string">"prototype"</span>)</span><br></pre></td></tr></table></figure>

<h5 id="å®ç°Orderæ¥å£æˆ–æ³¨è§£æ—¶å¦‚ä½•è‡ªåŠ¨æ’åºçš„"><a href="#å®ç°Orderæ¥å£æˆ–æ³¨è§£æ—¶å¦‚ä½•è‡ªåŠ¨æ’åºçš„" class="headerlink" title="å®ç°Orderæ¥å£æˆ–æ³¨è§£æ—¶å¦‚ä½•è‡ªåŠ¨æ’åºçš„?"></a>å®ç°<code>Order</code>æ¥å£æˆ–æ³¨è§£æ—¶å¦‚ä½•è‡ªåŠ¨æ’åºçš„?</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1) æ¯”å¦‚è¯´ BeanPostProcesser, å®¹å™¨æ‰«æå, ä¼šåƒå¯¹beané›†åˆæ’åº, å†éå†æ‰§è¡Œ.</span><br><span class="line">2) è¯¦ç»†è¿‡ç¨‹è§ PostProcessorRegistrationDelegate<span class="comment">#sortPostProcessors()</span></span><br></pre></td></tr></table></figure>

<h5 id="å•ä¾‹å¯¹è±¡å¦‚ä½•å®ç°å¾ªç¯ä¾èµ–æ³¨å…¥ï¼Ÿ"><a href="#å•ä¾‹å¯¹è±¡å¦‚ä½•å®ç°å¾ªç¯ä¾èµ–æ³¨å…¥ï¼Ÿ" class="headerlink" title="å•ä¾‹å¯¹è±¡å¦‚ä½•å®ç°å¾ªç¯ä¾èµ–æ³¨å…¥ï¼Ÿ"></a>å•ä¾‹å¯¹è±¡å¦‚ä½•å®ç°å¾ªç¯ä¾èµ–æ³¨å…¥ï¼Ÿ</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1) é¦–å…ˆï¼Œ è®¾å®šå¯¹è±¡Aï¼ŒBï¼Œ A æŒæœ‰ B, B æŒæœ‰Aï¼Œ æ„æˆå¾ªç¯</span><br><span class="line">2) æ­¤æ—¶ç¨‹åºè°ƒç”¨getBeanè·å–Aï¼Œåˆ™åœ¨ doCreateBean ä¸­ åˆ›å»ºåå°†beanç¼“å­˜åˆ° singletonFactories ä¸­</span><br><span class="line">3) ç„¶åè®¾ç½®å±æ€§B, è§£æå±æ€§, éœ€è¦è·å–Bå¯¹è±¡</span><br><span class="line">4) è·å–B, åˆ™æ‰§è¡ŒdoCreateBean åæ‰§è¡Œè§£æå±æ€§, éœ€è¦è·å– Aå¯¹è±¡ (åˆä¸€æ¬¡)</span><br><span class="line">5) è·å–A, è¿›å…¥ doGetBean ä¸­çš„ getSingleton, æ­¤æ—¶åˆ¤æ–­singletonFactoriesä¸­æœ‰A, åˆ™å¯ä»¥ç›´æ¥å–å‡ºA</span><br><span class="line">6) è·å¾—Aå, å³å¯å®ŒæˆBçš„å±æ€§èµ‹å€¼, ç„¶åä¼šå®ŒæˆBçš„åˆ›å»º.</span><br><span class="line">7) Båˆ›å»ºå®Œå, Aå°±èƒ½è·å¾—B, åˆ™Aä¹Ÿå®Œæˆäº†å±æ€§èµ‹å€¼, æœ€åå®Œæˆåˆ›å»ºA.</span><br><span class="line">8) åˆ°æ­¤, è¿”å›å³å¯.</span><br><span class="line"></span><br><span class="line">&gt; æ€»ç»“: é¦–æ¬¡è·å–A, åˆ›å»ºAå¯¹è±¡åç¼“å­˜ä¸€ä¸ªå­˜å‚¨Aå¯¹è±¡çš„ ObjectFactory å®ä¾‹, å†è§£æå±æ€§æ—¶è§¦å‘ getBean(B), åŒç†ä¹Ÿä¼šåšç¼“å­˜, ç„¶åä¹Ÿè§£æå±æ€§, è§¦å‘getBean(A), ç¬¬äºŒæ¬¡è·å–A, è¿›å…¥å¦ä¸€ä¸ªé€»è¾‘, è¿”å› ObjectFactory å®ä¾‹ä¸­å­˜å‚¨çš„å¯¹è±¡A, å³å¯å®ŒæˆgetBean(A), ç„¶åå®ŒæˆgetBean(B), å†å®Œæˆå¤–å±‚çš„getBean(A).</span><br></pre></td></tr></table></figure>

<p>TIPS</p>
<blockquote>
<p>è§‚å¯Ÿæºç , å‘ç°æœ‰2ä¸ªç¼“å­˜, ä¸€ä¸ªæ˜¯ <code>singletonFactories</code>, å¦ä¸€ä¸ªæ˜¯ <code>earlySingletonObjects</code>.<br>å…¶ä¸­<code>earlySingletonObjects</code>çš„ç®¡ç†éƒ½åœ¨ <code>getSingleton</code> æ–¹æ³•ä¸­åš, è€Œ <code>singletonFactories</code> åˆ™åœ¨<code>doCreateBean</code>ä¸­åŠ å…¥, åœ¨ <code>getSingleton</code> ä¸­åˆ é™¤(æœ‰<code>earlySingletonObjects</code>åå°±å¯ä»¥åˆ é™¤äº†).<br>è™½ç„¶æœ‰2ä¸ªç¼“å­˜, ä½†å¦‚æœä½ çš„beanæ²¡æœ‰ä½¿ç”¨<code>BeanFactory</code>åˆ›å»º, åˆ™å…¶å®ä¸€ä¸ªç¼“å­˜ä¹Ÿè¶³å¤Ÿäº†<br>(å› ä¸ºè¿™æ ·çš„è¯ <code>singletonFactories</code> æ¯æ¬¡åˆ›å»ºè¿”å›çš„éƒ½æ˜¯åŒä¸€ä¸ª, å› ä¸ºæ­¤æ—¶ <code>singletonFactories</code>å­˜çš„åªæ˜¯ä»£ç åŒ…è£…çš„ä¸€ä¸ªå†…éƒ¨ç±», è€Œéç”¨æˆ·è‡ªå®šä¹‰çš„.)</p>
</blockquote>
<h5 id="InstantiationAwareBeanPostProcessorç­‰ä¸€äº›ç‰¹æ®ŠBeanProcessorçš„æ‰©å±•æ–¹æ³•æ˜¯ä½•æ—¶è‡ªåŠ¨è°ƒç”¨çš„"><a href="#InstantiationAwareBeanPostProcessorç­‰ä¸€äº›ç‰¹æ®ŠBeanProcessorçš„æ‰©å±•æ–¹æ³•æ˜¯ä½•æ—¶è‡ªåŠ¨è°ƒç”¨çš„" class="headerlink" title="InstantiationAwareBeanPostProcessorç­‰ä¸€äº›ç‰¹æ®ŠBeanProcessorçš„æ‰©å±•æ–¹æ³•æ˜¯ä½•æ—¶è‡ªåŠ¨è°ƒç”¨çš„?"></a><code>InstantiationAwareBeanPostProcessor</code>ç­‰ä¸€äº›ç‰¹æ®Š<code>BeanProcessor</code>çš„æ‰©å±•æ–¹æ³•æ˜¯ä½•æ—¶è‡ªåŠ¨è°ƒç”¨çš„?</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>) é¦–å…ˆ getBeanPostProcessorCache è·å–ä¸€äº›ç‰¹æ®Šçš„BeanPostProcessor</span><br><span class="line"><span class="number">2</span>) å¦‚ InstantiationAwareBeanPostProcessor/SmartInstantiationAwareBeanPostProcessor</span><br><span class="line"><span class="number">3</span>) ç„¶å createBeanæ—¶, ä¼šåœ¨æ­£ç¡®çš„æ—¶æœºä½¿ç”¨åˆ°è¿™äº›ç‰¹æ®Šçš„ PostProcessor, å–å‡ºæ¥, ç„¶åæ‰§è¡Œå¯¹åº”æ–¹æ³•</span><br><span class="line"><span class="number">4</span>) å…·ä½“ä½•æ—¶å¯ä»¥æŸ¥çœ‹ getBeanPostProcessorCache() çš„è°ƒç”¨ä½ç½®ä¸€ä¸€æŸ¥çœ‹.</span><br></pre></td></tr></table></figure>

<h4 id="æ³¨è§£çš„å®ç°"><a href="#æ³¨è§£çš„å®ç°" class="headerlink" title="æ³¨è§£çš„å®ç°"></a>æ³¨è§£çš„å®ç°</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>) é¦–å…ˆæ˜¯æŒ‡å®šåŒ…åæˆ–æŒ‡å®šç±»å</span><br><span class="line">	å¦‚æŒ‡å®šåŒ…ååˆ™scanæ—¶ä¼šæ‰§è¡Œ, å¦‚æŒ‡å®šç±»ååˆ™åœ¨æ„é€ æ–¹æ³•åˆå§‹åŒ– reader æ—¶æ‰§è¡Œ</span><br><span class="line">2) æ— è®ºå“ªç§, æœ€ç»ˆéƒ½ä¼šèµ°ä¸€æ®µä»£ç  AnnotationConfigUtils#registerAnnotationConfigProcessors()</span><br><span class="line"><span class="number">3</span>) è¿™æ®µä»£ç ä¼šæ·»åŠ ä¸€äº› BeanFactoryPostProcessor</span><br><span class="line">	å¦‚ ConfigurationClassPostProcessor è´Ÿè´£è§£æ <span class="meta">@Configuration</span>/<span class="meta">@Import</span>/<span class="meta">@Bean</span> æ³¨è§£</span><br><span class="line">    	postProcessBeanDefinitionRegistry() ä¸­ parse æ‰€æœ‰çš„å¸¦ä»¥ä¸Šæ³¨è§£çš„ beanDefinitions</span><br><span class="line">    	ConfigurationClassParser å°†æ³¨è§£ä¿¡æ¯è§£æä¿å­˜ï¼Œ</span><br><span class="line">    	ç„¶åç”± ConfigurationClassBeanDefinitionReader è´Ÿè´£æ³¨å†Œåˆ°å®¹å™¨ã€‚</span><br><span class="line">	å¦‚ AutowiredAnnotationBeanPostProcessor è´Ÿè´£è§£æ <span class="meta">@Autowired</span>/<span class="meta">@Value</span> æ³¨è§£</span><br><span class="line">    å¦‚ CommonAnnotationBeanPostProcessor è´Ÿè´£è§£æ <span class="meta">@Resource</span> æ³¨è§£</span><br><span class="line">    è§£ææ”¾åœ¨ postProcessProperties() æ–¹æ³•ä¸­ï¼Œ å…ˆæ‰«æbeançš„å­—æ®µå’Œæ–¹æ³•ï¼Œ ç„¶åä¸€ä¸€è°ƒç”¨æ–¹æ³•å’Œä¸ºå­—æ®µæ³¨å…¥å€¼</span><br><span class="line"><span class="number">4</span>) ä¹‹å, ä»–ä¼šå°†æ‰«æçš„ç±»æ”¾åˆ° beanDefinitions ä¸­(æˆ–æŒ‡å®šçš„ç±»æ³¨å†Œè¿›å»)</span><br><span class="line"><span class="number">5</span>) BeanFactoryåŠ è½½å®Œæ¯•å, å›åˆ°AbstractApplicationContextçš„refreshé€»è¾‘</span><br><span class="line">	å¦‚ä¼šæ‰§è¡Œ postProcessBeanFactory(), è°ƒç”¨å‰é¢åŠ å…¥çš„ConfigurationClassPostProcessor</span><br><span class="line">	ç„¶åä¼šæ·»åŠ æ›´å¤šçš„ç±»åˆ°å®¹å™¨ä¸­.</span><br><span class="line">    </span><br><span class="line">æ³¨æ„äº‹é¡¹ï¼š</span><br><span class="line">    <span class="meta">@Configuration</span> å’Œ <span class="meta">@Component</span>çš„åŒºåˆ«ï¼Ÿ</span><br><span class="line">    è§‚å¯Ÿå‘ç°ï¼Œå³ä½¿ä½¿ç”¨<span class="meta">@Component</span> å…¶ä¸‹å¸¦ <span class="meta">@Bean</span> çš„æ–¹æ³•ä¾ç„¶å¯ä»¥æ³¨å…¥åˆ°å®¹å™¨ä¸­ã€‚æ‰€ä»¥ä¼¼ä¹ä¸¤è€…æ²¡æœ‰åŒºåˆ«ï¼Ÿ</span><br><span class="line">    ä»”ç»†æŸ¥çœ‹æºç å’Œèµ„æ–™åï¼Œå‘ç° postProcessBeanFactory() æ–¹æ³•åœ¨ processConfigBeanDefinitions() åè¿˜ä¼šè°ƒç”¨ enhanceConfigurationClasses()</span><br><span class="line">    è€Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­, å¯¹å‰é¢è§£æäº†<span class="class"><span class="keyword">class</span> æ˜¯ <span class="title">CONFIGURATION_CLASS_FULL</span> (å³ä»£è¡¨@<span class="title">Configuration</span>)çš„ç±»</span></span><br><span class="line"><span class="class">    ä¼šç”Ÿæˆä¸€ä¸ª <span class="title">cglib</span> çš„ä»£ç†, è¿™æ ·è·å–@<span class="title">Bean</span>æ³¨è§£çš„æ–¹æ³•çš„<span class="title">bean</span>æ—¶,ä¸ä¼šæ¯æ¬¡è°ƒç”¨æ–¹æ³•<span class="title">new</span> ä¸€ä¸ª, è€Œæ˜¯æœ‰ç¼“å­˜.</span></span><br></pre></td></tr></table></figure>

<h4 id="AOP-æµç¨‹"><a href="#AOP-æµç¨‹" class="headerlink" title="AOP æµç¨‹"></a>AOP æµç¨‹</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>) ä½¿ç”¨ <span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="number">2</span>) <span class="meta">@EnableAspectJAutoProxy</span> ä¸­ä½¿ç”¨äº† <span class="meta">@Import</span>(AspectJAutoProxyRegistrar<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">3) <span class="title">ConfigurationClassPostProcessor</span> ä¼šè§£æ@<span class="title">Import</span>, è¿›å…¥ <span class="title">registerBeanDefinitions</span>() ä¸­</span></span><br><span class="line"><span class="class">4) <span class="title">registerBeanDefinitions</span>() ä¸­æ·»åŠ äº† <span class="title">AnnotationAwareAspectJAutoProxyCreator</span> åˆ°å®¹å™¨ä¸­</span></span><br><span class="line"><span class="class">5) <span class="title">AnnotationAwareAspectJAutoProxyCreator</span> æœ¬è´¨ä¸Šæ—¶ä¸€ä¸ª <span class="title">BeanPostProcessor</span></span></span><br><span class="line"><span class="class">6) å› æ­¤åœ¨ <span class="title">createBean</span> æ—¶, ä¼šè¢«è‡ªåŠ¨è°ƒç”¨. å…¶ä¸­ <span class="title">postProcessAfterInitialization</span>() è´Ÿè´£åˆ›å»ºä»£ç†å¯¹è±¡</span></span><br><span class="line"><span class="class">7) è€Œ <span class="title">getAdvicesAndAdvisorsForBean</span>() åˆ™è´Ÿè´£æŸ¥æ‰¾å¯¹åº”çš„å¢å¼º. ç„¶åä¼šè°ƒç”¨å­ç±»çš„<span class="title">findCandidateAdvisors</span></span></span><br><span class="line"><span class="class">8) å¦‚ <span class="title">AnnotationAwareAspectJAutoProxyCreator</span>#<span class="title">findCandidateAdvisors</span>() è´Ÿè´£æ³¨è§£ç¼–å†™å¢å¼º@<span class="title">Before</span>/@<span class="title">After</span>ç­‰</span></span><br><span class="line"><span class="class">9) ç®€å•è¯´ä¸‹é€»è¾‘, å°±æ˜¯æŸ¥æ‰¾å®¹å™¨æ‰€æœ‰ç±», åˆ¤æ–­è¿™ä¸ªç±»æœ‰æ²¡æœ‰ @<span class="title">Aspect</span> æ³¨è§£, ç„¶åå…ˆæ‰¾å‡ºæ‰€æœ‰<span class="title">Pointcut</span></span></span><br><span class="line"><span class="class">	å†éå†æ‰€æœ‰æ–¹æ³•, æ‰¾å‡ºæ–¹æ³•ä¸Šå¸¦æœ‰@<span class="title">Before</span>ç­‰æ³¨è§£ä¸”æœ‰å…³è”çš„<span class="title">Pointcut</span>çš„æ–¹æ³•,</span></span><br><span class="line"><span class="class">    ç„¶åä½¿ç”¨è¿™ä¸ªæ–¹æ³•å’Œå…³è”çš„<span class="title">Pointcut</span> æ¥<span class="title">new</span> ä¸€ä¸ª<span class="title">Advisor</span>, åŠ å…¥åˆ°<span class="title">Advisor</span>é›†åˆä¸­, éå†ç»“æŸåè¿”å›å³å¯.</span></span><br><span class="line"><span class="class">10) æŸ¥æ‰¾åˆ°æ‰€æœ‰çš„å¢å¼ºå, å†æ¯”è¾ƒ<span class="title">Pointcut</span>è¡¨è¾¾å¼æ˜¯å¦åŒ¹é…å½“å‰çš„<span class="title">bean</span>, å¦‚å¯ä»¥åˆ™åŠ å…¥.</span></span><br><span class="line"><span class="class">11) æ ¹æ®æ‰¾åˆ°çš„<span class="title">Advisor</span>é›†åˆ, åˆ›å»ºä¸€ä¸ªå¸¦é…ç½®(<span class="title">advisor</span>é›†åˆç­‰)çš„ä»£ç†å¯¹è±¡, ä»£ç†å¯¹è±¡æ‰§è¡Œæ–¹æ³•å‰</span></span><br><span class="line"><span class="class">12) ä¼šå…ˆæ ¹æ®é…ç½®ä¸­çš„<span class="title">advisor</span>é›†åˆç”Ÿæˆä¸€ä¸ªæ‰§è¡Œé“¾, ç„¶ååœ¨æ‹¦æˆªä»£ç†æ–¹æ³•å¤„è°ƒç”¨. æ‰§è¡Œé“¾ä¼šè´Ÿè´£æ‰§è¡Œé€šçŸ¥.</span></span><br><span class="line"><span class="class">13) ä¸åŒçš„é€šçŸ¥ç”±ä¸åŒçš„é€‚é…å™¨æ‰§è¡Œ.</span></span><br></pre></td></tr></table></figure>

<h4 id="Spring-äº‹åŠ¡å®ç°"><a href="#Spring-äº‹åŠ¡å®ç°" class="headerlink" title="Spring äº‹åŠ¡å®ç°"></a>Spring äº‹åŠ¡å®ç°</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>) äº‹åŠ¡æ˜¯ç”±AOPå®ç°çš„, æ‰€ä»¥éœ€è¦æ‰¾åˆ°å¯¹åº”çš„Pointcut å’Œ Advisor</span><br><span class="line"><span class="number">1</span>) æ‰“å¼€äº† <span class="meta">@EnableTransactionManagement</span> æ³¨è§£</span><br><span class="line"><span class="number">2</span>) ç„¶å<span class="meta">@Import</span> äº† TransactionManagementConfigurationSelector</span><br><span class="line"><span class="number">3</span>) ä¹‹åå¯¼å…¥äº† ProxyTransactionManagementConfiguration åˆ°å®¹å™¨ä¸­</span><br><span class="line"><span class="number">4</span>) ProxyTransactionManagementConfiguration å¸¦æœ‰ <span class="meta">@Configuration</span></span><br><span class="line"><span class="number">5</span>) <span class="meta">@Bean</span> æ³¨å…¥äº†ä¸€ä¸ªé€šç”¨çš„Advisor: BeanFactoryTransactionAttributeSourceAdvisor</span><br><span class="line"><span class="number">6</span>) è¿™ä¸ªAdvisorçš„ Pointcut æ˜¯ç”± TransactionAttributeSourcePointcut å®ç°çš„</span><br><span class="line">	å®ç°é€»è¾‘æ˜¯ TransactionAttributeSourcePointcut çš„ matches()</span><br><span class="line">    è¿™ä¸ªæ–¹æ³•è°ƒç”¨äº† getTransactionAttributeSource() è·å– AnnotationTransactionAttributeSource</span><br><span class="line">    ç„¶åé€šè¿‡ getTransactionAttribute() è°ƒç”¨äº† findTransactionAttribute()</span><br><span class="line">    æœ€ç»ˆä½¿ç”¨SpringTransactionAnnotationParser ç±»åˆ¤æ–­æ–¹æ³•æ˜¯å¦æœ‰<span class="meta">@Transactional</span>æ³¨è§£</span><br><span class="line">    å¹¶è§£ææ³¨è§£ä¿¡æ¯ç„¶åè¿”å›. å¦å¤–è¿™ä¸ªæ–¹æ³•è¿˜å¯ä»¥è·å–<span class="meta">@Transactional</span>æ³¨è§£çš„ä¿¡æ¯, è€Œè¿™é‡Œåªç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦æ‹¦æˆªè¿™ä¸ªæ–¹æ³•.</span><br><span class="line"><span class="number">7</span>) TransactionInterceptor æ˜¯ä¸€ä¸ªAdvisor</span><br><span class="line">    ä¹Ÿå¯ä»¥é€šè¿‡AnnotationTransactionAttributeSourceè·å–<span class="meta">@Transactional</span>æ³¨è§£ä¸Šçš„ä¿¡æ¯</span><br><span class="line">    ç„¶ååœ¨invokeä¸­, æ‹¦æˆªæ–¹æ³•, æ‰“å¼€äº‹åŠ¡, åœ¨æ‰§è¡Œå®Œæ–¹æ³•å, æäº¤äº‹åŠ¡, æŠ¥é”™æ—¶å›æ»šäº‹åŠ¡</span><br><span class="line">    è¿™ä¸ª Advisor ä¸åŒäºä¼ ç»Ÿçš„å‰ç½®/åç½®, è€Œæ˜¯æ›´å…·ä½“çš„ MethodInterceptor.</span><br></pre></td></tr></table></figure>



<h3 id="Spring-Boot-æºç "><a href="#Spring-Boot-æºç " class="headerlink" title="Spring Boot æºç "></a>Spring Boot æºç </h3><h4 id="ç®€åŒ–äº†å¤šå°‘æ“ä½œï¼Ÿ"><a href="#ç®€åŒ–äº†å¤šå°‘æ“ä½œï¼Ÿ" class="headerlink" title="ç®€åŒ–äº†å¤šå°‘æ“ä½œï¼Ÿ"></a>ç®€åŒ–äº†å¤šå°‘æ“ä½œï¼Ÿ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.MultipartAutoConfiguration</span><br><span class="line">	æ·»åŠ äº†ä¸€ä¸ªbean StandardServletMultipartResolver, å¹¶è®¾ç½®ä¸Šä¼ æ–‡ä»¶å¤§å°ç­‰å±æ€§</span><br><span class="line">	ä½¿å¾—Spring MVCä¸­çš„ DispatcherServlet å¯ä»¥è·å– multipartResolver, å¤„ç†æ–‡ä»¶ä¸Šä¼ .</span><br><span class="line">    è‹¥ä¸æ˜¯Spring Boot, éœ€è¦åœ¨xmlæˆ–æ³¨è§£ä¸­æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ª è¿™æ ·çš„beanæ‰èƒ½å¤„ç†æ–‡ä»¶ä¸Šä¼ , è€Œä¸”é…ç½®æ–‡ä»¶è¿˜è¦è‡ªå·±è¯»å–.</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>.MailSenderAutoConfiguration</span><br><span class="line">    æ·»åŠ äº†ä¸€ä¸ª JavaMailSenderImpl çš„beanåˆ°å®¹å™¨ä¸­, å¹¶è®¾ç½®é‚®ç®±æœåŠ¡å™¨/è´¦å·/å¯†ç ç­‰å±æ€§</span><br><span class="line">    è‹¥ä¸æ˜¯Spring Boot, éœ€è¦åœ¨xmlä¸­é…ç½®ä¸€ä¸ªbeanå³é…ç½®ä»–çš„å±æ€§(é‚®ç®±é…ç½®)</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>.TransactionAutoConfiguration</span><br><span class="line">    åœ¨å†…éƒ¨ç±»æ·»åŠ  <span class="meta">@EnableTransactionManagement</span>ï¼Œå‰©ä¸‹çš„å‚è€ƒä¸Šé¢çš„ Spring äº‹åŠ¡å®ç°</span><br><span class="line">    </span><br><span class="line"><span class="number">4</span>.WebMvcAutoConfiguration</span><br><span class="line">    æ·»åŠ äº† RequestMappingHandlerAdapter/RequestMappingHandlerMapping</span><br><span class="line">    æ·»åŠ äº† ContentNegotiatingViewResolver</span><br></pre></td></tr></table></figure>

<h4 id="å¯åŠ¨æµç¨‹"><a href="#å¯åŠ¨æµç¨‹" class="headerlink" title="å¯åŠ¨æµç¨‹"></a>å¯åŠ¨æµç¨‹</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>) åˆ›å»º SpringApplicationRunListeners ç®¡ç† run è¿‡ç¨‹çš„äº‹ä»¶, ç›‘å¬è€…å–è‡ª spring.factories</span><br><span class="line"><span class="number">2</span>) è§¦å‘ run çš„å¼€å§‹(starting)äº‹ä»¶</span><br><span class="line"><span class="number">3</span>) åˆå§‹åŒ– environment å¯¹è±¡, å¹¶åˆ©ç”¨ run çš„ environmentPrepared äº‹ä»¶å°†application.ymlçš„æ•°æ®æ³¨å…¥</span><br><span class="line"><span class="number">4</span>) æ‰“å° Banner, å¯è‡ªå®šä¹‰ Banner é€šè¿‡ banner.txt æ–‡ä»¶</span><br><span class="line"><span class="number">5</span>) æ ¹æ®webApplicationTypeåˆ›å»ºä¸€ä¸ªApplicationContext å®¹å™¨</span><br><span class="line">    é»˜è®¤ä½¿ç”¨ AnnotationConfigApplicationContext</span><br><span class="line"><span class="number">6</span>) ä¸º context åšä¸€äº›åˆå§‹åŒ–å’Œè®¾ç½®</span><br><span class="line">    è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œ ä½¿å¾— context å¯ä»¥è·å– application.yml ä¸­çš„é…ç½®</span><br><span class="line">    è°ƒç”¨å­ç±»æ‰©å±•çš„è®¾ç½®</span><br><span class="line">    åŠ è½½ å®¹å™¨çš„ initializers</span><br><span class="line">    è§¦å‘ run çš„ contextPrepared äº‹ä»¶</span><br><span class="line">    æ‰“å°æ—¥å¿—</span><br><span class="line">    æ·»åŠ spring boot å¯åŠ¨å‚æ•°ä¿¡æ¯åˆ° bean å®¹å™¨ä¸­</span><br><span class="line">    è®¾ç½®beanFactoryçš„ allowBeanDefinitionOverriding å±æ€§</span><br><span class="line">    è®¾ç½® æ‡’åŠ è½½ç­–ç•¥ï¼Œ æ·»åŠ  postProcessor åˆ™ä¼šå°†æ¯ä¸ª beanDefinition çš„ lazyInit è®¾ç½®ä¸º <span class="keyword">true</span></span><br><span class="line">    æŠŠå¯åŠ¨ç±»<span class="class"><span class="keyword">class</span>å°è£…æˆ <span class="title">BeanDefinition</span> æ”¾åˆ°å®¹å™¨ä¸­, ä½¿å¾—@<span class="title">Configuration</span>ä¹‹ç±»çš„æ³¨è§£ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="class">    è§¦å‘ <span class="title">run</span> çš„ <span class="title">contextLoaded</span> äº‹ä»¶</span></span><br><span class="line"><span class="class">7) è°ƒç”¨ <span class="title">context</span> çš„ <span class="title">refresh</span>()</span></span><br><span class="line"><span class="class">    æ‰§è¡Œ <span class="title">BeanFactoryPostProcessor</span>, å¦‚ <span class="title">ConfigurationClassPostProcessor</span> è§£æ @<span class="title">Import</span> æ³¨è§£</span></span><br><span class="line"><span class="class">    @<span class="title">Import</span> ä¼šå®ç° @<span class="title">EnableAutoConfiguration</span>, æ€»ä¹‹éƒ½æ˜¯ç†Ÿæ‚‰çš„ <span class="title">spring</span> å¥—è·¯. <span class="title">boot</span>çš„ä¸œè¥¿å°±å°‘äº†.</span></span><br><span class="line"><span class="class">8) è°ƒç”¨ç•™ç»™å­ç±»çš„ <span class="title">afterRefresh</span>() æ–¹æ³•, é»˜è®¤ç©ºå®ç°</span></span><br><span class="line"><span class="class">9) æ‰“å°å¯åŠ¨å®Œæ¯•ä¿¡æ¯</span></span><br><span class="line"><span class="class">10) è§¦å‘ <span class="title">run</span> çš„ <span class="title">started</span> äº‹ä»¶</span></span><br><span class="line"><span class="class">11) è°ƒç”¨ å®¹å™¨å†…æ‰€æœ‰çš„ <span class="title">ApplicationRunner</span> å’Œ <span class="title">CommandLineRunner</span> å®ç°ç±», ç±»ä¼¼äº‹ä»¶ç›‘å¬.</span></span><br><span class="line"><span class="class">12) ä½¿ç”¨ <span class="title">spring</span>.<span class="title">factories</span> ä¸­çš„ <span class="title">exceptionReporters</span> å¤„ç†å¯èƒ½å‡ºç°çš„å¼‚å¸¸.</span></span><br><span class="line"><span class="class">13) è§¦å‘ <span class="title">run</span> çš„ <span class="title">running</span> äº‹ä»¶</span></span><br></pre></td></tr></table></figure>



<h4 id="ä¸€äº›ä¸œè¥¿çš„å®ç°åŸç†"><a href="#ä¸€äº›ä¸œè¥¿çš„å®ç°åŸç†" class="headerlink" title="ä¸€äº›ä¸œè¥¿çš„å®ç°åŸç†"></a>ä¸€äº›ä¸œè¥¿çš„å®ç°åŸç†</h4><h5 id="ConfigurationProperties-å¦‚ä½•å®ç°è‡ªåŠ¨æ³¨å…¥application-propertiesä¸­é…ç½®çš„å€¼"><a href="#ConfigurationProperties-å¦‚ä½•å®ç°è‡ªåŠ¨æ³¨å…¥application-propertiesä¸­é…ç½®çš„å€¼" class="headerlink" title="@ConfigurationProperties å¦‚ä½•å®ç°è‡ªåŠ¨æ³¨å…¥application.propertiesä¸­é…ç½®çš„å€¼?"></a><code>@ConfigurationProperties</code> å¦‚ä½•å®ç°è‡ªåŠ¨æ³¨å…¥<code>application.properties</code>ä¸­é…ç½®çš„å€¼?</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>) é¦–å…ˆåŠ äº† <span class="meta">@EnableConfigurationProperties</span> ä¹Ÿä¼šè§£æé‡Œé¢çš„ <span class="meta">@Import</span> </span><br><span class="line"><span class="number">2</span>) <span class="meta">@Import</span> åˆ™å¼•å…¥äº† EnableConfigurationPropertiesRegistrar<span class="class">.<span class="keyword">class</span></span></span><br><span class="line"><span class="class">3) è¿™æ˜¯ä¸€ä¸ª <span class="title">ImportBeanDefinitionRegistrar</span> çš„å®ç°ç±», ä¼šåœ¨è§£æ @<span class="title">Configuration</span> æ³¨è§£æ—¶è°ƒç”¨æŒ‡å®šæ–¹æ³•</span></span><br><span class="line"><span class="class">4) æŒ‡å®šæ–¹æ³• <span class="title">registerBeanDefinitions</span>() è·å– @<span class="title">EnableConfigurationPropertiesRegistrar</span> çš„æ•°æ®</span></span><br><span class="line"><span class="class">    å¦‚ @<span class="title">EnableConfigurationProperties</span>(<span class="title">RabbitProperties</span>.<span class="title">class</span>) åŠ è½½ <span class="title">RabbitProperties</span>.<span class="title">class</span></span></span><br><span class="line"><span class="class">    ç„¶å, å°†è¿™äº› <span class="title">class</span> éƒ½æ³¨å†Œåˆ°å®¹å™¨ä¸­</span></span><br><span class="line"><span class="class">5) æŒ‡å®šæ–¹æ³•è¿˜æ³¨å†Œäº†ä¸€äº›å·¥å…·<span class="title">bean</span>å’Œä¸€ä¸ªé‡è¦çš„ <span class="title">BeanPostProcessor</span> åœ¨ <span class="title">registerInfrastructureBeans</span>()ä¸­</span></span><br><span class="line"><span class="class">6) <span class="title">registerInfrastructureBeans</span>() åŠ è½½äº† <span class="title">ConfigurationPropertiesBindingPostProcessor</span>.<span class="title">class</span></span></span><br><span class="line"><span class="class">7) åœ¨ <span class="title">postProcessorBeforeInitialization</span>() ä¸­ è°ƒç”¨ <span class="title">ConfigurationPropertiesBinder</span></span></span><br><span class="line"><span class="class">8) è°ƒç”¨é“¾å¾ˆé•¿, æœ€å <span class="title">property</span>.<span class="title">setValue</span>(<span class="title">beanSupplier</span>, <span class="title">bound</span>)</span>;è®¾ç½®äº†å€¼ -- JavaBeanBinder</span><br><span class="line"></span><br><span class="line">æ€»ç»“: å°±æ˜¯å…ˆå°† XxxProperties ç±»å®šä¹‰æ³¨å…¥åˆ°å®¹å™¨ä¸­, è¿™æ ·å¯ä»¥getBean, ç„¶åé€šè¿‡ BeanPostProcessor</span><br><span class="line">    å†å®ä¾‹åŒ–åå°†å±æ€§å€¼ä¸€ä¸€ç»‘å®š.</span><br></pre></td></tr></table></figure>

<h5 id="ConditionalXxx-çš„å®ç°åŸç†"><a href="#ConditionalXxx-çš„å®ç°åŸç†" class="headerlink" title="@ConditionalXxx çš„å®ç°åŸç†"></a><code>@ConditionalXxx</code> çš„å®ç°åŸç†</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>) åœ¨ç±»ä¸ŠåŠ ä¸Šæ³¨è§£ <span class="meta">@Conditional</span> æˆ– å¸¦æœ‰ <span class="meta">@Conditional</span> çš„å…¶ä»–æ³¨è§£:å…¶ä»–æ‰©å±•å®ç°</span><br><span class="line"><span class="number">2</span>) åœ¨æ‰€æœ‰çš„æ‰«æç±»å’Œæ³¨è§£çš„åœ°æ–¹,å¦‚è§£æ<span class="meta">@Configuration</span>, AnotatedBeanDefinitionReaderç­‰reader</span><br><span class="line">    ä¼šä½¿ç”¨ ConditionEvaluator çš„ shouldSkip() åˆ¤æ–­æ˜¯å¦å¯ä»¥åŠ è½½, æ—¶æœºç‚¹å¦‚ä¸‹</span><br><span class="line">    AnnotatedBeanDefinitionReader#doRegisterBean() çš„ç¬¬äºŒè¡Œä»£ç </span><br><span class="line">    ConfigurationClassBeanDefinitionReader#loadBeanDefinitionsForBeanMethod() ç¬¬å››è¡Œ</span><br><span class="line">    ConfigurationClassBeanDefinitionReader#loadBeanDefinitionsForConfigurationClass()</span><br><span class="line">    ConfigurationClassParser#doProcessConfigurationClass() å¤„ç† ComponentScan é‚£æ®µ</span><br><span class="line"><span class="number">3</span>) ç„¶åå† shouldSkip ä¸­åˆ¤æ–­ï¼Œ åˆ¤æ–­é€»è¾‘å¤§è‡´å¦‚ä¸‹ï¼š</span><br><span class="line">    å…ˆéå†æ‰€æœ‰æ³¨è§£å–å¾—æ‰€æœ‰çš„ <span class="meta">@Conditional</span> ä¸‹çš„ æ‰€æœ‰ value, è¿™ä¸ª value æ˜¯å…·ä½“çš„Conditionå®ç°, å¦‚OnClassCondition</span><br><span class="line">    å®ä¾‹åŒ– Condition ç„¶åæ·»åŠ åˆ° conditionsä¸­</span><br><span class="line">    æ’åºå¹¶éå†è°ƒç”¨ matches(), ä¸€ä¸ªä¸åŒ¹é…åˆ™è¿”å›<span class="keyword">true</span>, ä»£è¡¨åº”è¯¥è·³è¿‡.</span><br><span class="line"></span><br><span class="line">TIPS:</span><br><span class="line">ConditionOutcome å°è£…äº†æ˜¯å¦åŒ¹é…å’ŒåŒ¹é…æ—¥å¿—ä¿¡æ¯[ä¸ºå•¥æˆåŠŸ/ä¸ºå•¥å¤±è´¥]</span><br><span class="line">SpringBootCondition æä¾›äº†é€šç”¨çš„æ ¹æ® ConditionOutcome åˆ¤æ–­æ˜¯å¦åŒ¹é…å¹¶è®°å½•æ—¥å¿—ä¿¡æ¯çš„æŠ½è±¡ç±».</span><br><span class="line">    å­ç±»åªéœ€å®ç° getMatchOutcome(): æ ¹æ® metadata[æ³¨è§£ä¿¡æ¯] è¿”å› ConditionOutcome å¯¹è±¡.</span><br><span class="line">    å› æ­¤, å¦‚æœæˆ‘ä»¬è¦å®ç°è‡ªå·±çš„ Condition, å¯ä»¥ç»§æ‰¿å®ƒ.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¦å‘ç° <code>AutoConfigurationImportSelector</code> ä¹Ÿå«æœ‰åˆ¤æ–­Conditionçš„é€»è¾‘,<br>åˆšå¼€å§‹ä»¥ä¸ºæ˜¯ <code>AutoConfiguration</code> çš„ç±»æ²¡æœ‰èµ°ä¹‹å‰è¯´åˆ°çš„åˆ¤æ–­, æ‰€ä»¥è¿™é‡Œè¦åšåˆ¤æ–­.<br>åæ¥æˆ‘ä¸€æƒ³, è¿™æ˜¯ @Import å¼•å…¥çš„, æ‰€ä»¥, æ˜¯èµ°äº†åˆ¤æ–­çš„. å› æ­¤è¿™é‡Œå¤šå‡ºçš„ä¸€ä¸ª <code>AutoConfigurationImportFilter</code>, åº”è¯¥æ˜¯ä¸€ä¸ªé¢å¤–çš„æ’ä»¶, ä¸“é—¨è¿‡æ»¤é…ç½®åœ¨ <code>spring.factories</code> ä¸­çš„ <code>AutoConfiguration</code> ç±»çš„. è€Œæ’ä»¶çš„è¯»å–, ä¹Ÿæ˜¯è¯»å– <code>spring.factories</code> æ¥éå†. </p>
</blockquote>
<h5 id="AutoConfigureAfter-çš„å®ç°åŸç†"><a href="#AutoConfigureAfter-çš„å®ç°åŸç†" class="headerlink" title="@AutoConfigureAfter  çš„å®ç°åŸç†"></a><code>@AutoConfigureAfter</code>  çš„å®ç°åŸç†</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>) é¦–å…ˆ AutoConfigurationImportSelector æ˜¯ä¸€ä¸ª DeferredImportSelector  </span><br><span class="line"><span class="number">2</span>) è¿™ç§ DeferredImportSelector ä¼šå»¶è¿ŸåŠ è½½, åŸç†æ˜¯ parse åå†åŠ è½½, è€Œéparseæ‰§è¡Œè¿‡ç¨‹ä¸­å°±åŠ è½½.</span><br><span class="line"><span class="number">3</span>) å»¶è¿ŸåŠ è½½æœºåˆ¶ ä¼šå…ˆè°ƒç”¨ process æ–¹æ³•, å°†è¦åŠ è½½çš„<span class="class"><span class="keyword">class</span>ä¿å­˜èµ·æ¥, ç„¶åå†è°ƒç”¨ <span class="title">selectImports</span> è¿”å›.</span></span><br><span class="line"><span class="class">4) æ­¤æ—¶ <span class="title">AutoConfigurationImportSelector</span>.<span class="title">AutoConfigurationGroup</span> çš„ <span class="title">selectImports</span>() ä¼šè°ƒç”¨ <span class="title">sortAutoConfigurations</span>(), ä¹Ÿå°±æ˜¯è°ƒç”¨äº† <span class="title">AutoConfigurationSorter</span>.<span class="title">getInPriorityOrder</span>()</span></span><br><span class="line"><span class="class">5) <span class="title">getInPriorityOrder</span>() è°ƒç”¨äº† <span class="title">sortByAnnotation</span>() è¿™ä¸ªæ–¹æ³•æ ¹æ®2ä¸ªæ³¨è§£ @<span class="title">AutoConfigureBefore</span> @<span class="title">AutoConfigureAfter</span> æ’åº.</span></span><br><span class="line"><span class="class">6) æœ€åè¿”å›çš„å°±æ˜¯æœ‰åºçš„äº†. å¦å¤–, è¿™ä¸¤ä¸ªæ³¨è§£åªèƒ½ä½œç”¨å† <span class="title">AutoConfiguration</span> ä¸Š.</span></span><br><span class="line"><span class="class"></span></span><br><span class="line">æ€»ç»“:</span><br><span class="line">æ‰€æœ‰çš„ AutoConfiguration æ‰€å¼•å…¥çš„<span class="class"><span class="keyword">class</span>æ–‡ä»¶è§£æå®Œæ¯•å, å†å‡†å¤‡åŠ è½½ä¹‹å‰, è¿›è¡Œæ’åº, ç„¶åä¸€ä¸€åŠ è½½.</span></span><br></pre></td></tr></table></figure>



<h5 id="å„ç§-AutoConfiguration-å®ç°å¤§è‡´æµç¨‹"><a href="#å„ç§-AutoConfiguration-å®ç°å¤§è‡´æµç¨‹" class="headerlink" title="å„ç§ AutoConfiguration å®ç°å¤§è‡´æµç¨‹."></a>å„ç§ <code>AutoConfiguration</code> å®ç°å¤§è‡´æµç¨‹.</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1) é¦–å…ˆæ˜¯ @SpringBootApplication å¯ç”¨äº† @EnableAutoConfiguration</span><br><span class="line">2) @EnableAutoConfiguration åˆä½¿ç”¨ @Import å¯¼å…¥äº† AutoConfigurationImportSelector.class</span><br><span class="line">3) ç„¶å AutoConfigurationImportSelector å¯¼å…¥ spring.factoriesæ‰€æœ‰çš„ EnableAutoConfiguration</span><br><span class="line">4) æœ€åï¼Œå½“ä¸€ä¸ªé¡¹ç›®ä¾èµ–ä¸€ä¸ªstarter-xxxï¼Œä¼šç»§æ‰¿starterçš„ä¾èµ–é¡¹, spring-boot-autoconfigure ç”±æ­¤è¢«ä¾èµ–</span><br><span class="line">5) spring-boot-autoconfigure å¸¦æœ‰æ‰€æœ‰ boot å®ç°çš„ AutoConfiguration å’Œ spring.factories é…ç½®</span><br><span class="line">6) æ‰€ä»¥ä¼šåŠ è½½è¯¥é¡¹ç›®ä¸‹ spirng.factories ä¸­å®šä¹‰çš„ EnableAutoConfiguration</span><br><span class="line">7) æ¯ä¸ª AutoConfiguration å®ç°ç±»è¢«å¯¼å…¥åˆ°å®¹å™¨ä¸­å</span><br><span class="line">	åˆè¢« ConfigurationClassPostProcessor è§£æ@Configuration, @Import ç­‰æ³¨è§£ (è€åƒå±‚é¥¼äº†)</span><br><span class="line">	è¿™äº›AutoConfigurationä¼šæ·»åŠ ä¸€äº›æä¾›æœåŠ¡çš„ beanï¼Œæˆ–è€…å†åµŒå¥—ä¸€å±‚@Importï¼Œ@Configurationç­‰ã€‚</span><br><span class="line">	å¦å¤–, è¿™äº›beanè¿˜æ˜¯è¢«è‡ªåŠ¨é…ç½®äº†å±æ€§å€¼çš„, å±æ€§å€¼å“ªé‡Œæ¥? éƒ½åœ¨ application.yml ä¸­, æˆ–æ˜¯é»˜è®¤é…ç½®ä¸­.</span><br><span class="line">9) è¿™æ ·ï¼Œå®¹å™¨ä¸­å°±åŠ å…¥äº†ä¸€ä¸ªæˆ–å¤šä¸ªé…ç½®å¥½çš„beanäº†, å¯ä»¥ç›´æ¥ä½¿ç”¨. å¦‚ stringRedisTemplate, jdbcTemplate</span><br></pre></td></tr></table></figure>

<h5 id="Spring-Boot-æ˜¯å¦‚ä½•è‡ªåŠ¨æ‰«æmainæ–¹æ³•æ‰€åœ¨ç±»æ‰€åœ¨åŒ…çš„"><a href="#Spring-Boot-æ˜¯å¦‚ä½•è‡ªåŠ¨æ‰«æmainæ–¹æ³•æ‰€åœ¨ç±»æ‰€åœ¨åŒ…çš„" class="headerlink" title="Spring Boot æ˜¯å¦‚ä½•è‡ªåŠ¨æ‰«æmainæ–¹æ³•æ‰€åœ¨ç±»æ‰€åœ¨åŒ…çš„?"></a>Spring Boot æ˜¯å¦‚ä½•è‡ªåŠ¨æ‰«æmainæ–¹æ³•æ‰€åœ¨ç±»æ‰€åœ¨åŒ…çš„?</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1) é¦–å…ˆæ˜¯ @SpringBootApplication å¯ç”¨äº† @EnableAutoConfiguration</span><br><span class="line">2) @EnableAutoConfiguration åˆä½¿ç”¨ @AutoConfigurationPackage</span><br><span class="line">3) @AutoConfigurationPackage ä¸­çš„ @Import ä¼šè¢«è§£æ, Registrar.class çš„registerBeanDefinitionsä¼šè¢«æ‰§è¡Œ</span><br><span class="line">4) æœ€ç»ˆæ ¹æ®å¸¦æœ‰ @SpringBootApplication çš„ç±»å¯¹åº”çš„åŒ…å, ç„¶åè‡ªåŠ¨æ‰«æåˆ°å®¹å™¨ä¸­, æ•ˆæœåŒ @ComponentScan</span><br></pre></td></tr></table></figure>

<h5 id="application-properties-æ˜¯å¦‚ä½•è¢«åŠ è½½åˆ°Environmentä¸­çš„"><a href="#application-properties-æ˜¯å¦‚ä½•è¢«åŠ è½½åˆ°Environmentä¸­çš„" class="headerlink" title="application.properties æ˜¯å¦‚ä½•è¢«åŠ è½½åˆ°Environmentä¸­çš„?"></a><code>application.properties</code> æ˜¯å¦‚ä½•è¢«åŠ è½½åˆ°Environmentä¸­çš„?</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>) runæ–¹æ³•ä¸­åˆ›å»ºäº†Environmentå¯¹è±¡, å½“åˆå§‹åŒ–å¥½ä¸€äº›ä¸œè¥¿åä¼šè§¦å‘äº‹ä»¶</span><br><span class="line"><span class="number">2</span>) é€šè¿‡ SpringApplicationRunListeners çš„ environmentPrepared() å‘ŠçŸ¥ç›‘å¬è€…</span><br><span class="line"><span class="number">3</span>) é»˜è®¤å­˜åœ¨ spring.factories ä¸­çš„ EventPublishingRunListener ç›‘å¬è€…è´Ÿè´£è½¬å‘äº‹ä»¶</span><br><span class="line"><span class="number">4</span>) äº‹ä»¶è¢«è½¬å‘åˆ° ApplicationListener ä¸‹çš„ç›‘å¬è€…æ¥å¤„ç†</span><br><span class="line"><span class="number">5</span>) ç›‘å¬è€…é…ç½®åœ¨ spring.factories ä¸­, å…¶ä¸­ ConfigFileApplicationListener ç›‘å¬äº†æ­¤äº‹ä»¶</span><br><span class="line"><span class="number">6</span>) æ­¤ç›‘å¬è€…æ¥å— ApplicationEnvironmentPreparedEvent äº‹ä»¶å</span><br><span class="line"><span class="number">7</span>) åŠ è½½ä¸€äº› postProcessor ä¸“é—¨ç”¨äºå¤„ç† environment å¯¹è±¡çš„ postProcessor</span><br><span class="line"><span class="number">8</span>) å…¶ä»–çš„ postProcessor æš‚æ—¶ä¸ç®¡, çœŸæ­£åšäº†åŠ è½½çš„æ˜¯ postProcessors.add(<span class="keyword">this</span>); è‡ªå·±çš„å®ç°</span><br><span class="line"><span class="number">9</span>) è‡ªå·±çš„å¤„ç†æ–¹æ³•æ˜¯: addPropertySources(), æ­¤æ–¹æ³•å°†ä¼šæ‰«ææŒ‡å®šçš„è·¯å¾„ä¸‹æŒ‡å®šçš„æŸäº›æ–‡ä»¶</span><br><span class="line"><span class="number">10</span>) ç„¶åä½¿ç”¨ spring.factories ä¸‹çš„ PropertySourceLoader ä¸€ä¸€å°è¯•è§£æ</span><br><span class="line"><span class="number">11</span>) æ–‡ä»¶å­˜åœ¨ä¸”è§£ææ­£ç¡®åˆ™åŠ å…¥åˆ° environment çš„ propertySources.</span><br><span class="line">	æŸäº›è·¯å¾„: getSearchLocations() ,é»˜è®¤: classpath:/,classpath:/config/ ...</span><br><span class="line">	æŸäº›æ–‡ä»¶: getSearchNames() ,é»˜è®¤: application</span><br><span class="line"></span><br><span class="line">TIPS: </span><br><span class="line">PropertySourceLoader æœ‰ PropertiesPropertySourceLoader/YamlPropertySourceLoader</span><br><span class="line">ä¸€ä¸ªå°è¯•åç¼€æœ‰ xml/properties, å¦ä¸€ä¸ªæ˜¯ yml/yaml, æ‰€ä»¥æ‰€æœ‰å¯èƒ½æ€§æœ‰:</span><br><span class="line">    classpath:/application.xml; classpath:/application.properties</span><br><span class="line">	classpath:/application.yml; classpath:/application.yaml</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure>

<h5 id="SpringApplication-run-å¦‚ä½•åŠ è½½-tomcat-çš„"><a href="#SpringApplication-run-å¦‚ä½•åŠ è½½-tomcat-çš„" class="headerlink" title="SpringApplication.run() å¦‚ä½•åŠ è½½ tomcat çš„?"></a><code>SpringApplication.run()</code> å¦‚ä½•åŠ è½½ tomcat çš„?</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>) boot çš„ run é‡Œé¢ä¼šåˆ›å»º applicationContext, å¦‚æ˜¯ webApplicationType = SERVLET, åˆ™å®ç°ç±»ä¸º AnnotationConfigServletWebServerApplicationContext</span><br><span class="line">    å¦å¤–ä¸€æ, webApplicationType æ˜¯æ ¹æ® classpath ä¸‹æ˜¯å¦æœ‰å“ªäº›ç±»æ¥æ¨æ–­çš„.</span><br><span class="line"><span class="number">2</span>) è¿™ä¸ªç±»ç»§æ‰¿äº† ServletWebServerApplicationContext</span><br><span class="line"><span class="number">3</span>) ServletWebServerApplicationContext å®ç°äº† onRefresh()</span><br><span class="line"><span class="number">4</span>) onRefresh() è°ƒç”¨äº† createWebServer()</span><br><span class="line"><span class="number">5</span>) createWebServer() ä½¿ç”¨ ServletWebServerFactory.getWebServer() è·å– webServer å¯¹è±¡</span><br><span class="line"><span class="number">6</span>) ServletWebServerFactory ä¼šè¢« ServletWebServerFactoryAutoConfiguration å¼•å…¥</span><br><span class="line">    è¯¦ç»†è§ ServletWebServerFactoryConfiguration.EmbeddedTomcat<span class="class">.<span class="keyword">class</span></span></span><br><span class="line"><span class="class">7) å¼•å…¥åè°ƒç”¨ <span class="title">getWebServer</span>(), å¤§æ¦‚ä¸º <span class="title">new</span> <span class="title">Tomcat</span>(), è®¾ç½®å±æ€§, ç„¶åå¯åŠ¨.</span></span><br><span class="line"><span class="class">8) è‡³æ­¤, <span class="title">run</span>() å¯åŠ¨äº† <span class="title">tomcat</span> æˆ– <span class="title">jetty</span>/<span class="title">undertow</span>.</span></span><br><span class="line"><span class="class"> </span></span><br><span class="line">TIPS:</span><br><span class="line">spring ä½¿ç”¨å·¥å‚æ¨¡å¼è·å–webServer, ç„¶åå·¥å‚åˆé€šè¿‡AutoConfigurationè‡ªåŠ¨æ³¨å…¥(è¿˜ä¼šåˆ¤æ–­Condition).</span><br><span class="line">    è¿™æ ·å¦‚æœæ–°å¢ä¸€ç§ webServer, åªéœ€è¦åœ¨å†™ä¸€ä¸ª AutoConfiguration æ³¨å…¥ä¸€ä¸ª å·¥å‚å³å¯. éå¸¸çµæ´».</span><br></pre></td></tr></table></figure>





<h3 id="Spring-MVC-æºç "><a href="#Spring-MVC-æºç " class="headerlink" title="Spring MVC æºç "></a>Spring MVC æºç </h3><h4 id="å…³é”®ç±»è§£æ-1"><a href="#å…³é”®ç±»è§£æ-1" class="headerlink" title="å…³é”®ç±»è§£æ"></a>å…³é”®ç±»è§£æ</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">WebMvcConfigurationSupport</span><br><span class="line">	é»˜è®¤æ³¨å†Œäº†å¾ˆå¤šä¸œè¥¿,å¦‚HandlerMappingå‡ ä¸ªå®ç°, HandlerAdaptorå‡ ä¸ªå®ç°</span><br><span class="line"></span><br><span class="line">HandlerMapping</span><br><span class="line">	æ·»åŠ å®¹å™¨å†…æ‰€æœ‰å¸¦æœ‰RequestMapingçš„ç±»çš„å…¬å¼€æ–¹æ³•åˆ° mappings ä¸­</span><br><span class="line">		(AbstractHandlerMethodMapping#afterPropertiesSetä¸­)</span><br><span class="line">    æ ¹æ®requestçš„uriæŸ¥æ‰¾å¯¹åº”çš„HandlerMethod, æ­¥éª¤æ¦‚è¿°:</span><br><span class="line">    	æŠŠRequestMappingæ³¨è§£å†…çš„pathä½œä¸ºkeyä¿æŒåˆ°ä¸€ä¸ªmap1</span><br><span class="line">    	å…¶ä»–ä¿¡æ¯å°è£…æˆmappingä½œä¸ºkeyä¹Ÿä¿æŒåˆ°å¦ä¸€ä¸ªmap2</span><br><span class="line">    	æ ¹æ®uriå» map1 è·å– mapping, å†æ ¹æ®mapping è·å– HandlerMethod</span><br><span class="line">    	å°è£…æˆMatchå¯¹è±¡, ä¸å…¶ä»–åŒ¹é…å¯¹è±¡åšæ¯”è¾ƒå, è¿”å› HandlerMethod</span><br><span class="line"></span><br><span class="line">HandlerAdapter</span><br><span class="line">	åˆå§‹åŒ–å‚æ•°è§£æï¼Œè¿”å›å€¼è§£æç­‰</span><br><span class="line">		(RequestMappingHandlerAdapter#afterPropertiesSet)</span><br><span class="line">	æ ¹æ®Handleç¡®å®šå¯¹åº”çš„HandlerAdapter, ç„¶åæ‰§è¡Œè¿™ä¸ª handler</span><br><span class="line">    å¦‚RequestMappingHandlerAdapter åˆ™è´Ÿè´£æ‰§è¡Œ HandlerMethod</span><br><span class="line">    	ç®€å•è¯´å°±æ˜¯å°è£… HandlerMethod, æ ¹æ®å‚æ•°å€¼è®¾ç½®å‚æ•°, ç„¶åè°ƒç”¨æ–¹æ³•, å†å¤„ç†è¿”å›å€¼å°è£…æˆModelAndView</span><br><span class="line">    å¦å¤–ï¼Œ è¿™é‡Œå¦‚æœä½¿ç”¨äº†@ResponseBodyï¼Œä¼šè¿›å…¥ RequestResponseBodyMethodProcessor</span><br><span class="line">    	ç„¶åä½¿ç”¨messageConvertersï¼ˆjsonï¼‰å†™å…¥åˆ°å“åº”æµ</span><br><span class="line">    	æœ€åmvä¹Ÿç›´æ¥è¿”å›nullï¼Œ ä¸éœ€è¦renderäº†ã€‚</span><br><span class="line"></span><br><span class="line">ViewResolver</span><br><span class="line">	è´Ÿè´£å°†ModelAndViewè§£ææˆHTML, å¦‚JSP, FreeMarker</span><br><span class="line"></span><br><span class="line">HandlerExecutionChian</span><br><span class="line">	ç®¡ç†æ‹¦æˆªå™¨å’Œå°è£…Handler, è´Ÿè´£æ‹¦æˆªå™¨çš„å®é™…è°ƒç”¨é€»è¾‘å®ç°</span><br><span class="line">	</span><br><span class="line">DispatcherServlet</span><br><span class="line">	è°ƒåº¦æ•´ä¸ªHTTPè¯·æ±‚å“åº”æµç¨‹, è°ƒç”¨å„ä¸ªå­ç»„ä»¶è´Ÿè´£æ‰§è¡Œå¤„ç†æ–¹æ³•, è§£æè§†å›¾, å¤„ç†å¼‚å¸¸ç­‰.</span><br></pre></td></tr></table></figure>

<h4 id="æ‰§è¡Œæµç¨‹"><a href="#æ‰§è¡Œæµç¨‹" class="headerlink" title="æ‰§è¡Œæµç¨‹"></a>æ‰§è¡Œæµç¨‹</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET</span><br><span class="line">HttpServlet#service()</span><br><span class="line">HttpServlet#doGet()</span><br><span class="line">FrameworkServlet#doGet()</span><br><span class="line">FrameworkServlet#processRequest()</span><br><span class="line">FrameworkServlet#doService()</span><br><span class="line">DispatcherServlet#doService()</span><br><span class="line">DispatcherServlet#doDispatch()</span><br><span class="line">	è°ƒç”¨å®¹å™¨å†…æ‰€æœ‰çš„HandlerMappingçš„å®ç°ç±»çš„getHandleræ–¹æ³•, è¿”å›HandlerExecutionChain</span><br><span class="line">	è°ƒç”¨å®¹å™¨å†…æ‰€æœ‰çš„HandlerAdaptorçš„å®ç°ç±»å¯»æ‰¾é€‚åˆçš„å½“å‰Hanlderçš„HandlerAdaptor</span><br><span class="line">	æ‰§è¡Œæ‹¦æˆªå™¨çš„ preHandle æ–¹æ³•, å¹¶æ ¹æ®è¿”å›ç»“æœåˆ¤æ–­æ˜¯å¦æ¥ç»­æ‰§è¡Œ</span><br><span class="line">	HandlerAdaptoræ‰§è¡Œhandleæ–¹æ³•</span><br><span class="line">	è¿›å…¥RequestMappingHandlerAdaptoræ‰§è¡Œhandle-&gt;handlerInternal-&gt;invokeHandlerMethod</span><br><span class="line">	ç”ŸæˆServletInvocableHandlerMethod(å°±æ˜¯å®ç°äº†åå°„è°ƒç”¨æ–¹æ³•å’Œè®¾ç½®å‚æ•°,å¤„ç†è¿”å›å€¼ç­‰æ“ä½œ)</span><br><span class="line">	è°ƒç”¨invokeAndHandle--&gt;invokeForRequest</span><br><span class="line">		å…¶ä¸­getMethodArgumentValuesæŒ¨ä¸ªè°ƒç”¨HandlerMethodArgumentResolverè·å–å‚æ•°å€¼</span><br><span class="line">	ç„¶åæ‰§è¡Œ doInvoke, åˆ©ç”¨åå°„æŠ€æœ¯è°ƒç”¨ Method, method.invoke(obj, args);</span><br><span class="line">	æ‰§è¡Œå®Œå, è¿”å›ç»“æœ, å›åˆ° invokeAndHandle è°ƒç”¨ returnValueHandlers å¤„ç†è¿”å›ç»“æœ</span><br><span class="line">	è¿”å›å å›åˆ° invokeHandlerMethod, è°ƒç”¨ getModelAndView è·å–é€šç”¨çš„è¿”å›å€¼(å¯èƒ½æ˜¯ç©º)</span><br><span class="line">	è¿”å›ModelAndViewå, å›åˆ°doDispatch, è®¾ç½®é»˜è®¤viewName (mvä¸ºç©ºåˆ™ä¸éœ€è¦è®¾ç½®)</span><br><span class="line">	æ‰§è¡Œæ‹¦æˆªå™¨çš„ postHandle æ–¹æ³•</span><br><span class="line">	processDispatchResult ä¸­çš„ render è§£æè§†å›¾åé€šè¿‡response å“åº”è¿™ä¸ªview</span><br><span class="line">	æ ¹æ®å¼‚å¸¸æƒ…å†µæ‰§è¡Œå¼‚å¸¸å¤„ç†å™¨, ä»¥åŠæ‰§è¡Œæ‹¦æˆªå™¨çš„ afterCompletion æ–¹æ³•</span><br></pre></td></tr></table></figure>

<h4 id="æ‹¦æˆªå™¨åŸç†"><a href="#æ‹¦æˆªå™¨åŸç†" class="headerlink" title="æ‹¦æˆªå™¨åŸç†"></a>æ‹¦æˆªå™¨åŸç†</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ä½•æ—¶åŠ å…¥?</span><br><span class="line">	ä»WebMvcConfigurationSupportçš„å­ç±»ä¸­è°ƒç”¨addInterceptors </span><br><span class="line">	æ·»åŠ ä¸€äº›æ‹¦æˆªå™¨å’Œæ‹¦æˆªå™¨çš„è·¯å¾„é…ç½® InterceptorRegistry å’Œ MappedInterceptor</span><br><span class="line">    å®ç°æ‹¦æˆªå™¨è·¯å¾„åŒ¹é…, åœ¨ new HandlerExecutionChian æ—¶åˆ¤æ–­</span><br><span class="line"></span><br><span class="line">ä½•æ—¶æ‰§è¡Œ?</span><br><span class="line">	DispatcherServlet è´Ÿè´£åœ¨æ­£ç¡®çš„æ—¶æœºè°ƒç”¨ HandlerExecutionChian æ¥è°ƒç”¨ preHanlde ç­‰æ–¹æ³•.</span><br><span class="line">	æ‹¿åˆ° HandlerExecutionChian åè°ƒç”¨ preHanlde</span><br><span class="line">	HandlerAdapteræ‰§è¡Œå®Œhandlerå, è°ƒç”¨ postHandle</span><br><span class="line">	è§£æè§†å›¾å¹¶æ¸²æŸ“åˆ°responseä¹‹å, è°ƒç”¨ afterCompletion</span><br><span class="line">	å¦‚æœä¸­é€”å‡ºç°å¼‚å¸¸, æˆ–preHandleæå‰ç»“æŸ, åˆ™ä¹Ÿè°ƒç”¨afterCompletion</span><br><span class="line"></span><br><span class="line">æ€»ç»“</span><br><span class="line">	DispatcherServlet å»è°ƒç”¨ HandlerExecutionChianå»è°ƒç”¨ æ‹¦æˆªå™¨å…·ä½“æ–¹æ³•. </span><br><span class="line">	å¤æ‚ç‚¹æ˜¯æ·»åŠ ä¸€ä¸ªæ‹¦æˆªå™¨åˆ°è¢«åŠ å…¥åˆ°HandlerExecutionChianæ¯”è¾ƒå¤æ‚ä¸€ç‚¹, ä»¥åŠå¸¦è·¯å¾„åŒ¹é…çš„æ‹¦æˆªå™¨å®ç°ç•¥å¤æ‚ä¸€äº›.</span><br></pre></td></tr></table></figure>



<h3 id="Mybatis-æºç "><a href="#Mybatis-æºç " class="headerlink" title="Mybatis æºç "></a><code>Mybatis</code> æºç </h3><h4 id="å…³é”®ç±»è§£æ-2"><a href="#å…³é”®ç±»è§£æ-2" class="headerlink" title="å…³é”®ç±»è§£æ"></a>å…³é”®ç±»è§£æ</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Configuration</span><br><span class="line">	ä½œç”¨: è§£æå’Œä¿å­˜å¤§é…ç½®(mybatiså…¨å±€é…ç½®,å¦‚æ•°æ®åº“è¿æ¥, åˆ«åç­‰), å°é…ç½®(æ¯ä¸ªmapperæ–‡ä»¶)ä¿¡æ¯</span><br><span class="line"></span><br><span class="line">MapperProxy, MapperMethod</span><br><span class="line">	ä½œç”¨: ç”ŸæˆdaoImplä»£ç†å¯¹è±¡å’Œå®ç°æ¥å£æ–¹æ³•: è°ƒç”¨sqlSession æ“ä½œæ–¹æ³•</span><br><span class="line"></span><br><span class="line">Executor</span><br><span class="line">	ä½œç”¨: åè°ƒå’Œç®¡ç†StatementHandler, ParameterHandler, ResultSetHandler, è§£æmapperStatementé…ç½®ä¿¡æ¯æˆBoundSql.</span><br><span class="line"></span><br><span class="line">StatementHandler</span><br><span class="line">	ä½œç”¨: ç”ŸæˆpreparedStatmentå¯¹è±¡(JDBCçš„), è°ƒç”¨executeæ–¹æ³•.</span><br><span class="line"></span><br><span class="line">ParameterHandler</span><br><span class="line">	ä½œç”¨: ç®¡ç†å¹¶ä½¿ç”¨TypeHandlerä¸ºpreparedStatmentå¯¹è±¡è®¾ç½®å‚æ•°,</span><br><span class="line"></span><br><span class="line">ResultSetHandler</span><br><span class="line">	ä½œç”¨: å°†ResultSetç»“æœé›†è½¬æˆæ¥å£è¿”å›å€¼è®¤è¯†çš„æ•°æ®, è´Ÿè´£å»¶è¿ŸåŠ è½½.</span><br></pre></td></tr></table></figure>

<h4 id="ç”Ÿå‘½å‘¨æœŸä¸æ‰§è¡Œæµç¨‹"><a href="#ç”Ÿå‘½å‘¨æœŸä¸æ‰§è¡Œæµç¨‹" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸä¸æ‰§è¡Œæµç¨‹"></a>ç”Ÿå‘½å‘¨æœŸä¸æ‰§è¡Œæµç¨‹</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1.è¯»å–é…ç½®æ–‡ä»¶, è§£æxml(æˆ–properties)è·å¾—é…ç½®ä¿¡æ¯(æ•°æ®åº“é…ç½®å’ŒmapperSqlç­‰) Configuration</span><br><span class="line">2.è·å–æ•°æ®åº“è¿æ¥, å¼€å¯äº‹åŠ¡, å‡†å¤‡æ‰§è¡Œsql (openSession)</span><br><span class="line">3.ä½¿ç”¨åŠ¨æ€ä»£ç†æŠ€æœ¯ç”Ÿæˆä»£ç†ç±»</span><br><span class="line">4.ä»£ç†ç±»æ ¹æ®ä»£ç†æ–¹æ³•å¯¹åº”çš„mapperStatementç±»å‹è°ƒç”¨sqlSessionçš„insert,update,delete,selectXxxæ–¹æ³• (MapperProxy, MapperMethod)</span><br><span class="line">4.sqlSessionè°ƒç”¨Executoræ‰§è¡Œsql (Exector, SimpleExecutor, CachingExecutor)</span><br><span class="line">5.Executor ç”ŸæˆStatementHandlerå¯¹è±¡å¹¶è§£æxmlä¸­sqlå‚æ•°, å†ä½¿ç”¨ParameterHandlerè®¾ç½®å‚æ•°. (BaseExecutor, StatmentHandler, ParameterHandler, TypeHandler å‰ä¸‰ä¸ªå¯è¢«æ’ä»¶æ‹¦æˆªä»»æ„æ–¹æ³•)</span><br><span class="line">6.æœ€åä½¿ç”¨OGNLè¡¨è¾¾å¼è§£æåº“å¯¹ if,foreach,whereç­‰æ ‡ç­¾è§£æç”Ÿæˆæœ€æ€»sql (ONGL)</span><br><span class="line">7.æ‰§è¡Œsqlåè·å¾—resultSet, ä½¿ç”¨ ResultSetHandler å¤„ç†åè¿”å›ç»“æœ(resultMap, resultTypeçš„å¤„ç†åœ¨è¿™é‡Œ) (ResultSetHandler å¯è¢«æ’ä»¶æ‹¦æˆªä»»æ„æ–¹æ³•)</span><br><span class="line">8.æ ¹æ®äº‹åŠ¡é…ç½®æäº¤äº‹åŠ¡(è‡ªåŠ¨æäº¤), ä¿å­˜ä¸€çº§ç¼“å­˜</span><br><span class="line">9.å¦‚å¼€å¯äºŒçº§ç¼“å­˜, Executorè¿˜ä¼šè¢«è£…é¥°å™¨æ¨¡å¼åŒ…è£…ä¸€å±‚, å°†ç»“æœç¼“å­˜åˆ°MapperStatementçš„cacheå˜é‡ä¸­.</span><br><span class="line"></span><br><span class="line">TIPS:</span><br><span class="line">1.æ’ä»¶çš„ä½¿ç”¨å®åœ¨Executor, StatementHandler, ParameterHandler, ResultSetHandlerè¿™å‡ ä¸ªå¯¹è±¡å®ä¾‹åŒ–çš„æ—¶å€™, ä½¿ç”¨jdkåŠ¨æ€ä»£ç†å°†é…ç½®é‡Œé…ç½®çš„å½¢æˆä»£ç†é“¾. è¿”å›ä»£ç†å¯¹è±¡, ä½†è°ƒç”¨æ–¹æ³•æ—¶, ä¼šåˆ¤æ–­æ˜¯å¦æ‹¦æˆªæ­¤æ–¹æ³•å¹¶æ‰§è¡Œæ’ä»¶çš„ä»£ç .</span><br></pre></td></tr></table></figure>

<h4 id="ä½¿ç”¨åˆ°çš„è®¾è®¡æ¨¡å¼"><a href="#ä½¿ç”¨åˆ°çš„è®¾è®¡æ¨¡å¼" class="headerlink" title="ä½¿ç”¨åˆ°çš„è®¾è®¡æ¨¡å¼"></a>ä½¿ç”¨åˆ°çš„è®¾è®¡æ¨¡å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">1.ä»£ç†æ¨¡å¼</span><br><span class="line">	MapperProxy ç”Ÿæˆ mapper å®ç°ç±» jdkä»£ç†</span><br><span class="line">	Plugin ç”Ÿæˆä»£ç†å¯¹è±¡å®ç°æ’ä»¶ jdkä»£ç†</span><br><span class="line">	ResultSetHandler(LazyLoad) cblib, javassist</span><br><span class="line">2.è£…é¥°è€…æ¨¡å¼</span><br><span class="line">	CachingExecutor: è£…é¥°SimpleExecutoræ·»åŠ äºŒçº§ç¼“å­˜åŠŸèƒ½</span><br><span class="line">	Cache,FifoCache... ä½¿ç”¨è£…é¥°è€…æ¨¡å¼ä¸ºç¼“å­˜æ·»åŠ ä¸åŒç‰¹æ€§(åŠŸèƒ½)</span><br><span class="line">3.é€‚é…å™¨æ¨¡å¼</span><br><span class="line">	StatementHandler</span><br><span class="line">4.è´£ä»»é“¾æ¨¡å¼</span><br><span class="line">	Interceptor(æ‹¦æˆªExecutorã€StatementHandlerã€ParameterHandlerã€ResultSetHandlerå¯¹è±¡)</span><br><span class="line">5.ç­–ç•¥æ¨¡å¼			</span><br><span class="line">	StatementHandler</span><br><span class="line">		PreparedStatementHandler,CallableStatementHandler,SimpleStatementHandler</span><br><span class="line">	Executor</span><br><span class="line">		SimpleExecutor,ReuseExecutor,BatchExecutor</span><br><span class="line">	TypeHandler</span><br><span class="line">		UnknownTypeHandler, IntegerTypeHandler, NStringTypeHandler</span><br><span class="line">6.å»ºé€ å™¨æ¨¡å¼</span><br><span class="line">	org.apache.ibatis.mapping.MappedStatement.Builder</span><br><span class="line">	org.apache.ibatis.builder.xml.XMLConfigBuilder</span><br></pre></td></tr></table></figure>

<h4 id="ä¸€çº§ç¼“å­˜å®ç°"><a href="#ä¸€çº§ç¼“å­˜å®ç°" class="headerlink" title="ä¸€çº§ç¼“å­˜å®ç°"></a>ä¸€çº§ç¼“å­˜å®ç°</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1.putæ—¶æœº: </span><br><span class="line">	org.apache.ibatis.executor.BaseExecutor#queryFromDatabase çš„ localCache.putObject(key, list)</span><br><span class="line">	</span><br><span class="line">2.getæ—¶æœº:</span><br><span class="line">	org.apache.ibatis.executor.BaseExecutor#query çš„ localCache.getObject(key)</span><br><span class="line">	</span><br><span class="line">3.å­˜åœ¨å“ªé‡Œ</span><br><span class="line">	org.apache.ibatis.executor.BaseExecutor#localCache</span><br><span class="line">	è¿™ä¸ªç±»æ¯æ¬¡openSessionä¼šæ–°å»ºä¸€ä¸ªExecutorå®ä¾‹</span><br></pre></td></tr></table></figure>

<h4 id="äºŒçº§ç¼“å­˜å®ç°"><a href="#äºŒçº§ç¼“å­˜å®ç°" class="headerlink" title="äºŒçº§ç¼“å­˜å®ç°"></a>äºŒçº§ç¼“å­˜å®ç°</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1.putæ—¶æœº: </span><br><span class="line">	org.apache.ibatis.executor.CachingExecutor#queryçš„tcm.putObject</span><br><span class="line">	ç„¶åå®é™…ä¸Šæ˜¯è°ƒç”¨äº†cacheçš„put, cacheå®é™…ä¸Šæ¥è‡ªConfigurationè§£æmapperæ–‡ä»¶æ—¶åˆ›å»ºçš„, å³åŒä¸€ä¸ªmapperå…±ç”¨åŒä¸€ä¸ªcache.</span><br><span class="line">	</span><br><span class="line">2.getæ—¶æœº:</span><br><span class="line">	org.apache.ibatis.executor.CachingExecutor#queryçš„tcm.getObject, cacheå®é™…æ˜¯: åŒä¸Š</span><br><span class="line"></span><br><span class="line">3.removeæ—¶æœº:</span><br><span class="line">	org.apache.ibatis.executor.CachingExecutor#flushCacheIfRequired</span><br><span class="line"></span><br><span class="line">æ³¨æ„äº‹é¡¹: ä¸Šè¿°æ—¶æœºéƒ½æ˜¯TransactionCacheManagerçš„è°ƒç”¨, è€ŒTransactionCacheManagerä¼šæ ¹æ®äº‹åŠ¡çš„æäº¤å’Œå›æ»šæ¥å¤„ç†ç¼“å­˜çš„å†™å…¥ä¸ç§»é™¤æ—¶æœº, å¦‚çœŸå®ç§»é™¤æ—¶æœºæ˜¯ä¸‹ä¸€æ¬¡commitè§¦å‘, çœŸå®å†™å…¥ä¹Ÿæ˜¯commitæ—¶è§¦å‘.</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">4.å­˜åœ¨å“ªé‡Œ</span><br><span class="line">	org.apache.ibatis.mapping.MappedStatement</span><br><span class="line">	ä¹Ÿç®—æ˜¯åœ¨ org.apache.ibatis.session.Configuration ä¸­</span><br></pre></td></tr></table></figure>





<h3 id="Mybatis-Plus"><a href="#Mybatis-Plus" class="headerlink" title="Mybatis-Plus"></a><code>Mybatis-Plus</code></h3><h2 id="IO-ç½‘ç»œ"><a href="#IO-ç½‘ç»œ" class="headerlink" title="IO / ç½‘ç»œ"></a>IO / ç½‘ç»œ</h2><h3 id="AIO-NIO-BIO"><a href="#AIO-NIO-BIO" class="headerlink" title="AIO, NIO, BIO"></a>AIO, NIO, BIO</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BIO: ä» jdk1.4 å‰, é‡‡ç”¨ ServerSocket API è¿›è¡Œç½‘ç»œè¿æ¥, æ‰€æœ‰æ“ä½œéƒ½æ˜¯é˜»å¡çš„(å¦‚ç›‘å¬, è¯»&#x2F;å†™)</span><br><span class="line">NIO: ä» jdk1.4 èµ·, å¯¹äºæ‰€æœ‰æ“ä½œéƒ½æ˜¯ä¾èµ–äº‹ä»¶é©±åŠ¨, åªéœ€è¾ƒå°‘çš„çº¿ç¨‹å³å¯å¤„ç†å¤§é‡è¯·æ±‚</span><br><span class="line">AIO: jdk1.7 èµ·, åœ¨ NIO åŸºç¡€ä¸Šå®ç°å¼‚æ­¥, æ‰€æœ‰äº‹ä»¶é€šçŸ¥ç”±ç³»ç»Ÿé€šçŸ¥, è€ŒéNIO é‚£æ ·è½®è¯¢</span><br></pre></td></tr></table></figure>

<h3 id="TCP-UDP"><a href="#TCP-UDP" class="headerlink" title="TCP/UDP"></a>TCP/UDP</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">TCP: æ˜¯é¢å‘è¿æ¥çš„åè®®, æ”¶å‘æ•°æ®å‰, å¿…é¡»å»ºç«‹å¯é çš„è¿æ¥(é€šè¿‡ä¸‰æ¬¡æ¡æ‰‹)</span><br><span class="line">UDP: æ˜¯æ— è¿æ¥çš„åè®®, æ”¶å‘æ•°æ®ä¸éœ€è¦å»ºç«‹è¿æ¥(æ¡æ‰‹)</span><br><span class="line"></span><br><span class="line">åŒºåˆ«:</span><br><span class="line">é€Ÿåº¦: TCP æ»¡, UDP å¿«</span><br><span class="line">æ­£ç¡®æ€§&#x2F;å®Œæ•´æ€§: TCP å¥½, UDP æ— </span><br><span class="line">é¡ºåºæ€§: TCP å¥½, UDP æ— </span><br><span class="line"></span><br><span class="line">åº”ç”¨:</span><br><span class="line">TCP: æ–‡ä»¶ä¸‹è½½, HTTP, DNS, IM é€šè®¯</span><br><span class="line">UDP: ç½‘ç»œæ¸¸æˆ, ç›´æ’­æ¨æµ</span><br></pre></td></tr></table></figure>

<h3 id="Netty"><a href="#Netty" class="headerlink" title="Netty"></a>Netty</h3><blockquote>
<p>å°è£…äº†å¤æ‚çš„NIOæ¥å£, æä¾›äº†ç®€å•çš„ API å®ç°æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯é«˜å¹¶å‘é€šè®¯, å¹¶å°è£…äº†å¾ˆå¤šå·¥å…·, å¦‚å¿ƒè·³è¶…æ—¶, åŠåŒ…å¤„ç†, websocket ç­‰.</p>
</blockquote>
<h2 id="æ•°æ®ç»“æ„ä¸ç®—æ³•"><a href="#æ•°æ®ç»“æ„ä¸ç®—æ³•" class="headerlink" title="æ•°æ®ç»“æ„ä¸ç®—æ³•"></a>æ•°æ®ç»“æ„ä¸ç®—æ³•</h2><h3 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h3><h4 id="é˜Ÿåˆ—-æ ˆ"><a href="#é˜Ÿåˆ—-æ ˆ" class="headerlink" title="é˜Ÿåˆ—,  æ ˆ"></a>é˜Ÿåˆ—,  æ ˆ</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">é˜Ÿåˆ—: å…ˆè¿›å…ˆå‡º FIFO</span><br><span class="line">æ ˆ: LIFO</span><br></pre></td></tr></table></figure>

<h4 id="é“¾è¡¨"><a href="#é“¾è¡¨" class="headerlink" title="é“¾è¡¨"></a>é“¾è¡¨</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å•å‘é“¾è¡¨: Node&#123;next: Node&#125;</span><br><span class="line">åŒå‘é“¾è¡¨: Node&#123;prev: Node, next: Node&#125;</span><br><span class="line">å¾ªç¯é“¾è¡¨: Node&#123;first: Node, last: Node, prev: Node, next: Node&#125;</span><br></pre></td></tr></table></figure>

<h4 id="æ ‘"><a href="#æ ‘" class="headerlink" title="æ ‘"></a>æ ‘</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">äºŒå‰æ ‘:</span><br><span class="line">	å…ˆåºéå†: æ ¹-&gt;å·¦-&gt;å³</span><br><span class="line">	ä¸­åºéå†: å·¦-&gt;æ ¹-&gt;å³</span><br><span class="line">	ååºéå†: å·¦-&gt;å³-&gt;æ ¹</span><br><span class="line"></span><br><span class="line">çº¢é»‘æ ‘:</span><br><span class="line">	çº¢é»‘æ ‘æ˜¯ä¸€ç§å«æœ‰çº¢é»‘ç»“ç‚¹å¹¶èƒ½è‡ªå¹³è¡¡çš„äºŒå‰æŸ¥æ‰¾æ ‘.</span><br><span class="line">	ä»»æ„ä¸€ç»“ç‚¹åˆ°æ¯ä¸ªå¶å­ç»“ç‚¹çš„è·¯å¾„éƒ½åŒ…å«æ•°é‡ç›¸åŒçš„é»‘ç»“ç‚¹.</span><br><span class="line">	é€Ÿåº¦: O(log2 n) æœ€å: O(log n)</span><br><span class="line">	å¯¹æ¯” BST: æŸ¥æ‰¾æ›´å¿«, æ’å…¥æ›´æ…¢.</span><br><span class="line">	å¯¹æ¯” AVL: æŸ¥æ‰¾ç•¥æ…¢, æ’å…¥æ›´å¿«.</span><br><span class="line">	</span><br><span class="line">B+æ ‘:</span><br><span class="line">	æ‰€æœ‰è®°å½•èŠ‚ç‚¹å­˜æ”¾åœ¨å¶å­èŠ‚ç‚¹ä¸Šï¼Œä¸”æ˜¯é¡ºåºå­˜æ”¾ï¼Œç”±å„å¶å­èŠ‚ç‚¹æŒ‡é’ˆè¿›è¡Œè¿æ¥ã€‚</span><br><span class="line">	å¦‚æœä»æœ€å·¦è¾¹çš„å¶å­èŠ‚ç‚¹å¼€å§‹é¡ºåºéå†ï¼Œèƒ½å¾—åˆ°æ‰€æœ‰é”®å€¼çš„é¡ºåºæ’åºã€‚</span><br><span class="line">	æŸ¥æ‰¾é€Ÿåº¦å’Œæ ‘é«˜åº¦æœ‰å…³, å¦‚ MySQL æ ‘é«˜åº¦ä¸º 3, åˆ™æ€»æ˜¯æŸ¥è¯¢ 3 æ¬¡æ‰¾åˆ°å­èŠ‚ç‚¹, å³å¾—åˆ°æ•°æ®.</span><br></pre></td></tr></table></figure>



<h3 id="ç®—æ³•"><a href="#ç®—æ³•" class="headerlink" title="ç®—æ³•"></a>ç®—æ³•</h3><h4 id="æ’åºç®—æ³•"><a href="#æ’åºç®—æ³•" class="headerlink" title="æ’åºç®—æ³•"></a>æ’åºç®—æ³•</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">å¿«é€Ÿæ’åº: O(nlog(n))</span><br><span class="line">	å°†æ•°ç»„åˆ†ä¸º2åŠï¼Œå¹¶è®¡ç®—ä¸€ä¸ªä¸­é—´å€¼ï¼Œå°†å·¦è¾¹æ‰€æœ‰å¤§äºä¸­é—´å€¼çš„ç§»åˆ°å³è¾¹ï¼ŒæŠŠå³è¾¹æ‰€æœ‰å°äºä¸­é—´å€¼çš„ç§»åˆ°å·¦è¾¹ï¼Œ</span><br><span class="line">	ç„¶ååˆ†åˆ«å¯¹å·¦è¾¹å’Œå³è¾¹é€’å½’å¤„ç†ï¼ˆå†åˆ†2åŠï¼Œå†å–ä¸­é—´å€¼ï¼Œå†ç§»åŠ¨ï¼Œå†é€’å½’ï¼‰ï¼Œç›´åˆ°æ— éœ€é€’å½’ä¸ºæ­¢ã€‚</span><br><span class="line"></span><br><span class="line">å½’å¹¶æ’åº: O(nlog(n))</span><br><span class="line">	å°†æ•°ç»„ä¸æ–­ä¸¤ä¸¤æ‹†åˆ†ï¼Œç›´åˆ°æ— æ³•æ‹†åˆ†ï¼ˆåªæœ‰2ä¸ªå…ƒç´ ï¼‰æ—¶å¼€å§‹å¯¹æ‹†åˆ†åçš„å…ƒç´ è¿›è¡Œæ’åºï¼Œç„¶åä¸æ–­å›æº¯ï¼Œ</span><br><span class="line">	ä¸æ–­æ’åºï¼Œç›´åˆ°ç¬¬ä¸€æ¬¡æ‹†åˆ†ï¼Œå³æ‰€æœ‰å…ƒç´ éƒ½æ˜¯æœ‰åºçš„äº†ã€‚æ’åºæ–¹å¼ä¸ºå…ˆå–ä¸¤ä¸ªéƒ¨åˆ†çš„ç¬¬ä¸€ä¸ªä¸‹æ ‡ï¼Œ</span><br><span class="line">	äº’ç›¸åˆ¤æ–­ï¼Œè°å°è°æ”¾åˆ°æœ‰åºæ•°ç»„ä¸­ï¼Œç„¶åå°çš„é‚£ä¸ªä¸‹æ ‡ç§»ä½ï¼Œç»§ç»­åˆ¤æ–­ï¼Œç›´åˆ°å…¶ä¸­ä¸€ä¸ªéƒ¨åˆ†æ‰€æœ‰å…ƒç´ å–å®Œï¼Œ</span><br><span class="line">	åˆ™å°†å¦ä¸€éƒ¨åˆ†å‰©ä½™å…ƒç´ æ‰¹é‡ç›´æ¥æ‹·è´åˆ°æœ‰åºæ•°ç»„å³å¯ã€‚</span><br><span class="line"></span><br><span class="line">å†’æ³¡æ’åº: O(n^2) æœ€å¥½ O(n)</span><br><span class="line">	è¿›è¡Œ n - 1 è½®ï¼Œ æ¯è½®éå†æ•°ç»„ä¸¤ä¸¤æ¯”è¾ƒäº¤æ¢ï¼Œä»è€Œè¾¾åˆ°æŠŠæœ€å¤§çš„äº¤æ¢åˆ°æœ€åé¢ã€‚ä¸‹è½®éå†æ•°ç»„ä¸ªæ•°å‡ä¸€ã€‚</span><br><span class="line"></span><br><span class="line">é€‰æ‹©æ’åº: O(n^2)</span><br><span class="line">	è¿›è¡Œ n - 1 è½®ï¼Œæ¯è½®éå†é€‰æ‹©æ•°ç»„æœ€å°å€¼æ”¾åˆ°æœ€å‰é¢ï¼Œä¸‹è½®éå†æ•°ç»„ä¸ªæ•°å‡ä¸€</span><br><span class="line"></span><br><span class="line">æ’å…¥æ’åº: O(n^2) æœ€å¥½ O(n)</span><br><span class="line">	åˆ†2ä¸ªæ•°ç»„ï¼Œæœ‰åºå’Œæ— åºï¼Œå¼€å±€æœ‰åºé»˜è®¤å«æœ‰æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæ— åºå«æœ‰å‰©ä½™çš„å…ƒç´ ã€‚</span><br><span class="line">	éå†æ— åºæ‰€æœ‰å…ƒç´ ï¼Œä»åå‘å‰æ¯”è¾ƒå¤§å°ï¼Œç„¶åè¿›è¡Œæ’å…¥åˆ°æœ‰åºæ•°ç»„ä¸­æˆ–å¯¹æ•°ç»„å…ƒç´ ç§»ä½ã€‚</span><br><span class="line"></span><br><span class="line">å¸Œå°”æ’åº: O(n^1.25)</span><br><span class="line">	å¯¹æ•°ç»„è¿›è¡Œåˆ†ç»„ï¼Œå¯¹æ¯ç»„ä½¿ç”¨æ’å…¥æ’åºçš„ç§»ä½è¿›è¡Œæ’åºï¼Œç¬¬ä¸€æ¬¡åˆ† æ•°ç»„é•¿åº¦&#x2F;2 ç»„ï¼Œ</span><br><span class="line">	ä¸‹ä¸€æ¬¡åˆ†ç»„ä¸ºæ•°ç»„é•¿åº¦&#x2F;2å†&#x2F;2ç»„ï¼Œè‹¥åˆ† é•¿åº¦&#x2F;2 ç»„ï¼Œåˆ™æ¯ç»„2ä¸ªï¼Œ è‹¥åˆ† é•¿åº¦&#x2F;2&#x2F;2 ç»„ï¼Œ</span><br><span class="line">	åˆ™æ¯ç»„ 2*2 ä¸ªï¼Œç›´åˆ°é•¿åº¦ä¸º1. è¿™æ˜¯ä¸€ä¸ªå°†æ•°ç»„åæ®µæ•°æ®å°½å¯èƒ½ä¸å‰æ®µæ•°æ®æ’åºï¼Œ</span><br><span class="line">	æ”¹è¿›æ’å…¥æ’åºåç«¯æ•°æ®è¿‡å°å¯¼è‡´ç§»ä½æ“ä½œè¿‡å¤šçš„é—®é¢˜ã€‚</span><br><span class="line"></span><br><span class="line">åŸºæ•°æ’åº: O(n)</span><br><span class="line">	åˆ›å»º10ä¸ªæ¡¶ï¼Œæ¯ä¸ªæ¡¶å¤§å°å‡ä¸ºæ•°ç»„é•¿åº¦ï¼Œç„¶åéå†æ•°ç»„ï¼Œä»å…ƒç´ çš„æœ€ä½ä½ï¼ˆä¸ªä½ï¼‰å¼€å§‹ï¼Œ</span><br><span class="line">	å–å‡ºå¹¶æ”¾åˆ°å¯¹åº”çš„æ¡¶ï¼ˆå¦‚ä¸ªä½æ˜¯8ï¼Œåˆ™æ”¾åˆ°ç¬¬8ä¸ªæ¡¶ä¸­ï¼‰ï¼Œæ”¾å®Œåï¼Œé¡ºåºéå†æ‰€æœ‰æ¡¶ï¼Œ</span><br><span class="line">	é¡ºåºå–å‡ºæ¯ä¸ªå…ƒç´ ï¼Œç»„æˆæ–°æ•°ç»„ï¼Œå†å°†æ–°æ•°ç»„æŒ‰ä»¥ä¸Šæµç¨‹å¤„ç†åä½ï¼Œå†ç™¾ä½ï¼Œç›´åˆ°æ•°ç»„ä¸­çš„æœ€å¤§æ•°çš„æœ€é«˜ä½ã€‚</span><br><span class="line">	</span><br><span class="line">å †æ’åºï¼š</span><br><span class="line">	ã€‚ã€‚ã€‚</span><br></pre></td></tr></table></figure>

<h4 id="ä¼˜åŒ–ç®—æ³•"><a href="#ä¼˜åŒ–ç®—æ³•" class="headerlink" title="ä¼˜åŒ–ç®—æ³•"></a>ä¼˜åŒ–ç®—æ³•</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">è´ªå¿ƒç®—æ³•</span><br><span class="line">çˆ¬å±±ç®—æ³•</span><br><span class="line">æ¨¡æ‹Ÿé€€ç«ç®—æ³•</span><br><span class="line">é—ä¼ ç®—æ³•</span><br><span class="line">èšç¾¤æœç´¢ç®—æ³•</span><br></pre></td></tr></table></figure>



<h2 id="è®¾è®¡æ¨¡å¼"><a href="#è®¾è®¡æ¨¡å¼" class="headerlink" title="è®¾è®¡æ¨¡å¼"></a>è®¾è®¡æ¨¡å¼</h2><h3 id="7-å¤§åŸåˆ™"><a href="#7-å¤§åŸåˆ™" class="headerlink" title="7 å¤§åŸåˆ™"></a>7 å¤§åŸåˆ™</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">å•ä¸€èŒè´£: æ¯ä¸ªç±»åªè´Ÿè´£ä¸€ä¸ªèŒè´£(æˆ–æ¯ä¸ªæ–¹æ³•)</span><br><span class="line">æ¥å£éš”ç¦»: ä¸€ä¸ªç±»å¯¹å¦ä¸€ä¸ªç±»çš„ä¾èµ–åº”å»ºç«‹åœ¨æœ€å°çš„æ¥å£ä¸Š</span><br><span class="line">ä¾èµ–å€’è½¬: é«˜å±‚æ¨¡å—ä¸åº”ä¾èµ–ä½å±‚æ¨¡å—, äºŒè€…éƒ½åº”è¯¥ä¾èµ–æ¥å£è€Œéç»†èŠ‚. ç»†èŠ‚ä¾èµ–æŠ½è±¡, é¢å‘æ¥å£ç¼–ç¨‹</span><br><span class="line">é‡Œå¼æ›¿æ¢: å­ç±»åº”è¯¥åšåˆ°å¯ä»¥æ›¿æ¢çˆ¶ç±», åŠå­ç±»åº”å°½é‡ä¸é‡å†™çˆ¶ç±»æ–¹æ³•.</span><br><span class="line">å¼€é—­åŸåˆ™: å¯¹æä¾›è€…è€Œå·²å¯ä»¥ä¿®æ”¹, å¯¹ä½¿ç”¨è€…è€Œè¨€ä¸éœ€è¦ä¿®æ”¹(å³ä»£ç å…¼å®¹æ€§), å°½é‡ä½¿ç”¨æ‰©å±•å¢åŠ åŠŸèƒ½, è€Œéä¿®æ”¹åŸæœ‰ç±»</span><br><span class="line">è¿ªç±³ç‰¹æ³•åˆ™: ä¸€ä¸ªå¯¹è±¡åº”è¯¥å¯¹å…¶ä»–å¯¹è±¡ä¿æŒæœ€å°äº†è§£(æœ€å°‘çŸ¥é“åŸåˆ™)</span><br><span class="line">åˆæˆå¤ç”¨åŸåˆ™: ä¸€ä¸ªç±»ä½¿ç”¨å¦ä¸€ä¸ªç±»çš„ä»£ç (æ–¹æ³•), å°½é‡ä½¿ç”¨åˆæˆ, è€Œä¸æ˜¯ç»§æ‰¿</span><br></pre></td></tr></table></figure>



<h3 id="åˆ›å»ºå‹"><a href="#åˆ›å»ºå‹" class="headerlink" title="åˆ›å»ºå‹"></a>åˆ›å»ºå‹</h3><h4 id="å•ä¾‹æ¨¡å¼"><a href="#å•ä¾‹æ¨¡å¼" class="headerlink" title="å•ä¾‹æ¨¡å¼"></a>å•ä¾‹æ¨¡å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">åŸç†: ç¡®ä¿ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›è¯¥å®ä¾‹çš„å…¨å±€è®¿é—®ç‚¹ã€‚</span><br><span class="line"></span><br><span class="line">é¥¿æ±‰å¼:</span><br><span class="line">	é™æ€å¸¸é‡</span><br><span class="line">	é™æ€ä»£ç å—</span><br><span class="line">æ‡’æ±‰å¼:</span><br><span class="line">	ç›´æ¥åˆ¤æ–­(çº¿ç¨‹ä¸å®‰å…¨)</span><br><span class="line">	æ–¹æ³•åŠ  synchronized(çº¿ç¨‹å®‰å…¨, æ•ˆç‡ä½)</span><br><span class="line">	åˆ¤æ–­åå†åŒæ­¥(é”™è¯¯å†™æ³•)</span><br><span class="line">	åŒé‡åˆ¤æ–­(if-åŒæ­¥-if) (æ¨èå†™æ³•)</span><br><span class="line">	åŒ¿åé™æ€å†…éƒ¨ç±» (ç®€å•, æ¨è)</span><br><span class="line">	æšä¸¾(ç®€å•, ä½†å¯¹è±¡æ–¹æ³•å†™åœ¨æšä¸¾ä¸­, ç•¥æœ‰ä¸é€‚)</span><br><span class="line">	</span><br><span class="line">ç¤ºä¾‹:</span><br><span class="line">	java.lang.Runtime#getRuntime()</span><br><span class="line">	java.awt.Desktop#getDesktop()</span><br></pre></td></tr></table></figure>

<h4 id="åŸå‹æ¨¡å¼"><a href="#åŸå‹æ¨¡å¼" class="headerlink" title="åŸå‹æ¨¡å¼"></a>åŸå‹æ¨¡å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">åŸç†: ä½¿ç”¨åŸå‹å®ä¾‹æŒ‡å®šè¦åˆ›å»ºå¯¹è±¡çš„ç±»å‹ï¼Œé€šè¿‡å¤åˆ¶è¿™ä¸ªåŸå‹æ¥åˆ›å»ºæ–°å¯¹è±¡.</span><br><span class="line">ç¤ºä¾‹: Java çš„ Object å¯¹è±¡çš„ clone æ–¹æ³•, java.util.Arrays.ArrayList#toArray()</span><br><span class="line"></span><br><span class="line">æµ…æ‹·è´: ä»…å¯¹åŸºç¡€ç±»å‹åŠå­—ç¬¦ä¸²ç±»å‹çš„å­—æ®µæ‹·è´å€¼</span><br><span class="line">æ·±æ‹·è´: åŒæ—¶å¯¹å¼•ç”¨ç±»å‹(å¦‚æ•°ç»„,å¯¹è±¡) ä¹Ÿè¿›è¡Œæ‹·è´</span><br><span class="line"></span><br><span class="line">æ·±æ‹·è´å®ç°:</span><br><span class="line">1.é‡å†™ clone, ä¸€ä¸€å¤„ç†æ¯ä¸ªå¼•ç”¨å¯¹è±¡(è°ƒç”¨å¯¹è±¡çš„ clone), éº»çƒ¦, ä¸”è‹¥å¯¹è±¡ä¹‹é—´å…³ç³»å¤æ‚, å…¶ä¸­ä¸€ä¸ªæœªå®ç°æ·±æ‹·è´åˆ™å¯¼è‡´ bug.</span><br><span class="line">2.åˆ©ç”¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–, å¦‚ Json, æˆ– Java è‡ªå¸¦çš„åºåˆ—åŒ–æ–¹å¼(äºŒè¿›åˆ¶)</span><br></pre></td></tr></table></figure>

<h4 id="åˆ›å»ºè€…æ¨¡å¼-ç”Ÿæˆå™¨æ¨¡å¼"><a href="#åˆ›å»ºè€…æ¨¡å¼-ç”Ÿæˆå™¨æ¨¡å¼" class="headerlink" title="åˆ›å»ºè€…æ¨¡å¼(ç”Ÿæˆå™¨æ¨¡å¼)"></a>åˆ›å»ºè€…æ¨¡å¼(ç”Ÿæˆå™¨æ¨¡å¼)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">åŸç†:</span><br><span class="line">	å°è£…ä¸€ä¸ªå¯¹è±¡çš„æ„é€ è¿‡ç¨‹ï¼Œå¹¶å…è®¸æŒ‰æ­¥éª¤æ„é€ .</span><br><span class="line">	è‹¥å¯¹è±¡çš„ç”Ÿæˆè¿‡äºå¤æ‚(å­—æ®µæå¤šä¸”èµ‹å€¼è¿˜æœ‰ä¾èµ–å…³ç³», éœ€è¦é¡ºåºè°ƒç”¨), åˆ™å¯å°†èµ‹å€¼è¿‡ç¨‹å°è£…æˆä¸€ä¸ªbuild(), å¹¶æ”¾åˆ°ä¸€ä¸ª Builder ç±»ä¸­. æ­¤ç±»å¯¹å¤–æä¾›å„ä¸ªå­—æ®µçš„èµ‹å€¼æ–¹æ³•å¹¶å…ˆä¿å­˜èµ·æ¥, ç›´åˆ°è°ƒç”¨ build(), æ­¤æ–¹æ³•è¿”å›å¯¹è±¡å®ä¾‹. </span><br><span class="line">	ä½¿ç”¨æ­¤æ¨¡å¼, è°ƒç”¨è€…æ— éœ€å…³æ³¨æ„å»ºè¿‡ç¨‹, åªéœ€è®¾ç½®è‡ªå·±æƒ³è¦çš„å€¼, ç„¶åè°ƒç”¨ build() å³å¯å¾—åˆ°å¯¹è±¡å®ä¾‹. ä¸”è‹¥å¢åŠ æˆ–ä¿®æ”¹å­—æ®µ, æ„é€ è¿‡ç¨‹å˜åŒ–, è°ƒç”¨è€…æ— æ„ŸçŸ¥, æ— éœ€ä¿®æ”¹ä»£ç . ç¬¦åˆå¼€é—­åŸåˆ™.</span><br><span class="line"></span><br><span class="line">ç¤ºä¾‹: StringBuilder, ä¸€äº›æ¡†æ¶çš„ ConfigurationBuilder(å¦‚ xmpp), ç”¨äºæ„å»ºé…ç½®.</span><br></pre></td></tr></table></figure>

<h4 id="ç®€å•å·¥å‚æ¨¡å¼"><a href="#ç®€å•å·¥å‚æ¨¡å¼" class="headerlink" title="ç®€å•å·¥å‚æ¨¡å¼"></a>ç®€å•å·¥å‚æ¨¡å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">åŸç†:</span><br><span class="line">	åœ¨åˆ›å»ºä¸€ä¸ªå¯¹è±¡æ—¶ä¸å‘å®¢æˆ·æš´éœ²å†…éƒ¨ç»†èŠ‚ï¼Œå¹¶æä¾›ä¸€ä¸ªåˆ›å»ºå¯¹è±¡çš„é€šç”¨æ¥å£ã€‚</span><br><span class="line">	æ­¤æ¨¡å¼å¯é¿å…å¤šä¸ªè°ƒç”¨è€…åˆ›å»ºå¯¹è±¡æ—¶åˆ¤æ–­åˆ›å»ºå“ªä¸ªå­ç±»çš„é‡å¤ä»£ç , ä¸”è‹¥å¤šä¸€ä¸ªå­ç±», è°ƒç”¨è€…æ— éœ€ä¿®æ”¹ä»£ç .</span><br><span class="line">	</span><br><span class="line">ç¤ºä¾‹: Spring ApplicationContext çš„ getBean æ–¹æ³•.</span><br></pre></td></tr></table></figure>

<h4 id="å·¥å‚æ–¹æ³•æ¨¡å¼"><a href="#å·¥å‚æ–¹æ³•æ¨¡å¼" class="headerlink" title="å·¥å‚æ–¹æ³•æ¨¡å¼"></a>å·¥å‚æ–¹æ³•æ¨¡å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">åŸç†:</span><br><span class="line">	å®šä¹‰äº†ä¸€ä¸ªåˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼Œä½†ç”±å­ç±»å†³å®šè¦å®ä¾‹åŒ–å“ªä¸ªç±»ã€‚å·¥å‚æ–¹æ³•æŠŠå®ä¾‹åŒ–æ“ä½œæ¨è¿Ÿåˆ°å­ç±»ã€‚</span><br><span class="line">	æ­¤æ¨¡å¼è§£å†³äº†ç®€å•å·¥å‚æ¯å¢åŠ ä¸€ä¸ªå­ç±»éœ€è¦ä¿®æ”¹å·¥å‚ç±»çš„é—®é¢˜.</span><br><span class="line">	æ­¤æ¨¡å¼å­˜åœ¨é—®é¢˜, è‹¥æ–°å¢ä¸€ä¸ªå­ç±», éœ€åŒæ—¶æ–°å¢ä¸€ä¸ªå­ç±»å·¥å‚, ç³»ç»Ÿå¤æ‚æ€§æ›´é«˜.</span><br><span class="line"></span><br><span class="line">ç¤ºä¾‹: Calendar, NumberFormat</span><br></pre></td></tr></table></figure>

<h4 id="æŠ½è±¡å·¥å‚æ¨¡å¼"><a href="#æŠ½è±¡å·¥å‚æ¨¡å¼" class="headerlink" title="æŠ½è±¡å·¥å‚æ¨¡å¼"></a>æŠ½è±¡å·¥å‚æ¨¡å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">åŸç†:</span><br><span class="line">	æä¾›ä¸€ä¸ªæ¥å£ï¼Œç”¨äºåˆ›å»º ç›¸å…³çš„å¯¹è±¡å®¶æ—.</span><br><span class="line">  åŒä¸Š, ç”±å­ç±»å·¥å‚å†³å®šåˆ›å»ºå“ªäº›å¯¹è±¡.</span><br><span class="line">	æ­¤æ¨¡å¼æ˜¯å·¥å‚æ–¹æ³•çš„å‡çº§ç‰ˆ, ä¸åŒä¹‹å¤„åœ¨äºå®ƒåŒæ—¶åˆ›å»ºå¤šä¸ªç§ç±»çš„å¯¹è±¡(å·¥å‚ç±»å…·æœ‰å¤šä¸ªæ–¹æ³•).</span><br><span class="line">	æ­¤æ¨¡å¼å°†ä¸€ä¸ªå¯¹è±¡å®¶æ—çš„æ–°å»ºé›†åˆåˆ°ä¸€ä¸ªå·¥å‚ç±»åˆ›å»ºç®¡ç†, è¿™äº›å¯¹è±¡å®¶æ—ç›¸äº’ä¹‹é—´ä¸€èˆ¬æœ‰å…³è”, åœ¨åˆ›å»ºæ—¶å°±å¯ä»¥å¤„ç†è¿™äº›å…³è”. ä¸”å¯¹äº 2 ä¸ªå­ç±»å·¥å‚, ä¸€èˆ¬å¯ä»¥æ— ç¼åˆ‡æ¢, ä½¿å¾—ä¿®æ”¹ä»£ç æä¸ºæ–¹ä¾¿(å³æ¢ä¸€ä¸ªå­ç±»å·¥å‚).</span><br><span class="line">	æ­¤æ¨¡å¼åœ¨æ–°å¢ä¸€ä¸ªå¯¹è±¡å®¶æ—çš„æˆå‘˜æ—¶éå¸¸éº»çƒ¦(å³æ‰€æœ‰å·¥å‚ç±»éœ€è¦æ–°å¢ä¸€ä¸ªæ–¹æ³•), ä½†å†æ–°å¢ä¸€ç±»å¯¹è±¡å®¶æ—æ—¶æ¯”è¾ƒç®€å•(å³æ–°å¢ä¸€ä¸ªå­ç±»å·¥å‚).</span><br></pre></td></tr></table></figure>



<h3 id="ç»“æ„å‹"><a href="#ç»“æ„å‹" class="headerlink" title="ç»“æ„å‹"></a>ç»“æ„å‹</h3><h4 id="é€‚é…å™¨æ¨¡å¼"><a href="#é€‚é…å™¨æ¨¡å¼" class="headerlink" title="é€‚é…å™¨æ¨¡å¼"></a>é€‚é…å™¨æ¨¡å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">åŸç†:</span><br><span class="line">	æŠŠä¸€ä¸ªæ¥å£è½¬æ¢æˆå¦ä¸€ä¸ªç”¨æˆ·éœ€è¦çš„æ¥å£.</span><br><span class="line">	å®šä¹‰ä¸€ä¸ªç±», å®ç°ç”¨æˆ·éœ€è¦çš„æ¥å£, å¹¶èšåˆä¸€ä¸ªéœ€è¦è½¬æ¢çš„æ¥å£å¯¹è±¡, åœ¨é‡å†™çš„æ–¹æ³•(ç”¨æˆ·éœ€è¦çš„æ–¹æ³•)ä¸­è°ƒç”¨èšåˆçš„å¯¹è±¡çš„æ–¹æ³•, è‹¥éœ€è¦è¿”å›å€¼, ä¸”è¿”å›å€¼ç±»å‹ä¸ä¸€è‡´, åˆ™è¿˜éœ€è¦åœ¨æ–¹æ³•ä¸­å¤„ç†ä¸€ç•ª, ç„¶åè¿”å›. è¿™ä¸ªè¿‡ç¨‹å«åšé€‚é….è¿™ä¸ªç±»å«åšé€‚é…å™¨ç±».</span><br><span class="line">	ä½¿ç”¨æ­¤æ¨¡å¼å¯å¯¹ä¸€äº›è€æ—§æ¥å£é€‚é…å…¼å®¹.</span><br><span class="line">	</span><br><span class="line">ç¤ºä¾‹: java.util.Arrays#asList() å°†æ•°ç»„é€‚é…æˆ List, Spring MVCçš„ HandlerAdapter</span><br></pre></td></tr></table></figure>

<h4 id="è£…é¥°è€…æ¨¡å¼"><a href="#è£…é¥°è€…æ¨¡å¼" class="headerlink" title="è£…é¥°è€…æ¨¡å¼"></a>è£…é¥°è€…æ¨¡å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">åŸç†:</span><br><span class="line">	å°†ä¸€ä¸ªæˆ–å¤šä¸ªåŠŸèƒ½(æ–¹æ³•)åŠ¨æ€çš„æ–°å¢åˆ°ä¸€ä¸ªç±»ä¸­.</span><br><span class="line">	æŠŠéœ€è¦æ–°å¢åŠŸèƒ½ç±»ç§°ä¸º A,å®šä¹‰ä¸€ä¸ªç±»B,å®ç°Açš„ä¸Šå±‚æ¥å£, å¹¶èšåˆä¸€ä¸ªA çš„å®ä¾‹å¯¹è±¡, Bç±»å®ç°çš„æ¥å£ä¸­, å¯¹å…¶ä»–ä¸å…³å¿ƒçš„æ–¹æ³•ç›´æ¥è°ƒç”¨èšåˆçš„å¯¹è±¡çš„æ–¹æ³•. å¯¹äºå…³å¿ƒçš„æ–¹æ³•åˆ™å¯ä»¥åœ¨è°ƒç”¨å‰åè¿›è¡ŒåŠ æ–™å¤„ç†(å¦‚ä¸€ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªæ•°, å¯ä»¥åœ¨åŸæ¥çš„è¿”å›å€¼ä¸Šä¹˜ä»¥ 2), åŒæ—¶, Bç±»ä¹Ÿå¯ä»¥æ–°å¢ä¸€äº›å…¶ä»–æ–¹æ³•, è¿™äº›æ–¹æ³•å°±æ˜¯å¤šå‡ºçš„åŠŸèƒ½. Bç±»å°±æ˜¯è£…é¥°è€…ç±», Aå°±æ˜¯è¢«è£…é¥°ç±».</span><br><span class="line">	æ­¤æ¨¡å¼çš„ä¼˜ç‚¹æ˜¯, è£…é¥°ç±»ä¹Ÿå¯ä»¥å½“åšè¢«è£…é¥°ç±», ç„¶åå†æ¥ä¸€å±‚è£…é¥°, å¯ä»¥æ— é™çš„è£…é¥°.</span><br><span class="line">	</span><br><span class="line">ç¤ºä¾‹: java IO æµ</span><br></pre></td></tr></table></figure>

<h4 id="ä»£ç†æ¨¡å¼"><a href="#ä»£ç†æ¨¡å¼" class="headerlink" title="ä»£ç†æ¨¡å¼"></a>ä»£ç†æ¨¡å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">åŸç†:</span><br><span class="line">	æ§åˆ¶å…¶ä»–å¯¹è±¡çš„è®¿é—®(æ–¹æ³•çº§), å°†ä¸€äº›å‰ç½®æˆ–åç½®çš„å¤„ç†, é€šè¿‡ä»£ç†å¯¹è±¡æ³¨å…¥åˆ°ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•å‰å. é¢å‘åˆ‡é¢ç¼–ç¨‹.</span><br><span class="line"></span><br><span class="line">ç±»å‹:</span><br><span class="line">	é™æ€ä»£ç†: å®šä¹‰ä¸€ä¸ªä»£ç†ç±»å®ç°ç›®æ ‡å¯¹è±¡çš„ä¸Šå±‚æ¥å£, å¹¶èšåˆä¸€ä¸ªç›®æ ‡å¯¹è±¡, é‡å†™æ–¹æ³•æ—¶å°†å‰ç½®åç½®å¤„ç†åŠ ä¸Š.</span><br><span class="line">	åŠ¨æ€ä»£ç†: </span><br><span class="line">		JDK åŠ¨æ€ä»£ç†: éœ€è¦ç›®æ ‡å¯¹è±¡æœ‰ä¸Šå±‚æ¥å£(è‡ªç„¶æ¥å£å†…çš„æ–¹æ³•æ‰å¯ä»¥ä»£ç†) </span><br><span class="line">			ä½¿ç”¨java.lang.reflect.Proxy#getProxyClass</span><br><span class="line">		CGLIB åŠ¨æ€ä»£ç†: æ˜¯ä¸ªç±»å°±è¡Œ. å®ç°åŸç†æ˜¯ ASM æ¡†æ¶åŠ¨æ€ç”Ÿæˆç›®æ ‡å¯¹è±¡ç±»çš„å­ç±»å­—èŠ‚ç , ç„¶åé€šè¿‡åå°„ç”Ÿæˆä»£ç†å¯¹è±¡.</span><br><span class="line"></span><br><span class="line">ç¤ºä¾‹: Spring AOP</span><br></pre></td></tr></table></figure>

<h4 id="æ¡¥æ¥æ¨¡å¼"><a href="#æ¡¥æ¥æ¨¡å¼" class="headerlink" title="æ¡¥æ¥æ¨¡å¼"></a>æ¡¥æ¥æ¨¡å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">åŸç†:</span><br><span class="line">	å°†æŠ½è±¡ä¸å®ç°åˆ†ç¦»å¼€æ¥ï¼Œä½¿å®ƒä»¬å¯ä»¥ç‹¬ç«‹å˜åŒ–ã€‚</span><br><span class="line">	æ¡¥æ¥çš„å«ä¹‰æ˜¯, ä¸€ä¸ªæ¡¥, æ”¾åœ¨å“ªé‡Œéƒ½æœ‰æ¡¥çš„ 2 è¾¹, æ¡¥çš„ 2 è¾¹å¯ä»¥å˜åŒ–, ä½†æ¡¥å§‹ç»ˆä¸å˜. æ­¤å¤„, æ¡¥ä»£è¡¨ä¸€ä¸ªæ“ä½œ(å¦‚æ‰‹æœºä¸Šè¿è¡Œè½¯ä»¶), 2 è¾¹ä»£è¡¨ ä¸€ä¸ªæ“ä½œçš„ 2 ä¸ªç»´åº¦(å¦‚æ‰‹æœºå’Œè½¯ä»¶). åŒæ—¶, æ¡¥æ¥åçš„æ“ä½œä¹Ÿå¯ä»¥è§†ä¸ºä¸€ä¸ªç»´åº¦, ä¸å¦ä¸€ä¸ªç»´åº¦æ¡¥æ¥(å¦‚æ‰‹æœºä¸Šè¿è¡Œè½¯ä»¶å’Œäººè¿™ 2 ä¸ªç»´åº¦, å¯ä»¥è¿›è¡Œæ¡¥æ¥, ç»„æˆ 3 ç»´åº¦åµŒå¥—æ¡¥æ¥).</span><br><span class="line">	</span><br><span class="line">ç¤ºä¾‹: JDBC è·å–è¿æ¥, è·å–è¿æ¥æ˜¯ä¸€ä¸ªç»´åº¦, æ•°æ®åº“æ˜¯ä¸€ä¸ªç»´åº¦, æ•°æ®åº“æœ‰å¤šä¸ª, æ‰€ä»¥è¿™æ˜¯ä¸€ä¸ªæ•°æ®åº“ç»´åº¦å˜åŒ–, å¦ä¸€ç»´åº¦ä¸å˜çš„æ¡¥æ¥æ¨¡å¼.</span><br></pre></td></tr></table></figure>

<h4 id="äº«å…ƒæ¨¡å¼"><a href="#äº«å…ƒæ¨¡å¼" class="headerlink" title="äº«å…ƒæ¨¡å¼"></a>äº«å…ƒæ¨¡å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">åŸç†:</span><br><span class="line">	åˆ©ç”¨å…±äº«çš„æ–¹å¼æ¥æ”¯æŒå¤§é‡ç»†ç²’åº¦çš„å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡ä¸€éƒ¨åˆ†å†…éƒ¨çŠ¶æ€æ˜¯ç›¸åŒçš„ã€‚</span><br><span class="line">	å¦‚å¸¸è§çš„ çº¿ç¨‹æ± , å¸¸é‡æ± ç­‰, ä½¿å¾—å¯¹è±¡çš„è·å–é€Ÿåº¦åŠ å¿«.</span><br><span class="line">	</span><br><span class="line">ç¤ºä¾‹: java.lang.Integer#valueOf() java.lang.Boolean#valueOf()</span><br></pre></td></tr></table></figure>

<h4 id="ç»„åˆæ¨¡å¼"><a href="#ç»„åˆæ¨¡å¼" class="headerlink" title="ç»„åˆæ¨¡å¼"></a>ç»„åˆæ¨¡å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">åŸç†:</span><br><span class="line">	å°†å¯¹è±¡ç»„åˆæˆæ ‘å½¢ç»“æ„æ¥è¡¨ç¤ºâ€œæ•´ä½“&#x2F;éƒ¨åˆ†â€å±‚æ¬¡å…³ç³»ï¼Œå…è®¸ç”¨æˆ·ä»¥ç›¸åŒçš„æ–¹å¼å¤„ç†å•ç‹¬å¯¹è±¡å’Œç»„åˆå¯¹è±¡ã€‚</span><br><span class="line">	ä¸€èˆ¬éœ€è¦éƒ¨åˆ†å’Œæ•´ä½“å…·æœ‰ä¸€å®šçš„ç›¸ä¼¼åº¦, æ‰èƒ½å¯¹å…¶è¿›è¡ŒæŠ½è±¡.</span><br><span class="line">	å¯¹éƒ¨åˆ†&#x2F;æ•´ä½“è¿›è¡ŒæŠ½è±¡, å¾—å‡ºä¸€ä¸ªå…¬å…±æŠ½è±¡ç±»æˆ–æ¥å£, å†å®ç°ç±»ä¸­æ ¹æ®å…·ä½“è§’è‰²åšä¸åŒå¤„ç†. </span><br><span class="line"></span><br><span class="line">ç¤ºä¾‹:</span><br><span class="line">	javax.swing.JComponent#add(Component) </span><br><span class="line">  java.util.Map#putAll(Map)</span><br><span class="line">  java.util.List#addAll(Collection)</span><br><span class="line">  java.util.Set#addAll(Collection)</span><br></pre></td></tr></table></figure>

<h4 id="å¤–è§‚æ¨¡å¼"><a href="#å¤–è§‚æ¨¡å¼" class="headerlink" title="å¤–è§‚æ¨¡å¼"></a>å¤–è§‚æ¨¡å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">åŸç†:</span><br><span class="line">	æä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£ï¼Œç”¨æ¥è®¿é—®å­ç³»ç»Ÿä¸­çš„ä¸€ç¾¤æ¥å£ï¼Œä»è€Œè®©å­ç³»ç»Ÿæ›´å®¹æ˜“ä½¿ç”¨.</span><br></pre></td></tr></table></figure>



<h3 id="è¡Œä¸ºå‹"><a href="#è¡Œä¸ºå‹" class="headerlink" title="è¡Œä¸ºå‹"></a>è¡Œä¸ºå‹</h3><h4 id="èŒè´£é“¾-è´£ä»»é“¾-æ¨¡å¼"><a href="#èŒè´£é“¾-è´£ä»»é“¾-æ¨¡å¼" class="headerlink" title="èŒè´£é“¾(è´£ä»»é“¾)æ¨¡å¼"></a>èŒè´£é“¾(è´£ä»»é“¾)æ¨¡å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">åŸç†:</span><br><span class="line">	ä½¿å¤šä¸ªå¯¹è±¡éƒ½æœ‰æœºä¼šå¤„ç†è¯·æ±‚ï¼Œå°†è¿™äº›å¯¹è±¡è¿æˆä¸€æ¡é“¾ï¼Œå¹¶æ²¿ç€è¿™æ¡é“¾å‘é€è¯¥è¯·æ±‚ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªå¯¹è±¡å¤„ç†å®ƒä¸ºæ­¢, ä»è€Œé¿å…è¯·æ±‚çš„å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´çš„è€¦åˆå…³ç³»ã€‚</span><br><span class="line">	</span><br><span class="line">ç¤ºä¾‹:</span><br><span class="line">	javax.servlet.Filter#doFilter()</span><br><span class="line">	netty çš„ Handler Chain</span><br></pre></td></tr></table></figure>

<h4 id="è§‚å¯Ÿè€…æ¨¡å¼"><a href="#è§‚å¯Ÿè€…æ¨¡å¼" class="headerlink" title="è§‚å¯Ÿè€…æ¨¡å¼"></a>è§‚å¯Ÿè€…æ¨¡å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">åŸç†:</span><br><span class="line">	å®šä¹‰å¯¹è±¡ä¹‹é—´çš„ä¸€å¯¹å¤šä¾èµ–ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çŠ¶æ€æ”¹å˜æ—¶ï¼Œå®ƒçš„æ‰€æœ‰ä¾èµ–éƒ½ä¼šæ”¶åˆ°é€šçŸ¥å¹¶ä¸”è‡ªåŠ¨æ›´æ–°çŠ¶æ€ã€‚</span><br><span class="line">	ä¸»é¢˜ï¼ˆSubjectï¼‰æ˜¯è¢«è§‚å¯Ÿçš„å¯¹è±¡ï¼Œè€Œå…¶æ‰€æœ‰ä¾èµ–è€…ï¼ˆObserverï¼‰ç§°ä¸ºè§‚å¯Ÿè€…ã€‚</span><br><span class="line"></span><br><span class="line">ç¤ºä¾‹: </span><br><span class="line">	swing çš„äº‹ä»¶ç›‘å¬(æŒ‰é’®äº‹ä»¶, é¼ æ ‡äº‹ä»¶)</span><br><span class="line">	JS çš„ äº‹ä»¶ç›‘å¬</span><br></pre></td></tr></table></figure>

<h4 id="çŠ¶æ€æ¨¡å¼"><a href="#çŠ¶æ€æ¨¡å¼" class="headerlink" title="çŠ¶æ€æ¨¡å¼"></a>çŠ¶æ€æ¨¡å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">åŸç†:</span><br><span class="line">	å…è®¸å¯¹è±¡åœ¨å†…éƒ¨çŠ¶æ€æ”¹å˜æ—¶æ”¹å˜å®ƒçš„è¡Œä¸ºï¼Œå¯¹è±¡çœ‹èµ·æ¥å¥½åƒä¿®æ”¹äº†å®ƒæ‰€å±çš„ç±»ã€‚</span><br><span class="line">	çŠ¶æ€æ¨¡å¼ä¸»è¦æ˜¯ç”¨æ¥è§£å†³çŠ¶æ€è½¬ç§»çš„é—®é¢˜ï¼Œå½“çŠ¶æ€å‘ç”Ÿè½¬ç§»äº†ï¼Œé‚£ä¹ˆ Context å¯¹è±¡å°±ä¼šæ”¹å˜å®ƒçš„è¡Œä¸º.</span><br></pre></td></tr></table></figure>

<h4 id="ç­–ç•¥æ¨¡å¼"><a href="#ç­–ç•¥æ¨¡å¼" class="headerlink" title="ç­–ç•¥æ¨¡å¼"></a>ç­–ç•¥æ¨¡å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">åŸç†:</span><br><span class="line">	å®šä¹‰ä¸€ç³»åˆ—ç®—æ³•ï¼Œå°è£…æ¯ä¸ªç®—æ³•ï¼Œå¹¶ä½¿å®ƒä»¬å¯ä»¥äº’æ¢ã€‚</span><br><span class="line">	ç­–ç•¥æ¨¡å¼å¯ä»¥è®©ç®—æ³•ç‹¬ç«‹äºä½¿ç”¨å®ƒçš„å®¢æˆ·ç«¯ã€‚</span><br><span class="line">	ç­–ç•¥æ¨¡å¼ä¸»è¦æ˜¯ç”¨æ¥å°è£…ä¸€ç»„å¯ä»¥äº’ç›¸æ›¿ä»£çš„ç®—æ³•æ—ï¼Œå¹¶ä¸”å¯ä»¥æ ¹æ®éœ€è¦åŠ¨æ€åœ°å»æ›¿æ¢ Context ä½¿ç”¨çš„ç®—æ³•.</span><br><span class="line"></span><br><span class="line">ç¤ºä¾‹: java.util.Comparator#compare() javax.servlet.http.HttpServlet</span><br></pre></td></tr></table></figure>

<h4 id="æ¨¡æ¿æ–¹æ³•æ¨¡å¼"><a href="#æ¨¡æ¿æ–¹æ³•æ¨¡å¼" class="headerlink" title="æ¨¡æ¿æ–¹æ³•æ¨¡å¼"></a>æ¨¡æ¿æ–¹æ³•æ¨¡å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">åŸç†:</span><br><span class="line">	å®šä¹‰ç®—æ³•æ¡†æ¶ï¼Œå¹¶å°†ä¸€äº›æ­¥éª¤çš„å®ç°å»¶è¿Ÿåˆ°å­ç±»ã€‚</span><br><span class="line">	é€šè¿‡æ¨¡æ¿æ–¹æ³•ï¼Œå­ç±»å¯ä»¥é‡æ–°å®šä¹‰ç®—æ³•çš„æŸäº›æ­¥éª¤ï¼Œè€Œä¸ç”¨æ”¹å˜ç®—æ³•çš„ç»“æ„ã€‚</span><br><span class="line"></span><br><span class="line">ç¤ºä¾‹: java.util.Collections#sort()</span><br></pre></td></tr></table></figure>

<h4 id="å‘½ä»¤æ¨¡å¼"><a href="#å‘½ä»¤æ¨¡å¼" class="headerlink" title="å‘½ä»¤æ¨¡å¼"></a>å‘½ä»¤æ¨¡å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">åŸç†:</span><br><span class="line">	å°†ä¸€ä¸ªå¯¹è±¡(å‘½ä»¤æ¥æ”¶è€…)çš„æ¯ä¸ªæ“ä½œæ‹†åˆ†åˆ°æ¯ä¸€ä¸ªå‘½ä»¤ç±»ä¸­, å†ä½¿ç”¨ä¸€ä¸ªå‘½ä»¤ç®¡ç†ç±»æ¥ç®¡ç†è¿™äº›å‘½ä»¤. ä½¿å¾—å‘½ä»¤å¯ä»¥æ”¾å…¥é˜Ÿåˆ—ä¸­æœ‰åºæ‰§è¡Œ, ä¸”å¯ä»¥ç»Ÿä¸€è®°å½•å‘½ä»¤çš„æ“ä½œæ—¥å¿—, è¿˜å¯ä»¥æ”¯æŒæ’¤é”€æ“ä½œ(æ¯ä¸ªå‘½ä»¤éƒ½å®ç°å¯¹åº”çš„æ’¤é”€å³å¯).</span><br><span class="line">	æ­¤æ¨¡å¼çš„å¥½å¤„æ˜¯, è‹¥å°†å‘½ä»¤æŠ½è±¡ä¸ºå‡ ä¸ªæ ‡å‡†çš„å‘½ä»¤(å¦‚å¼€,å…³), ç„¶åç®¡ç†å¤šä¸ªå‘½ä»¤æ¥æ”¶è€…(å¦‚ç¯,ç”µè§†æœº,ç©ºè°ƒ)çš„æ“ä½œ, å¯ä½¿æ–°å¢å‘½ä»¤æ¥æ”¶è€…å˜å¾—ç®€å•, å³æ‰©å±•æ€§å¥½.</span><br><span class="line">	</span><br><span class="line">	åˆç§°ä¸‡èƒ½é¥æ§å™¨.</span><br></pre></td></tr></table></figure>

<h4 id="ä¸­ä»‹æ¨¡å¼"><a href="#ä¸­ä»‹æ¨¡å¼" class="headerlink" title="ä¸­ä»‹æ¨¡å¼"></a>ä¸­ä»‹æ¨¡å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">åŸç†:</span><br><span class="line">	é›†ä¸­ç›¸å…³å¯¹è±¡ä¹‹é—´å¤æ‚çš„æ²Ÿé€šå’Œæ§åˆ¶æ–¹å¼ã€‚é™ä½å­ç³»ç»Ÿä¹‹é—´çš„è€¦åˆ.</span><br><span class="line">	ç±»ä¼¼ä¸€ä¸ªæ¶ˆæ¯æ”¶å‘ä¸­å¿ƒ, è´Ÿè´£å­—ç³»ç»Ÿçš„æ¶ˆæ¯ä¸­è½¬, ä½¿å¾—å­ç³»ç»Ÿä¹‹é—´å¯ä»¥è¿›è¡Œä¸€å®šçš„äº¤äº’.</span><br><span class="line">	</span><br><span class="line">ç¤ºä¾‹: çº¿ç¨‹æ± ç®¡ç†è€…çº¿ç¨‹å’Œè¦æ‰§è¡Œçš„ä»»åŠ¡.</span><br></pre></td></tr></table></figure>

<h4 id="å¤‡å¿˜å½•æ¨¡å¼"><a href="#å¤‡å¿˜å½•æ¨¡å¼" class="headerlink" title="å¤‡å¿˜å½•æ¨¡å¼"></a>å¤‡å¿˜å½•æ¨¡å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">åŸç†:</span><br><span class="line">	åœ¨ä¸è¿åå°è£…çš„æƒ…å†µä¸‹è·å¾—å¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ï¼Œä»è€Œåœ¨éœ€è¦æ—¶å¯ä»¥å°†å¯¹è±¡æ¢å¤åˆ°æœ€åˆçŠ¶æ€ã€‚</span><br><span class="line">	å¦‚å¯¹æ¸¸æˆçš„å½“å‰çŠ¶æ€è¿›è¡Œä¸€ä¸ªä¿å­˜, ç„¶ååœ¨åç»­æ¸¸æˆä¸­æ­»äº¡åå¯ä»¥è¯»å–è¿™ä¸ªçŠ¶æ€é‡æ–°å¼€å§‹.</span><br></pre></td></tr></table></figure>

<h4 id="è®¿é—®è€…æ¨¡å¼"><a href="#è®¿é—®è€…æ¨¡å¼" class="headerlink" title="è®¿é—®è€…æ¨¡å¼"></a>è®¿é—®è€…æ¨¡å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">åŸç†: </span><br><span class="line">	ä¸ºä¸€ä¸ªå¯¹è±¡ç»“æ„ï¼ˆæ¯”å¦‚ç»„åˆç»“æ„ï¼‰å¢åŠ æ–°èƒ½åŠ›ã€‚</span><br><span class="line">	ä½¿ç”¨è®¿é—®è€…æ¨¡å¼å¯å®ç°é‡è½½çš„åŠ¨æ€ç»‘å®š(å³ä¼ªåŒåˆ†æ´¾), æ•ˆæœä¸é‡è½½æ–¹æ³•å†…ä½¿ç”¨ instanceof æ˜¯ä¸€æ ·çš„, ä½†ä½¿ç”¨è®¿é—®è€…æ¨¡å¼, å¯æ‰©å±•æ€§æ›´å¥½.</span><br></pre></td></tr></table></figure>

<h4 id="è¿­ä»£å™¨æ¨¡å¼"><a href="#è¿­ä»£å™¨æ¨¡å¼" class="headerlink" title="è¿­ä»£å™¨æ¨¡å¼"></a>è¿­ä»£å™¨æ¨¡å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">åŸç†:</span><br><span class="line">	æä¾›ä¸€ç§é¡ºåºè®¿é—®èšåˆå¯¹è±¡å…ƒç´ çš„æ–¹æ³•ï¼Œå¹¶ä¸”ä¸æš´éœ²èšåˆå¯¹è±¡çš„å†…éƒ¨è¡¨ç¤ºã€‚</span><br><span class="line"></span><br><span class="line">ç¤ºä¾‹: java.util.Iterator</span><br></pre></td></tr></table></figure>

<h4 id="è§£é‡Šå™¨æ¨¡å¼"><a href="#è§£é‡Šå™¨æ¨¡å¼" class="headerlink" title="è§£é‡Šå™¨æ¨¡å¼"></a>è§£é‡Šå™¨æ¨¡å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">åŸç†:</span><br><span class="line">	ä¸ºè¯­è¨€åˆ›å»ºè§£é‡Šå™¨ï¼Œé€šå¸¸ç”±è¯­è¨€çš„è¯­æ³•å’Œè¯­æ³•åˆ†ææ¥å®šä¹‰ã€‚</span><br><span class="line"></span><br><span class="line">ç¤ºä¾‹: EL è¡¨è¾¾å¼, Freemakeræ¨¡æ¿</span><br></pre></td></tr></table></figure>

<h4 id="ç©ºå¯¹è±¡æ¨¡å¼"><a href="#ç©ºå¯¹è±¡æ¨¡å¼" class="headerlink" title="ç©ºå¯¹è±¡æ¨¡å¼"></a>ç©ºå¯¹è±¡æ¨¡å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">åŸç†:</span><br><span class="line">	ä½¿ç”¨ä»€ä¹ˆéƒ½ä¸åšçš„ç©ºå¯¹è±¡æ¥ä»£æ›¿ NULL, é¿å…ç©ºå¯¹è±¡åˆ¤æ–­, é¿å…ç©ºæŒ‡é’ˆå¼‚å¸¸.</span><br></pre></td></tr></table></figure>



<h2 id="é«˜å¹¶å‘"><a href="#é«˜å¹¶å‘" class="headerlink" title="é«˜å¹¶å‘"></a>é«˜å¹¶å‘</h2><h3 id="Redis-ç¼“å­˜"><a href="#Redis-ç¼“å­˜" class="headerlink" title="Redis ç¼“å­˜"></a>Redis ç¼“å­˜</h3><h4 id="ç¼“å­˜ç©¿é€-æ”»å‡»å‹"><a href="#ç¼“å­˜ç©¿é€-æ”»å‡»å‹" class="headerlink" title="ç¼“å­˜ç©¿é€(æ”»å‡»å‹)"></a>ç¼“å­˜ç©¿é€(æ”»å‡»å‹)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">å«ä¹‰:</span><br><span class="line">	å¯¹äºä¸€ä¸ªä¸å­˜åœ¨çš„ key è¿›è¡Œè®¿é—®, ä¼šå¯¼è‡´æ•°æ®åº“ä¸åœåœ°æŸ¥è¯¢è¿™ä¸ª key è¿›è¡Œç¼“å­˜.</span><br><span class="line">	</span><br><span class="line">è§£å†³æ–¹æ¡ˆ:</span><br><span class="line">	1.ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨, ä¸€å®šä¸å­˜åœ¨çš„æ•°æ®ä¼šè¢«è¿‡æ»¤.</span><br><span class="line">	2.æŸ¥è¯¢åç¼“å­˜ä¸€ä¸ªç©ºç»“æœ, ä½†å¾ˆå¿«è¶…æ—¶.(æœ‰ç¼ºç‚¹, ä½†ç®€å•)</span><br></pre></td></tr></table></figure>

<h4 id="ç¼“å­˜é›ªå´©"><a href="#ç¼“å­˜é›ªå´©" class="headerlink" title="ç¼“å­˜é›ªå´©"></a>ç¼“å­˜é›ªå´©</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">å«ä¹‰:</span><br><span class="line">	ç¼“å­˜é›ªå´©æ˜¯æŒ‡åœ¨æˆ‘ä»¬è®¾ç½®ç¼“å­˜æ—¶é‡‡ç”¨äº†ç›¸åŒçš„è¿‡æœŸæ—¶é—´ï¼Œå¯¼è‡´ç¼“å­˜åœ¨æŸä¸€æ—¶åˆ»åŒæ—¶å¤±æ•ˆï¼Œè¯·æ±‚å…¨éƒ¨è½¬å‘åˆ°DBï¼ŒDBç¬æ—¶å‹åŠ›è¿‡é‡é›ªå´©ã€‚</span><br><span class="line">	</span><br><span class="line">è§£å†³æ–¹æ¡ˆ:</span><br><span class="line">	1.è®¾ç½®è¶…æ—¶æ—¶, åœ¨åŸæœ‰çš„å¤±æ•ˆæ—¶é—´åŸºç¡€ä¸Šå¢åŠ ä¸€ä¸ªéšæœºå€¼ï¼Œæ¯”å¦‚1-5åˆ†é’Ÿéšæœº</span><br><span class="line">	2.åŠ é”æˆ–è€…é˜Ÿåˆ—çš„æ–¹å¼ä¿è¯ç¼“å­˜çš„å•çº¿ ç¨‹ï¼ˆè¿›ç¨‹ï¼‰, é¿å…å¤§é‡è¯·æ±‚æ‰“åˆ°æ•°æ®åº“.</span><br></pre></td></tr></table></figure>

<h4 id="ç¼“å­˜å‡»ç©¿"><a href="#ç¼“å­˜å‡»ç©¿" class="headerlink" title="ç¼“å­˜å‡»ç©¿"></a>ç¼“å­˜å‡»ç©¿</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">å«ä¹‰:</span><br><span class="line">	å•ä¸€çƒ­ç‚¹ key å¤±æ•ˆæ—¶å¯¼è‡´å¤§é‡è¯·æ±‚æ‰“åˆ°æ•°æ®åº“ã€‚</span><br><span class="line"></span><br><span class="line">è§£å†³æ–¹æ¡ˆ:</span><br><span class="line">	1.åˆ†å¸ƒå¼äº’æ–¥é”(redis,zookper)</span><br><span class="line">	2.æ·»åŠ è¶…æ—¶å­—æ®µè®°å½•è¶…æ—¶(æ¯”å®é™…è¶…æ—¶å°ä¸€äº›), æ¯æ¬¡è·å–æ•°æ®æ ¹æ®å­—æ®µåˆ¤æ–­æ˜¯å¦è¶…æ—¶, è‹¥æ˜¯, åˆ™é©¬ä¸Šå»¶é•¿è¶…æ—¶å­—æ®µ, ç„¶ååŠ è½½æ•°æ®åº“é‡æ–°ç¼“å­˜</span><br><span class="line">	3.redisä¸è®¾ç½®è¿‡æœŸ, é€šè¿‡æ·»åŠ è¶…æ—¶å­—æ®µåˆ¤æ–­, è¶…æ—¶åˆ™ä»£ç å¼‚æ­¥è·‘ä¸€ä¸ªé‡æ–°ç¼“å­˜çš„ä»»åŠ¡(è¿™é‡Œä»£ç éœ€è¦å…ˆæœ¬åœ°åŠ é”, å†åŠ åˆ†å¸ƒå¼é”).</span><br></pre></td></tr></table></figure>



<h3 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h3><blockquote>
<p>è§£è€¦, å¼‚æ­¥, å‰Šå³°</p>
</blockquote>
<h4 id="è§£è€¦"><a href="#è§£è€¦" class="headerlink" title="è§£è€¦"></a>è§£è€¦</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å®šä¹‰:</span><br><span class="line">	ä¸ºé¢å‘æœåŠ¡çš„æ¶æ„ï¼ˆSOAï¼‰æä¾›åŸºæœ¬çš„æœ€ç»ˆä¸€è‡´æ€§å®ç°. å³å°† 2 ä¸ªç³»ç»Ÿçš„äº¤äº’é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—ä¸­è½¬, ä»¥é˜²æ­¢æŸä¸ªç³»ç»Ÿä¸´æ—¶æŒ‚äº†å¯¼è‡´è°ƒç”¨å¤±è´¥.</span><br><span class="line">ç¤ºä¾‹: ä¸‹å•ç³»ç»Ÿè°ƒç”¨åº“å­˜ç³»ç»Ÿ, è‹¥å½“æ—¶åº“å­˜ç³»ç»Ÿæ­£å¥½æŒ‚äº†, åˆ™å¯¼è‡´ä¸‹å•å¤±è´¥. æ­¤æ—¶å°†è¯·æ±‚æ”¾åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­, åº“å­˜ç³»ç»Ÿè¯»å–æ¶ˆæ¯è¿›è¡Œå¤„ç†, è‹¥å½“æ—¶åº“å­˜æŒ‚äº†ä¹Ÿæ²¡å…³ç³», å¤„ç†å¤±è´¥ä¹Ÿæ²¡å…³ç³»(å¯é‡è¯•, ä¸”é‡è¯•ä»£ç æ¯”è¾ƒç®€å•).</span><br></pre></td></tr></table></figure>

<h4 id="å¼‚æ­¥"><a href="#å¼‚æ­¥" class="headerlink" title="å¼‚æ­¥"></a>å¼‚æ­¥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å®šä¹‰:</span><br><span class="line">	å¯¹äºæŸäº›ä¸è¦æ±‚è¿”å›å€¼çš„è€—æ—¶æ“ä½œ, å¯å¼‚æ­¥å¤„ç†.</span><br><span class="line">ç¤ºä¾‹:</span><br><span class="line">	ç”¨æˆ·ä¸‹å•å, éœ€å‘é€å¤šä¸ªä¸‹å•æé†’(å¾®ä¿¡é€šçŸ¥, çŸ­ä¿¡é€šçŸ¥, é‚®ä»¶é€šçŸ¥), æ¯ä¸ªæ“ä½œéƒ½æ¯”è¾ƒè€—æ—¶, å¯è€ƒè™‘å°†å…¶æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ—åç›´æ¥è¿”å›, ç”±å¦ä¸€æ®µä»£ç è´Ÿè´£è¯»å–æ¶ˆæ¯å‘é€é€šçŸ¥.</span><br></pre></td></tr></table></figure>

<h4 id="å‰Šå³°"><a href="#å‰Šå³°" class="headerlink" title="å‰Šå³°"></a>å‰Šå³°</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å®šä¹‰:</span><br><span class="line">	å°†è¯·æ±‚é«˜å³°æ‰“å¹³, ä½¿å¾—ç³»ç»Ÿå¯ä»¥å¤„ç†è¿‡æ¥.</span><br><span class="line">ç¤ºä¾‹:</span><br><span class="line">	æŸæ¬¡ç§’æ€ 1 åˆ†é’Ÿè¿‡æ¥ 1 ä¸‡è¯·æ±‚, è€Œç³»ç»Ÿä¸€åˆ†é’Ÿå¤§æ¦‚åªèƒ½å¤„ç† 1åƒ è¯·æ±‚, ç³»ç»Ÿè¦å¤„ç†å®Œè¿™äº›è¯·æ±‚ç†è®ºéœ€è¦ 10 åˆ†é’Ÿ, ä½†å¦‚æœä¸åšå¤„ç†, è¯·æ±‚ç¬é—´æ‰“è¿‡æ¥, ç³»ç»Ÿç›´æ¥å¡æ­», å¡ä½æ—¶å€™ä¸€åˆ†é’Ÿå¯èƒ½åªèƒ½å¤„ç† 100 è¯·æ±‚. æ­¤æ—¶éœ€è¦å°†æ‰€æœ‰è¯·æ±‚éƒ½æ‰“åˆ°é˜Ÿåˆ—é‡Œé¢, ç³»ç»Ÿå†æ…¢æ…¢ä»é˜Ÿåˆ—ä¸­è¯»å–å¤„ç†.</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://gudqs7.github.io/2021/01/30/source-code-spring-cloud-gateway/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="gudqs7">
      <meta itemprop="description" content="å¿ƒç´¯æ²¡é’±èººå°¸ä¸­">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="gudqs7's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/30/source-code-spring-cloud-gateway/" class="post-title-link" itemprop="url">source-code-spring-cloud-gateway</a>
        </h2>

        <div class="post-meta">
			
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-01-30 17:07:38" itemprop="dateCreated datePublished" datetime="2021-01-30T17:07:38+08:00">2021-01-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-01-31 00:50:53" itemprop="dateModified" datetime="2021-01-31T00:50:53+08:00">2021-01-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SourceCode/" itemprop="url" rel="index"><span itemprop="name">SourceCode</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/2021/01/30/source-code-spring-cloud-gateway/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/01/30/source-code-spring-cloud-gateway/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Spring-Gateway-æºç ç¬”è®°"><a href="#Spring-Gateway-æºç ç¬”è®°" class="headerlink" title="Spring Gateway æºç ç¬”è®°"></a>Spring Gateway æºç ç¬”è®°</h1><h2 id="å…³é”®ç±»"><a href="#å…³é”®ç±»" class="headerlink" title="å…³é”®ç±»"></a>å…³é”®ç±»</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">1.DispatcherHandler</span><br><span class="line">	Spring Webflux çš„æ ¸å¿ƒç±», è´Ÿè´£åè°ƒ HandlerMapping å’Œ HandlerAdapter</span><br><span class="line"></span><br><span class="line">2.HandlerMapping</span><br><span class="line">	Spring Webflux çš„æ ¸å¿ƒç±», è´Ÿè´£æ ¹æ®è¯·æ±‚ä¿¡æ¯æŸ¥æ‰¾ handler</span><br><span class="line"></span><br><span class="line">3.HandlerAdapter</span><br><span class="line">	Spring Webflux çš„æ ¸å¿ƒç±», è´Ÿè´£æ‰§è¡Œ handler</span><br><span class="line">	</span><br><span class="line">4.RoutePredicateHandlerMapping</span><br><span class="line">	Spring Gateway å®ç°çš„ HandlerMapping, è´Ÿè´£æ ¹æ®è°“è¯æŸ¥æ‰¾ Route å¯¹è±¡å¹¶è¿”å› handler(FilteringWebHandler)</span><br><span class="line"></span><br><span class="line">5.FilteringWebHandler</span><br><span class="line">	æ˜¯ä¸€ä¸ª handler</span><br><span class="line">	ç”¨äºè·å– route å¯¹è±¡çš„ä¿¡æ¯(ä¸»è¦æ˜¯ GatewayFilter), ç„¶åå°è£…æ‰€æœ‰æ‹¦æˆªå™¨(åŒ…æ‹¬ GlobalFilter)åˆ° DefaultGatewayFilterChain, æŒ¨ä¸ªæ‰§è¡Œ, å€’å™å›å½’.</span><br><span class="line">	</span><br><span class="line">6.RoutePredicateFactory</span><br><span class="line">	è°“è¯å®ç°ç±»çš„å·¥å‚ç±»</span><br><span class="line">	è´Ÿè´£åˆ›å»ºå…·ä½“çš„è°“è¯å·¥å‚(å¦‚ Path, Method, Before ç­‰)</span><br><span class="line">	apply() è¿”å›ä¸€ä¸ª Predicate</span><br><span class="line">	</span><br><span class="line">7.Predicate</span><br><span class="line">	å®šä¹‰äº† <span class="built_in">test</span> æ–¹æ³•, è¿”å› Boolean å€¼, <span class="literal">true</span> ä»£è¡¨åŒ¹é…, <span class="literal">false</span> ä»£è¡¨ä¸åŒ¹é…(æŒ‡åŒ¹é… Route)</span><br><span class="line">	</span><br><span class="line">8.GlobalFilter/GatewayFilter</span><br><span class="line">	å®šä¹‰äº†ä¸€ä¸ªæ‹¦æˆªæ–¹æ³•, å¯æ‹¦æˆªè¯·æ±‚è¿›è¡Œç›¸åº”å¤„ç†</span><br><span class="line">	</span><br><span class="line">9.AsyncPredicate/AndAsyncPredicate</span><br><span class="line">	AsyncPredicate æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ–¹æ³•(å•æ–¹æ³•æ¥å£), æ–¹æ³•è¢«è°ƒç”¨æ—¶ä¼šè°ƒç”¨ä¿å­˜çš„ Predicate ç±»å‹å­—æ®µçš„ <span class="built_in">test</span>() æ–¹æ³•.</span><br><span class="line">  AndAsyncPredicate æ˜¯ä¸€ä¸ªå·¦å³ç»“æ„çš„ AsyncPredicate, è¿›è¡Œåˆ¤æ–­æ—¶å…ˆåˆ¤æ–­å·¦è¾¹, å†åˆ¤æ–­å³è¾¹</span><br><span class="line">  è‹¥ä¸æ–­çš„ and, ä¼šå½¢æˆæ ‘ç»“æ„. æ‰€ä»¥æ‰§è¡Œæ—¶ç±»ä¼¼éå†äºŒå‰æ ‘.</span><br><span class="line"></span><br><span class="line">10.RouteDefinitionRouteLocator</span><br><span class="line">	è´Ÿè´£ä»ä¸åŒçš„ Locator(å¦‚é…ç½®æ–‡ä»¶) è·å– RouteDefinition, å¹¶è´Ÿè´£å°† RouteDefinition è½¬æˆ Route å¯¹è±¡</span><br><span class="line">	</span><br><span class="line">11.RouteDefinition</span><br><span class="line">	åŒ…å«æœ‰è·¯ç”±çš„æ‰€æœ‰é…ç½®ä¿¡æ¯, å«è°“è¯, æ‹¦æˆªå™¨, id, url ç­‰ç­‰, ä½†éƒ½æ˜¯å­—ç¬¦ä¸².</span><br><span class="line">	</span><br><span class="line">12.Route</span><br><span class="line">	å«æœ‰çš„é…ç½®ä¿¡æ˜¯è½¬åŒ–å¥½äº†çš„, å¦‚ Predicate å’Œ GatewayFilter.</span><br><span class="line">	</span><br><span class="line">13.NettyRoutingFilter</span><br><span class="line">	ä½¿ç”¨ netty å‘é€ http/wss ç­‰è¯·æ±‚.</span><br><span class="line"></span><br><span class="line">14.GatewayFilterFactory</span><br><span class="line">	æ‹¦æˆªå™¨å®ç°ç±»çš„å·¥å‚ç±»</span><br><span class="line">	è´Ÿè´£åˆ›å»ºå…·ä½“çš„ GatewayFilter å¯¹è±¡.</span><br><span class="line"></span><br><span class="line">15.AbstractConfigurable</span><br><span class="line">	è´Ÿè´£å¤„ç†è°“è¯çš„é…ç½®å’Œæ‹¦æˆªå™¨çš„é…ç½®è½¬åŒ–æˆä¸åŒçš„ Class é…ç½®.</span><br><span class="line">	å®é™…ä¸Šç”± shortcutFieldOrder å±æ€§é…åˆ Binder å®ç°.</span><br><span class="line">	å³æŒ‰ shortcutFieldOrder é…ç½®çš„å­—æ®µåˆ—è¡¨, æŒ‰é¡ºåºä» PropertySource ä¸­è¯»å–æ•°æ®è¿›è¡Œç»‘å®š; è€Œ PropertySource åˆ™æ˜¯ä» RouteDefinition çš„é…ç½®ä¿¡æ¯åŠ å…¥åˆ° Map åå†ç”¨ MapConfigurationPropertySource åŒ…è£… Map è€Œå¾—åˆ°çš„.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“: é™¤äº†è°“è¯å·¥å‚å’Œæ‹¦æˆªå™¨å·¥å‚è¿™å—çš„å®ç°å¤æ‚, å…¶ä»–éƒ½ç®—æ¯”è¾ƒç®€å•, å“ªæ€•å“åº”å¼ç¼–ç¨‹çš„ä»£ç åˆ°å¤„éƒ½æ˜¯, ä¹Ÿè¿˜æ˜¯å¯ä»¥å¤§è‡´çš„ç†è§£ä»£ç çš„æ„æ€.</p>
<p>è¿™ä¸¤ä¸ªå·¥å‚å…¶å®åŸºæœ¬æ˜¯åŒä¸€å¥—é€»è¾‘, åŒä¸€å¥—ä»£ç , å°±æ˜¯æœ‰ä¸€ä¸ªæ¥å£åä¸åŒ, ç„¶åå…¶ä½œç”¨ä¹Ÿä¸åŒ, ä½†å¾ˆç›¸ä¼¼.</p>
</blockquote>
<h2 id="è°“è¯­çš„å®ç°åŸç†-å¦‚ä½•åˆ¤æ–­å“ªäº›è¯·æ±‚è¯¥èµ°å“ªä¸ªé“"><a href="#è°“è¯­çš„å®ç°åŸç†-å¦‚ä½•åˆ¤æ–­å“ªäº›è¯·æ±‚è¯¥èµ°å“ªä¸ªé“" class="headerlink" title="è°“è¯­çš„å®ç°åŸç†(å¦‚ä½•åˆ¤æ–­å“ªäº›è¯·æ±‚è¯¥èµ°å“ªä¸ªé“)?"></a>è°“è¯­çš„å®ç°åŸç†(å¦‚ä½•åˆ¤æ–­å“ªäº›è¯·æ±‚è¯¥èµ°å“ªä¸ªé“)?</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1.Spring gateway åŸºäº Spring webflux, å› æ­¤ä¼šæ‰§è¡Œ DispatcherHandler, è¿™æ˜¯ä¸€ä¸ª WebHandler, æ‰€ä»¥ä¼šè°ƒç”¨ DispatcherHandler.handle(), è¿™ä¸ªç±»é€šè¿‡ HandlerMapping æŸ¥æ‰¾å¯¹åº”çš„ handler æ¥æ‰§è¡Œ.</span><br><span class="line">2.åœ¨åˆå§‹åŒ–æ—¶ä¼šä»å®¹å™¨ä¸­æŸ¥æ‰¾ HandlerMapping ç±»å‹çš„ bean, ç”¨äºæŸ¥æ‰¾ handler; è€Œ gateway å®ç°äº†ä¸€ä¸ª RoutePredicateHandlerMapping(GatewayAutoConfiguration ä¸­æ³¨å†Œè¿›å»çš„); å› æ­¤è¿™é‡Œæ˜¯å…¥å£!!!</span><br><span class="line">3.å†çœ‹ RoutePredicateHandlerMapping çš„é€»è¾‘, å…¶é€šè¿‡ç»§æ‰¿æŠ½è±¡ç±», å› æ­¤ä¼šåœ¨ getHandlerInternal() ä¸­è·å– handler. æ¥ç€å›é¡¾ä¸‹ Route å¯¹è±¡çš„è·å–.</span><br><span class="line">4.å…¶ä½¿ç”¨ RouteDefinitionRouteLocator å¯¹è±¡æ¥è°ƒç”¨ PropertiesRouteDefinitionLocator.getRouteDefinitions() è·å– RouteDefinition é›†åˆå¯¹è±¡(è¿™é‡Œè¿˜æœ‰å¥½å‡ ä¸ªä¸åŒçš„ Locator), ç„¶ååœ¨ RouteDefinitionRouteLocator.convertToRoute() ä¸­å°† RouteDefinition è½¬æˆ Route å¯¹è±¡, æ­¤æ—¶ä¼šè°ƒç”¨ RouteDefinitionRouteLocator.combinePredicates() å°† RouteDefinition ä¸­çš„ PredicateDefinition é›†åˆä¿¡æ¯è½¬æˆäº† AsyncPredicate å¯¹è±¡é›†åˆ. è¿™ä¸ª AsyncPredicate æ˜¯é€šè¿‡è§£æè°“è¯å­—ç¬¦ä¸², æ ¹æ®è°“è¯åç§°è·å–å·¥å‚ç±»(PredicateFactory)å†è°ƒç”¨ç›¸åº”å·¥å‚ç±»çš„æ–¹æ³•(apply æ–¹æ³•)ç”Ÿæˆå«ç›¸åº”é€»è¾‘åˆ¤æ–­çš„ GatewayPredicate ç±»(åˆ¤æ–­é€»è¾‘åœ¨ <span class="built_in">test</span> æ–¹æ³•ä¸­); é¡ºå¸¦ä¸€æè°“è¯é…ç½®ä¿¡æ¯æ˜¯ ä» apply çš„å‚æ•°ä¸­ä¼ é€’è¿‡æ¥çš„.</span><br><span class="line">5.Spring Gateway é»˜è®¤æ³¨å…¥äº†å¾ˆå¤šå·¥å‚(è§ GatewayAutoConfiguration), å¦‚ Host,Path,Method,Query,Cookie ç­‰ç­‰.</span><br><span class="line">6.è¿™æ · åœ¨ RoutePredicateHandlerMapping.lookupRoute() ä¸­çš„ r.getPredicate().apply(exchange) å°±ä¼šæ‰§è¡Œ Route ä¸­çš„è°“è¯åˆ¤æ–­, ä»…ä¿ç•™åŒ¹é…çš„ Route, ç„¶åå†å‰©ä¸‹çš„ Route ä¸­å–ç¬¬ä¸€ä¸ªè¿”å›. æœ€åå°† Route å¯¹è±¡å­˜åˆ° exchange ä¸­, ç„¶åè¿”å› FilteringWebHandler. </span><br><span class="line">7.è¿™æ˜¯ä¸€ä¸ª WebHandler, ä¼šç”±è‡ªå¸¦çš„é€‚é…å™¨ SimpleHandlerAdapter æ‰§è¡Œ, å³è°ƒç”¨å…¶ handle æ–¹æ³•.</span><br><span class="line">8.FilteringWebHandler ä» exchange ä¸­å–å‡º Route å¯¹è±¡, åœ¨å°† globalFilter å’Œ gatewayFilter æ”¾åˆ°é›†åˆä¸­(ç›¸å½“äºé“¾)å†é€’å½’è°ƒç”¨æ‰€æœ‰ Filter; å…¶ä¸­æœ‰å‡ ä¸ª Filter ä¼šæ‰§è¡Œè¯·æ±‚, å³å°†è¯·æ±‚åˆ†å‘åˆ°æŒ‡å®šåœ°å€. å¦‚ NettyRoutingFilter(è§ GatewayAutoConfiguration).</span><br><span class="line">9.åˆ°æ­¤ä»¥å°† Spring gateway æ¥æ”¶åˆ°çš„è¯·æ±‚æ ¹æ®è°“è¯­åŒ¹é…å¯¹åº”çš„ Route(è·¯ç”±) å†æ‰§è¡Œæ‰€æœ‰çš„ Filter åè¯·æ±‚ route é…ç½®çš„åœ°å€.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“: ä» Spring webflux çš„å…¥å£, å…ˆ getHandler(), å¾—åˆ°çš„æ˜¯è¿”å›å€¼ FilteringWebHandler, è¿™ä¸ªè¿”å›å€¼ä¼šè¢« SimpleHandlerAdapter æ‰§è¡Œ, ä½†ä¸è°“è¯çš„é€»è¾‘æ— å…³; ä½† getHandler() è¿˜å°†é…ç½®æ–‡ä»¶(ä»¥åŠå…¶ä»–åœ°æ–¹)è·å–åˆ°çš„ RouteDefinition è½¬æˆ Route å¯¹è±¡, åŒæ—¶ä¹Ÿå°† RouteDefinition ä¸­çš„ PredicateDefinition è½¬æ¢æˆäº† Predicate, å†å°†å¤šä¸ª Predicate ç»„æˆæ ‘ç»“æ„å˜æˆä¸€ä¸ª AsyncPredicate; ç„¶åè°ƒç”¨ AsyncPredicate éå†æ‰§è¡Œæ¯ä¸ªè°“è¯åˆ¤æ–­. æœ‰ä¸€ä¸ªè¿”å› false, åˆ™æ•´ä¸ªç»“æœè¿”å› false (æŒ‡ and ç›¸è¿). å¦‚æ­¤ä¾¿å®Œæˆäº†æ ¹æ®è°“è¯åˆ¤æ–­æ˜¯å¦åŒ¹é… Route!!</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line"></span><br><span class="line">A1(DispatcherHandler)</span><br><span class="line">A2(HandlerMapping#getHandler)</span><br><span class="line">A3(RoutePredicateHandlerMapping#getHandlerInternal)</span><br><span class="line">A4(RouteDefinitionRouteLocator#getRouteDefinitions)</span><br><span class="line">A5(RouteDefinition)</span><br><span class="line">A6(RouteDefinitionRouteLocator#convertToRoute)</span><br><span class="line">A7(Route)</span><br><span class="line">A8(RouteDefinitionRouteLocator#combinePredicates)</span><br><span class="line">A9(PredicateDefinition#è°“è¯é…ç½®ä¿¡æ¯)</span><br><span class="line">A0(AsyncPredicate#å¯æ‰§è¡Œçš„è°“è¯)</span><br><span class="line"></span><br><span class="line">B0(PredicateFactory#apply)</span><br><span class="line">B1(GatewayPredicate#test è°“è¯åˆ¤æ–­)</span><br><span class="line">B2(GlobalFilter å« NettyRoutingFilter)</span><br><span class="line">B3(FilteringWebHandler)</span><br><span class="line">B4(SimpleHandlerAdapter#é€‚é…å™¨)</span><br><span class="line">B5(DefaultGatewayFilterChain#æ‹¦æˆªå™¨é“¾)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">A1--è°ƒç”¨--&gt;A2</span><br><span class="line">A2--è°ƒç”¨å­ç±»--&gt;A3</span><br><span class="line"></span><br><span class="line">A3--åè§¦å‘æ‰€æœ‰--&gt;A0</span><br><span class="line">A0--é€šè¿‡--&gt;B1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">A4--ä»é…ç½®æ–‡ä»¶ç­‰åœ°æ–¹è·å¾—--&gt;A5</span><br><span class="line">A5--é€šè¿‡--&gt;A6</span><br><span class="line"></span><br><span class="line">A6--è¿˜è°ƒç”¨--&gt;A8</span><br><span class="line">A8--å°†--&gt;A9</span><br><span class="line">A9--é€šè¿‡è°ƒç”¨--&gt;B0</span><br><span class="line">B0--å¾—åˆ° Predicate å¯¹è±¡, å†ç”±å¤šä¸ªå¯¹è±¡ç»„åˆå¾—åˆ°--&gt;A0</span><br><span class="line"></span><br><span class="line">B1--è¿”å›åŒ¹é…çš„--&gt;A7</span><br><span class="line">A7--å°†å…¶å­˜åˆ° exchange å¯¹è±¡ä¸­, ç„¶åè¿”å›--&gt;B3</span><br><span class="line"></span><br><span class="line">B4--è´Ÿè´£æ‰§è¡Œ--&gt;B3</span><br><span class="line">B3--ä» exchange å¯¹è±¡è·å– Route åå†å°†--&gt;B2</span><br><span class="line">B2--æ‰“åŒ…å°è£…æˆä¸€ä¸ª--&gt;B5</span><br><span class="line"></span><br><span class="line">B5--æœ€ç»ˆä¼šæ‰§è¡Œ--&gt;G1(NettyRoutingFilter#å‘èµ·HTTPè¯·æ±‚)</span><br><span class="line"></span><br><span class="line">A1--è°ƒç”¨--&gt;B4</span><br></pre></td></tr></table></figure>





<p><img src="https://gitee.com/gudqs7/many-images/raw/master/Mac-PicGo/20210131004943.png" alt="iShot2021-01-31 00.48.56"></p>
<h2 id="ä¸-LoadBalancer-å¯¹æ¥æ­¥éª¤"><a href="#ä¸-LoadBalancer-å¯¹æ¥æ­¥éª¤" class="headerlink" title="ä¸ LoadBalancer å¯¹æ¥æ­¥éª¤"></a>ä¸ LoadBalancer å¯¹æ¥æ­¥éª¤</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.ä¸Šé¢è®²åˆ°æ‰§è¡Œæ‰€æœ‰çš„ Filter, é‚£ä¹ˆé™¤äº†ç”¨æˆ·é…ç½®çš„ GatewayFilter, Gateway é…ç½®çš„å…¨å±€ Filter ä¹Ÿä¼šæ‰§è¡Œ(è§ GatewayAutoConfiguration); è€Œè´Ÿè´£å¤„ç† lb:// çš„ Filter æ˜¯ ReactiveLoadBalancerClientFilter (è§ GatewayReactiveLoadBalancerClientAutoConfiguration) </span><br><span class="line">2.å…·ä½“æ–¹æ³•ä¸º ReactiveLoadBalancerClientFilter.filter(), å…¶é€»è¾‘æ˜¯å–å‡º host, è°ƒç”¨ LoadBalancer çš„ choose() è·å– ServiceInstance, ç„¶åå°† url put å› exchange çš„ä¸Šä¸‹æ–‡ä¸­å­˜èµ·æ¥å³å¯.</span><br></pre></td></tr></table></figure>



<h2 id="æ‹¦æˆªå™¨çš„æ‰§è¡Œæ–¹å¼"><a href="#æ‹¦æˆªå™¨çš„æ‰§è¡Œæ–¹å¼" class="headerlink" title="æ‹¦æˆªå™¨çš„æ‰§è¡Œæ–¹å¼?"></a>æ‹¦æˆªå™¨çš„æ‰§è¡Œæ–¹å¼?</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‹¦æˆªé“¾æ˜¯è‚¯å®šçš„, æ‰€æœ‰çš„ Filter éƒ½å¯ä»¥å…ˆæ‰§è¡Œè‡ªå·±é€»è¾‘, å†ä½¿ç”¨ chain è§¦å‘ä¸‹ä¸€ä¸ª Filter ç›´åˆ°æ— æ‹¦æˆªå™¨</span></span><br><span class="line"><span class="comment">// ç„¶åå¼€å§‹è¿”å›, å› ä¸ºæ˜¯é¡ºåºè¿›å…¥, æ‰€ä»¥æ˜¯å€’å™è¿”å›</span></span><br><span class="line"><span class="comment">// è¿”å›åæ­£å¸¸æ˜¯ä¸€è·¯ä¸æ–­å¾€å›è¿”å›, ä½†ä½ çš„ Filter ä¹Ÿå¯ä»¥åœ¨ è°ƒç”¨ chain çš„æ—¶å€™ä¸ç›´æ¥è¿”å›, è€Œæ˜¯å…ˆæš‚å­˜è¿”å›å€¼, å†é€šè¿‡ exchange å¯¹è±¡(æ­¤æ—¶æ‰§è¡Œäº†å…¶ä»– Filter åŒ…æ‹¬å®é™…è¯·æ±‚ä¹Ÿæ‰§è¡Œäº†, å› æ­¤ä¼šæœ‰å“åº”æ•°æ®)å–å‡ºå“åº”æ•°æ®(æˆ–è¿”å›å€¼), è¿›è¡Œä¿®æ”¹, å† return æš‚å­˜çš„å˜é‡.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultGatewayFilterChain</span> <span class="keyword">implements</span> <span class="title">GatewayFilterChain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> index;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> List&lt;GatewayFilter&gt; filters;</span><br><span class="line"></span><br><span class="line">  DefaultGatewayFilterChain(List&lt;GatewayFilter&gt; filters) &#123;</span><br><span class="line">    <span class="keyword">this</span>.filters = filters;</span><br><span class="line">    <span class="keyword">this</span>.index = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">DefaultGatewayFilterChain</span><span class="params">(DefaultGatewayFilterChain parent, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.filters = parent.getFilters();</span><br><span class="line">    <span class="keyword">this</span>.index = index;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;GatewayFilter&gt; <span class="title">getFilters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> filters;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Mono.defer(() -&gt; &#123;</span><br><span class="line">      <span class="comment">// è¿™é‡ŒæŒ¨ä¸ªå–å‡º, è™½ç„¶æ²¡æœ‰å¯¹ filters è¿›è¡Œ pop æ“ä½œå•¥çš„, ä½†æ˜¯ä¸‹ä¸€ä¸ªæ‰§è¡Œå®Œå, ä¼šè°ƒç”¨ chain.filter</span></span><br><span class="line">      <span class="comment">// ç­‰äºåœ¨é€’å½’è¿›å…¥è¿™ä¸ªæ–¹æ³•, è™½ç„¶æ˜¯ä¸åŒå¯¹è±¡çš„.. ä½†å› ä¸ºç»´æŠ¤äº† parent å’Œ index çš„å€¼</span></span><br><span class="line">      <span class="comment">// ä½¿å¾— this.index &lt; filters.size() è¿™ä¸ªé€’å½’ç»ˆæ­¢æ¡ä»¶å¾—ä»¥æ­£ç¡®æ‰§è¡Œ. å› æ­¤å’Œé€’å½’æ˜¯ç±»ä¼¼çš„.</span></span><br><span class="line">      <span class="comment">// ä¹Ÿå°±æ˜¯è¯´, æœ€åæ‰€æœ‰ filter æ‰§è¡Œå®Œå, ä¹Ÿä¼šä¸æ–­çš„å›å½’.</span></span><br><span class="line">      <span class="comment">// é‚£ä¹ˆ, æœ€åçš„ Filter å®Œæˆè¯·æ±‚(æ¯”å¦‚ http è¯·æ±‚), å¾—åˆ°çš„ response ä¼šå­˜åœ¨ exchange ä¸­</span></span><br><span class="line">      <span class="comment">// è¿™æ ·å›å½’è¿‡ç¨‹(ä¹Ÿå°±æ˜¯ chain.filter æ–¹æ³•ä¹‹åå¾—ä»£ç å°±å¯ä»¥å–å¾—æ•°æ®è¿›è¡Œå¹²é¢„)</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.index &lt; filters.size()) &#123;</span><br><span class="line">        GatewayFilter filter = filters.get(<span class="keyword">this</span>.index);</span><br><span class="line">        DefaultGatewayFilterChain chain = <span class="keyword">new</span> DefaultGatewayFilterChain(<span class="keyword">this</span>, <span class="keyword">this</span>.index + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> filter.filter(exchange, chain);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.empty(); <span class="comment">// complete</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://gudqs7.github.io/2021/01/30/source-code-spring-cloud-alibaba-sentinel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="gudqs7">
      <meta itemprop="description" content="å¿ƒç´¯æ²¡é’±èººå°¸ä¸­">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="gudqs7's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/30/source-code-spring-cloud-alibaba-sentinel/" class="post-title-link" itemprop="url">Spring Cloud Alibaba Sentinel æºç ç¬”è®°</a>
        </h2>

        <div class="post-meta">
			
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-01-30 15:19:26 / ä¿®æ”¹æ—¶é—´ï¼š17:05:00" itemprop="dateCreated datePublished" datetime="2021-01-30T15:19:26+08:00">2021-01-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SourceCode/" itemprop="url" rel="index"><span itemprop="name">SourceCode</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring-Cloud/" itemprop="url" rel="index"><span itemprop="name">Spring Cloud</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/2021/01/30/source-code-spring-cloud-alibaba-sentinel/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/01/30/source-code-spring-cloud-alibaba-sentinel/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Sentinel-ä¸-Openfeign-æ•´åˆ"><a href="#Sentinel-ä¸-Openfeign-æ•´åˆ" class="headerlink" title="Sentinel ä¸ Openfeign æ•´åˆ"></a>Sentinel ä¸ Openfeign æ•´åˆ</h2><h3 id="å…³é”®ç±»"><a href="#å…³é”®ç±»" class="headerlink" title="å…³é”®ç±»"></a>å…³é”®ç±»</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">1.SentinelFeignAutoConfiguration</span><br><span class="line">	æ³¨å…¥äº† Feign.Builder(å³ SentinelFeign.Builder) åˆ°å®¹å™¨ä¸­</span><br><span class="line"></span><br><span class="line">2.SentinelFeign.Builder</span><br><span class="line">	é‡å†™ build æ–¹æ³•æ³¨å…¥ sentinel çš„ InvocationHandler(SentinelInvocationHandler)</span><br><span class="line"></span><br><span class="line">3.SentinelInvocationHandler</span><br><span class="line">	æ‹¦æˆªæ–¹æ³•, åŒ…è£…æ–¹æ³•ä¸ºä¸€ä¸ªèµ„æº, è¿›è¡Œæµæ§é™çº§ç­‰å¤„ç†</span><br><span class="line">	</span><br><span class="line">4.SentinelAutoConfiguration</span><br><span class="line">	æ³¨å…¥äº† SentinelResourceAspect æ¥æ”¯æŒ @SentinelResource æ³¨è§£</span><br><span class="line">	æ³¨å…¥äº† SentinelBeanPostProcessor æ¥å¤„ç† @SentinelRestTemplate</span><br><span class="line">	æ³¨å…¥äº† SentinelDataSourceHandler æ¥åŠ è½½å„ç§æ•°æ®æºä¸ºè§„åˆ™é…ç½®</span><br><span class="line"></span><br><span class="line">5.SentinelResourceAspect</span><br><span class="line">	å¯¹åŠ äº† @SentinelResource çš„æ–¹æ³•æ·»åŠ  @Around é€šçŸ¥, åŒ…å›´åŸæ–¹æ³•å·²å®ç°æµæ§é™çº§ç­‰å¤„ç†.</span><br><span class="line">	</span><br><span class="line">6.SentinelBeanPostProcessor</span><br><span class="line">	å¯¹åŠ äº† @SentinelRestTemplate æ³¨è§£çš„ RestTemplate bean, æ·»åŠ ä¸€ä¸ª SentinelProtectInterceptor</span><br><span class="line"></span><br><span class="line">7.SentinelDataSourceHandler</span><br><span class="line">	è§£æ spring.cloud.sentinel.datasource çš„é…ç½®, åŠ è½½é…ç½®çš„è§„åˆ™åˆ° Sentinel ä¸­.</span><br><span class="line">	</span><br><span class="line">8.SentinelProtectInterceptor</span><br><span class="line">	åŒ…è£… RestTemplate çš„è¯·æ±‚, ä½¿å…¶å¯è¢«æµæ§é™çº§ç­‰æ“ä½œ.</span><br></pre></td></tr></table></figure>





<h3 id="æ•´åˆæ­¥éª¤"><a href="#æ•´åˆæ­¥éª¤" class="headerlink" title="æ•´åˆæ­¥éª¤"></a>æ•´åˆæ­¥éª¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.Feign é‚£è¾¹çš„æ­¥éª¤æ˜¯, å…ˆä»å®¹å™¨ä¸­è·å– Feign.Builder å¯¹è±¡, å¹¶ä¸” FeignContext ä¹Ÿä¼šæ³¨å…¥ä¸€ä¸ªé»˜è®¤çš„ Builder å¯¹è±¡, ä½†æ˜¯æ¯•ç«Ÿæ˜¯å­å®¹å™¨, ä¼˜å…ˆçº§æ²¡æœ‰çˆ¶å®¹å™¨é«˜(åŠ è½½é…ç½®æ›´å, æ‰€ä»¥ @ConditionalOnMissingBean è§¦å‘, å­å®¹å™¨å°±ä¸æ³¨å†Œäº†). å› æ­¤æˆ‘ä»¬åœ¨çˆ¶å®¹å™¨ä¸­ä¸­é…ç½®ä¸€ä¸ª Builder å°±èƒ½è¿›è¡Œå¯¹æ¥.</span><br><span class="line">2.Feign çš„å®ç°æ˜¯é€šè¿‡ JDK ç”Ÿæˆä¸€ä¸ªä»£ç†å¯¹è±¡æ‹¦æˆªæ–¹æ³•æ¥æ„é€ å¹¶æ‰§è¡Œ HTTP è¯·æ±‚, å› æ­¤å…¶éœ€è¦ä¸€ä¸ª InvocationHandler æ¥æ‹¦æˆªé…ç½®; åœ¨ Feign ä¸­, é€šè¿‡å­—æ®µ invocationHandlerFactory æ¥åˆ›å»ºè¿™ä¸ª InvocationHandler, æ‰€ä»¥æˆ‘ä»¬æ³¨å…¥è‡ªå·±å®ç°çš„ Builder éœ€è¦è®¾ç½®è¿™ä¸ªå­—æ®µ.</span><br><span class="line">3.å³ SentinelFeign.Builder.build() ä¸­è°ƒç”¨ super.invocationHandlerFactory(xxx) æ¥è®¾ç½®.</span><br><span class="line">4.xxx æ˜¯åŒ¿åå†…éƒ¨ç±», ç›´æ¥çœ‹ create æ–¹æ³•, è¿™é‡Œæ ¹æ® @FeignClient æ³¨è§£çš„é…ç½®(fallback/fallbackFactory) åˆ›å»ºäº†ä¸€ä¸ª SentinelInvocationHandler</span><br><span class="line">5.SentinelInvocationHandler.invoke() çš„é€»è¾‘æ˜¯ä½¿ç”¨ SphU.entry() åŒ…å›´ feign ç”Ÿæˆçš„ method(è¿™ä¸ª method æ˜¯å¹²æ­£äº‹çš„: æ‰§è¡Œè´Ÿè½½å‡è¡¡å’Œå‘é€ Http è¯·æ±‚), è¿™å°±å¯¹è¿™ä¸ª method è¿›è¡Œæµé‡æ§åˆ¶äº†; ç„¶åè¿˜åœ¨ catch ä¸­å¤„ç† fallback.</span><br><span class="line">6.è‡³æ­¤, ä¸ feign çš„å¯¹æ¥å°±å®Œæˆäº†</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“: æ–°å»ºä¸€ä¸ª Builder ä»¤ç”Ÿæˆçš„ Feign å¯¹è±¡æŒæœ‰æˆ‘ä»¬æŒ‡å®šçš„ invocationHandlerFactory, ä½¿å…¶åˆ›å»ºä»£ç†å¯¹è±¡æ—¶ä½¿ç”¨æˆ‘ä»¬åˆ›å»ºçš„ SentinelInvocationHandler æ‹¦æˆªå¯¹è±¡æ–¹æ³•; è¿™æ ·å°±æŠŠæ–¹æ³•çš„æ‰§è¡ŒåŒ…å›´èµ·æ¥, è¿›è¡Œæµé‡æ§åˆ¶å’Œç†”æ–­é™çº§(catch å¼‚å¸¸è°ƒç”¨ fallback)äº†.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line"></span><br><span class="line">A1(FeignClientsRegistrar)</span><br><span class="line">A2(FeignClientFactoryBean)</span><br><span class="line">A3(çœŸå® XxxService æ¥å£)</span><br><span class="line">A4(SentinelInvocationHandler)</span><br><span class="line">A5(SentinelFeignAutoConfiguration)</span><br><span class="line">A6(Feign.Builder å³ SentinelFeign.Builder)</span><br><span class="line">A7(Feign å¯¹è±¡)</span><br><span class="line">A8(ä»£ç†å¯¹è±¡)</span><br><span class="line">A9( sentinel å°†æ–¹æ³•å½“åšèµ„æºè¿›è¡Œæ‹¦æˆª)</span><br><span class="line">B1(åœ¨ catch ä¸­å¤„ç† fallback ç†”æ–­é€»è¾‘)</span><br><span class="line"></span><br><span class="line">A1--æ‰«æ FeignClient æ³¨è§£, æ³¨å…¥--&gt;A2</span><br><span class="line"></span><br><span class="line">A3--è¢« controller è°ƒç”¨, è§¦å‘--&gt;A4</span><br><span class="line"></span><br><span class="line">A5--æ³¨å…¥äº†ä¸€ä¸ª--&gt;A6</span><br><span class="line">A2--è°ƒç”¨--&gt;A6</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">A6--çš„ build æ–¹æ³•åˆ›å»ºä¸€ä¸ª--&gt;A7</span><br><span class="line">A7--è°ƒç”¨ newInstance æ–¹æ³•åˆ›å»ºäº†å«--&gt;A4</span><br><span class="line">A8--ç”¨æ¥ä»£æ›¿--&gt;A3</span><br><span class="line">A4--çš„--&gt;A8</span><br><span class="line"></span><br><span class="line">A4--è°ƒç”¨--&gt;A9</span><br><span class="line">A9--ç„¶å--&gt;B1</span><br></pre></td></tr></table></figure>





<p><img src="https://gitee.com/gudqs7/many-images/raw/master/Mac-PicGo/20210130163421.png" alt="image-20210130163418057"></p>
<h3 id="æ•´åˆ-FeignCircuitBreaker-Builder-æ­¥éª¤"><a href="#æ•´åˆ-FeignCircuitBreaker-Builder-æ­¥éª¤" class="headerlink" title="æ•´åˆ FeignCircuitBreaker.Builder æ­¥éª¤"></a>æ•´åˆ FeignCircuitBreaker.Builder æ­¥éª¤</h3><blockquote>
<p>å³ä¸æ³¨å…¥è‡ªå·±çš„ Builder, ä½¿ç”¨ openfeign æä¾›çš„ Builder, é€šè¿‡æ‰©å±• CircuitBreakerFactory(å³æ‰©å±• CircuitBreaker) æ¥å®ç°æµæ§é™çº§(å€’æ˜¯ fallback çš„å¤„ç†ä¾¿è½»æ¾äº†ä¸å°‘)</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.åœ¨ SentinelCircuitBreakerAutoConfiguration æ³¨å…¥ä¸€ä¸ª CircuitBreakerFactory.</span><br><span class="line">2.åœ¨ Openfeign ä¸­, ä¼šè°ƒç”¨å…¶ create() åˆ›å»ºå¾—åˆ°ä¸€ä¸ª CircuitBreaker (å³ SentinelCircuitBreaker)</span><br><span class="line">3.æ¥ç€ä¼šåœ¨ FeignCircuitBreakerInvocationHandler.invoke() ä¸­è·å–è¿™ä¸ª CircuitBreaker, è°ƒç”¨å…¶ run() å°†è¦æ‰§è¡Œçš„ method äº¤ç»™ SentinelCircuitBreaker æ¥å¤„ç†.</span><br><span class="line">4.SentinelCircuitBreaker ä¸­ run() çš„å®ç°å°±æ˜¯ç®€å•çš„ SphU.entry() æ¥åŒ…è£…æ–¹æ³•ä¸ºèµ„æºè¿›è¡Œæµæ§é™çº§, è‡³äº fallback åˆ™ç›´æ¥è°ƒç”¨ apply äº¤ç”± Openfeign å¤„ç†.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“: ä¸å†™è‡ªå·±çš„ Builder, ç®€å•å¤šäº†! ä¸»è¦æ˜¯å»æ‰äº† fallback ç›¸å…³é…ç½®çš„è·å–ä¸å¤„ç†.</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://gudqs7.github.io/2021/01/29/source-code-spring-cloud-server-discover-and-register/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="gudqs7">
      <meta itemprop="description" content="å¿ƒç´¯æ²¡é’±èººå°¸ä¸­">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="gudqs7's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/29/source-code-spring-cloud-server-discover-and-register/" class="post-title-link" itemprop="url">Spring Cloud æœåŠ¡æ³¨å†Œä¸å‘ç°æºç ç¬”è®° (Nacos/Consul/Eureka)</a>
        </h2>

        <div class="post-meta">
			
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-01-29 13:21:23" itemprop="dateCreated datePublished" datetime="2021-01-29T13:21:23+08:00">2021-01-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-01-30 00:11:56" itemprop="dateModified" datetime="2021-01-30T00:11:56+08:00">2021-01-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SourceCode/" itemprop="url" rel="index"><span itemprop="name">SourceCode</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring-Cloud/" itemprop="url" rel="index"><span itemprop="name">Spring Cloud</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/2021/01/29/source-code-spring-cloud-server-discover-and-register/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/01/29/source-code-spring-cloud-server-discover-and-register/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Spring-Cloud-æœåŠ¡æ³¨å†Œä¸å‘ç°æºç ç¬”è®°-Nacos-Consul-Eureka"><a href="#Spring-Cloud-æœåŠ¡æ³¨å†Œä¸å‘ç°æºç ç¬”è®°-Nacos-Consul-Eureka" class="headerlink" title="Spring Cloud æœåŠ¡æ³¨å†Œä¸å‘ç°æºç ç¬”è®° (Nacos/Consul/Eureka)"></a>Spring Cloud æœåŠ¡æ³¨å†Œä¸å‘ç°æºç ç¬”è®° (Nacos/Consul/Eureka)</h1><h2 id="Eureka"><a href="#Eureka" class="headerlink" title="Eureka"></a>Eureka</h2><h3 id="å…³é”®ç±»"><a href="#å…³é”®ç±»" class="headerlink" title="å…³é”®ç±»"></a>å…³é”®ç±»</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æœåŠ¡æ³¨å†Œ</span></span><br><span class="line">1.EurekaClientAutoConfiguration</span><br><span class="line">	æ³¨å†Œäº†ä¼—å¤šçš„ bean</span><br><span class="line">	ä¸€éƒ¨åˆ†ç”¨äºå’Œ Eureka Server äº¤äº’</span><br><span class="line">	ä¸€éƒ¨åˆ†å’Œ Commons é¡¹ç›®å¯¹æ¥</span><br><span class="line">	æ³¨å†Œäº†(EurekaClient/EurekaAutoServiceRegistration/ApplicationInfoManager/EurekaRegistration)</span><br><span class="line">	   </span><br><span class="line">2.EurekaClient</span><br><span class="line">	ä¸ Eureka Server ç«¯äº¤äº’</span><br><span class="line">	è´Ÿè´£å‘ Eureka Server ç«¯æ³¨å†Œ/æ³¨é”€æœåŠ¡å®ä¾‹</span><br><span class="line">	åœ¨æ„é€ æ–¹æ³•å’Œ shutdown æ–¹æ³•ä¸­æ ¹æ®é…ç½®å¤„ç†è‡ªåŠ¨æ³¨å†Œå’Œè‡ªåŠ¨æ³¨é”€.</span><br><span class="line"></span><br><span class="line">3.InstanceInfoReplicator</span><br><span class="line">	è´Ÿè´£å®šä¹‰ä¸€ä¸ªæ³¨å†Œæˆ–æ›´æ–°æœåŠ¡å®ä¾‹çš„ä»»åŠ¡</span><br><span class="line">	è´Ÿè´£ç®¡ç†ä»»åŠ¡æ‰§è¡Œå™¨</span><br><span class="line"></span><br><span class="line">4.RestTemplateEurekaHttpClient</span><br><span class="line">	è´Ÿè´£æ ¹æ®æœåŠ¡å®ä¾‹ä¿¡æ¯æ„é€ æ³¨å†Œ/æ³¨é”€çš„ Http è¯·æ±‚</span><br><span class="line">	ä½¿ç”¨ RestTemplate å‘é€è¯·æ±‚</span><br><span class="line">	</span><br><span class="line">5.EurekaAutoServiceRegistration</span><br><span class="line">	è´Ÿè´£ç®¡ç†æœåŠ¡å®ä¾‹çš„è‡ªåŠ¨æ³¨å†Œ/æ³¨é”€, ä¸å®¹å™¨ç”Ÿå‘½å‘¨æœŸæŒ‚é’©</span><br><span class="line"></span><br><span class="line">6.ApplicationInfoManager</span><br><span class="line">	è´Ÿè´£ç®¡ç†æœåŠ¡å®ä¾‹çŠ¶æ€å˜æ›´äº‹ä»¶(å³ç®¡ç†ç›‘å¬è€…å¹¶åœ¨é€‚å½“æ—¶æœºè§¦å‘ä»–ä»¬)</span><br><span class="line"></span><br><span class="line">7.ApplicationInfoManager.StatusChangeListener</span><br><span class="line">	çŠ¶æ€æ”¹å˜äº‹ä»¶ç›‘å¬è€…ç±»</span><br><span class="line">	</span><br><span class="line">8.EurekaHealthCheckHandler</span><br><span class="line">	æœåŠ¡å®ä¾‹çŠ¶æ€å¥åº·æ£€æŸ¥ç±», æ³¨å†Œ/æ³¨é”€æœåŠ¡å®ä¾‹å‰ä¼šè°ƒç”¨æ­¤ç±»è¿›è¡Œæ£€æŸ¥å…¶çŠ¶æ€</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æœåŠ¡å‘ç°</span></span><br><span class="line">1.BlockingLoadBalancer (Commons é¡¹ç›®ä¸Š)</span><br><span class="line">	è´Ÿè´£è°ƒç”¨å®é™…çš„è´Ÿè½½å‡è¡¡å™¨å»é€‰æ‹©ä¸€ä¸ªæœåŠ¡å®ä¾‹</span><br><span class="line">	è´Ÿè´£è°ƒåº¦è´Ÿè½½å‡è¡¡æ•´ä¸ªè¿‡ç¨‹, è§¦å‘ç›¸åº”çš„ç”Ÿå‘½å‘¨æœŸ.</span><br><span class="line">	</span><br><span class="line">2.RoundRobinLoadBalancer (Commons é¡¹ç›®ä¸Š)</span><br><span class="line">	å®é™…çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ç®—æ³•ç±»</span><br><span class="line">	è´Ÿè´£è¿æ¥ ServiceInstanceListSupplier ä»å…¶ä¸­è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">3.ServiceInstanceListSupplier</span><br><span class="line">	å®šä¹‰äº†è·å–æœåŠ¡å®ä¾‹å®ä¾‹åˆ—è¡¨çš„æ¥å£(ä»»æ„æ–¹å¼)</span><br><span class="line"></span><br><span class="line">4.DiscoveryClient</span><br><span class="line">	å®šä¹‰äº†ä»æœåŠ¡ç«¯è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨çš„æ¥å£(æ›´æ˜ç¡®äº†)</span><br><span class="line"></span><br><span class="line">4.DiscoveryClientServiceInstanceListSupplier</span><br><span class="line">	ServiceInstanceListSupplier çš„å®ç°ç±»</span><br><span class="line">	è¿æ¥ ReactiveDiscoveryClient ç±», å°†æœåŠ¡ç«¯è·å–é“å¾·æœåŠ¡å®ä¾‹åˆ—è¡¨è¿”å›å‡ºå»</span><br><span class="line">	</span><br><span class="line">5.EurekaDiscoveryClient</span><br><span class="line">	å®ç°äº† DiscoveryClient æ¥å£</span><br><span class="line">	è´Ÿè´£è°ƒç”¨ EurekaClient ä» Eureka Server ç«¯è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨.</span><br><span class="line"></span><br><span class="line">6.EurekaClient</span><br><span class="line">	ä¸ Eureka Server ç«¯äº¤äº’</span><br><span class="line">	è´Ÿè´£å‘ Eureka Server ç«¯è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨</span><br><span class="line">	åœ¨æ„é€ æ–¹æ³•å’Œ shutdown æ–¹æ³•ä¸­æ ¹æ®é…ç½®å¤„ç†è‡ªåŠ¨æ³¨å†Œå’Œè‡ªåŠ¨æ³¨é”€.</span><br><span class="line"></span><br><span class="line">7.EurekaServiceInstance</span><br><span class="line">	æœåŠ¡å®ä¾‹ä¿¡æ¯å¯¹è±¡</span><br><span class="line">	å®ç° ServiceInstance, ä¸ Commons å¯¹æ¥</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ€»ç»“</span></span><br><span class="line">å®ç°äº† Commons çš„ DiscoveryClient æ¥å£(å³ EurekaDiscoveryClient), äºæ˜¯æœåŠ¡å‘ç°å®ç°äº†;</span><br><span class="line">å®ç°äº† Commons çš„ ServiceRegisty æ¥å£(å³ EurekaServiceRegistry), äºæ˜¯æœåŠ¡æ³¨å†Œä¹Ÿå®ç°äº†.</span><br><span class="line">å†æ€»ç»“: Commons å¤§å‘å¥½.</span><br></pre></td></tr></table></figure>





<h3 id="æœåŠ¡æ³¨å†Œæµç¨‹"><a href="#æœåŠ¡æ³¨å†Œæµç¨‹" class="headerlink" title="æœåŠ¡æ³¨å†Œæµç¨‹"></a>æœåŠ¡æ³¨å†Œæµç¨‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EurekaClient æ„é€ æ–¹æ³•è§¦å‘(å‰æ shouldRegisterWithEureka ä¸º true)</span></span><br><span class="line">1.EurekaClientAutoConfiguration è®©å®¹å™¨é‡Œæ³¨å†Œäº†ä¸€ä¸ª EurekaClient</span><br><span class="line">2.EurekaClient è¿™ä¸ªç±»åœ¨æ„é€ æ–¹æ³•ä¸­çš„ initScheduledTasks() ç”Ÿæˆäº†ä¸€ä¸ª InstanceInfoReplicator å¯¹è±¡</span><br><span class="line">3.ç„¶åè°ƒç”¨å…¶ instanceInfoReplicator.start(), é€»è¾‘æ˜¯æ·»åŠ ä¸€ä¸ªå®šæ—¶ä»»åŠ¡(ä»…æ‰§è¡Œä¸€æ¬¡), å®šæ—¶ä»»åŠ¡æ‰§è¡Œ run()</span><br><span class="line">4.run() é‡Œé¢ä¼šæ‰§è¡Œ discoveryClient.register() ä¹Ÿå°±æ˜¯æ³¨å†Œå®ä¾‹ä¿¡æ¯åˆ° Eureka ä¸Šå».</span><br><span class="line">5.register() é‡Œé¢ä¼šè°ƒç”¨ RestTemplateEurekaHttpClient<span class="comment">#register() </span></span><br><span class="line">6.è¿™ä¸ªæ–¹æ³•æ˜¯æ„é€ ä¸€ä¸ª HTTP è¯·æ±‚, åœ°å€ä¸º serviceUrl + <span class="string">"apps/"</span> + info.getAppName(), Method ä¸º POST, å³ Eureka server çš„ip/apps/æœåŠ¡å®ä¾‹åç§°(å¦‚spring.application.name), å½“ç„¶è¯·æ±‚ body è¿˜ä¼šå¸¦ä¸Šå®ä¾‹ä¿¡æ¯ info å¯¹è±¡.</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ¹æ®å®¹å™¨ç”Ÿå‘½å‘¨æœŸè§¦å‘</span></span><br><span class="line">1.EurekaClientAutoConfiguration è®©å®¹å™¨é‡Œæ³¨å†Œäº†ä¸€ä¸ª EurekaAutoServiceRegistration.</span><br><span class="line">2.è¿™ä¸ªç±»å³æ˜¯ SmartLifecycle(ä¸å®¹å™¨ç”Ÿå‘½å‘¨æœŸç»‘å®š), ä¹Ÿæ˜¯ SmartApplicationListener(ç›‘å¬å®¹å™¨åŠ è½½/å…³é—­äº‹ä»¶)</span><br><span class="line">3.å› æ­¤å…¶å¯¹åº”çš„ start()/stop() å’Œ onApplicationEvent() éƒ½å®ç°äº†å¯¹åº”çš„é€»è¾‘.</span><br><span class="line">4.å¦‚ start() çš„é€»è¾‘ä¸ºè°ƒç”¨ EurekaServiceRegistry<span class="comment">#register()</span></span><br><span class="line">5.register() å…ˆä¿®æ”¹æœ¬åœ°æœåŠ¡å®ä¾‹çš„è£…å¡«, å†é€šè¿‡ com.netflix.discovery.DiscoveryClient<span class="comment">#registerHealthCheck() æ¥å¾€ä»»åŠ¡ç®¡ç†å™¨ä¸­æäº¤ä¸€ä¸ªä»»åŠ¡, åå°æ‰§è¡Œ, ä»»åŠ¡ InstanceInfoReplicator#onDemandUpdate()</span></span><br><span class="line">6.æ­¤ä»»åŠ¡å°±æ˜¯æœ€ç»ˆä¹Ÿä¼šè°ƒç”¨å‰é¢æåˆ°çš„ (4) ä¸­çš„ run(). ç„¶åå°±æ³¨å†Œä¸Šå»äº†.</span><br><span class="line"></span><br><span class="line"><span class="comment"># PS</span></span><br><span class="line">(6) ä¸­çš„ä»»åŠ¡, ä¸çŠ¶æ€ç›‘å¬æ˜¯ä¸€è‡´çš„</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“: å®¹å™¨æ³¨å†Œ EurekaClient, è°ƒç”¨æ„é€ æ–¹æ³•å®Œæˆå¤§é‡åˆå§‹åŒ–å·¥ä½œå, å¦èµ·ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ restTemplate å‘é€ HTTP è¯·æ±‚å°†å½“å‰æœåŠ¡å®ä¾‹ä¿¡æ¯å‘é€ç»™ Eureka server. å®ŒæˆæœåŠ¡æ³¨å†Œå·¥ä½œ.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line"></span><br><span class="line">A(EurekaClientAutoConfiguration)</span><br><span class="line">A1(EurekaClient)</span><br><span class="line">A2(InstanceInfoReplicator)</span><br><span class="line">A3(EurekaClient#register)</span><br><span class="line">A4(RestTemplateEurekaHttpClient)</span><br><span class="line">A5(RestTemplate)</span><br><span class="line">A6(Eureka Server)</span><br><span class="line">A7(EurekaHttpResponse)</span><br><span class="line"></span><br><span class="line">A--è®©å®¹å™¨é‡Œæ³¨å†Œä¸€ä¸ª--&gt;A1</span><br><span class="line">A1--åœ¨æ„é€ æ–¹æ³•ä¸­ç”Ÿæˆä¸€ä¸ª--&gt;A2</span><br><span class="line">A2--åœ¨ run æ–¹æ³•ä¸­è°ƒç”¨--&gt;A3</span><br><span class="line">A3--åˆæŠŠæœåŠ¡å®ä¾‹ä¿¡æ¯äº¤ç»™--&gt;A4</span><br><span class="line">A4--æ ¹æ®æœåŠ¡å®ä¾‹ä¿¡æ¯æ„é€ HTTPè¯·æ±‚--&gt;A5</span><br><span class="line">A5--å°†æœåŠ¡å®ä¾‹ä¿¡æ¯å‘é€ç»™--&gt;A6</span><br><span class="line">A6--è¿”å›ä¸€ä¸ª--&gt;A7</span><br></pre></td></tr></table></figure>



<p><img src="https://gitee.com/gudqs7/many-images/raw/master/Mac-PicGo/20210129172741.png" alt="image-20210129171345329"></p>
<h3 id="æœåŠ¡æ³¨é”€æµç¨‹"><a href="#æœåŠ¡æ³¨é”€æµç¨‹" class="headerlink" title="æœåŠ¡æ³¨é”€æµç¨‹"></a>æœåŠ¡æ³¨é”€æµç¨‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®¹å™¨å…³é—­(é…ç½®äº†å®¹å™¨ shouldUnregisterOnShutdown=true)</span></span><br><span class="line">1.åœ¨ DiscoveryClient<span class="comment">#shutdown() ä¸­æ ¹æ® shouldUnregisterOnShutdown åˆ¤æ–­æ˜¯å¦éœ€è¦æ³¨é”€</span></span><br><span class="line">2.ç„¶ååœ¨ unregister() ä¸­è°ƒç”¨ RestTemplateEurekaHttpClient<span class="comment">#cancel() </span></span><br><span class="line">3.cancel() ä¸­ä½¿ç”¨ restTemplate æ„é€  Method ä¸º DELETE, URL ä¸º serviceUrl + <span class="string">"apps/"</span> + appName + <span class="string">'/'</span> + id çš„è¯·æ±‚å¹¶å‘é€ç»™ Eureka server å‘ŠçŸ¥å…¶æ³¨é”€ appName ä¸‹å¯¹åº”çš„æœåŠ¡å®ä¾‹(æ ¹æ® id).</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¥æ”¶åˆ°å®¹å™¨å…³é—­äº‹ä»¶</span></span><br><span class="line">1.EurekaClientAutoConfiguration è®©å®¹å™¨é‡Œæ³¨å†Œäº†ä¸€ä¸ª EurekaAutoServiceRegistration.</span><br><span class="line">2.è¿™ä¸ªç±»å³æ˜¯ SmartLifecycle(ä¸å®¹å™¨ç”Ÿå‘½å‘¨æœŸç»‘å®š), ä¹Ÿæ˜¯ SmartApplicationListener(ç›‘å¬å®¹å™¨åŠ è½½/å…³é—­äº‹ä»¶)</span><br><span class="line">3.å› æ­¤å…¶å¯¹åº”çš„ start()/stop() å’Œ onApplicationEvent() éƒ½å®ç°äº†å¯¹åº”çš„é€»è¾‘.</span><br><span class="line">4.å¦‚ stop() çš„é€»è¾‘ä¸ºè°ƒç”¨ EurekaServiceRegistry<span class="comment">#deregister()</span></span><br><span class="line">5.deregister() çš„ä½œç”¨æ˜¯æ‰§è¡Œ ApplicationInfoManager<span class="comment">#setInstanceStatus() å°†çŠ¶æ€æ”¹ä¸º DOWN</span></span><br><span class="line">6.å› ä¸º ApplicationInfoManager è¿™ä¸ªç±»ä¸“é—¨ç®¡ç†çŠ¶æ€å˜åŒ–äº‹ä»¶, å› æ­¤è¿˜ä¼šå°†äº‹ä»¶å‘å¸ƒå‡ºå». </span><br><span class="line">7.è€Œåœ¨ initScheduledTasks ä¸­å°±æ·»åŠ äº†è¿™æ ·çš„ä¸€ä¸ªç›‘å¬è€…, èµ·ä½œç”¨ä¸ºè°ƒç”¨ InstanceInfoReplicator<span class="comment">#onDemandUpdate()</span></span><br><span class="line">8.æ¥ç€ä¼šè°ƒç”¨ InstanceInfoReplicator<span class="comment">#run(), ç¬¬ä¸€è¡Œä»£ç  refreshInstanceInfo() ä¼šç¡®ä¿çŠ¶æ€ä¸ºæœ€æ–°çš„(é‚£ä¹Ÿè¿˜æ˜¯ DOWN)</span></span><br><span class="line">9.ä½†æ˜¯å…¶æœ€ç»ˆå¹¶ä¸æ˜¯è°ƒç”¨ cancel æ³¨é”€, è€Œ register æ³¨å†Œ, ä¸è¿‡å…¶ä¸­çš„çŠ¶æ€æ˜¯ DOWN, å› æ­¤ä¼šæœ‰ server é‚£è¾¹åˆ¤æ–­; æ‰€ä»¥å®¹å™¨å…³é—­äº‹ä»¶å¹¶ä¸ä¼šè§¦å‘ cancel, ä½†æ•ˆæœåº”æ˜¯ä¸€æ ·çš„.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“: è¦ä¹ˆæ˜¯ shutdown() ä¸­ unregister è°ƒç”¨äº† cancel(), å‘å‡ºäº† Method ä¸º DELETE çš„è¯·æ±‚æ¥æ³¨é”€; è¦ä¹ˆå°±æ˜¯ EurekaClientAutoConfiguration ä¸­ä¸å®¹å™¨ç”Ÿå‘½å‘¨æœŸåšå…³è”, å…¨ç¨‹ä½¿ç”¨ register æ¥å£æ¥æ›´æ–°çŠ¶æ€.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line"></span><br><span class="line">A(å®¹å™¨å…³é—­#close)</span><br><span class="line">A1(DiscoveryClient#shutdown)</span><br><span class="line">A2(DiscoveryClient#unregister)</span><br><span class="line">A3(RestTemplateEurekaHttpClient#cancel)</span><br><span class="line">A4(RestTemplate)</span><br><span class="line">A5(Eureka Server) </span><br><span class="line"></span><br><span class="line">A--è§¦å‘--&gt;A1</span><br><span class="line">A1--è°ƒç”¨--&gt;A2</span><br><span class="line">A2--è°ƒç”¨--&gt;A3</span><br><span class="line">A3--æ„é€ HTTPè¯·æ±‚äº¤ç»™--&gt;A4</span><br><span class="line">A4--å‘é€æ³¨é”€ç”³è¯·ç»™--&gt;A5</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/gudqs7/many-images/raw/master/Mac-PicGo/20210129171241.png" alt="image-20210129171237603"></p>
<h3 id="æœåŠ¡å‘ç°æµç¨‹"><a href="#æœåŠ¡å‘ç°æµç¨‹" class="headerlink" title="æœåŠ¡å‘ç°æµç¨‹"></a>æœåŠ¡å‘ç°æµç¨‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.Spring Cloud Commons ä¸­æ³¨å†Œäº†ä¸€ä¸ª ServiceInstanceListSupplier, å…·ä½“ä¸º(DiscoveryClientServiceInstanceListSupplier)</span><br><span class="line">2.è¿™ä¸ªç±»çš„ä½œç”¨æ˜¯å€ŸåŠ© ReactiveDiscoveryClient çš„ getInstances(String serviceId) æ–¹æ³•å‘ LoadBalancer æä¾›ä»å…·ä½“çš„ server(å¦‚Eureka) è·å–æœåŠ¡å®ä¾‹å¯¹è±¡åˆ—è¡¨, è¿™æ ·åªè¦å®ç° ReactiveDiscoveryClient å¹¶æ”¾å…¥å®¹å™¨å°±å¯ä»¥å’Œ Spring cloud LoadBalancer å¯¹æ¥äº†.</span><br><span class="line">3.åœ¨ EurekaDiscoveryClientConfiguration ä¸­è®©å®¹å™¨æ³¨å†Œäº†ä¸€ä¸ª DiscoveryClient(å…·ä½“ä¸º EurekaDiscoveryClient).</span><br><span class="line">4.å› ä¸º Spring Cloud Commons åšäº†å¤§é‡çš„é¢„å¤‡å¯¹æ¥å·¥ä½œ, æ‰€ä»¥å¯¹æ¥å…¶å®å°±ç»“æŸäº†.</span><br><span class="line">5.é‚£å†ç®€å•è¯´ä¸‹ EurekaDiscoveryClient çš„å®ç°, å³æ³¨å…¥ä¸€ä¸ª EurekaClient eurekaClient, ç„¶åè°ƒç”¨ DiscoveryClient<span class="comment">#getInstancesByVipAddress() å°±è·å–åˆ°äº† ServiceInstance åˆ—è¡¨.</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“: Commons ä¸­å‡†å¤‡å¥½äº†å¯¹æ¥çš„æ–¹å¼: å®ç° DiscoveryClient æ¥å£, æ¥ç€æˆ‘ä»¬çš„ç¡®å®ç°äº† DiscoveryClient æ¥å£, å³ EurekaDiscoveryClient, è€Œè¿™è¿™ä¸ªç±»åˆ™ä¼šè°ƒç”¨ EurekaClient çš„ getInstancesByVipAddress ä» Eureka Server ç«¯è·å–æ³¨å†Œäº†çš„æœåŠ¡å®ä¾‹ä¿¡æ¯.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line"></span><br><span class="line">A1(BlockingLoadBalancerClient#ä½äºCommonsé¡¹ç›®)</span><br><span class="line">A2(RoundRobinLoadBalancer#ä½äºCommonsé¡¹ç›®)</span><br><span class="line">A4(LoadBalancerClientConfiguration#ä½äºCommonsé¡¹ç›®)</span><br><span class="line">A5(DiscoveryClientServiceInstanceListSupplier)</span><br><span class="line">A6(EurekaDiscoveryClient#getInstances)</span><br><span class="line">A7(EurekaClient#getInstancesByVipAddress)</span><br><span class="line">A9(Eureka Server)</span><br><span class="line">A8(ServiceInstance é›†åˆ)</span><br><span class="line"></span><br><span class="line">A1--choose æ–¹æ³•è°ƒç”¨--&gt;A2</span><br><span class="line">A2--choose æ–¹æ³•è°ƒç”¨--&gt;A5</span><br><span class="line">A4--æ³¨å…¥ä¸€ä¸ª--&gt;A5</span><br><span class="line">A5--è°ƒç”¨--&gt;A6</span><br><span class="line">A6--è°ƒç”¨--&gt;A7</span><br><span class="line">A7--ä»--&gt;A9</span><br><span class="line">A9--è·å–--&gt;A8</span><br><span class="line">A10(EurekaDiscoveryClientConfiguration)--æ³¨å…¥ä¸€ä¸ª--&gt;A6</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/gudqs7/many-images/raw/master/Mac-PicGo/20210129233856.png" alt="image-20210129233854498"></p>
<h2 id="Consul"><a href="#Consul" class="headerlink" title="Consul"></a>Consul</h2><h3 id="å…³é”®ç±»-1"><a href="#å…³é”®ç±»-1" class="headerlink" title="å…³é”®ç±»"></a>å…³é”®ç±»</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æœåŠ¡æ³¨å†Œ</span></span><br><span class="line">1.ConsulAutoServiceRegistrationAutoConfiguration</span><br><span class="line">	è´Ÿè´£æ·»åŠ è‡ªåŠ¨æ³¨å†Œ/æ³¨é”€ç›¸å…³çš„ bean</span><br><span class="line">	æ³¨å†Œäº† ConsulAutoServiceRegistration/ConsulAutoServiceRegistrationListener/ConsulAutoRegistration</span><br><span class="line">	</span><br><span class="line">2.ConsulServiceRegistryAutoConfiguration</span><br><span class="line">	è´Ÿè´£æ³¨å†ŒæœåŠ¡æ³¨å†Œç›¸å…³çš„ bean</span><br><span class="line">	æ³¨å†Œäº† ConsulServiceRegistry</span><br><span class="line">	</span><br><span class="line">3.ConsulDiscoveryClientConfiguration</span><br><span class="line">	è´Ÿè´£æ³¨å†ŒæœåŠ¡å‘ç°ç›¸å…³çš„ bean</span><br><span class="line">	æ³¨å†Œäº† ConsulDiscoveryClient</span><br><span class="line">	</span><br><span class="line">4.ConsulServiceRegistry</span><br><span class="line">	è´Ÿè´£ä¸ ConsulClient å¯¹æ¥, å†æä¾›æ³¨å†Œ/æ³¨é”€åŠŸèƒ½</span><br><span class="line"></span><br><span class="line">5.ConsulClient</span><br><span class="line">	ä¸ Consul Server ç«¯äº¤äº’</span><br><span class="line">	è´Ÿè´£å‘ Consul Server ç«¯æ³¨å†Œ/æ³¨é”€æœåŠ¡å®ä¾‹</span><br><span class="line"></span><br><span class="line">6.AgentConsulClient</span><br><span class="line">	è´Ÿè´£æ ¹æ®æœåŠ¡å®ä¾‹ä¿¡æ¯æ„é€ æ³¨å†Œ/æ³¨é”€çš„ Http è¯·æ±‚</span><br><span class="line">	</span><br><span class="line">7.ConsulAutoServiceRegistration/ConsulAutoServiceRegistrationListener</span><br><span class="line">	è´Ÿè´£ç®¡ç†æœåŠ¡å®ä¾‹çš„è‡ªåŠ¨æ³¨å†Œ/æ³¨é”€, ä¸å®¹å™¨ç”Ÿå‘½å‘¨æœŸæŒ‚é’©</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æœåŠ¡å‘ç°</span></span><br><span class="line">1.BlockingLoadBalancer (Commons é¡¹ç›®ä¸Š)</span><br><span class="line">	è´Ÿè´£è°ƒç”¨å®é™…çš„è´Ÿè½½å‡è¡¡å™¨å»é€‰æ‹©ä¸€ä¸ªæœåŠ¡å®ä¾‹</span><br><span class="line">	è´Ÿè´£è°ƒåº¦è´Ÿè½½å‡è¡¡æ•´ä¸ªè¿‡ç¨‹, è§¦å‘ç›¸åº”çš„ç”Ÿå‘½å‘¨æœŸ.</span><br><span class="line">	</span><br><span class="line">2.RoundRobinLoadBalancer (Commons é¡¹ç›®ä¸Š)</span><br><span class="line">	å®é™…çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ç®—æ³•ç±»</span><br><span class="line">	è´Ÿè´£è¿æ¥ ServiceInstanceListSupplier ä»å…¶ä¸­è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">3.ServiceInstanceListSupplier</span><br><span class="line">	å®šä¹‰äº†è·å–æœåŠ¡å®ä¾‹å®ä¾‹åˆ—è¡¨çš„æ¥å£(ä»»æ„æ–¹å¼)</span><br><span class="line"></span><br><span class="line">4.DiscoveryClient</span><br><span class="line">	å®šä¹‰äº†ä»æœåŠ¡ç«¯è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨çš„æ¥å£(æ›´æ˜ç¡®äº†)</span><br><span class="line"></span><br><span class="line">4.DiscoveryClientServiceInstanceListSupplier</span><br><span class="line">	ServiceInstanceListSupplier çš„å®ç°ç±»</span><br><span class="line">	è¿æ¥ ReactiveDiscoveryClient ç±», å°†æœåŠ¡ç«¯è·å–é“å¾·æœåŠ¡å®ä¾‹åˆ—è¡¨è¿”å›å‡ºå»</span><br><span class="line">	</span><br><span class="line">5.ConsulDiscoveryClient</span><br><span class="line">	å®ç°äº† DiscoveryClient æ¥å£</span><br><span class="line">	è´Ÿè´£è°ƒç”¨ ConsulClient ä» Consul Server ç«¯è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨.</span><br><span class="line"></span><br><span class="line">6.ConsulClient</span><br><span class="line">	ä¸ Consul Server ç«¯äº¤äº’</span><br><span class="line">	è´Ÿè´£å‘ Consul Server ç«¯è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">7.ConsulServiceInstance</span><br><span class="line">	æœåŠ¡å®ä¾‹ä¿¡æ¯å¯¹è±¡</span><br><span class="line">	å®ç° ServiceInstance, ä¸ Commons å¯¹æ¥</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ€»ç»“</span></span><br><span class="line">å®ç°äº† Commons çš„ DiscoveryClient æ¥å£(å³ ConsulDiscoveryClient), äºæ˜¯æœåŠ¡å‘ç°å®ç°äº†;</span><br><span class="line">å®ç°äº† Commons çš„ ServiceRegisty æ¥å£(å³ ConsulServiceRegistry), äºæ˜¯æœåŠ¡æ³¨å†Œä¹Ÿå®ç°äº†.</span><br><span class="line">å†æ€»ç»“: Commons å¤§å‘å¥½.</span><br></pre></td></tr></table></figure>

<h3 id="æœåŠ¡æ³¨å†Œæµç¨‹-1"><a href="#æœåŠ¡æ³¨å†Œæµç¨‹-1" class="headerlink" title="æœåŠ¡æ³¨å†Œæµç¨‹"></a>æœåŠ¡æ³¨å†Œæµç¨‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.ConsulAutoServiceRegistration è°ƒç”¨ org.springframework.cloud.consul.serviceregistry.ConsulServiceRegistry<span class="comment">#register() å®Œæˆæ³¨å†Œ</span></span><br><span class="line">2.æ¥ç€ register() è°ƒç”¨ ConsulClient<span class="comment">#agentServiceRegister()</span></span><br><span class="line">3.ç„¶åä¼šè°ƒç”¨ AgentConsulClient<span class="comment">#agentServiceRegister()</span></span><br><span class="line">4.ç”Ÿæˆå¹¶å‘é€è¯·æ±‚, è¯·æ±‚åœ°å€ä¸º /v1/agent/service/register</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“: å…¶å®å’Œ Eureka å·®ä¸å¤š, åªæ˜¯æˆ‘è·³è¿‡äº†ä¸€ç‚¹ç‚¹ç»†èŠ‚. åŸºæœ¬æ˜¯å°±æ˜¯ ä¸ ServiceRegistry äº¤äº’äº†, éå¸¸çš„é…åˆ Commons é¡¹ç›®, å°±åƒä¸€ä¸ªäººå†™çš„ä¸€æ ·â€¦</p>
</blockquote>
<h3 id="æœåŠ¡å‘ç°æµç¨‹-1"><a href="#æœåŠ¡å‘ç°æµç¨‹-1" class="headerlink" title="æœåŠ¡å‘ç°æµç¨‹"></a>æœåŠ¡å‘ç°æµç¨‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.é¦–å…ˆæ˜¯ DiscoveryClientServiceInstanceListSupplier ä¼šè°ƒç”¨ ConsulDiscoveryClient<span class="comment">#getInstances()</span></span><br><span class="line">2.æ¥ç€ getInstances() ä¼šè°ƒç”¨ ConsulClient<span class="comment">#getHealthServices()</span></span><br><span class="line">3.ç„¶åå°±æ˜¯å‘é€ HTTP è¯·æ±‚äº†, è¯·æ±‚åœ°å€ä¸º /v1/health/service/, è¿”å›çš„å¯¹è±¡å°è£…å¤„ç†ä¸‹å¾—åˆ° ServiceInstance çš„å®ç°ç±» ConsulServiceInstance.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“: è¿™æ¬¡çœŸçš„æ˜¯å’Œ Eureka ç±»ä¼¼, ä» Commons åˆ° ConsulDiscoveryClient, æµç¨‹æ˜¯ä¸€æ ·çš„. è€Œå…¶å® ConsulDiscoveryClient çš„é€»è¾‘ä¹Ÿå’Œ EurekaDiscoverClient ç±»ä¼¼â€¦ åªèƒ½è¯´å…¶å®æœåŠ¡æ³¨å†Œå‘ç°è¿™ä¸ªæ¡†æ¶, æˆ‘ä»¬å…³æ³¨çš„åŠŸèƒ½å…¶å®å¹¶ä¸æ˜¯éš¾ç‚¹. éš¾ç‚¹æ˜¯ server ç«¯çš„ç®¡ç†.</p>
</blockquote>
<h2 id="Nacos"><a href="#Nacos" class="headerlink" title="Nacos"></a>Nacos</h2><h3 id="å…³é”®ç±»-2"><a href="#å…³é”®ç±»-2" class="headerlink" title="å…³é”®ç±»"></a>å…³é”®ç±»</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æœåŠ¡æ³¨å†Œ</span></span><br><span class="line">1.NacosServiceRegistryAutoConfiguration</span><br><span class="line">	è´Ÿè´£æ·»åŠ è‡ªåŠ¨æ³¨å†Œ/æ³¨é”€ç›¸å…³çš„ bean</span><br><span class="line">	æ³¨å†Œäº† NacosAutoServiceRegistration/NacosServiceRegistry/NacosRegistration</span><br><span class="line">	</span><br><span class="line">2.NacosDiscoveryClientConfiguration</span><br><span class="line">	è´Ÿè´£æ³¨å†ŒæœåŠ¡å‘ç°ç›¸å…³çš„ bean</span><br><span class="line">	æ³¨å†Œäº† NacosDiscoveryClient</span><br><span class="line">	</span><br><span class="line">3.NacosServiceRegistry</span><br><span class="line">	è´Ÿè´£ä¸ NamingService å¯¹æ¥, å†æä¾›æ³¨å†Œ/æ³¨é”€åŠŸèƒ½</span><br><span class="line"></span><br><span class="line">4.NamingService</span><br><span class="line">	ä¸ Nacos Server ç«¯äº¤äº’</span><br><span class="line">	è´Ÿè´£å‘ Nacos Server ç«¯æ³¨å†Œ/æ³¨é”€æœåŠ¡å®ä¾‹</span><br><span class="line">	è°ƒç”¨ NamingProxy</span><br><span class="line"></span><br><span class="line">5.NamingProxy</span><br><span class="line">	è´Ÿè´£æ ¹æ®æœåŠ¡å®ä¾‹ä¿¡æ¯æ„é€ æ³¨å†Œ/æ³¨é”€çš„ Http è¯·æ±‚</span><br><span class="line">	</span><br><span class="line">6.NacosAutoServiceRegistration</span><br><span class="line">	è´Ÿè´£ç®¡ç†æœåŠ¡å®ä¾‹çš„è‡ªåŠ¨æ³¨å†Œ/æ³¨é”€, ä¸å®¹å™¨ç”Ÿå‘½å‘¨æœŸæŒ‚é’©</span><br><span class="line"></span><br><span class="line">7.NacosRegistration</span><br><span class="line">	æœ¬åœ°å®ä¾‹å¯¹è±¡, ç›¸æ¯”æœåŠ¡å®ä¾‹æ•°æ®æ›´å¤š</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æœåŠ¡å‘ç°</span></span><br><span class="line">1.BlockingLoadBalancer (Commons é¡¹ç›®ä¸Š)</span><br><span class="line">	è´Ÿè´£è°ƒç”¨å®é™…çš„è´Ÿè½½å‡è¡¡å™¨å»é€‰æ‹©ä¸€ä¸ªæœåŠ¡å®ä¾‹</span><br><span class="line">	è´Ÿè´£è°ƒåº¦è´Ÿè½½å‡è¡¡æ•´ä¸ªè¿‡ç¨‹, è§¦å‘ç›¸åº”çš„ç”Ÿå‘½å‘¨æœŸ.</span><br><span class="line">	</span><br><span class="line">2.RoundRobinLoadBalancer (Commons é¡¹ç›®ä¸Š)</span><br><span class="line">	å®é™…çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ç®—æ³•ç±»</span><br><span class="line">	è´Ÿè´£è¿æ¥ ServiceInstanceListSupplier ä»å…¶ä¸­è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">3.ServiceInstanceListSupplier</span><br><span class="line">	å®šä¹‰äº†è·å–æœåŠ¡å®ä¾‹å®ä¾‹åˆ—è¡¨çš„æ¥å£(ä»»æ„æ–¹å¼)</span><br><span class="line"></span><br><span class="line">4.DiscoveryClient</span><br><span class="line">	å®šä¹‰äº†ä»æœåŠ¡ç«¯è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨çš„æ¥å£(æ›´æ˜ç¡®äº†)</span><br><span class="line"></span><br><span class="line">4.DiscoveryClientServiceInstanceListSupplier</span><br><span class="line">	ServiceInstanceListSupplier çš„å®ç°ç±»</span><br><span class="line">	è¿æ¥ ReactiveDiscoveryClient ç±», å°†æœåŠ¡ç«¯è·å–é“å¾·æœåŠ¡å®ä¾‹åˆ—è¡¨è¿”å›å‡ºå»</span><br><span class="line">	</span><br><span class="line">5.NacosDiscoveryClient</span><br><span class="line">	å®ç°äº† DiscoveryClient æ¥å£</span><br><span class="line">	è´Ÿè´£è°ƒç”¨ NamingService ä» Nacos Server ç«¯è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨.</span><br><span class="line"></span><br><span class="line">6.NamingService</span><br><span class="line">	ä¸ Nacos Server ç«¯äº¤äº’</span><br><span class="line">	è´Ÿè´£å‘ Nacos Server ç«¯è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">7.NacosServiceInstance</span><br><span class="line">	æœåŠ¡å®ä¾‹ä¿¡æ¯å¯¹è±¡</span><br><span class="line">	å®ç° ServiceInstance, ä¸ Commons å¯¹æ¥</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ€»ç»“</span></span><br><span class="line">å®ç°äº† Commons çš„ DiscoveryClient æ¥å£(å³ NacosDiscoveryClient), äºæ˜¯æœåŠ¡å‘ç°å®ç°äº†;</span><br><span class="line">å®ç°äº† Commons çš„ ServiceRegisty æ¥å£(å³ ConsulServiceRegistry), äºæ˜¯æœåŠ¡æ³¨å†Œä¹Ÿå®ç°äº†.</span><br><span class="line">å†æ€»ç»“: Commons å¤§å‘å¥½.</span><br></pre></td></tr></table></figure>



<h3 id="æœåŠ¡æ³¨å†Œæµç¨‹-2"><a href="#æœåŠ¡æ³¨å†Œæµç¨‹-2" class="headerlink" title="æœåŠ¡æ³¨å†Œæµç¨‹"></a>æœåŠ¡æ³¨å†Œæµç¨‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.NacosAutoServiceRegistration è°ƒç”¨ NacosServiceRegistry<span class="comment">#register å®Œæˆæ³¨å†Œ</span></span><br><span class="line">2.æ¥ç€ register() è°ƒç”¨ NacosNamingService<span class="comment">#registerInstance()</span></span><br><span class="line">3.ç„¶åä¼šè°ƒç”¨ NamingProxy<span class="comment">#registerService()</span></span><br><span class="line">4.ç”Ÿæˆå¹¶å‘é€è¯·æ±‚, è¯·æ±‚åœ°å€ä¸º /nacos/v1/ns/instance</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“: è¿™å’Œ Consul å·®ä¸å¤š; è¿˜æ˜¯ç»§æ‰¿ AbstractAutoServiceRegistration æ¥ä¸ ServiceRegistry äº¤äº’äº†, ä¹Ÿæ˜¯éå¸¸çš„é…åˆ Commons é¡¹ç›®å•Š!!</p>
</blockquote>
<h3 id="æœåŠ¡å‘ç°æµç¨‹-2"><a href="#æœåŠ¡å‘ç°æµç¨‹-2" class="headerlink" title="æœåŠ¡å‘ç°æµç¨‹"></a>æœåŠ¡å‘ç°æµç¨‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.é¦–å…ˆæ˜¯ DiscoveryClientServiceInstanceListSupplier ä¼šè°ƒç”¨ NacosDiscoveryClient<span class="comment">#getInstances()</span></span><br><span class="line">2.æ¥ç€ getInstances() ä¼šè°ƒç”¨ NacosServiceDiscovery<span class="comment">#getInstances()</span></span><br><span class="line">3.ç„¶åå°±æ˜¯å‘é€ HTTP è¯·æ±‚äº†, è¯·æ±‚åœ°å€ä¸º /nacos/v1/ns/instance/list, è¿”å›çš„å¯¹è±¡å°è£…å¤„ç†ä¸‹å¾—åˆ° ServiceInstance çš„å®ç°ç±» NacosServiceInstance.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“: ä¾ç„¶æ˜¯å’Œ Eureka/Consul ç±»ä¼¼, ä» Commons åˆ° NacosDiscoveryClient, æµç¨‹æ˜¯ä¸€æ ·çš„. è€Œå…¶å® NacosDiscoveryClient çš„é€»è¾‘ä¹Ÿå’Œ ConsulDiscoveryClient/EurekaDiscoverClient ç±»ä¼¼, æœ€ç»ˆæ€»æ˜¯å‘èµ· HTTP æŸ¥è¯¢ server ç«¯, æ‰€ä»¥ server ç«¯çš„ä»£ç æ‰æ¯”è¾ƒæœ‰è¶£å•Š.</p>
</blockquote>
<h2 id="Nacos-Config"><a href="#Nacos-Config" class="headerlink" title="Nacos Config"></a>Nacos Config</h2><h3 id="Nacos-Config-Client-åŠ è½½-nacos-server-é…ç½®åŸç†"><a href="#Nacos-Config-Client-åŠ è½½-nacos-server-é…ç½®åŸç†" class="headerlink" title="Nacos Config Client åŠ è½½ nacos server é…ç½®åŸç†"></a>Nacos Config Client åŠ è½½ nacos server é…ç½®åŸç†</h3><h4 id="å…³é”®ç±»-3"><a href="#å…³é”®ç±»-3" class="headerlink" title="å…³é”®ç±»"></a>å…³é”®ç±»</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1.NacosConfigBootstrapConfiguration</span><br><span class="line">	æ³¨å†Œäº†ä¸€ä¸ª NacosPropertySourceLocator</span><br><span class="line"></span><br><span class="line">2.NacosPropertySourceLocator</span><br><span class="line">	ç”¨äºä» nacos server ä¸ŠåŠ è½½ dataId å¯¹åº”çš„é…ç½®æ–‡ä»¶åˆ° environment çš„ PropertySource é›†åˆä¸­.</span><br><span class="line">	</span><br><span class="line">3.ConfigService</span><br><span class="line">	ç”¨äºä¸ nacos server é€šä¿¡, è·å–é…ç½®æ–‡ä»¶, ä¹ƒè‡³è®¢é˜…æ›´æ–°</span><br><span class="line">	</span><br><span class="line">4.NacosPropertySourceBuilder</span><br><span class="line">	å€ŸåŠ© ConfigService ä¸ NacosDataParserHandler ä» nacos è·å– NacosPropertySource</span><br><span class="line">	</span><br><span class="line">5.NacosDataParserHandler</span><br><span class="line">	ç”¨äºåºåˆ—åŒ–(è½¬ç )æœåŠ¡ç«¯çš„é…ç½®æ–‡ä»¶æ•°æ®ä¸ºä¸€ä¸ª PropertySource(å³ NacosPropertySource)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># è‡ªåŠ¨åˆ·æ–°</span></span><br><span class="line">1.NacosConfigAutoConfiguration</span><br><span class="line">2.NacosContextRefresher</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“: ConfigService ä¸ NacosDataParserHandler æ˜¯ä¸¤ä¸ªå¹²äº‹çš„, å…¶ä»–éƒ½æ˜¯æ¸£æ¸£!!!</p>
</blockquote>
<h4 id="ä»-server-è·å–é…ç½®æµç¨‹"><a href="#ä»-server-è·å–é…ç½®æµç¨‹" class="headerlink" title="ä» server è·å–é…ç½®æµç¨‹"></a>ä» server è·å–é…ç½®æµç¨‹</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1.åœ¨ NacosConfigBootstrapConfiguration ä¸­æ³¨å†Œäº†ä¸€ä¸ª PropertySourceLocator(å³ NacosPropertySourceLocator), å¯ç”¨äºä¸º environment æ·»åŠ  PropertySource</span><br><span class="line">2.ç„¶åå®ç° locate æ–¹æ³•, å³ NacosPropertySourceLocator<span class="comment">#locate()</span></span><br><span class="line">3.åœ¨ locate() çš„æœ€åé¢, è°ƒç”¨äº† loadApplicationConfiguration()</span><br><span class="line">4.è¿™ä¸ªæ–¹æ³•é€šè¿‡å¤šæ¬¡è°ƒç”¨ loadNacosDataIfPresent() åŠ è½½ dataId å’Œä¸åŒæ–‡ä»¶åç¼€ä»¥åŠprofile ç»„å’Œå¾—åˆ°ä¸åŒçš„ dataId.</span><br><span class="line">5.loadNacosDataIfPresent() è°ƒç”¨äº† loadNacosPropertySource()</span><br><span class="line">6.å…¶æœ€ç»ˆè°ƒç”¨äº† NacosPropertySourceBuilder<span class="comment">#loadNacosData()</span></span><br><span class="line">7.loadNacosData() è°ƒç”¨ ConfigService<span class="comment">#getConfig() </span></span><br><span class="line">8.getConfig() ä¼šä½¿ç”¨ ClientWorker<span class="comment">#getServerConfig() å‘èµ· HTTP è¯·æ±‚ä» nacos server è·å–é…ç½®æ–‡ä»¶. å…¶è¯·æ±‚åœ°å€æ˜¯ /v1/cs/configs</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p> è¿˜æ˜¯æŒºç®€å•çš„, å‘ä¸ª HTTP è·å–é…ç½®æ–‡ä»¶, ç„¶åè½¬åŒ–æˆä¸€ä¸ª PropertySource, å†åœ¨ NacosPropertySourceLocator çš„ locate ä¸­æ‰”è¿› environment ä¸­å». Bingo!!!</p>
</blockquote>
<h4 id="ä»-server-å®æ—¶æ›´æ–°åŸç†"><a href="#ä»-server-å®æ—¶æ›´æ–°åŸç†" class="headerlink" title="ä» server å®æ—¶æ›´æ–°åŸç†"></a>ä» server å®æ—¶æ›´æ–°åŸç†</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1.åœ¨ NacosConfigAutoConfiguration æ³¨å†Œäº†ä¸€ä¸ª NacosContextRefresher</span><br><span class="line">2.å…¶å®ç°äº† ApplicationListener&lt;ApplicationReadyEvent&gt;, ä¹Ÿå°±æ˜¯ä¼šåœ¨å®¹å™¨å‡†å¤‡äº‹ä»¶è§¦å‘åè°ƒç”¨ NacosContextRefresher<span class="comment">#registerNacosListenersForApplications()</span></span><br><span class="line">3.åœ¨è¿›è¡Œä¸¤ä¸ªé…ç½®åˆ¤æ–­å(å³ isRefreshEnabled() å’Œ PropertySource çš„ isRefreshable), è°ƒç”¨ NacosContextRefresher<span class="comment">#registerNacosListener() </span></span><br><span class="line">4.è¿™ä¸ªæ–¹æ³•é€šè¿‡ NacosConfigService<span class="comment">#addListener() æ³¨å†Œä¸€ä¸ª AbstractSharedListener ç›‘å¬è€…åˆ° cacheData.</span></span><br><span class="line">5.è€Œ ClientWorker<span class="comment">#checkConfigInfo() ä¸­æ·»åŠ çš„ LongPollingRunnable ä»»åŠ¡, ä¼šåœ¨ run() ä¸­æ‰§è¡Œ getServerConfig() è·å–æœåŠ¡é…ç½®æ–‡ä»¶, ç„¶åä¸å½“å‰ç¼“å­˜å¯¹æ¯” md5, è‹¥æ›´æ–°åˆ™é€šè¿‡ cacheData å–å‡ºåˆšåˆšæ·»åŠ çš„ listener, è§¦å‘äº‹ä»¶(å³ receiveConfigInfo() )</span></span><br><span class="line">6.è§¦å‘ååˆä¼šå†å‘å¸ƒä¸€ä¸ª RefreshEvent äº‹ä»¶</span><br><span class="line">7.æ¥ç€æµè½¬åˆ° RefreshEventListener.onApplicationEvent()</span><br><span class="line">8.ç„¶ååˆä¼šè°ƒç”¨ ContextRefresher.refresh(), è¿™ä¸ªæ–¹æ³•ä¸­çš„ refreshEnvironment() ä¼šè°ƒç”¨ addConfigFilesToEnvironment(), è¿™æ–¹æ³•å…ˆå¤åˆ¶ä¸€ä¸ª StandardEnvironment, å°†å…¶æ”¾å…¥åˆ° SpringApplication ä¸­, å†è°ƒç”¨ SpringApplication çš„ run() èµ°ä¸€é, ä¼šè§¦å‘ NacosPropertySourceLocator.locate(), äºæ˜¯å¤åˆ¶çš„ environment é‡Œé¢æœ‰æ–°æ•°æ®äº†, å†å°†å…¶æ‹·è´æ›¿æ¢åˆ°å½“å‰çš„ environment. å®Œæˆ environment çš„åˆ·æ–°. </span><br><span class="line">9.æ¥ç€å‘å¸ƒä¸€ä¸ª EnvironmentChangeEvent äº‹ä»¶, ç”¨æ¥åˆ·æ–° @ConfigurationProperties æ³¨è§£çš„ Bean. (è¿™ä¹ˆå–œæ¬¢äº‹ä»¶?ä¸æ„§æ˜¯å†™å‡º RocketMQ çš„é˜¿é‡Œå•Š!!!)</span><br><span class="line">10.æ¥ç€åœ¨ ConfigurationPropertiesRebinder ä¸­æ¥æ”¶åˆ°è¿™ä¸ªäº‹ä»¶, è§¦å‘ onApplicationEvent()</span><br><span class="line">11.ç„¶åä¼šæ‰§è¡Œ ConfigurationPropertiesRebinder<span class="comment">#rebind()</span></span><br><span class="line">12.å…¶é€»è¾‘æ˜¯å°† postProcessBeforeInitialization ä¸­å­˜èµ·æ¥çš„ ConfigurationPropertiesBean ç±»å‹çš„ map éå†, è¿›è¡Œé‡æ–°ç»‘å®š(å³ destroyBean åå† initializeBean, åˆ™ä¼šä»æ–°é…ç½®é‡æ–°èµ‹å€¼).</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“: æœ‰çš„åœ°æ–¹(NacosContextRefresher)ç›‘å¬å®¹å™¨åˆå§‹åŒ–æ·»åŠ é…ç½®æ›´æ–°çš„ç›‘å¬è€…, è‡ªå·±ä¸å¹²æ´»åªå‘å¸ƒé…ç½®åˆ·æ–°äº‹ä»¶;</p>
<p>æœ‰çš„åœ°æ–¹(ClientWorker)æ·»åŠ è½®è¯¢ä»»åŠ¡è·å–æœåŠ¡ç«¯é…ç½®æ–‡ä»¶ä¸æœ¬åœ° cacheData å¯¹æ¯” md5 æ¥åˆ¤æ–­æ˜¯å¦è§¦å‘é…ç½®æ›´æ–°çš„ç›‘å¬è€…;</p>
<p>ç„¶åæœ‰çš„åœ°æ–¹(RefreshEventListener)ç›‘å¬é…ç½®åˆ·æ–°äº‹ä»¶ç„¶åç”¨ SpringApplication.run() é€šè¿‡è§¦å‘ NacosPropertySourceLocator#locate() ä¸ºä¸€ä¸ªå¤åˆ¶å‡ºæ¥çš„ environment å¯¹è±¡æ·»åŠ ä»æœåŠ¡ç«¯è·å–æœ€æ–°é…ç½®, å†æ‹·è´åˆ°å½“å‰çš„ environment å¯¹è±¡, å®Œæˆ environment é…ç½®çš„åˆ·æ–°, ä¹‹åå‘å¸ƒ environment åˆ·æ–°äº‹ä»¶;</p>
<p>æœ‰çš„åœ°æ–¹(ConfigurationPropertiesRebinder)ç›‘å¬ environment åˆ·æ–°äº‹ä»¶, ç„¶åä¸º @ConfigurationProperties æ³¨è§£ç”Ÿæˆçš„ bean é‡æ–°ç»‘å®šé…ç½®.</p>
<p>å†æ€»ç»“: æŒºå¥½çš„, å¥¥è¿ç«ç‚¬æ‰‹å•Šè¿™æ˜¯, ä¸åœä¼ é€’!!!!!</p>
</blockquote>
<h4 id="å…³é”®ç±»-4"><a href="#å…³é”®ç±»-4" class="headerlink" title="å…³é”®ç±»"></a>å…³é”®ç±»</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">1.NacosConfigAutoConfiguration</span><br><span class="line">	æ³¨å†Œä¸€ä¸ªç›‘å¬å®¹å™¨åˆå§‹åŒ–äº‹ä»¶çš„ bean (NacosContextRefresher)</span><br><span class="line"></span><br><span class="line">2.NacosContextRefresher</span><br><span class="line">	å†åˆå§‹åŒ–äº‹ä»¶è§¦å‘åæ·»åŠ ä¸€ä¸ª AbstractSharedListener ç›‘å¬è€…åˆ° cacheData</span><br><span class="line"></span><br><span class="line">3.AbstractSharedListener</span><br><span class="line">	å½“æœåŠ¡ç«¯é…ç½®ä¸æœ¬åœ°ä¸åŒåè§¦å‘</span><br><span class="line">	è§¦å‘åå‘å¸ƒ RefreshEvent äº‹ä»¶</span><br><span class="line"></span><br><span class="line">4.CacheData</span><br><span class="line">	ç®¡ç†é…ç½®æ›´æ–°äº‹ä»¶ç›‘å¬è€…</span><br><span class="line">	å¯¹æ¯”æœåŠ¡ç«¯é…ç½®ä¸æœ¬åœ°é…ç½®çš„ md5</span><br><span class="line">	md5 ä¸åŒåˆ™è§¦å‘ AbstractSharedListener</span><br><span class="line">	</span><br><span class="line">5.RefreshEvent</span><br><span class="line">	é€šè¿‡å®¹å™¨å‘å¸ƒ</span><br><span class="line">	å½“æœåŠ¡ç«¯é…ç½®å‘é€æ›´æ–°è§¦å‘</span><br><span class="line">	è§¦å‘åè°ƒç”¨ ContextRefresher<span class="comment">#refresh()</span></span><br><span class="line">	</span><br><span class="line">6.LongPollingRunnable</span><br><span class="line">	è½®è¯¢ä»»åŠ¡, è·å–æœåŠ¡ç«¯æœ€æ–°é…ç½®, ä¸ cacheData å¯¹æ¯”</span><br><span class="line"></span><br><span class="line">7.ClientWorker</span><br><span class="line">	ç®¡ç†è½®è¯¢ä»»åŠ¡(LongPollingRunnable)</span><br><span class="line">	è´Ÿè´£ä¸ nacos æœåŠ¡ç«¯é€šä¿¡</span><br><span class="line">	</span><br><span class="line">8.ContextRefresher</span><br><span class="line">	ç›‘å¬ RefreshEvent äº‹ä»¶</span><br><span class="line">	è´Ÿè´£è·å–æœåŠ¡ç«¯æœ€æ–°é…ç½®åˆ° environment å¯¹è±¡ä¸­</span><br><span class="line">	å‘å¸ƒ EnvironmentChangeEvent äº‹ä»¶</span><br><span class="line">	</span><br><span class="line">9.EnvironmentChangeEvent</span><br><span class="line">	é€šè¿‡å®¹å™¨å‘å¸ƒ</span><br><span class="line">	å½“ environment å¯¹è±¡æ›´æ–°åè§¦å‘</span><br><span class="line">	è§¦å‘åè°ƒç”¨ ConfigurationPropertiesRebinder<span class="comment">#rebind()</span></span><br><span class="line">	</span><br><span class="line">10.ConfigurationPropertiesRebinder</span><br><span class="line">	ç›‘å¬ EnvironmentChangeEvent äº‹ä»¶</span><br><span class="line">	è´Ÿè´£é‡æ–°ç»‘å®šç”¨äº† @ConfigurationProperties æ³¨è§£çš„ Bean çš„å€¼</span><br></pre></td></tr></table></figure>





<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line"></span><br><span class="line">A1(NacosConfigAutoConfiguration)</span><br><span class="line">A2(NacosContextRefresher)</span><br><span class="line">A3(ApplicationReadyEvent)</span><br><span class="line">A4(NacosContextRefresher#registerNacosListener)</span><br><span class="line">A5(NacosConfigService#addListener)</span><br><span class="line"> </span><br><span class="line">A7(ClientWorker)</span><br><span class="line">A8(LongPollingRunnable#è½®è¯¢ä»»åŠ¡)</span><br><span class="line">A9(NacosConfigService#getServerConfig)</span><br><span class="line">B1(AbstractSharedListener#é…ç½®æ›´æ–°äº‹ä»¶çš„ç›‘å¬è€…)</span><br><span class="line">B2(cacheData)</span><br><span class="line">B3(RefreshEvent)</span><br><span class="line">B4(RefreshEventListener)</span><br><span class="line">B5(ContextRefresher#refresh)</span><br><span class="line">B6(ContextRefresher#refreshEnvironment)</span><br><span class="line">B7(ContextRefresher#addConfigFilesToEnvironment)</span><br><span class="line">B8(SpringApplication#run)</span><br><span class="line">B9(StandardEnvironment)</span><br><span class="line">C1(NacosPropertySourceLocator#locate)</span><br><span class="line">C2(å½“å‰å®¹å™¨çš„ environment å¯¹è±¡)</span><br><span class="line">C3(EnvironmentChangeEvent)</span><br><span class="line">C4(ConfigurationPropertiesRebinder#onApplicationEvent)</span><br><span class="line">C5(ConfigurationPropertiesRebinder#rebind)</span><br><span class="line">C6(ç”¨äº† ConfigurationProperties æ³¨è§£ Bean)</span><br><span class="line"></span><br><span class="line">A1--æ³¨å†Œäº†ä¸€ä¸ª--&gt;A2</span><br><span class="line">A2--ç›‘å¬äº†--&gt;A3</span><br><span class="line">A3--äº‹ä»¶è§¦å‘åè°ƒç”¨--&gt;A4</span><br><span class="line">A4--é€šè¿‡--&gt;A5</span><br><span class="line">A5--æ³¨å†Œäº†ä¸€ä¸ª--&gt;B1</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">A7--æ„é€ æ–¹æ³•ä¸­åˆ›å»ºäº†ä¸€ä¸ª--&gt;A8</span><br><span class="line">A8--run æ–¹æ³•ä¸­è°ƒç”¨--&gt;A9</span><br><span class="line">A9--è·å–æœ€æ–°é…ç½®ä¸--&gt;B2</span><br><span class="line"></span><br><span class="line">B2--æ¯”è¾ƒ md5, ä¸åŒåˆ™è§¦å‘--&gt;B1</span><br><span class="line">B1--äº‹ä»¶è§¦å‘åå‘å¸ƒ--&gt;B3</span><br><span class="line">B4--ç›‘å¬äº†--&gt;B3</span><br><span class="line">B3--äº‹ä»¶è§¦å‘åè°ƒç”¨--&gt;B5</span><br><span class="line">B5--è°ƒç”¨--&gt;B6</span><br><span class="line">B6--è°ƒç”¨--&gt;B7</span><br><span class="line">B7--åˆ©ç”¨--&gt;B8</span><br><span class="line">B7--å¤åˆ¶å½“å‰å®¹å™¨ environment å¯¹è±¡åˆ°--&gt;B9</span><br><span class="line">B8--è§¦å‘--&gt;C1</span><br><span class="line">C1--è·å–äº†æœ€æ–°é…ç½®åˆ°--&gt;B9</span><br><span class="line">B9--å¤åˆ¶æœ€æ–°é…ç½®å›åˆ°--&gt;C2</span><br><span class="line"></span><br><span class="line">C2--æ›´æ–°å®Œé…ç½®åå‘å¸ƒ--&gt;C3</span><br><span class="line">G1(ConfigurationPropertiesRebinder)--ç›‘å¬äº†--&gt;C3</span><br><span class="line">C3--äº‹ä»¶è§¦å‘åè°ƒç”¨--&gt;C4</span><br><span class="line">C4--è°ƒç”¨--&gt;C5</span><br><span class="line">C5--è·å–æ–°é…ç½®ç»‘å®šåˆ°--&gt;C6</span><br></pre></td></tr></table></figure>





<p><img src="https://gitee.com/gudqs7/many-images/raw/master/Mac-PicGo/20210130001118.png" alt=""></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://gudqs7.github.io/2021/01/28/source-code-spring-cloud-openfeign/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="gudqs7">
      <meta itemprop="description" content="å¿ƒç´¯æ²¡é’±èººå°¸ä¸­">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="gudqs7's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/28/source-code-spring-cloud-openfeign/" class="post-title-link" itemprop="url">Spring Cloud Openfeign æºç ç¬”è®°</a>
        </h2>

        <div class="post-meta">
			
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-01-28 13:59:51" itemprop="dateCreated datePublished" datetime="2021-01-28T13:59:51+08:00">2021-01-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-01-30 00:14:53" itemprop="dateModified" datetime="2021-01-30T00:14:53+08:00">2021-01-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SourceCode/" itemprop="url" rel="index"><span itemprop="name">SourceCode</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring-Cloud-Openfeign/" itemprop="url" rel="index"><span itemprop="name">Spring Cloud Openfeign</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/2021/01/28/source-code-spring-cloud-openfeign/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/01/28/source-code-spring-cloud-openfeign/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Spring-Cloud-Openfeign-æºç ç¬”è®°"><a href="#Spring-Cloud-Openfeign-æºç ç¬”è®°" class="headerlink" title="Spring Cloud Openfeign æºç ç¬”è®°"></a>Spring Cloud Openfeign æºç ç¬”è®°</h1><h2 id="å…³é”®ç±»åˆ†æ"><a href="#å…³é”®ç±»åˆ†æ" class="headerlink" title="å…³é”®ç±»åˆ†æ"></a>å…³é”®ç±»åˆ†æ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.FeignAutoConfiguration</span></span><br><span class="line">  é…ç½®äº†ä¸€ä¸ªç®¡ç† feign å­å®¹å™¨çš„å·¥å‚(FeignContext). </span><br><span class="line">  é…ç½®ä¸€ä¸ª Targeter, ç›´æ¥ä¸­ä¸“ fegin çš„ target æ–¹æ³•(DefaultTargeter, è¿™é‡Œæ‰©å±•å¯ä»¥å®ç°é™çº§å“¦)</span><br><span class="line">  é…ç½®äº†ä¸€ä¸ª feign client (ApacheHttpClient), ç”¨äºæ‰§è¡Œ HTTP è¯·æ±‚</span><br><span class="line">  è¿˜é…å¤‡äº† ok http client æ–¹å¼çš„ feign client, ä½†é»˜è®¤ä¸å¯ç”¨</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.FeignClientsRegistrar</span></span><br><span class="line">  è¢« @EnableFeignClients å¼•å…¥</span><br><span class="line">  æ‰«æå¸¦ @FeignClient æ³¨è§£çš„æ¥å£, ç”Ÿæˆä»£ç†å¯¹è±¡(FeignClientFactoryBean)æ³¨å†Œåˆ°å®¹å™¨ä¸­</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.FeignClientFactoryBean</span></span><br><span class="line">  ç»§æ‰¿è‡ª FactoryBean, Spring çš„ä¸œè¥¿, getBean() æ—¶è°ƒç”¨è·³è½¬åˆ° getObject()</span><br><span class="line">  getObject() ä¼šè°ƒç”¨é€šè¿‡ feign å¯¹è±¡ç”Ÿæˆä»£ç†å¯¹è±¡</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.FeignInvocationHandler</span></span><br><span class="line">	JDK åŠ¨æ€ä»£ç†ç”Ÿæˆå¯¹è±¡çš„çš„æ–¹æ³•æ‹¦æˆªå™¨</span><br><span class="line">	é€šè¿‡è°ƒç”¨ SynchronousMethodHandler çš„ invoke() å®ç°å‘é€è¯·æ±‚çš„åŠŸèƒ½</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.SynchronousMethodHandler</span></span><br><span class="line">	invoke() ä¼šè°ƒç”¨ FeignBlockingLoadBalancerClient çš„ execute() é€šè¿‡è´Ÿè½½å‡è¡¡è·å– url å†è°ƒç”¨ ApacheHttpClient çš„ execute() å‘é€å¸¦å®é™… url çš„ HTTP è¯·æ±‚.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.ParseHandlersByName</span></span><br><span class="line">	å…·æœ‰æ ¸å¿ƒæ–¹æ³• apply, è§£æ @FeignClient æ¥å£çš„æ‰€æœ‰æ–¹æ³•çš„æ³¨è§£å’Œå‚æ•°ä¿¡æ¯, è½¬åŒ–ä¸º RequestTemplate, å¯ç”¨äºæ„é€  HTTP è¯·æ±‚å¯¹è±¡. è½¬åŒ–åçš„ä¿¡æ¯å­˜äº SynchronousMethodHandler å­—æ®µä¸­.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7.FeignBlockingLoadBalancerClient</span></span><br><span class="line">	execute() ä¼šè°ƒç”¨ LoadBalancerClient çš„ choose() æ ¹æ® serviceId(å³ HTTP çš„ host) è·å– url.</span><br><span class="line">	è¿˜è´Ÿè´£è°ƒç”¨ ApacheHttpClient çš„ execute() çœŸæ­£çš„å‘é€ HTTP è¯·æ±‚.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8.LoadBalancerClient</span></span><br><span class="line">  commons ä¸‹ loadbalancer é¡¹ç›®çš„è€ä¼™è®¡äº†... å¹²å•¥çš„æ¥ç€? å¿˜äº†</span><br><span class="line"></span><br><span class="line"><span class="comment"># 9.ApacheHttpClient</span></span><br><span class="line">	è´Ÿè´£å‘é€ HTTP è¯·æ±‚.</span><br></pre></td></tr></table></figure>



<h2 id="openfeign-åŸç†-EnableFeignClients-ç”Ÿæ•ˆæ­¥éª¤"><a href="#openfeign-åŸç†-EnableFeignClients-ç”Ÿæ•ˆæ­¥éª¤" class="headerlink" title="openfeign åŸç†(@EnableFeignClients ç”Ÿæ•ˆæ­¥éª¤)"></a>openfeign åŸç†(@EnableFeignClients ç”Ÿæ•ˆæ­¥éª¤)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">1.å…ˆè§£æ @EnableFeignClients å¯¼å…¥ FeignClientsRegistrar.class</span><br><span class="line">2.FeignClientsRegistrar å°†æ‰«æå¸¦ @FeignClient æ³¨è§£çš„æ¥å£, æ³¨å†Œåˆ°å®¹å™¨ä¸­</span><br><span class="line">3.æ³¨å†Œè¿›å®¹å™¨çš„æ˜¯ä¸€ä¸ª FeignClientFactoryBean</span><br><span class="line">4.FeignClientFactoryBean å…¶æœ¬è´¨æ˜¯ä¸€ä¸ª FactoryBean, ä¼šåœ¨è¢« getBean() æ—¶è°ƒç”¨ getObject()</span><br><span class="line">5.getObject() ä¼šä»å®¹å™¨ä¸­å– Feign.Builder builder å¯¹è±¡å†æ ¹æ®é…ç½®æ–‡ä»¶è¿›è¡Œé…ç½® </span><br><span class="line">6.æ¥ç€ä¼šèµ° Targeter å¯¹è±¡(é»˜è®¤ä¸º DefaultTargeter)çš„ target(), å…¶é»˜è®¤ä¸º builder.target(target); å…¶ä¸­ builder ä¸º Feign.Builder å¯¹è±¡, target ä¸º <span class="built_in">type</span>(class), name(serviceId), url(http://name/path)</span><br><span class="line">7.target() ä¼šå…ˆè°ƒç”¨ build()ç”Ÿæˆä¸€ä¸ª feign å¯¹è±¡, å†è°ƒç”¨ feign.newInstance(target) ç”Ÿæˆä¸€ä¸ªä»£ç†å¯¹è±¡</span><br><span class="line">8.å…ˆçœ‹ build() æ–¹æ³•, åˆå§‹åŒ–äº†é‡è¦å±æ€§ targetToHandlersByName, å€¼ä¸º new ParseHandlersByName(), è¿™ä¸ªç±»çš„ apply() ä¼šåœ¨è¿‡ä¸€ä¼šç”¨åˆ°. apply() é€»è¾‘æ˜¯éå†æŒ¨ä¸ªè§£ææ–¹æ³•ä¸Šçš„æ³¨è§£(å¦‚@RequestMapping, @RequestParam, @PathVariableç­‰ç­‰)å’Œå‚æ•°, è½¬åŒ–ååŒ…è£…æˆ HTTP è¯·æ±‚ç›¸å…³çš„å®ä½“ç±», å­˜åˆ° SynchronousMethodHandler çš„å­—æ®µä¸­, å†è¿”å› SynchronousMethodHandler å¯¹è±¡å­˜åˆ° map é‡Œ.</span><br><span class="line">9.å†çœ‹ feign.newInstance(), å…ˆè°ƒç”¨åˆšè¯´çš„é‡è¦å±æ€§ targetToHandlersByName.apply(), è·å¾—ä¸€ä¸ª map, é‡Œé¢é”®å¤§è‡´ä¸ºç±»å+æ–¹æ³•å+å½¢å‚ç»„æˆ, å€¼æ˜¯ SynchronousMethodHandler å¯¹è±¡(è§ SynchronousMethodHandler.Factory.create()), ç„¶åéå†ä»£ç†ç±»çš„æ‰€æœ‰æ–¹æ³•, å°†æ–¹æ³•æ‰€å¯¹åº”çš„ SynchronousMethodHandler ä» map ä¸­å–å‡ºå†å­˜åˆ°å¦ä¸€ä¸ª map, è¿™ä¸ª map çš„é”®åˆ™ä¸º method; æ¥ç€ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†ç”Ÿæˆä¸€ä¸ªä»£ç†å¯¹è±¡, å…¶ç”¨äºæ‹¦æˆªæ–¹æ³•çš„ç±» InvocationHandler å…·ä½“ä¸º FeignInvocationHandler, è¿™ä¸ªç±»é‡Œé¢çš„ invoke é€»è¾‘å¾ˆç®€å•, å…ˆæ’é™¤ Object é€šç”¨çš„æ–¹æ³•çš„å½±å“, å¯¹äºæ­£å¸¸æ–¹æ³•ä¼šè°ƒç”¨ SynchronousMethodHandler çš„ invoke()... é—¹äº†åŠå¤©å°±æ˜¯ä¸ªä¸­è½¬å‘—, æœ‰ç±»çš„ Handler åˆ°äº†æ–¹æ³•çš„ MethodHandler.</span><br><span class="line">10.SynchronousMethodHandler çš„ invoke() çš„æ ¸å¿ƒä»£ç æ˜¯ this.client.execute(), è¿™é‡Œä¼šèµ°åˆ° feign.Client çš„å…·ä½“å®ç°ç±». å¯èƒ½æ˜¯ ApacheHttpClient(å½“ url æœ‰åœ°å€æ—¶), é‚£å°±ç›´æ¥æ‰§è¡Œè¯·æ±‚äº†, ä¹Ÿå¯èƒ½æ˜¯ FeignBlockingLoadBalancerClient, é‚£ä¹ˆä¼šè°ƒç”¨ loadBalancerClient çš„ choose æ–¹æ³•è·å– url, å†æ‰§è¡Œ feignClient.execute(), è¿™æ¬¡è¿™ä¸ª feignClient åˆ™è‚¯å®šæ˜¯ ApacheHttpClient äº†, äºæ˜¯æœ€ç»ˆå°±è¿™æ ·å‘é€äº†è¯·æ±‚.</span><br><span class="line"></span><br><span class="line"><span class="comment">#PS: </span></span><br><span class="line">æœ‰äººé—®æˆ‘(æ— ä¸­ç”Ÿå‹)å‘é€çš„ HTTP è¯·æ±‚æ€ä¹ˆæ„å»º? </span><br><span class="line">å…¶å®æˆ‘ä¸Šé¢è¯´çš„å¾ˆæ¸…æ¥šäº†, å…³é”®å°±åœ¨äº apply(), å¥½å§, æˆ‘è¯´çš„å…·ä½“ä¸€ç‚¹... å…³é”®åœ¨äº SpringMvcContract<span class="comment">#parseAndValidateMetadata()</span></span><br><span class="line">è¿™ä¸ªçš„å…¥å£åœ¨ apply() çš„ç¬¬ä¸€è¡Œ, this.contract.parseAndValidateMetadata() ä¸€ç›´å¾€é‡Œè·³è½¬, å°±ä¼šè¿›å…¥ SpringMvcContract...  å…·ä½“ä»£ç æŒºå¤šçš„... çœŸçš„æ²¡å¿…è¦ç»†è¯»... å› ä¸ºå…¶æœ¬èº«åªç›¸å½“äºä¸€ä¸ªå·¥å…·ç±», è€Œè¯»æºç åº”è¯¥æ”¾çœ¼å¤§å±€, å¦åˆ™æ¯æ®µä»£ç éƒ½è®¤çœŸè¯», é‚£å¤ªéš¾äº†!!!</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“: æ‰«æ @FeignClient, ç”Ÿæˆä»£ç†å¯¹è±¡, æ‰”è¿›å®¹å™¨. æ‹¦æˆªä»£ç†å¯¹è±¡çš„æ–¹æ³•, è°ƒç”¨æ–¹æ³•å¯¹åº”çš„ SynchronousMethodHandler, æ­¤ç±»è°ƒç”¨ä¹‹å‰è§£æå¥½çš„ RequestTemplate ç”Ÿæˆè¯·æ±‚å¯¹è±¡, å†é€šè¿‡ Client æ‰§è¡Œè¯·æ±‚, è‹¥é…ç½®äº†è´Ÿè½½å‡è¡¡, åˆ™ä¼šè°ƒç”¨ LoadBalancerClient å°† serviceId å…ˆè§£ææˆå…·ä½“çš„åœ°å€å†è½¬äº¤ç»™ ApacheHttpClient æ‰§è¡Œè¯·æ±‚.</p>
</blockquote>
<h2 id="ä»£ç†å¯¹è±¡çš„ç”Ÿæˆæ­¥éª¤"><a href="#ä»£ç†å¯¹è±¡çš„ç”Ÿæˆæ­¥éª¤" class="headerlink" title="ä»£ç†å¯¹è±¡çš„ç”Ÿæˆæ­¥éª¤"></a>ä»£ç†å¯¹è±¡çš„ç”Ÿæˆæ­¥éª¤</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line"></span><br><span class="line">A1(FeignClientFactoryBean)</span><br><span class="line">A2(Feign.Builder)</span><br><span class="line">A3(Feign)</span><br><span class="line">A4(FeignInvocationHandler)</span><br><span class="line">A5(SynchronousMethodHandler)</span><br><span class="line">A6(FeignBlockingLoadBalancerClient)</span><br><span class="line">A7(ApacheHttpClient)</span><br><span class="line">A8(LoadBalancerClient)</span><br><span class="line">A9(ServiceInstance)</span><br><span class="line">A10(Response)</span><br><span class="line">A11(Decoder é“¾)</span><br><span class="line"></span><br><span class="line">A1--getObject è§¦å‘--&gt;A2</span><br><span class="line">A2--build å¾—åˆ°--&gt;A3</span><br><span class="line">A3--Proxy.newProxyInstance ç”¨åˆ°--&gt;A4</span><br><span class="line">A4--invoke é‡Œè°ƒç”¨--&gt;A5</span><br><span class="line">A5--invoke é‡Œè°ƒç”¨--&gt;A6</span><br><span class="line">A6--execute ä¸­å…ˆè°ƒç”¨ --&gt;A8</span><br><span class="line">A6--execute ä¸­åè°ƒç”¨--&gt;A7</span><br><span class="line">A8--è·å–--&gt;A9</span><br><span class="line">A7--å¾—åˆ°--&gt;A10</span><br><span class="line">A10--äº¤ç»™--&gt;A11</span><br><span class="line">A11--ç¼–ç å¾—åˆ°--&gt;A12(json)</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/gudqs7/many-images/raw/master/Mac-PicGo/20210128204558.png" alt="iShot2021-01-28 20.45.21"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://gudqs7.github.io/2021/01/27/source-code-spring-cloud-ribbon/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="gudqs7">
      <meta itemprop="description" content="å¿ƒç´¯æ²¡é’±èººå°¸ä¸­">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="gudqs7's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/27/source-code-spring-cloud-ribbon/" class="post-title-link" itemprop="url">Spring Cloud Commons ä¹‹ loadbalancer æºç ç¬”è®°</a>
        </h2>

        <div class="post-meta">
			
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-01-27 13:10:01 / ä¿®æ”¹æ—¶é—´ï¼š21:22:50" itemprop="dateCreated datePublished" datetime="2021-01-27T13:10:01+08:00">2021-01-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SourceCode/" itemprop="url" rel="index"><span itemprop="name">SourceCode</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring-Cloud/" itemprop="url" rel="index"><span itemprop="name">Spring-Cloud</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/2021/01/27/source-code-spring-cloud-ribbon/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/01/27/source-code-spring-cloud-ribbon/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Spring-Cloud-Commons-ä¹‹-loadbalancer-æºç ç¬”è®°"><a href="#Spring-Cloud-Commons-ä¹‹-loadbalancer-æºç ç¬”è®°" class="headerlink" title="Spring Cloud Commons ä¹‹ loadbalancer æºç ç¬”è®°"></a>Spring Cloud Commons ä¹‹ loadbalancer æºç ç¬”è®°</h1><blockquote>
<p>Spring Cloud Commons æ˜¯ä»€ä¹ˆæ ·çš„? æœ‰ä»€ä¹ˆä½œç”¨? å¦‚ä½•ä¸ Spring Cloud å’Œ Cloud Alibaba æ•´åˆ?<br>è®©æˆ‘ä»¬å¸¦ç€è¿™äº›é—®é¢˜å»ç ”ç©¶æºç å§! </p>
</blockquote>
<h2 id="loadbalancer-åŸç†åˆ†æ"><a href="#loadbalancer-åŸç†åˆ†æ" class="headerlink" title="loadbalancer åŸç†åˆ†æ"></a>loadbalancer åŸç†åˆ†æ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…ˆæ¥è®¤è¯†ä¸€ä¸‹ Spring Cloud Commons å§</span></span><br><span class="line">æ˜¯å®šä¹‰äº†è¯¸å¤šæ¥å£(å¦‚ServiceRegistry/DiscoveryClient/LoadBalancerClient)å’Œæ³¨è§£(å¦‚!EnableDiscoveryClient/@LoadBalanced)ä¸ºä¸», å°‘é‡ä»£ç å®ç°(å¦‚ RandomLoadBalancer). </span><br><span class="line">ä»¥åŠå¯¹ Spring å®¹å™¨(Context) çš„æ‰©å±•(å¦‚ NamedContextFactory, bootstrap é…ç½®æ–‡ä»¶çš„åŠ è½½, å®¹å™¨é‡å¯, å®¹å™¨è·Ÿéšé…ç½®æ–‡ä»¶åˆ·æ–°ç­‰ç­‰)</span><br><span class="line">å½“ç„¶è¿˜æœ‰ä¸€äº›æ‰“åŒ…å¥½çš„ starter.</span><br><span class="line">æˆ‘ä»¬è¦ç ”ç©¶çš„ loadbalancer å°±æ˜¯å…¶ä¸­ä¸€ä¸ªå­é¡¹ç›®.</span><br></pre></td></tr></table></figure>



<h3 id="loadbalancer-å…³é”®ç±»è§£æ"><a href="#loadbalancer-å…³é”®ç±»è§£æ" class="headerlink" title="loadbalancer å…³é”®ç±»è§£æ"></a>loadbalancer å…³é”®ç±»è§£æ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 0.æƒŠ! ä¸€å †ç±»ä»…ä¸ºæ·»åŠ ä¸€ä¸ªæ‹¦æˆªå™¨</span></span><br><span class="line">LoadBalancerRequestFactory: ä¸€ä¸ªå·¥å‚, åŒ…è£…ä¸€ä¸ªä¸ºè¯·æ±‚å¯¹è±¡ HttpRequest åŠ æ–™çš„å›è°ƒ LoadBalancerRequest</span><br><span class="line"></span><br><span class="line">LoadBalancerClient: ç”¨äºæ ¹æ® serviceId é€‰å–ä¸€ä¸ª ServiceInstance, æ‰§è¡Œä» LoadBalancerRequestFactory è·å¾—çš„é‚£ä¸ªå›è°ƒ</span><br><span class="line"></span><br><span class="line">LoadBalancerInterceptor: restTemplate çš„æ‹¦æˆªå™¨, æ‹¦æˆªåè°ƒç”¨ LoadBalancerClient ä¿®æ”¹ HttpRequest å¯¹è±¡(ä¸»è¦æ˜¯ url), ä¸”ä¼ å…¥è°ƒç”¨ LoadBalancerRequestFactory ç”Ÿæˆçš„å›è°ƒç»™ LoadBalancerClient</span><br><span class="line"></span><br><span class="line">RestTemplateCustomizer: ä¸º restTemplate åŠ ä¸Šä¸€ä¸ªæ‹¦æˆªå™¨(ä¹Ÿå¯ä»¥å¹²ç‚¹åˆ«çš„, é»˜è®¤å°±è¿™ä¸€ä¸ªç”¨å¤„)</span><br><span class="line"></span><br><span class="line">SmartInitializingSingleton: è°ƒç”¨ RestTemplateCustomizer ä¸ºå®¹å™¨ä¸­æ‰€æœ‰åŠ äº† @LoadBalanced çš„ RestTemplate åŠ ä¸Šä¸€ä¸ªæ‹¦æˆªå™¨</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.è·å–å¯¹è±¡çš„å·¥å‚, ä»¥ Spring å®¹å™¨ä½œä¸ºè½½ä½“ç®¡ç†å¯¹è±¡.</span></span><br><span class="line">NamedContextFactory</span><br><span class="line">	ç»§æ‰¿ DisposableBean, ç”¨äºç±»é”€æ¯æ˜¯æ‰§è¡Œç‚¹ä¸œè¥¿(æŒ‡åˆ›å»ºçš„å¥½å¤šä¸ªå­å®¹å™¨)</span><br><span class="line">	ç»§æ‰¿ ApplicationContextAware, ç”¨äºå°†å­å®¹å™¨å’Œå½“å‰å®¹å™¨å…³è”èµ·æ¥(æ‰€ä»¥ Spring æ ‘å½¢æ‰©å±•è¿™ä¸ªè®¾è®¡çœŸä¸é”™)</span><br><span class="line">	æ³›å‹ C extends NamedContextFactory.Specification, æ— å®ƒ, å°±æ˜¯ä¸ª POJO, å­˜ä¸ª name å’Œå¯¹åº”çš„é…ç½® class, ç”¨äºåˆå§‹åŒ–å®¹å™¨çš„(ä¼šè¢«æ³¨å†Œè¿›å», ç„¶åè§£æé‡Œé¢çš„æ³¨è§£å•¥çš„...)</span><br><span class="line">	æ­¤ç±»ä½œç”¨å°±æ˜¯ç®¡ç†ä¸€å¤§å †(å–å†³äºä½ å¾®æœåŠ¡æ‹†åˆ†çš„ç¨‹åº¦)å­å®¹å™¨, è·å–å…¶ä»–ä»£ç éœ€è¦çš„ç±»å‹å¯¹è±¡</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ReactiveLoadBalancer.Factory</span><br><span class="line">  å®šä¹‰äº†è·å– ReactiveLoadBalancer çš„æ¥å£ä»¥åŠä¸å…¶ç›¸å…³çš„æ‰©å±•</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">LoadBalancerClientFactory</span><br><span class="line">  ç»§æ‰¿ NamedContextFactory, æ„é€ å‚æ•°æŒ‡å®šäº†å‡ ä¸ªå±æ€§å€¼</span><br><span class="line">  å®ç°äº† ReactiveLoadBalancer.Factory çš„æ¥å£, å³æä¾›è·å– ReactiveLoadBalancer çš„æ–¹æ³•.</span><br><span class="line">  æ³›å‹å…·ä½“ä¸º LoadBalancerClientSpecification, è¿˜æ˜¯ä¸ªPOJO</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.åŒ…å«ç®—æ³•é€»è¾‘çš„è´Ÿè½½å‡è¡¡ç­–ç•¥çš„ç±»</span></span><br><span class="line">Response</span><br><span class="line">	server çš„å°è£…ç±», ä¸€èˆ¬æŒæœ‰ä¸€ä¸ª ServiceInstance å¯¹è±¡, å¦‚ DefaultResponse</span><br><span class="line">	</span><br><span class="line">Publisher</span><br><span class="line">	å“åº”å¼ç¼–ç¨‹çš„ä¸œè¥¿, å¯è·å– Response&lt;T&gt; å¯¹è±¡, ä¸€èˆ¬ä¸º Response&lt;ServiceInstance&gt;</span><br><span class="line">	</span><br><span class="line">ReactiveLoadBalancer.Factory</span><br><span class="line">	å®šä¹‰äº†è·å– ReactiveLoadBalancer çš„æ¥å£ä»¥åŠä¸å…¶ç›¸å…³çš„æ‰©å±•</span><br><span class="line"></span><br><span class="line">ReactiveLoadBalancer</span><br><span class="line">	å®šä¹‰äº† choose æ–¹æ³•, å³å¦‚ä½•é€‰å–ä¸€ä¸ª ServiceInstance, å¦‚è½®æ’­, éšæœº...</span><br><span class="line"></span><br><span class="line">ReactorLoadBalancer</span><br><span class="line">  å®šä¹‰äº† choose æ–¹æ³•çš„å¦ä¸€å½¢å¼, ä»…è¿”å›å€¼ä¸åŒ, ä¸º Mono&lt;Response&lt;T&gt;&gt; æ˜¯ Publisher&lt;Response&lt;T&gt;&gt; çš„å­ç±», è¿”å›å€¼ä¸ºæŠ½è±¡ç±».</span><br><span class="line"></span><br><span class="line">ReactorServiceInstanceLoadBalancer</span><br><span class="line">  ç»§æ‰¿ ReactorLoadBalancer</span><br><span class="line">	ä»…ä»…ä½œä¸ºä¸€ä¸ªæ ‡è®°ç±», æ— æ–°æ¥å£</span><br></pre></td></tr></table></figure>



<h3 id="ç±»å¤§è‡´è°ƒç”¨å›¾"><a href="#ç±»å¤§è‡´è°ƒç”¨å›¾" class="headerlink" title="ç±»å¤§è‡´è°ƒç”¨å›¾"></a>ç±»å¤§è‡´è°ƒç”¨å›¾</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line"></span><br><span class="line">A(SmartInitializingSingleton)</span><br><span class="line">A1(RestTemplateCustomizer)</span><br><span class="line">A2(LoadBalancerInterceptor)</span><br><span class="line">A3(restTemplate)</span><br><span class="line">A4(LoadBalancerClient)</span><br><span class="line">A5(LoadBalancerRequestFactory)</span><br><span class="line">A6(ReactorServiceInstanceLoadBalancer)</span><br><span class="line">A8(LoadBalancerClientFactory)</span><br><span class="line"></span><br><span class="line">A--è°ƒç”¨--&gt;A1</span><br><span class="line">A1--æ·»åŠ ä¸€ä¸ª--&gt;A2</span><br><span class="line">A2--åˆ°--&gt;A3</span><br><span class="line">A2--è°ƒç”¨--&gt;A4</span><br><span class="line">A2--è°ƒç”¨--&gt;A5</span><br><span class="line">A5--ç”Ÿæˆä¸€ä¸ªå›è°ƒç»™--&gt;A4 </span><br><span class="line">A4--è°ƒç”¨--&gt;A8</span><br><span class="line">A8--è·å–--&gt;A6</span><br><span class="line">A6--è·å–--&gt;A7(ServiceInstance)</span><br></pre></td></tr></table></figure>



<p><img src="https://gitee.com/gudqs7/many-images/raw/master/Mac-PicGo/20210127212226.png" alt="a copy"></p>
<blockquote>
<p>ç…ç…æœ‰å“ªäº›è´Ÿè½½å‡è¡¡ç­–ç•¥å§(çœ‹å®Œå‘ç°è¿™æ‰æ˜¯æœ€ç®€å•çš„â€¦ å¤–é¢é‚£äº›ç»“æ„åè€Œä¸å®¹æ˜“ç†æ¸…)</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.RandomLoadBalancer: å°±æ˜¯éšæœºæ•°å‘—, 0-size, ç®€å•!!</span></span><br><span class="line"><span class="comment">// åœ¨ RandomLoadBalancer#getInstanceResponse() ä¸­</span></span><br><span class="line"><span class="comment">// è§‰å¾—è¿™ä¸ªæ–¹æ³•å¯ä»¥åšå‡º protected, è¿™æ ·æœ‰äº›å®ç°åªéœ€è¦é‡å†™è¿™ä¸ªæ–¹æ³•å°±è¡Œäº† </span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Response&lt;ServiceInstance&gt; <span class="title">getInstanceResponse</span><span class="params">(List&lt;ServiceInstance&gt; instances)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (instances.isEmpty()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (log.isWarnEnabled()) &#123;</span><br><span class="line">      log.warn(<span class="string">"No servers available for service: "</span> + serviceId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> EmptyResponse();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">int</span> index = ThreadLocalRandom.current().nextInt(instances.size());</span><br><span class="line"></span><br><span class="line">  ServiceInstance instance = instances.get(index);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> DefaultResponse(instance);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.RoundRobinLoadBalancer</span></span><br><span class="line"><span class="comment">// åœ¨ RoundRobinLoadBalancer#getInstanceResponse() ä¸­</span></span><br><span class="line"><span class="comment">// ç”¨ä¸€ä¸ª position ä¿å­˜ä½ç½®, è¿™ä¸ªä¸»æ„é«˜å•Š, å³ä¿è¯äº†æ•°æ®çš„æ­£ç¡®æ€§, è¿˜.... ç¼–ä¸ä¸‹å»äº†!!</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Response&lt;ServiceInstance&gt; <span class="title">getInstanceResponse</span><span class="params">(List&lt;ServiceInstance&gt; instances)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (instances.isEmpty()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (log.isWarnEnabled()) &#123;</span><br><span class="line">      log.warn(<span class="string">"No servers available for service: "</span> + serviceId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> EmptyResponse();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> enforce order?</span></span><br><span class="line">  <span class="keyword">int</span> pos = Math.abs(<span class="keyword">this</span>.position.incrementAndGet());</span><br><span class="line"></span><br><span class="line">  ServiceInstance instance = instances.get(pos % instances.size());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> DefaultResponse(instance);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿™ä»£ç ç®€å•çš„, ç‰¹åˆ«ä¸æƒ³åˆ†æâ€¦. ä½†å…¶å®æœ€å¼€å§‹å°±æ˜¯å†²ç€è¿™ä¸ªæ¥çš„â€¦ æ€»å¾—çœ‹çœ‹å§, å’³å’³!!</p>
</blockquote>
<h3 id="loadbalancer-åŸç†åˆ†æ-1"><a href="#loadbalancer-åŸç†åˆ†æ-1" class="headerlink" title="loadbalancer åŸç†åˆ†æ"></a>loadbalancer åŸç†åˆ†æ</h3><ol>
<li>å…ˆæ‹¦æˆª RestTemplate å¯¹è±¡çš„è¯·æ±‚, ä½¿å…¶è°ƒç”¨ LoadBalancerClient çš„æ¥å£è·å–çœŸå®IP</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># org.springframework.cloud.client.loadbalancer.LoadBalancerAutoConfiguration ä¸­</span></span><br><span class="line">1.@Bean åŠ å…¥ä¸€ä¸ª LoadBalancerRequestFactory, å¹¶ä¸”å¸¦æœ‰ç”¨æˆ·è‡ªå®šä¹‰çš„ transformers(ä½œç”¨: å¯¹é€‰å–çœŸå® url åçš„è¯·æ±‚å¯¹è±¡è¿›è¡Œå¹²é¢„)</span><br><span class="line">2.@Bean åŠ å…¥ä¸€ä¸ª LoadBalancerClient, å…¶ä½œç”¨æ˜¯, æ ¹æ® serviceId è·å–/é€‰å–çœŸå® url, ä»¥åŠæ‰§è¡Œè¯·æ±‚</span><br><span class="line">3.@Bean åŠ å…¥ä¸€ä¸ª LoadBalancerInterceptor, å³æ ¸å¿ƒæ‹¦æˆªå™¨. é€»è¾‘æ˜¯: è·å– host, è°ƒç”¨ LoadBalancerRequestFactory ç”Ÿæˆè¯·æ±‚, ç”¨ LoadBalancerClient æ‰§è¡Œ.</span><br><span class="line">4.@Bean åŠ å…¥ä¸€ä¸ª RestTemplateCustomizer, å…¶ä½œç”¨æ˜¯: ä¸ºç»™å®šçš„ RestTemplate æ·»åŠ ä¸€ä¸ª LoadBalancerInterceptor.</span><br><span class="line">5.@Bean åŠ å…¥ä¸€ä¸ª SmartInitializingSingleton, ä½œç”¨æ˜¯å•ä¾‹éƒ½åŠ è½½åè§¦å‘å›è°ƒ, å›è°ƒä»£ç ä¸º:</span><br><span class="line">     éå†æ‰€æœ‰çš„ RestTemplateCustomizer å’Œ restTemplates, ç”¨ RestTemplateCustomizer å¯¹ RestTemplate åšè®¾ç½®. åŒ…æ‹¬(4)åˆšåˆšåŠ å…¥çš„é‚£ä¸ª.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“: ä¸ºç”¨æˆ·è‡ªå®šä¹‰(å¦‚é…ç½®ç±»ä¸­å†™äº†ä¸ª@Bean + return new RestTemplate() è¿™ç§å½¢å¼)çš„ RestTemplate æ·»åŠ ä¸€ä¸ªæ‹¦æˆªå™¨, åœ¨è¯·æ±‚æ‰§è¡Œå‰è¿›è¡Œæ‹¦æˆª, ç„¶åå°†è¯·æ±‚æ•°æ®çš„ host ä½œä¸º serviceId, æ¥ç€ä½¿ç”¨æŸä¸ªå…·ä½“çš„ LoadBalancerClient å®ç°ç±»è°ƒç”¨å…¶æ–¹æ³•è·å–çœŸå®çš„ url. è‹¥å¯¹åº”å­˜åœ¨å¤šä¸ª url, ç”±å…¶ç®—æ³•ç­–ç•¥å†³å®šå¦‚ä½•é€‰æ‹©.</p>
</blockquote>
<ol start="2">
<li>å†çœ‹ LoadBalancerClient çš„é»˜è®¤å®ç°ç±»(åœ¨ BlockingLoadBalancerClientAutoConfiguration ä¸­é…ç½®çš„), å…¶é€»è¾‘æ˜¯, é€šè¿‡å·¥å‚è·å– ReactorServiceInstanceLoadBalancer å¯¹è±¡å¹¶è°ƒç”¨å…¶æ¥å£æ‰§è¡Œè´Ÿè½½å‡è¡¡ç®—æ³•.</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.springframework.cloud.loadbalancer.blocking.client.BlockingLoadBalancerClient</span></span><br><span class="line"><span class="comment">// å…ˆè¿›å…¥è¿™ä¸ªæ–¹æ³•, ç„¶åä¼šè°ƒç”¨ç¬¬äºŒä¸ªæ–¹æ³•.</span></span><br><span class="line"><span class="comment">// è¿™ä¸¤ä¸ªæ–¹æ³•å…¶å®å°±æ˜¯ä»å·¥å‚è·å–å¯¹è±¡æ‰§è¡Œ choose åå†è®©å…¶å®Œæˆè¯·æ±‚çš„æ‰§è¡Œ, å¤§éƒ¨åˆ†ä»£ç éƒ½æ˜¯ LoadBalancerLifecycle çš„è§¦å‘.</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(String serviceId, LoadBalancerRequest&lt;T&gt; request)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// éå† LoadBalancerLifecycle è§¦å‘ onStart é’©å­</span></span><br><span class="line">  <span class="comment">// è°ƒç”¨ choose æ–¹æ³•é€‰å–ä¸€ä¸ª IP:PORT å¾—åˆ°åŒ…è£…ç±» ServiceInstance</span></span><br><span class="line">  <span class="comment">// éå† LoadBalancerLifecycle è§¦å‘ onComplete é’©å­</span></span><br><span class="line">  <span class="comment">// æ‰§è¡Œè¯·æ±‚</span></span><br><span class="line">  String hint = getHint(serviceId);</span><br><span class="line">  LoadBalancerRequestAdapter&lt;T, DefaultRequestContext&gt; lbRequest = <span class="keyword">new</span> LoadBalancerRequestAdapter&lt;&gt;(request,</span><br><span class="line">                                                                                                    <span class="keyword">new</span> DefaultRequestContext(request, hint));</span><br><span class="line">  Set&lt;LoadBalancerLifecycle&gt; supportedLifecycleProcessors = LoadBalancerLifecycleValidator</span><br><span class="line">    .getSupportedLifecycleProcessors(</span><br><span class="line">    loadBalancerClientFactory.getInstances(serviceId, LoadBalancerLifecycle<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line"><span class="class">    <span class="title">DefaultRequestContext</span>.<span class="title">class</span>, <span class="title">Object</span>.<span class="title">class</span>, <span class="title">ServiceInstance</span>.<span class="title">class</span>)</span>;</span><br><span class="line">  supportedLifecycleProcessors.forEach(lifecycle -&gt; lifecycle.onStart(lbRequest));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä» serviceId å¯¹åº”çš„å®¹å™¨ä¸­è·å–ä¸€ä¸ªè´Ÿè½½å‡è¡¡ç®—æ³•å®ç°ç±»å¯¹è±¡, å³ ReactorServiceInstanceLoadBalancer.</span></span><br><span class="line">  <span class="comment">// è°ƒç”¨å…¶ choose æ–¹æ³•. ä»å“åº”ä¸­è·å– ServiceInstance å¹¶è¿”å›.</span></span><br><span class="line">  ServiceInstance serviceInstance = choose(serviceId, lbRequest);</span><br><span class="line">  <span class="keyword">if</span> (serviceInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">    supportedLifecycleProcessors.forEach(lifecycle -&gt; lifecycle.onComplete(</span><br><span class="line">      <span class="keyword">new</span> CompletionContext&lt;&gt;(CompletionContext.Status.DISCARD, lbRequest, <span class="keyword">new</span> EmptyResponse())));</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No instances available for "</span> + serviceId);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¯ä»¥æ‰§è¡Œäº†</span></span><br><span class="line">  <span class="keyword">return</span> execute(serviceId, serviceInstance, lbRequest);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(String serviceId, ServiceInstance serviceInstance, LoadBalancerRequest&lt;T&gt; request)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// éå† LoadBalancerLifecycle è§¦å‘ onStartRequest é’©å­</span></span><br><span class="line">  <span class="comment">// è°ƒç”¨ request.apply æ–¹æ³•æ‰§è¡Œè¯·æ±‚(å³è¿›å…¥ä¹‹å‰ LoadBalancerRequestFactory ä¸­çš„ä»£ç )</span></span><br><span class="line">  <span class="comment">// éå† LoadBalancerLifecycle è§¦å‘ onComplete é’©å­</span></span><br><span class="line"></span><br><span class="line">  DefaultResponse defaultResponse = <span class="keyword">new</span> DefaultResponse(serviceInstance);</span><br><span class="line">  Set&lt;LoadBalancerLifecycle&gt; supportedLifecycleProcessors = LoadBalancerLifecycleValidator</span><br><span class="line">    .getSupportedLifecycleProcessors(</span><br><span class="line">    loadBalancerClientFactory.getInstances(serviceId, LoadBalancerLifecycle<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line"><span class="class">    <span class="title">DefaultRequestContext</span>.<span class="title">class</span>, <span class="title">Object</span>.<span class="title">class</span>, <span class="title">ServiceInstance</span>.<span class="title">class</span>)</span>;</span><br><span class="line">  Request lbRequest = request <span class="keyword">instanceof</span> Request ? (Request) request : <span class="keyword">new</span> DefaultRequest&lt;&gt;();</span><br><span class="line">  supportedLifecycleProcessors</span><br><span class="line">    .forEach(lifecycle -&gt; lifecycle.onStartRequest(lbRequest, <span class="keyword">new</span> DefaultResponse(serviceInstance)));</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// è¯·æ±‚è°ƒç”¨å‰å…ˆä½¿ç”¨ transformers å¯¹åŸå§‹è¯·æ±‚å¯¹è±¡è¿›è¡Œä¸€äº›æ”¹å˜å¤„ç†åå†æ‰§è¡Œè¯·æ±‚</span></span><br><span class="line">    T response = request.apply(serviceInstance);</span><br><span class="line">    Object clientResponse = getClientResponse(response);</span><br><span class="line">    supportedLifecycleProcessors</span><br><span class="line">      .forEach(lifecycle -&gt; lifecycle.onComplete(<span class="keyword">new</span> CompletionContext&lt;&gt;(CompletionContext.Status.SUCCESS,</span><br><span class="line">                                                                         lbRequest, defaultResponse, clientResponse)));</span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (IOException iOException) &#123;</span><br><span class="line">    supportedLifecycleProcessors.forEach(lifecycle -&gt; lifecycle.onComplete(</span><br><span class="line">      <span class="keyword">new</span> CompletionContext&lt;&gt;(CompletionContext.Status.FAILED, iOException, lbRequest, defaultResponse)));</span><br><span class="line">    <span class="keyword">throw</span> iOException;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">    supportedLifecycleProcessors.forEach(lifecycle -&gt; lifecycle.onComplete(</span><br><span class="line">      <span class="keyword">new</span> CompletionContext&lt;&gt;(CompletionContext.Status.FAILED, exception, lbRequest, defaultResponse)));</span><br><span class="line">    ReflectionUtils.rethrowRuntimeException(exception);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>æ‰€ä»¥å†çœ‹çœ‹å·¥å‚æ˜¯æ€ä¹ˆè·å–å’Œå­˜æ”¾å¯¹è±¡çš„, å…³é”®ç±»: LoadBalancerClientFactory, å…¶ç»§æ‰¿è‡ª NamedContextFactory</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…ˆçœ‹å…¶å¦‚ä½•è·å–å¯¹è±¡çš„ LoadBalancerClientFactory#getInstance()</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ReactiveLoadBalancer&lt;ServiceInstance&gt; <span class="title">getInstance</span><span class="params">(String serviceId)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ä» serviceId å¯¹åº”çš„å®¹å™¨ä¸­è·å–ä¸€ä¸ªè´Ÿè½½å‡è¡¡ç®—æ³•å®ç°ç±»å¯¹è±¡, å³ ReactorServiceInstanceLoadBalancer.</span></span><br><span class="line">  <span class="keyword">return</span> getInstance(serviceId, ReactorServiceInstanceLoadBalancer<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// getInstance(serviceId, ReactorServiceInstanceLoadBalancer.class):</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getInstance</span><span class="params">(String name, Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">  AnnotationConfigApplicationContext context = getContext(name);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> context.getBean(type);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (NoSuchBeanDefinitionException e) &#123;</span><br><span class="line">    <span class="comment">// ignore</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// getContext(name):</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AnnotationConfigApplicationContext <span class="title">getContext</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.contexts.containsKey(name)) &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.contexts) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.contexts.containsKey(name)) &#123;</span><br><span class="line">        <span class="comment">// ç»“è®º: å®¹å™¨é‡Œæœ‰ç‚¹ä¸œè¥¿, ä½†ä¸å¤š...  ä¸»è¦æ˜¯äºçˆ¶å®¹å™¨æ‰“é€š... æ‰€ä»¥åˆå•¥éƒ½æœ‰äº†.</span></span><br><span class="line">        <span class="keyword">this</span>.contexts.put(name, createContext(name));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.contexts.get(name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// createContext(name):</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AnnotationConfigApplicationContext <span class="title">createContext</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 0.ç»“åˆå®ç°ç±» LoadBalancerClientFactory åšå‡ºå¦‚ä¸‹æ³¨é‡Š</span></span><br><span class="line">  <span class="comment">// 1.å°† LoadBalancerAutoConfiguration æ‰«æåˆ° configurations æ³¨å†Œåˆ° name å¯¹åº”çš„å®¹å™¨ä¸­.</span></span><br><span class="line">  <span class="comment">//     è¿™é‡Œçš„ name å…¶å®å°±æ˜¯ serviceId, ä¹Ÿå°±æ˜¯è¯´, è‹¥æˆ‘ä»¬æƒ³ç»™æŸä¸ªå®¹å™¨åŠ å…¥ä¸€äº›ä¸œè¥¿, åˆ™å®ç° LoadBalancerClientSpecification æ—¶, name éœ€è¦ä¸ serviceId å¯¹åº”èµ·æ¥(ç›¸åŒ)</span></span><br><span class="line">  <span class="comment">// 2.å½“æˆ‘ä¸Šé¢é‚£å¥æ²¡è¯´å•Š... åŸæ¥ name ä¸º default. å¼€å¤´æ˜¯å¯ä»¥åŠ å…¥ä»»æ„ serviceId å¯¹åº”çš„å®¹å™¨çš„.........................(qiao)</span></span><br><span class="line">  <span class="comment">// 3.ä¸ºå®¹å™¨åŠ å…¥ä¸€ä¸ªå ä½ç¬¦è§£æå™¨, å’Œä¸€ä¸ª defaultConfigType(=LoadBalancerClientConfiguration.class, ä½œç”¨é…ç½®ä¸€äº› bean)</span></span><br><span class="line">  <span class="comment">//     LoadBalancerClientConfiguration ä¼šåŠ å…¥ä¸€ä¸ª RoundRobinLoadBalancer, çœ‹æ¥å°±æ˜¯é»˜è®¤çš„è´Ÿè½½å‡è¡¡ç±»äº†.</span></span><br><span class="line">  <span class="comment">// 4.é»˜è®¤ä¸ºåŠ äº†ä¸€ä¸ªåä¸º loadbalancer çš„ PropertySource, é‡Œé¢æœ‰ä¸€ä¸ª loadbalancer.client.name=serviceId çš„é…ç½®....</span></span><br><span class="line">  <span class="comment">// 5.è®¾å®šçˆ¶å®¹å™¨, çˆ¶å®¹å™¨é€šè¿‡ ApplicationContextAware è·å¾—, è¿™æ ·åˆšæ‰é‚£ä¹ˆè¾›è‹¦çš„æ³¨å†Œæ–¹å¼, å°±ä»…é€‚åˆäºç‰¹æ€§, è€Œéé€šç”¨äº†.</span></span><br><span class="line">  <span class="comment">// 6.è®¾ç½®åç§°(å•¥æ„ä¹‰å‘¢?), ç„¶åè°ƒç”¨å®¹å™¨çš„ refresh() å®Œæˆå®¹å™¨åŠ è½½</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.configurations.containsKey(name)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; configuration : <span class="keyword">this</span>.configurations.get(name).getConfiguration()) &#123;</span><br><span class="line">      context.register(configuration);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (Map.Entry&lt;String, C&gt; entry : <span class="keyword">this</span>.configurations.entrySet()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (entry.getKey().startsWith(<span class="string">"default."</span>)) &#123;</span><br><span class="line">      <span class="keyword">for</span> (Class&lt;?&gt; configuration : entry.getValue().getConfiguration()) &#123;</span><br><span class="line">        context.register(configuration);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  context.register(PropertyPlaceholderAutoConfiguration<span class="class">.<span class="keyword">class</span>, <span class="title">this</span>.<span class="title">defaultConfigType</span>)</span>;</span><br><span class="line">  <span class="comment">// é»˜è®¤ä¸ºåŠ äº†ä¸€ä¸ªåä¸º loadbalancer çš„ PropertySource, é‡Œé¢æœ‰ä¸€ä¸ª loadbalancer.client.name=serviceId çš„é…ç½®....</span></span><br><span class="line">  context.getEnvironment().getPropertySources().addFirst(<span class="keyword">new</span> MapPropertySource(<span class="keyword">this</span>.propertySourceName,</span><br><span class="line">                                                                               Collections.&lt;String, Object&gt;singletonMap(<span class="keyword">this</span>.propertyName, name)));</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Uses Environment from parent as well as beans</span></span><br><span class="line">    context.setParent(<span class="keyword">this</span>.parent);</span><br><span class="line">    <span class="comment">// jdk11 issue</span></span><br><span class="line">    <span class="comment">// https://github.com/spring-cloud/spring-cloud-netflix/issues/3101</span></span><br><span class="line">    context.setClassLoader(<span class="keyword">this</span>.parent.getClassLoader());</span><br><span class="line">  &#125;</span><br><span class="line">  context.setDisplayName(generateDisplayName(name));</span><br><span class="line">  context.refresh();</span><br><span class="line">  <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®è¿™å¥ context.register(PropertyPlaceholderAutoConfiguration.class, this.defaultConfigType);</span></span><br><span class="line"><span class="comment">// è€Œ defaultConfigType åœ¨ LoadBalancerClientFactory å®šä¹‰ä¸º LoadBalancerClientConfiguration.class, å…¶é…ç½®äº†ä¸€ä¸ª bean, ä»£ç å¦‚ä¸‹</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ReactorLoadBalancer&lt;ServiceInstance&gt; <span class="title">reactorServiceInstanceLoadBalancer</span><span class="params">(Environment environment,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                                               LoadBalancerClientFactory loadBalancerClientFactory)</span> </span>&#123;</span><br><span class="line">  String name = environment.getProperty(LoadBalancerClientFactory.PROPERTY_NAME);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> RoundRobinLoadBalancer(</span><br><span class="line">    loadBalancerClientFactory.getLazyProvider(name, ServiceInstanceListSupplier<span class="class">.<span class="keyword">class</span>), <span class="title">name</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è¿™é‡Œä¼šä¸æœåŠ¡å‘ç°ç»“åˆèµ·æ¥, å³ loadBalancerClientFactory.getLazyProvider(name, ServiceInstanceListSupplier.class)</span></span><br><span class="line"><span class="comment">// æ­¤æ–¹æ³•ä»å®¹å™¨ä¸­è·å–èƒ½æä¾› ServiceInstanceListSupplier.class ç±»å‹çš„ BeanProvider, å…¶å®å°±æ˜¯èƒ½è·å–è¿™ç§ç±»å‹çš„ bean å‘—, ç„¶åç”¨è¿™ä¸ªç±»æ¥è·å– url åˆ—è¡¨...  å…·ä½“å®ç°è¦çœ‹ Nacos / Consul äº†.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰€ä»¥é»˜è®¤è·å–çš„è´Ÿè½½å‡è¡¡ç­–ç•¥å°±æ˜¯å®ƒäº†:  RoundRobinLoadBalancer</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“: ç”¨äº†ä¸€ä¸ª LoadBalancerAutoConfiguration, ä¸º RestTemplate åŠ ä¸€ä¸ªæ‹¦æˆªå™¨ä½¿å¾—æ‰§è¡Œè¯·æ±‚å‰å…ˆä¿®æ”¹ä¸€ä¸‹è¯·æ±‚å¯¹è±¡(ä¸»è¦ä¿®æ”¹urlå‘—), ä¿®æ”¹çš„æ­¥éª¤æ˜¯ LoadBalancerClient.execute(), é‡Œé¢åˆ™ä¼šä½¿ç”¨ choose è·å–å¾®æœåŠ¡çœŸå®url, choose æ˜¯ ReactorLoadBalancer  çš„æ¥å£, ä»£è¡¨è´Ÿè½½å‡è¡¡ç­–ç•¥. å•Šå¯¹äº†, æ—¢ç„¶æ˜¯è´Ÿè½½å‡è¡¡ç®—æ³•, é‚£å°±æ˜¯è´Ÿè´£é€‰å–, ä¸è´Ÿè´£è·å–æ‰å¯¹â€¦ äºæ˜¯æˆ‘å‘ç° loadBalancerClientFactory.getLazyProvider(name, ServiceInstanceListSupplier.class) æ‰æ˜¯å¾—åˆ°çš„å¯¹è±¡, æ‰æ˜¯è·å– url åˆ—è¡¨çš„ä»£ç (è‚¯å®šå’Œconsulæˆ–nacosæœ‰å…³äº†)!!</p>
<p>æš—ç¤ºä¸‹é›†å‡º Nacos!!</p>
</blockquote>
<h2 id="Cloud-Alibaba-å’Œ-Spring-Cloud-æ•´åˆ-Spring-Cloud-Commons-æ­¥éª¤-æŒ‡æœåŠ¡æ³¨å†Œä¸å‘ç°"><a href="#Cloud-Alibaba-å’Œ-Spring-Cloud-æ•´åˆ-Spring-Cloud-Commons-æ­¥éª¤-æŒ‡æœåŠ¡æ³¨å†Œä¸å‘ç°" class="headerlink" title="Cloud Alibaba å’Œ Spring Cloud æ•´åˆ Spring Cloud Commons æ­¥éª¤(æŒ‡æœåŠ¡æ³¨å†Œä¸å‘ç°)"></a>Cloud Alibaba å’Œ Spring Cloud æ•´åˆ Spring Cloud Commons æ­¥éª¤(æŒ‡æœåŠ¡æ³¨å†Œä¸å‘ç°)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.å¸Œæœ›åˆ«å¤ªç®€å•</span><br><span class="line">2.å°±ä¸å†™è¿™é‡Œäº†(å› ä¸ºè¿˜æ²¡å†™å•Š!)</span><br><span class="line">3.ä¸‹é›†è§</span><br></pre></td></tr></table></figure>



<h2 id="Spring-Cloud-æ•´åˆ-spring-cloud-loadbalancer"><a href="#Spring-Cloud-æ•´åˆ-spring-cloud-loadbalancer" class="headerlink" title="Spring Cloud æ•´åˆ spring-cloud-loadbalancer"></a>Spring Cloud æ•´åˆ spring-cloud-loadbalancer</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.pom æ·»åŠ ä¾èµ–å³å¯</span><br><span class="line">2.pom æ·»åŠ ä¾èµ–å³å¯</span><br><span class="line">3.pom æ·»åŠ ä¾èµ–å³å¯</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ€»ç»“</span></span><br><span class="line">æˆ‘ä¹Ÿæ²¡æƒ³åˆ°, æ²¡å¤šå†™ä¸€ä¸ªç±», ç›´æ¥å°±èƒ½ç”¨...  åŸç†ä¸Šé¢åˆ†æäº† ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­</span><br></pre></td></tr></table></figure>



<h2 id="Cloud-Alibaba-æ•´åˆ-spring-cloud-loadbalancer"><a href="#Cloud-Alibaba-æ•´åˆ-spring-cloud-loadbalancer" class="headerlink" title="Cloud Alibaba æ•´åˆ spring-cloud-loadbalancer"></a>Cloud Alibaba æ•´åˆ spring-cloud-loadbalancer</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.pom æ·»åŠ ä¾èµ–å³å¯</span><br><span class="line">2.pom æ·»åŠ ä¾èµ–å³å¯</span><br><span class="line">3.pom æ·»åŠ ä¾èµ–å³å¯</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ€»ç»“</span></span><br><span class="line">æˆ‘ä¹Ÿæ²¡æƒ³åˆ°, æ²¡å¤šå†™ä¸€ä¸ªç±», ç›´æ¥å°±èƒ½ç”¨...  åŸç†ä¸Šé¢åˆ†æäº† ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“: ä½ æ²¡å¡, ä½ ç”µè„‘æ²¡é—®é¢˜, æˆ‘å°±æ˜¯å†™(zhan)äº†(tie)ä¸¤é!!!</p>
</blockquote>
<h2 id="Spring-Cloud-Commons-çš„æ ¸å¿ƒç±»åŠå…¶ä½œç”¨"><a href="#Spring-Cloud-Commons-çš„æ ¸å¿ƒç±»åŠå…¶ä½œç”¨" class="headerlink" title="Spring Cloud Commons çš„æ ¸å¿ƒç±»åŠå…¶ä½œç”¨"></a>Spring Cloud Commons çš„æ ¸å¿ƒç±»åŠå…¶ä½œç”¨</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.LoadBalancerClient: å®ç°å®ƒå°±å®ç°äº†è´Ÿè½½å‡è¡¡ç­–ç•¥</span><br><span class="line">	ä½†å…¶å®å®ç° ReactorServiceInstanceLoadBalancer æ›´ç®€å•</span><br><span class="line">2.DiscoveryClient: å®ç°å®ƒå°±å®ç°äº†æœåŠ¡å‘ç°</span><br><span class="line">3.ServiceRegistry: å®ç°å®ƒå°±å®ç°äº†æœåŠ¡æ³¨å†Œ</span><br><span class="line">4.ServiceInstance: ä»£è¡¨ä¸€ä¸ªæœåŠ¡, å‰é¢åŠ ä¸ª Micro å°±æ˜¯å¾®æœåŠ¡äº† :D</span><br></pre></td></tr></table></figure>





<blockquote>
<p>PS: å°±è¿™!</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://gudqs7.github.io/2021/01/25/source-code-jdk/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="gudqs7">
      <meta itemprop="description" content="å¿ƒç´¯æ²¡é’±èººå°¸ä¸­">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="gudqs7's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/25/source-code-jdk/" class="post-title-link" itemprop="url">source-code-jdk</a>
        </h2>

        <div class="post-meta">
			
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-01-25 23:12:48" itemprop="dateCreated datePublished" datetime="2021-01-25T23:12:48+08:00">2021-01-25</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/2021/01/25/source-code-jdk/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/01/25/source-code-jdk/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://gudqs7.github.io/2021/01/25/source-code-spring-mvc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="gudqs7">
      <meta itemprop="description" content="å¿ƒç´¯æ²¡é’±èººå°¸ä¸­">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="gudqs7's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/25/source-code-spring-mvc/" class="post-title-link" itemprop="url">Spring MVC æºç ç¬”è®°</a>
        </h2>

        <div class="post-meta">
			
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-01-25 23:12:41" itemprop="dateCreated datePublished" datetime="2021-01-25T23:12:41+08:00">2021-01-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-01-26 21:25:55" itemprop="dateModified" datetime="2021-01-26T21:25:55+08:00">2021-01-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SourceCode/" itemprop="url" rel="index"><span itemprop="name">SourceCode</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring-MVC/" itemprop="url" rel="index"><span itemprop="name">Spring MVC</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/2021/01/25/source-code-spring-mvc/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/01/25/source-code-spring-mvc/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Spring-MVC-æºç ç¬”è®°"><a href="#Spring-MVC-æºç ç¬”è®°" class="headerlink" title="Spring MVC æºç ç¬”è®°"></a>Spring MVC æºç ç¬”è®°</h1><h2 id="å…³é”®ç±»åˆ†æ"><a href="#å…³é”®ç±»åˆ†æ" class="headerlink" title="å…³é”®ç±»åˆ†æ"></a>å…³é”®ç±»åˆ†æ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">WebMvcConfigurationSupport</span><br><span class="line">	é»˜è®¤æ³¨å†Œäº†å¾ˆå¤šä¸œè¥¿,å¦‚ HandlerMapping å‡ ä¸ªå®ç°, HandlerAdaptor å‡ ä¸ªå®ç°</span><br><span class="line"></span><br><span class="line">HandlerMapping</span><br><span class="line">	æ·»åŠ å®¹å™¨å†…æ‰€æœ‰å¸¦æœ‰ RequestMaping çš„ç±»çš„å…¬å¼€æ–¹æ³•åˆ° mappings ä¸­å­˜èµ·æ¥</span><br><span class="line">		(AbstractHandlerMethodMapping<span class="comment">#afterPropertiesSetä¸­)</span></span><br><span class="line">    æ ¹æ® request çš„ uri æŸ¥æ‰¾å¯¹åº”çš„ HandlerMethod, æ­¥éª¤æ¦‚è¿°:</span><br><span class="line">    	æŠŠRequestMappingæ³¨è§£å†…çš„ path ä½œä¸º key ä¿æŒåˆ°ä¸€ä¸ª map1</span><br><span class="line">    	å…¶ä»–ä¿¡æ¯å°è£…æˆ mapping ä½œä¸º key ä¹Ÿä¿æŒåˆ°å¦ä¸€ä¸ª map2</span><br><span class="line">    	æ ¹æ® uriå» map1 è·å– mapping, å†æ ¹æ® mapping è·å– HandlerMethod</span><br><span class="line">    	å°è£…æˆ Match å¯¹è±¡, ä¸å…¶ä»–åŒ¹é…å¯¹è±¡åšæ¯”è¾ƒå, è¿”å› HandlerMethod</span><br><span class="line"></span><br><span class="line">HandlerAdapter</span><br><span class="line">	åˆå§‹åŒ–å‚æ•°è§£æï¼Œè¿”å›å€¼è§£æç­‰</span><br><span class="line">		(RequestMappingHandlerAdapter<span class="comment">#afterPropertiesSet)</span></span><br><span class="line">	æ ¹æ® handler ç¡®å®šå¯¹åº”çš„ HandlerAdapter, ç„¶å HandlerAdapter è´Ÿè´£æ‰§è¡Œè¿™ä¸ª handler</span><br><span class="line">    å¦‚ RequestMappingHandlerAdapter åˆ™è´Ÿè´£æ‰§è¡Œ HandlerMethod</span><br><span class="line">    	ç®€å•è¯´å°±æ˜¯å°è£… HandlerMethod, æ ¹æ®å‚æ•°å€¼è®¾ç½®å‚æ•°, ç„¶åè°ƒç”¨æ–¹æ³•, å†å¤„ç†è¿”å›å€¼å°è£…æˆ ModelAndView</span><br><span class="line">    å¦å¤–ï¼Œè¿™é‡Œå¦‚æœä½¿ç”¨äº†@ResponseBodyï¼Œä¼šè¿›å…¥ RequestResponseBodyMethodProcessor</span><br><span class="line">    	ç„¶åä½¿ç”¨ messageConvertersï¼ˆjsonï¼‰å†™å…¥åˆ°å“åº”æµ</span><br><span class="line">    	æœ€å mv ä¹Ÿç›´æ¥è¿”å›null, ä¸éœ€è¦renderäº†.</span><br><span class="line"></span><br><span class="line">ViewResolver</span><br><span class="line">	è´Ÿè´£å°† ModelAndView è§£ææˆHTML, å¦‚JSP, FreeMarker</span><br><span class="line"></span><br><span class="line">HandlerExecutionChian</span><br><span class="line">	ç®¡ç†æ‹¦æˆªå™¨å’Œå°è£…Handler, è´Ÿè´£æ‹¦æˆªå™¨çš„å®é™…è°ƒç”¨é€»è¾‘å®ç°</span><br><span class="line">	</span><br><span class="line">DispatcherServlet</span><br><span class="line">	è°ƒåº¦æ•´ä¸ªHTTPè¯·æ±‚å“åº”æµç¨‹, è°ƒç”¨å„ä¸ªå­ç»„ä»¶è´Ÿè´£æ‰§è¡Œå¤„ç†æ–¹æ³•, è§£æè§†å›¾, å¤„ç†å¼‚å¸¸ç­‰.</span><br></pre></td></tr></table></figure>





<h2 id="SSMé¡¹ç›®-Spring-å®¹å™¨å’Œ-Spring-MVC-å®¹å™¨çš„åˆ›å»ºè¿‡ç¨‹åŠå…³ç³»"><a href="#SSMé¡¹ç›®-Spring-å®¹å™¨å’Œ-Spring-MVC-å®¹å™¨çš„åˆ›å»ºè¿‡ç¨‹åŠå…³ç³»" class="headerlink" title="SSMé¡¹ç›® Spring å®¹å™¨å’Œ Spring MVC å®¹å™¨çš„åˆ›å»ºè¿‡ç¨‹åŠå…³ç³»"></a>SSMé¡¹ç›® Spring å®¹å™¨å’Œ Spring MVC å®¹å™¨çš„åˆ›å»ºè¿‡ç¨‹åŠå…³ç³»</h2><h3 id="Spring-å®¹å™¨çš„åˆ›å»º"><a href="#Spring-å®¹å™¨çš„åˆ›å»º" class="headerlink" title="Spring å®¹å™¨çš„åˆ›å»º"></a>Spring å®¹å™¨çš„åˆ›å»º</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.web.context.ContextLoader<span class="comment">#initWebApplicationContext</span></span><br><span class="line">1.å…ˆåˆ¤æ–­æ­¤æ–¹æ³•æ˜¯å¦é‡å¤è¿è¡Œ, è‹¥é‡å¤åˆ™æŠ¥å¼‚å¸¸.</span><br><span class="line">2.è®°å½•æ—¥å¿—, è®°å½•å¼€å§‹æ—¶é—´ç”¨äºè®¡ç®—å¯åŠ¨æ¶ˆè€—æ—¶é—´</span><br><span class="line">3.å°†å®¹å™¨å¯¹è±¡å­˜å‚¨åœ¨æœ¬åœ°è€Œé servletContext, é˜²æ­¢ ServletContext å…³é—­åæ— æ³•è®¿é—®</span><br><span class="line">4.æ ¹æ®é…ç½®çš„ç±»å, å®ä¾‹åŒ–ä¸€ä¸ªå®¹å™¨å¹¶èµ‹å€¼ç»™ this.context</span><br><span class="line">5.æ ‡å‡†ä»£ç , ä½†å…¶å®å°±æ˜¯ setParent(null), å‰ææ˜¯ä¸æ‰©å±•å­ç±»å’¯. ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªå°±æ˜¯é¡¶çº§å®¹å™¨äº†</span><br><span class="line">6.æ ¹æ® web.xml çš„é…ç½®å¯¹å®¹å™¨åšç›¸åº”çš„é…ç½®, åˆå§‹åŒ–, å°† ServletContext å­˜å…¥åˆ° environment å¯¹è±¡ä¸­; æ‰§è¡Œ InitializerClass, è°ƒç”¨å®¹å™¨ refresh å®Œæˆå®¹å™¨åŠ è½½</span><br><span class="line">7.æ‰“å°å®¹å™¨åˆå§‹åŒ–å®Œæˆæ—¥å¿—å’Œè®°å½•è€—æ—¶</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“: ç›‘å¬ ServletContext åˆ›å»ºå®Œæ¯•çš„äº‹ä»¶, ç„¶ååˆ›å»ºä¸€ä¸ª web å®¹å™¨, é…ç½®ä¸€äº›ä¸œè¥¿(id, parent, environment)å¹¶åˆå§‹åŒ–(refresh)</p>
</blockquote>
<h3 id="MVC-å­å®¹å™¨çš„åˆ›å»º"><a href="#MVC-å­å®¹å™¨çš„åˆ›å»º" class="headerlink" title="MVC å­å®¹å™¨çš„åˆ›å»º"></a>MVC å­å®¹å™¨çš„åˆ›å»º</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.é¦–å…ˆæ˜¯ DispatchServlet æœ¬èº«æ˜¯ä¸€ä¸ª Servlet, å› æ­¤ä»–æœ‰ç”Ÿå‘½å‘¨æœŸ init(), å…¶çˆ¶ç±» init() ä¼šå°† ServletConfig çš„é…ç½®(web.xml ä¸­çš„ initParams)ä¸ servlet å¯¹è±¡ç»‘å®š, è¿™æ · DispatchServlet å¯¹è±¡çš„å­—æ®µå°±æœ‰å€¼äº†.</span><br><span class="line">2.ç„¶ååœ¨ DispatchServlet çš„çˆ¶ç±» FrameworkServlet<span class="comment">#initServletBean ä¸­, ä¼šåˆ›å»ºä¸€ä¸ªå®¹å™¨å¹¶ä½¿å…¶åŠ è½½.(è¯¦ç»†è§ FrameworkServlet#initWebApplicationContext() )</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“: å°±æ˜¯åˆ©ç”¨ Servlet çš„ç”Ÿå‘½å‘¨æœŸåªä¼šæ‰§è¡Œä¸€æ¬¡ init çš„ç‰¹æ€§, æŸ¥æ‰¾çˆ¶å®¹å™¨, åˆ›å»ºå­å®¹å™¨.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.web.servlet.HttpServletBean#init</span><br><span class="line">    <span class="comment">// 1.æŠŠ servletConfig çš„ initParameters éƒ½åŠ å…¥ PropertySource, æ ¹æ® requiredProperties åˆ¤æ–­æ‰€éœ€é…ç½®é¡¹æ˜¯å¦é½å…¨</span></span><br><span class="line">		<span class="comment">// 2.å°†é…ç½®é¡¹ç»‘å®šåˆ° Servlet å¯¹è±¡(this) ä¸Š(å­ç±»çš„å­—æ®µä¹Ÿç®—).</span></span><br><span class="line">		<span class="comment">// 3.è°ƒç”¨å­ç±»åˆå§‹åŒ–æ–¹æ³•</span></span><br><span class="line">  </span><br><span class="line">org.springframework.web.servlet.FrameworkServlet#initServletBean</span><br><span class="line">    <span class="comment">// 0.çˆ¶ç±»çš„ init æ‰§è¡Œå®Œ, æ­¤æ—¶ contextConfigLocation å·²ç»æœ‰å€¼äº†</span></span><br><span class="line">		<span class="comment">// 1.è®°å½•æ—¥å¿—å’Œå¼€å§‹æ—¶é—´</span></span><br><span class="line">		<span class="comment">// 2.åˆ›å»ºå­å®¹å™¨, ä¸çˆ¶å®¹å™¨ç»‘å®š, åšä¸€äº›é…ç½®, è°ƒç”¨ refresh() å®ŒæˆåŠ è½½.</span></span><br><span class="line">		<span class="comment">// 3.æ‰“å°æ—¥å¿—, æ‰“å°è€—æ—¶</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">org.springframework.web.servlet.FrameworkServlet#initWebApplicationContext</span><br><span class="line">    <span class="comment">// 1.ä» ServletContext ä¸­è·å– Spring å®¹å™¨.(é‚£ä¹ˆè°æ”¾è¿›å»çš„å‘¢? æ²¡é”™, å°±æ˜¯ ContextLoader,ç›‘å¬äº† ServletContext äº‹ä»¶)</span></span><br><span class="line">		<span class="comment">// 2.è‹¥å®¹å™¨åœ¨æ„é€ æ–¹æ³•å¤„è¢«æ³¨å…¥(å¯èƒ½æ˜¯æ³¨è§£å¼€å‘ Spring MVC çš„æ–¹å¼ä¼šè§¦å‘), å…ˆå¿½è§†  -- æ¥è‡ª web.xml å½¢å¼å¯åŠ¨åˆ†æ</span></span><br><span class="line">		<span class="comment">// 3.æ ¹æ®ç»‘å®šå¾—åˆ°çš„é…ç½®çš„ contextClass åˆ›å»ºä¸€ä¸ªå­å®¹å™¨, è¿›è¡Œä¸€äº›é…ç½®å’Œåˆå§‹åŒ–, è°ƒç”¨ refresh() å®Œæˆå®¹å™¨åŠ è½½</span></span><br><span class="line">		<span class="comment">// 4.é˜²æ­¢å­å®¹å™¨ä¸æ”¯æŒ refresh, æˆ–å­å®¹å™¨ä¸æ˜¯åˆšåˆšåˆ›å»ºçš„, å› æ­¤æ‰‹åŠ¨è§¦å‘ onRefresh(), è¿™ä¸ªæ–¹æ³•ä¼šåŠ è½½ä¸€äº›é»˜è®¤çš„ bean(ç”¨å¤„å¾ˆå¤§çš„é‚£ç§)</span></span><br><span class="line">		<span class="comment">// 5.å°†å®¹å™¨è®¾ç½®åˆ° ServletContext ä¸­(æ ¹æ®é…ç½®, é»˜è®¤å…è®¸)</span></span><br><span class="line">		<span class="comment">// 6.è¿”å›åˆ›å»ºçš„å­å®¹å™¨å¯¹è±¡</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">org.springframework.web.servlet.FrameworkServlet#configureAndRefreshWebApplicationContext</span><br><span class="line">    <span class="comment">// 1.æ ¹æ®ç»‘å®šå¾—åˆ°çš„é…ç½®è®¾ç½®å®¹å™¨ id, è‹¥æ— åˆ™ç”Ÿæˆé»˜è®¤çš„</span></span><br><span class="line">		<span class="comment">// 2.è®¾ç½® ServletContext/ServletConfig å¯¹è±¡</span></span><br><span class="line">		<span class="comment">// 3.ä¸ºå­å®¹å™¨æ·»åŠ ä¸€ä¸ªç›‘å¬åªç›‘å¬å­å®¹å™¨åˆ·æ–°äº‹ä»¶çš„ç›‘å¬å™¨, ç”¨äºå®¹å™¨åŠ è½½å®Œæ¯•åè°ƒç”¨ FrameworkServlet.onApplicationEvent()</span></span><br><span class="line">		<span class="comment">// 4.å°† ServletConfig/ServletContext åŠ å…¥åˆ° environment ä¸­.</span></span><br><span class="line">		<span class="comment">// 5.æ‰§è¡Œ web.xml ä¸­é…ç½®çš„ Initializers, ä¸ºå­å®¹å™¨åšçš„åˆå§‹åŒ–</span></span><br><span class="line">		<span class="comment">// 6.è°ƒç”¨å­å®¹å™¨çš„ refresh(), å®Œæˆå®¹å™¨çš„åŠ è½½</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">org.springframework.web.servlet.DispatcherServlet#initStrategies</span><br><span class="line">    <span class="comment">// åŠ è½½æ–‡ä»¶ä¸Šä¼ å¤„ç† bean</span></span><br><span class="line">		<span class="comment">// åŠ è½½å›½é™…åŒ–å¤„ç† bean</span></span><br><span class="line">		<span class="comment">// åŠ è½½ä¸»é¢˜åˆ‡æ¢å¤„ç† bean</span></span><br><span class="line">		<span class="comment">// åŠ è½½ HandlerMapping bean</span></span><br><span class="line">		<span class="comment">// åŠ è½½ HandlerAdapter bean</span></span><br><span class="line">		<span class="comment">// åŠ è½½å¼‚å¸¸å¤„ç† bean</span></span><br><span class="line">		<span class="comment">// åŠ è½½ HttpServletRequest è½¬è§†å›¾åç§°å¤„ç†ç­–ç•¥ bean</span></span><br><span class="line">		<span class="comment">// åŠ è½½è§†å›¾è§£æå™¨</span></span><br><span class="line">		<span class="comment">// åŠ è½½ FlashMap ç®¡ç† bean</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// æ¯ä¸€ä¸ªåŠ è½½çš„é€»è¾‘éƒ½æ˜¯ç±»ä¼¼çš„, å…ˆä»å®¹å™¨ä¸­æ ¹æ® Xxx.class getBean</span></span><br><span class="line">		<span class="comment">// è‹¥æ— , åˆ™è°ƒç”¨ getDefaultStrategy() ä» DispatcherServlet.properties é…ç½®æ–‡ä»¶ä¸­è¯»å–</span></span><br></pre></td></tr></table></figure>



<h3 id="DispatchServlet-çš„åˆ›å»º"><a href="#DispatchServlet-çš„åˆ›å»º" class="headerlink" title="DispatchServlet çš„åˆ›å»º"></a>DispatchServlet çš„åˆ›å»º</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.Tomcat ä¼šåˆ›å»ºé…ç½®åœ¨ web.xml çš„ Servlet</span><br><span class="line">2.æ¥ç€ä¼šè§¦å‘ init æ–¹æ³•, init è°ƒç”¨äº†åˆ›å»ºå­å®¹å™¨çš„æ–¹æ³•å, è¿˜æ·»åŠ äº†å®¹å™¨åŠ è½½å®Œæ¯•äº‹ä»¶ç›‘å¬æ¥å›è°ƒ DispatcherServlet<span class="comment">#onRefresh</span></span><br><span class="line">3.DispatcherServlet<span class="comment">#onRefresh ä¼š initStrategies() åŠ è½½å¾ˆå¤šç­–ç•¥æ¥å£ bean.</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“: å’Œå­å®¹å™¨çš„åˆ›å»ºæ¯æ¯ç›¸å…³.</p>
</blockquote>
<h2 id="Dispatch-è¿‡ç¨‹"><a href="#Dispatch-è¿‡ç¨‹" class="headerlink" title="Dispatch è¿‡ç¨‹"></a>Dispatch è¿‡ç¨‹</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1.è¦†ç›– HttpServlet çš„ service æ–¹æ³•, è°ƒç”¨ FrameworkServlet<span class="comment">#processRequest()</span></span><br><span class="line">2.æ­¤æ–¹æ³•ä¸­è¿›è¡Œä¸€äº›ä¸Šä¸‹æ–‡çš„å‡†å¤‡å·¥ä½œ, ä»¥åŠå¤„ç†æ—¥å¿—, å¼‚å¸¸(é controller å¼‚å¸¸), ç„¶åè°ƒç”¨ DispatcherServlet<span class="comment">#doService()</span></span><br><span class="line">3.doService() ä¸­å¯¹ request åšä¸€äº›å‡†å¤‡å·¥ä½œ, ç„¶åè°ƒç”¨ DispatcherServlet<span class="comment">#doDispatch()</span></span><br><span class="line">4.doDispatch() å…ˆç”¨ handlerMappings æŸ¥æ‰¾åˆé€‚çš„ handler(å¹¶åŠ å…¥æ‹¦æˆªå™¨é“¾), å†é€šè¿‡ handlerAdapters å¾—åˆ° handler çš„é€‚é…å™¨, åœ¨åˆé€‚çš„åœ°æ–¹è§¦å‘æ‹¦æˆªå™¨; ç„¶åè°ƒç”¨é€‚é…å™¨çš„ handle() å¾—åˆ° ModelAndView</span><br><span class="line">5.å¾—åˆ° ModelAndView å, å…ˆåˆ¤æ–­æ˜¯å¦æ•è·åˆ°äº†å¼‚å¸¸, æ˜¯åˆ™è°ƒç”¨ handlerExceptionResolvers çš„ resolveException() å¤„ç†å¼‚å¸¸</span><br><span class="line">6.æ¥ç€, è°ƒç”¨ viewResolvers çš„ resolveViewName, å°† viewName è§£ææˆä¸€ä¸ª View å¯¹è±¡</span><br><span class="line">7.è°ƒç”¨ View å¯¹è±¡çš„ render(), å°†è§†å›¾é€šè¿‡ response å“åº”åˆ°å‰ç«¯.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“: handlerMappings æ‰¾ handler å¹¶åŒ…è£…æ‹¦æˆªå™¨é“¾, handlerAdapters æ‰¾å¯æ‰§è¡Œçš„ HandlerAdapter, viewResolvers è§£æè§†å›¾, æ¸²æŸ“è§†å›¾.</p>
</blockquote>
<h3 id="è¶…é•¿æºç æ³¨é‡Š"><a href="#è¶…é•¿æºç æ³¨é‡Š" class="headerlink" title="è¶…é•¿æºç æ³¨é‡Š"></a>è¶…é•¿æºç æ³¨é‡Š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…¥å£ HttpServlet.service</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">  HttpMethod httpMethod = HttpMethod.resolve(request.getMethod());</span><br><span class="line">  <span class="keyword">if</span> (httpMethod == HttpMethod.PATCH || httpMethod == <span class="keyword">null</span>) &#123;</span><br><span class="line">    processRequest(request, response);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.service(request, response);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€è¿›å…¥åˆ° processRequest, æˆ‘åªå†™æ³¨é‡Šäº†å•Š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.web.servlet.FrameworkServlet#processRequest</span><br><span class="line">    <span class="comment">// 1.è®°å½•å¯åŠ¨æ—¶é—´</span></span><br><span class="line">		<span class="comment">// 2.å‡†å¤‡å›½é™…åŒ–å¤„ç†ä¸Šä¸‹æ–‡</span></span><br><span class="line">		<span class="comment">// 3.å‡†å¤‡å±æ€§ç®¡ç†ä¸Šä¸‹æ–‡</span></span><br><span class="line">		<span class="comment">// 4.è·å–å¹¶ç¼“å­˜ä¸€ä¸ª asyncManager(å¼‚æ­¥)</span></span><br><span class="line">		<span class="comment">// 5.åˆå§‹åŒ–ä¸¤ä¸ª ContextHolder</span></span><br><span class="line">		<span class="comment">// 6.å¤„ç†æ–‡ä»¶ä¸Šä¼ , æ ¹æ®ä¸åŒç­–ç•¥æŸ¥æ‰¾å¯æ‰§è¡Œçš„ controller æ–¹æ³•, æŸ¥åˆ°ååŠ å…¥æ‹¦æˆªå™¨, å†é€šè¿‡é€‚é…å™¨æ¥æ‰§è¡Œ controller æ–¹æ³•, ç„¶åæŠŠå¾—åˆ°çš„ ModelAndView è§£ææˆè§†å›¾å¯¹è±¡, å¹¶æ¸²æŸ“åˆ°å‰ç«¯.</span></span><br><span class="line">		<span class="comment">// 7.é‡ç½®ä¸¤ä¸ª ContextHolder</span></span><br><span class="line">		<span class="comment">// 8.æ‰“å°æ—¥å¿—, å‘å¸ƒäº‹ä»¶</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">org.springframework.web.servlet.DispatcherServlet#doService</span><br><span class="line">    <span class="comment">// 1.æ‰“å°æ—¥å¿—, è®°å½•è¯·æ±‚ä¿¡æ¯</span></span><br><span class="line">		<span class="comment">// 2.ä¿å­˜ä¸€ä»½è¯·æ±‚ä¸Šä¸‹æ–‡çš„å¿«ç…§, è¿™æ ·åµŒå¥—çš„è¯·æ±‚åœ¨å›å½’æ—¶å¯ä»¥æ¢å¤æ•°æ®</span></span><br><span class="line">		<span class="comment">// 3.å°†å®¹å™¨ä¸­çš„ä¸€äº› bean é…ç½®åˆ°è¯·æ±‚ä¸Šä¸‹æ–‡ä¸­</span></span><br><span class="line">		<span class="comment">// 4.å¤„ç†æ–‡ä»¶ä¸Šä¼ , æ ¹æ®ä¸åŒç­–ç•¥æŸ¥æ‰¾å¯æ‰§è¡Œçš„ controller æ–¹æ³•, æŸ¥åˆ°ååŠ å…¥æ‹¦æˆªå™¨, å†é€šè¿‡é€‚é…å™¨æ¥æ‰§è¡Œ controller æ–¹æ³•, ç„¶åæŠŠå¾—åˆ°çš„ ModelAndView è§£ææˆè§†å›¾å¯¹è±¡, å¹¶æ¸²æŸ“åˆ°å‰ç«¯.</span></span><br><span class="line">		<span class="comment">// 5.è‹¥éœ€è¦, å°†å¿«ç…§æ¢å¤åˆ°è¯·æ±‚ä¸Šä¸‹æ–‡</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">org.springframework.web.servlet.DispatcherServlet#doDispatch</span><br><span class="line">    <span class="comment">// 1.å‡†å¤‡ä¸€äº›å˜é‡</span></span><br><span class="line">		<span class="comment">// 2.åˆ¤æ–­å¹¶å¤„ç†æ–‡ä»¶ä¸Šä¼ è¯·æ±‚, è‹¥æ˜¯, processedRequest åˆ™å˜ä¸º MultipartHttpServletRequest ç±»å‹çš„å¯¹è±¡.</span></span><br><span class="line">		<span class="comment">// 3.éå†ä¹‹å‰åŠ è½½çš„ handlerMappings, è°ƒç”¨ getHandler æ¥å£è·å–æ‰§è¡Œé“¾å¯¹è±¡å¹¶è¿”å›. æ‰¾ä¸åˆ°åˆ™è¿”å› null</span></span><br><span class="line">		<span class="comment">// 4.æ ¹æ® handler è·å–åˆé€‚çš„é€‚é…å™¨</span></span><br><span class="line">		<span class="comment">// 5.éå†æ‰§è¡Œæ‹¦æˆªå™¨çš„ preHandle(), è‹¥é‡åˆ° renturn false, åˆ™ç»“æŸ doDispatch</span></span><br><span class="line">		<span class="comment">// 6.æ‰§è¡Œå®é™…çš„ controller çš„æ–¹æ³•å¾—åˆ° ModelAndView å¯¹è±¡.</span></span><br><span class="line">		<span class="comment">// 7.å¤„ç†é»˜è®¤çš„ viewName</span></span><br><span class="line">		<span class="comment">// 8.éå†æ‰§è¡Œæ‹¦æˆªå™¨çš„ postHandle()</span></span><br><span class="line">		<span class="comment">// 9.è‹¥æœ‰å¼‚å¸¸åˆ™å¤„ç†å¼‚å¸¸: éå†ä¹‹å‰åŠ è½½çš„å¼‚å¸¸å¤„ç†å™¨ç­–ç•¥ç±», è°ƒç”¨ resolveException()</span></span><br><span class="line">		<span class="comment">//10.è‹¥æ— å¼‚å¸¸åˆ™æ ¹æ®éœ€è¦æ ¹æ® ModelAndViewçš„å¯¹è±¡çš„è§†å›¾åé…åˆä¹‹å‰åŠ è½½çš„è§†å›¾è§£æå™¨è·å– View å¯¹è±¡, å†è°ƒç”¨ render() æ¸²æŸ“è§†å›¾.</span></span><br><span class="line">		<span class="comment">//11.æœ€åæ‰§è¡Œæ‹¦æˆªå™¨çš„ triggerAfterCompletion</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">org.springframework.web.servlet.DispatcherServlet#getHandler</span><br><span class="line">    <span class="comment">// éå†ä¹‹å‰åŠ è½½çš„ handlerMappings, è°ƒç”¨å…¶ getHandler æ¥å£è·å– handler å’Œæ‹¦æˆªå™¨å°è£…æˆ chain å¯¹è±¡å¹¶è¿”å›. æ‰¾ä¸åˆ°åˆ™è¿”å› null</span></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">org.springframework.web.servlet.DispatcherServlet#getHandlerAdapter</span><br><span class="line">    <span class="comment">// éå†ä¹‹å‰åŠ è½½çš„ handlerAdapters, è°ƒç”¨ supports åˆ¤æ–­æ˜¯å¦æ”¯æŒ handler, æ”¯æŒåˆ™è¿”å› adapter</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">org.springframework.web.servlet.HandlerExecutionChain#applyPreHandle</span><br><span class="line">    <span class="comment">// ä»å¤´åˆ°å°¾éå†æ‹¦æˆªå™¨, æ‰§è¡Œ preHandle(), è‹¥æ‹¦æˆªå™¨è¿”å› false, åˆ™ç«‹åˆ» triggerAfterCompletion, ç„¶å return false</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">org.springframework.web.servlet.DispatcherServlet#processDispatchResult</span><br><span class="line">    <span class="comment">// è‹¥æœ‰å¼‚å¸¸åˆ™å¤„ç†å¼‚å¸¸: éå†ä¹‹å‰åŠ è½½çš„å¼‚å¸¸å¤„ç†å™¨ç­–ç•¥ç±», è°ƒç”¨ resolveException()</span></span><br><span class="line">		<span class="comment">// è‹¥æ— å¼‚å¸¸åˆ™æ ¹æ®éœ€è¦æ ¹æ®è§†å›¾åå’Œè§†å›¾è§£æå™¨æ¸²æŸ“è§†å›¾</span></span><br><span class="line">		<span class="comment">// æœ€åæ‰§è¡Œæ‹¦æˆªå™¨çš„ triggerAfterCompletion</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">org.springframework.web.servlet.DispatcherServlet#processHandlerException</span><br><span class="line">    <span class="comment">// éå†ä¹‹å‰åŠ è½½çš„å¼‚å¸¸å¤„ç†å™¨ç­–ç•¥ç±», è°ƒç”¨ resolveException()</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">org.springframework.web.servlet.DispatcherServlet#render</span><br><span class="line">    <span class="comment">// å…ˆéå†è§†å›¾è§£æå™¨, æ ¹æ®è§†å›¾åè·å–å®é™…è§†å›¾å¯¹è±¡</span></span><br><span class="line">		<span class="comment">// æœ€åè°ƒç”¨å®é™…è§†å›¾å¯¹è±¡çš„ render (æ¸²æŸ“æ–¹æ³•)</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">org.springframework.web.servlet.DispatcherServlet#resolveViewName</span><br><span class="line">    <span class="comment">// éå†è§†å›¾è§£æå™¨, æ ¹æ®è§†å›¾åè·å–å®é™…è§†å›¾å¯¹è±¡</span></span><br></pre></td></tr></table></figure>





<h2 id="æŸäº›å®ç°åŸç†"><a href="#æŸäº›å®ç°åŸç†" class="headerlink" title="æŸäº›å®ç°åŸç†"></a>æŸäº›å®ç°åŸç†</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.æ‹¦æˆªå™¨åŸç†</span><br><span class="line">2.é»˜è®¤çš„ HandlerMapping/HandlerAdapter åœ¨ä½•æ—¶åŠ å…¥?</span><br><span class="line">3.å‚æ•°æ˜¯å¦‚ä½•ä¸ HTTP è¯·æ±‚ body ç»‘å®šçš„(åºåˆ—åŒ–, æ ¼å¼åŒ–, ç»‘å®š)?</span><br><span class="line">4.å‚æ•°æ ¡éªŒæ˜¯å¦‚ä½•è¿›è¡Œçš„?</span><br><span class="line">5.æœ‰å…³å‚æ•°ä¸è¿”å›å€¼çš„ä¸€äº›æ‹¦æˆªä¸å¹²é¢„(@RequestBody, @ResponseBody).</span><br></pre></td></tr></table></figure>



<h3 id="æ‹¦æˆªå™¨åŸç†"><a href="#æ‹¦æˆªå™¨åŸç†" class="headerlink" title="æ‹¦æˆªå™¨åŸç†"></a>æ‹¦æˆªå™¨åŸç†</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ä½•æ—¶åŠ å…¥?</span><br><span class="line">	ä» WebMvcConfigurationSupport çš„å­ç±»ä¸­è°ƒç”¨ addInterceptors </span><br><span class="line">	æ·»åŠ ä¸€äº›æ‹¦æˆªå™¨å’Œæ‹¦æˆªå™¨çš„è·¯å¾„é…ç½® InterceptorRegistry å’Œ MappedInterceptor</span><br><span class="line">    å®ç°æ‹¦æˆªå™¨è·¯å¾„åŒ¹é…, åœ¨ new HandlerExecutionChian æ—¶åˆ¤æ–­</span><br><span class="line"></span><br><span class="line">ä½•æ—¶æ‰§è¡Œ?</span><br><span class="line">	DispatcherServlet è´Ÿè´£åœ¨æ­£ç¡®çš„æ—¶æœºè°ƒç”¨ HandlerExecutionChian æ¥è°ƒç”¨ preHanlde ç­‰æ–¹æ³•.</span><br><span class="line">	æ‹¿åˆ° HandlerExecutionChian åè°ƒç”¨ preHanlde</span><br><span class="line">	HandlerAdapter æ‰§è¡Œå®Œ handler å, è°ƒç”¨ postHandle</span><br><span class="line">	è§£æè§†å›¾å¹¶æ¸²æŸ“åˆ°responseä¹‹å, è°ƒç”¨ afterCompletion</span><br><span class="line">	å¦‚æœä¸­é€”å‡ºç°å¼‚å¸¸, æˆ– preHandle æå‰ç»“æŸ, åˆ™ä¹Ÿè°ƒç”¨ afterCompletion</span><br><span class="line"></span><br><span class="line">æ€»ç»“</span><br><span class="line">	DispatcherServlet å»è°ƒç”¨ HandlerExecutionChian å»è°ƒç”¨ æ‹¦æˆªå™¨å…·ä½“æ–¹æ³•. </span><br><span class="line">	å¤æ‚ç‚¹æ˜¯æ·»åŠ ä¸€ä¸ªæ‹¦æˆªå™¨åˆ°è¢«åŠ å…¥åˆ° HandlerExecutionChian æ¯”è¾ƒå¤æ‚ä¸€ç‚¹, ä»¥åŠå¸¦è·¯å¾„åŒ¹é…çš„æ‹¦æˆªå™¨å®ç°ç•¥å¤æ‚ä¸€äº›.</span><br></pre></td></tr></table></figure>



<h3 id="é»˜è®¤çš„-HandlerMapping-HandlerAdapter-åœ¨ä½•æ—¶åŠ å…¥"><a href="#é»˜è®¤çš„-HandlerMapping-HandlerAdapter-åœ¨ä½•æ—¶åŠ å…¥" class="headerlink" title="é»˜è®¤çš„ HandlerMapping/HandlerAdapter åœ¨ä½•æ—¶åŠ å…¥?"></a>é»˜è®¤çš„ HandlerMapping/HandlerAdapter åœ¨ä½•æ—¶åŠ å…¥?</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.web.servlet.DispatcherServlet#initStrategies</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initStrategies</span><span class="params">(ApplicationContext context)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åŠ è½½æ–‡ä»¶ä¸Šä¼ å¤„ç† bean</span></span><br><span class="line">  <span class="comment">// åŠ è½½å›½é™…åŒ–å¤„ç† bean</span></span><br><span class="line">  <span class="comment">// åŠ è½½ä¸»é¢˜åˆ‡æ¢å¤„ç† bean</span></span><br><span class="line">  <span class="comment">// åŠ è½½ HandlerMapping bean</span></span><br><span class="line">  <span class="comment">// åŠ è½½ HandlerAdapter bean</span></span><br><span class="line">  <span class="comment">// åŠ è½½å¼‚å¸¸å¤„ç† bean</span></span><br><span class="line">  <span class="comment">// åŠ è½½ HttpServletRequest è½¬è§†å›¾åç§°å¤„ç†ç­–ç•¥ bean</span></span><br><span class="line">  <span class="comment">// åŠ è½½è§†å›¾è§£æå™¨</span></span><br><span class="line">  <span class="comment">// åŠ è½½ FlashMap ç®¡ç† bean</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¯ä¸€ä¸ª init çš„é€»è¾‘éƒ½æ˜¯ç±»ä¼¼çš„, å…ˆä»å®¹å™¨ä¸­æ ¹æ® Xxx.class getBean</span></span><br><span class="line">  <span class="comment">// è‹¥æ— , åˆ™è°ƒç”¨ getDefaultStrategy() ä» DispatcherServlet.properties é…ç½®æ–‡ä»¶ä¸­è¯»å–</span></span><br><span class="line">  initMultipartResolver(context);</span><br><span class="line">  initLocaleResolver(context);</span><br><span class="line">  initThemeResolver(context);</span><br><span class="line">  initHandlerMappings(context);</span><br><span class="line">  initHandlerAdapters(context);</span><br><span class="line">  initHandlerExceptionResolvers(context);</span><br><span class="line">  initRequestToViewNameTranslator(context);</span><br><span class="line">  initViewResolvers(context);</span><br><span class="line">  initFlashMapManager(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="å‚æ•°æ˜¯å¦‚ä½•ä¸-HTTP-è¯·æ±‚-body-ç»‘å®šçš„-åºåˆ—åŒ–-æ ¼å¼åŒ–-ç»‘å®š"><a href="#å‚æ•°æ˜¯å¦‚ä½•ä¸-HTTP-è¯·æ±‚-body-ç»‘å®šçš„-åºåˆ—åŒ–-æ ¼å¼åŒ–-ç»‘å®š" class="headerlink" title="å‚æ•°æ˜¯å¦‚ä½•ä¸ HTTP è¯·æ±‚ body ç»‘å®šçš„(åºåˆ—åŒ–, æ ¼å¼åŒ–, ç»‘å®š)?"></a>å‚æ•°æ˜¯å¦‚ä½•ä¸ HTTP è¯·æ±‚ body ç»‘å®šçš„(åºåˆ—åŒ–, æ ¼å¼åŒ–, ç»‘å®š)?</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.åœ¨é€‚é…å™¨æ‰§è¡Œ handler çš„æ—¶å€™, å³ RequestMappingHandlerAdapter#invokeHandlerMethod</span><br><span class="line">2.æ­¤æ–¹æ³•ä¼šè¿›è¡Œä¸€äº›å…¶ä»–å¤„ç†, ç„¶åå‡†å¤‡æ‰§è¡Œæ–¹æ³•å‰è§£æå‚æ•°, å³åœ¨ InvocableHandlerMethod#getMethodArgumentValues() ä¸­</span><br><span class="line"><span class="number">3</span>.è¿™ä¸ªæ–¹æ³•ä¸­ä¼šéå†æ¯ä¸€ä¸ªå‚æ•°, å†éå†é…ç½®çš„æ‰€æœ‰ resolvers, é€šè¿‡ supportsParameter æ¥å£åˆ¤æ–­æ˜¯å¦æ”¯æŒå‚æ•°è§£æ, æ˜¯åˆ™è°ƒç”¨ resolveArgument æ¥å£è·å¾—å®å‚</span><br><span class="line">4.è¿™å…¶ä¸­, æœ€é‡è¦çš„æ˜¯ resolvers, å…¶ä¸€èˆ¬åœ¨ RequestMappingHandlerAdapter#getDefaultArgumentResolvers() ä¸­æ·»åŠ é»˜è®¤å’Œç”¨æˆ·è‡ªå®šä¹‰çš„ resoloves.</span><br><span class="line">5.å¦‚ RequestResponseBodyMethodProcessor#resolveArgument() ç”¨äºå¤„ç†å¸¦ @RequestBody æ³¨è§£çš„å‚æ•°.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“: é€‚é…å™¨æ‰§è¡Œå…·ä½“æ–¹æ³•å‰, å…ˆç”¨åå°„è·å–è¿™ä¸ªæ–¹æ³•çš„ å‚æ•°(å½¢å‚)é›†åˆ, æŒ¨ä¸ªéå†ä» resolvers æ‰¾æ”¯æŒè§£æçš„ç±»æ¥è§£æ, å¾—åˆ°çš„è¿”å›å€¼ä½œä¸ºå®å‚å…ˆå­˜èµ·æ¥, æœ€åè°ƒç”¨å…·ä½“æ–¹æ³•æ—¶å°±å¯ä»¥å¸¦ä¸Šå®å‚ä»¬æ‰§è¡Œå°±å®ç°äº†å°† HTTP çš„æ•°æ®ç»‘å®šåˆ° controller çš„æ–¹æ³•å‚æ•°ä¸Šçš„åŠŸèƒ½.</p>
<p>å‚è€ƒ RequestResponseBodyMethodProcessor#resolveArgument()</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">resolveArgument</span><span class="params">(MethodParameter parameter, @Nullable ModelAndViewContainer mavContainer,</span></span></span><br><span class="line"><span class="function"><span class="params">                              NativeWebRequest webRequest, @Nullable WebDataBinderFactory binderFactory)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="comment">// è°ƒç”¨ readWithMessageConverters è¯»å– body çš„æ•°æ®, å†åºåˆ—åŒ– json æˆç›¸åº”çš„ Java Bean</span></span><br><span class="line">  <span class="comment">// ä½¿ç”¨ binder æ£€æŸ¥ arg çš„å€¼æ˜¯å¦ä¸ @Valid çš„é‚£äº›æ³¨è§£ç›¸å…³çš„è§„åˆ™ç›¸ç¬¦, è‹¥æœ‰é”™è¯¯, åˆ™æŠ›å¼‚å¸¸.</span></span><br><span class="line"></span><br><span class="line">  parameter = parameter.nestedIfOptional();</span><br><span class="line">  Object arg = readWithMessageConverters(webRequest, parameter, parameter.getNestedGenericParameterType());</span><br><span class="line">  String name = Conventions.getVariableNameForParameter(parameter);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (binderFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">    WebDataBinder binder = binderFactory.createBinder(webRequest, arg, name);</span><br><span class="line">    <span class="keyword">if</span> (arg != <span class="keyword">null</span>) &#123;</span><br><span class="line">      validateIfApplicable(binder, parameter);</span><br><span class="line">      <span class="keyword">if</span> (binder.getBindingResult().hasErrors() &amp;&amp; isBindExceptionRequired(binder, parameter)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MethodArgumentNotValidException(parameter, binder.getBindingResult());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mavContainer != <span class="keyword">null</span>) &#123;</span><br><span class="line">      mavContainer.addAttribute(BindingResult.MODEL_KEY_PREFIX + name, binder.getBindingResult());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> adaptArgumentIfNecessary(arg, parameter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="å‚æ•°æ ¡éªŒæ˜¯å¦‚ä½•è¿›è¡Œçš„"><a href="#å‚æ•°æ ¡éªŒæ˜¯å¦‚ä½•è¿›è¡Œçš„" class="headerlink" title="å‚æ•°æ ¡éªŒæ˜¯å¦‚ä½•è¿›è¡Œçš„?"></a>å‚æ•°æ ¡éªŒæ˜¯å¦‚ä½•è¿›è¡Œçš„?</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚è€ƒä¸Šé¢çš„ä»£ç </span></span><br><span class="line"><span class="keyword">if</span> (binderFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">  WebDataBinder binder = binderFactory.createBinder(webRequest, arg, name);</span><br><span class="line">  <span class="keyword">if</span> (arg != <span class="keyword">null</span>) &#123;</span><br><span class="line">    validateIfApplicable(binder, parameter);</span><br><span class="line">    <span class="keyword">if</span> (binder.getBindingResult().hasErrors() &amp;&amp; isBindExceptionRequired(binder, parameter)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> MethodArgumentNotValidException(parameter, binder.getBindingResult());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (mavContainer != <span class="keyword">null</span>) &#123;</span><br><span class="line">    mavContainer.addAttribute(BindingResult.MODEL_KEY_PREFIX + name, binder.getBindingResult());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è¿™æ®µä»£ç  validateIfApplicable() å°±è¿›è¡Œäº†å‚æ•°æ ¡éªŒ, ä»£ç å¦‚ä¸‹:</span></span><br><span class="line"><span class="comment">// é€»è¾‘æ˜¯: éå†å‚æ•°æ‰€æœ‰çš„æ³¨è§£, åŒ…å« validatedAnn æˆ–ä»¥ Valid å¼€å¤´çš„æ³¨è§£éƒ½è¿›è¡Œæ ¡éªŒ</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">validateIfApplicable</span><span class="params">(WebDataBinder binder, MethodParameter parameter)</span> </span>&#123;</span><br><span class="line">  Annotation[] annotations = parameter.getParameterAnnotations();</span><br><span class="line">  <span class="keyword">for</span> (Annotation ann : annotations) &#123;</span><br><span class="line">    Validated validatedAnn = AnnotationUtils.getAnnotation(ann, Validated<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">if</span> (validatedAnn != <span class="keyword">null</span> || ann.annotationType().getSimpleName().startsWith(<span class="string">"Valid"</span>)) &#123;</span><br><span class="line">      Object hints = (validatedAnn != <span class="keyword">null</span> ? validatedAnn.value() : AnnotationUtils.getValue(ann));</span><br><span class="line">      Object[] validationHints = (hints <span class="keyword">instanceof</span> Object[] ? (Object[]) hints : <span class="keyword">new</span> Object[] &#123;hints&#125;);</span><br><span class="line">      binder.validate(validationHints);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç„¶åæ˜¯ validate å…·ä½“çš„å¯¹è±¡.</span></span><br><span class="line"><span class="comment">// é€»è¾‘æ˜¯: éå†æ‰€æœ‰çš„ validators, æŒ¨ä¸ªè°ƒç”¨ validate æ ¡éªŒ</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validate</span><span class="params">(Object... validationHints)</span> </span>&#123;</span><br><span class="line">  Object target = getTarget();</span><br><span class="line">  Assert.state(target != <span class="keyword">null</span>, <span class="string">"No target to validate"</span>);</span><br><span class="line">  BindingResult bindingResult = getBindingResult();</span><br><span class="line">  <span class="comment">// Call each validator with the same binding result</span></span><br><span class="line">  <span class="keyword">for</span> (Validator validator : getValidators()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!ObjectUtils.isEmpty(validationHints) &amp;&amp; validator <span class="keyword">instanceof</span> SmartValidator) &#123;</span><br><span class="line">      ((SmartValidator) validator).validate(target, bindingResult, validationHints);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (validator != <span class="keyword">null</span>) &#123;</span><br><span class="line">      validator.validate(target, bindingResult);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å†å¾€ä¸‹å°±æ²¡å•¦... Spring æ²¡æœ‰å…·ä½“çš„å®ç°, æ‰€ä»¥è¦å¯¼å…¥ Hibernate çš„å•¥å•¥å•¥åŒ…, è¿™æ˜¯æœ‰åŸå› çš„.</span></span><br></pre></td></tr></table></figure>





<h3 id="æœ‰å…³å‚æ•°ä¸è¿”å›å€¼çš„ä¸€äº›æ‹¦æˆªä¸å¹²é¢„-RequestBody-ResponseBody"><a href="#æœ‰å…³å‚æ•°ä¸è¿”å›å€¼çš„ä¸€äº›æ‹¦æˆªä¸å¹²é¢„-RequestBody-ResponseBody" class="headerlink" title="æœ‰å…³å‚æ•°ä¸è¿”å›å€¼çš„ä¸€äº›æ‹¦æˆªä¸å¹²é¢„(@RequestBody, @ResponseBody)."></a>æœ‰å…³å‚æ•°ä¸è¿”å›å€¼çš„ä¸€äº›æ‹¦æˆªä¸å¹²é¢„(@RequestBody, @ResponseBody).</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚è€ƒ RequestMappingHandlerAdapter#afterPropertiesSet()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Do this first, it may add ResponseBody advice beans</span></span><br><span class="line">  initControllerAdviceCache();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.argumentResolvers == <span class="keyword">null</span>) &#123;</span><br><span class="line">    List&lt;HandlerMethodArgumentResolver&gt; resolvers = getDefaultArgumentResolvers();</span><br><span class="line">    <span class="keyword">this</span>.argumentResolvers = <span class="keyword">new</span> HandlerMethodArgumentResolverComposite().addResolvers(resolvers);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.initBinderArgumentResolvers == <span class="keyword">null</span>) &#123;</span><br><span class="line">    List&lt;HandlerMethodArgumentResolver&gt; resolvers = getDefaultInitBinderArgumentResolvers();</span><br><span class="line">    <span class="keyword">this</span>.initBinderArgumentResolvers = <span class="keyword">new</span> HandlerMethodArgumentResolverComposite().addResolvers(resolvers);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.returnValueHandlers == <span class="keyword">null</span>) &#123;</span><br><span class="line">    List&lt;HandlerMethodReturnValueHandler&gt; handlers = getDefaultReturnValueHandlers();</span><br><span class="line">    <span class="keyword">this</span>.returnValueHandlers = <span class="keyword">new</span> HandlerMethodReturnValueHandlerComposite().addHandlers(handlers);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ç”±ä¸Šå¯çŸ¥, argumentResolvers/returnValueHandlers éƒ½æ˜¯æ­¤æ—¶åˆå§‹åŒ–çš„, å†ç‚¹è¿›å»çœ‹ä»£ç å‘ç°, é™¤äº†é»˜è®¤çš„, è¿˜æœ‰ç”¨æˆ·è‡ªå®šä¹‰çš„ customArgumentResolvers/customReturnValueHandlers;</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯»æ‰¾å­—æ®µçš„å¼•ç”¨å‘ç°</span></span><br><span class="line">WebMvcConfigurationSupport#addReturnValueHandlers</span><br><span class="line">WebMvcConfigurationSupport#addArgumentResolvers</span><br><span class="line"><span class="comment">// è¿™ä¸¤ä¸ªæ–¹æ³•å¯ä»¥ç»§æ‰¿ååŠ å…¥åŠ å…¥è‡ªå·±çš„ ArgumentResolvers/ReturnValueHandlers, ä¹Ÿå°±æ˜¯é¡¹ç›®é‡Œé¢ç»§æ‰¿ WebMvcConfiguration çš„é‚£ä¸ªç±», é‡å†™è¿™ä¸¤ä¸ªæ–¹æ³•, åŠ å…¥è‡ªå·±çš„ç±»å³å¯å®ç°å¯¹å‚æ•°/è¿”å›å€¼çš„å¹²é¢„; å¸¸ç”¨äºç»Ÿä¸€åŠ å¯†/è§£å¯†, è®°å½•æ—¥å¿—ç­‰.</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>é™¤æ­¤ä¹‹å¤–, ä¸¤è¾¹çš„é»˜è®¤å€¼éƒ½æœ‰ RequestResponseBodyMethodProcessor, è¿™å°±æ˜¯ç”¨äºå¤„ç†@RequestBody/@ResponseBody çš„äº†, å¾€é‡Œé¢æ·±å…¥çš„çœ‹, èƒ½çœ‹åˆ°å…¶ä½¿ç”¨ messageConverters è¯»å– body æ•°æ®, ç„¶åä¹Ÿä¼šåœ¨å¯¹åº”çš„åœ°æ–¹è§¦å‘ advice çš„æ–¹æ³•.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚è€ƒ AbstractMessageConverterMethodArgumentResolver#readWithMessageConverters</span></span><br><span class="line"><span class="keyword">for</span> (HttpMessageConverter&lt;?&gt; converter : <span class="keyword">this</span>.messageConverters) &#123;</span><br><span class="line">  Class&lt;HttpMessageConverter&lt;?&gt;&gt; converterType = (Class&lt;HttpMessageConverter&lt;?&gt;&gt;) converter.getClass();</span><br><span class="line">  GenericHttpMessageConverter&lt;?&gt; genericConverter =</span><br><span class="line">    (converter <span class="keyword">instanceof</span> GenericHttpMessageConverter ? (GenericHttpMessageConverter&lt;?&gt;) converter : <span class="keyword">null</span>);</span><br><span class="line">  <span class="keyword">if</span> (genericConverter != <span class="keyword">null</span> ? genericConverter.canRead(targetType, contextClass, contentType) :</span><br><span class="line">      (targetClass != <span class="keyword">null</span> &amp;&amp; converter.canRead(targetClass, contentType))) &#123;</span><br><span class="line">    <span class="keyword">if</span> (message.hasBody()) &#123;</span><br><span class="line">      HttpInputMessage msgToUse =</span><br><span class="line">        getAdvice().beforeBodyRead(message, parameter, targetType, converterType);</span><br><span class="line">      body = (genericConverter != <span class="keyword">null</span> ? genericConverter.read(targetType, contextClass, msgToUse) :</span><br><span class="line">              ((HttpMessageConverter&lt;T&gt;) converter).read(targetClass, msgToUse));</span><br><span class="line">      body = getAdvice().afterBodyRead(body, msgToUse, parameter, targetType, converterType);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      body = getAdvice().handleEmptyBody(<span class="keyword">null</span>, message, parameter, targetType, converterType);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h2 id="å‚æ•°çš„Nç§ç»‘å®šæ–¹å¼"><a href="#å‚æ•°çš„Nç§ç»‘å®šæ–¹å¼" class="headerlink" title="å‚æ•°çš„Nç§ç»‘å®šæ–¹å¼"></a>å‚æ•°çš„Nç§ç»‘å®šæ–¹å¼</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚è€ƒ RequestMappingHandlerAdapter#getDefaultArgumentResolvers</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;HandlerMethodArgumentResolver&gt; <span class="title">getDefaultArgumentResolvers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  List&lt;HandlerMethodArgumentResolver&gt; resolvers = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Annotation-based argument resolution</span></span><br><span class="line">  resolvers.add(<span class="keyword">new</span> RequestParamMethodArgumentResolver(getBeanFactory(), <span class="keyword">false</span>));</span><br><span class="line">  resolvers.add(<span class="keyword">new</span> RequestParamMapMethodArgumentResolver());</span><br><span class="line">  resolvers.add(<span class="keyword">new</span> PathVariableMethodArgumentResolver());</span><br><span class="line">  resolvers.add(<span class="keyword">new</span> PathVariableMapMethodArgumentResolver());</span><br><span class="line">  resolvers.add(<span class="keyword">new</span> MatrixVariableMethodArgumentResolver());</span><br><span class="line">  resolvers.add(<span class="keyword">new</span> MatrixVariableMapMethodArgumentResolver());</span><br><span class="line">  resolvers.add(<span class="keyword">new</span> ServletModelAttributeMethodProcessor(<span class="keyword">false</span>));</span><br><span class="line">  resolvers.add(<span class="keyword">new</span> RequestResponseBodyMethodProcessor(getMessageConverters(), <span class="keyword">this</span>.requestResponseBodyAdvice));</span><br><span class="line">  resolvers.add(<span class="keyword">new</span> RequestPartMethodArgumentResolver(getMessageConverters(), <span class="keyword">this</span>.requestResponseBodyAdvice));</span><br><span class="line">  resolvers.add(<span class="keyword">new</span> RequestHeaderMethodArgumentResolver(getBeanFactory()));</span><br><span class="line">  resolvers.add(<span class="keyword">new</span> RequestHeaderMapMethodArgumentResolver());</span><br><span class="line">  resolvers.add(<span class="keyword">new</span> ServletCookieValueMethodArgumentResolver(getBeanFactory()));</span><br><span class="line">  resolvers.add(<span class="keyword">new</span> ExpressionValueMethodArgumentResolver(getBeanFactory()));</span><br><span class="line">  resolvers.add(<span class="keyword">new</span> SessionAttributeMethodArgumentResolver());</span><br><span class="line">  resolvers.add(<span class="keyword">new</span> RequestAttributeMethodArgumentResolver());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Type-based argument resolution</span></span><br><span class="line">  resolvers.add(<span class="keyword">new</span> ServletRequestMethodArgumentResolver());</span><br><span class="line">  resolvers.add(<span class="keyword">new</span> ServletResponseMethodArgumentResolver());</span><br><span class="line">  resolvers.add(<span class="keyword">new</span> HttpEntityMethodProcessor(getMessageConverters(), <span class="keyword">this</span>.requestResponseBodyAdvice));</span><br><span class="line">  resolvers.add(<span class="keyword">new</span> RedirectAttributesMethodArgumentResolver());</span><br><span class="line">  resolvers.add(<span class="keyword">new</span> ModelMethodProcessor());</span><br><span class="line">  resolvers.add(<span class="keyword">new</span> MapMethodProcessor());</span><br><span class="line">  resolvers.add(<span class="keyword">new</span> ErrorsMethodArgumentResolver());</span><br><span class="line">  resolvers.add(<span class="keyword">new</span> SessionStatusMethodArgumentResolver());</span><br><span class="line">  resolvers.add(<span class="keyword">new</span> UriComponentsBuilderMethodArgumentResolver());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Custom arguments</span></span><br><span class="line">  <span class="keyword">if</span> (getCustomArgumentResolvers() != <span class="keyword">null</span>) &#123;</span><br><span class="line">    resolvers.addAll(getCustomArgumentResolvers());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Catch-all</span></span><br><span class="line">  resolvers.add(<span class="keyword">new</span> RequestParamMethodArgumentResolver(getBeanFactory(), <span class="keyword">true</span>));</span><br><span class="line">  resolvers.add(<span class="keyword">new</span> ServletModelAttributeMethodProcessor(<span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> resolvers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>çœ‹å‡ ä¸ªå¸¸è§çš„</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1.RequestParamMethodArgumentResolver: è´Ÿè´£è§£æå¸¦ @RequestParam æ³¨è§£çš„æ™®é€šå‚æ•°</span><br><span class="line">2.RequestParamMapMethodArgumentResolver: è´Ÿè´£è§£æå¸¦ @RequestParam çš„ Map å‚æ•°....</span><br><span class="line">3.PathVariableMethodArgumentResolver/PathVariableMapMethodArgumentResolver: åŒä¸Šè§£æå¸¦ @PathVariable æ³¨è§£çš„å‚æ•°</span><br><span class="line">4.RequestResponseBodyMethodProcessor: è´Ÿè´£è§£æå¸¦ @RequestBody çš„å‚æ•°</span><br><span class="line">5.RequestHeaderMethodArgumentResolver: è´Ÿè´£è§£æå¸¦ @RequestHeader çš„å‚æ•° (è¡¨ç¤ºæ²¡ç”¨è¿‡)</span><br><span class="line">6.ServletRequestMethodArgumentResolver: è´Ÿè´£è§£æ HttpServletRequest ç­‰ç±»å‹çš„å‚æ•°(å³ req, ç”¨çš„è´¼å¤š)</span><br><span class="line">7.ServletResponseMethodArgumentResolver: è´Ÿè´£è§£æ HttpServletResponse ç­‰ç±»å‹çš„å‚æ•°(å³ resp, ä¸‹è½½æ¥å£æ²¡å°‘ç”¨)</span><br><span class="line">8.RequestParamMethodArgumentResolver: å•¥éƒ½è§£æ.... å³ä¸å¸¦ä»»ä½•æ³¨è§£çš„æ™®é€šç±»å‹.</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://gudqs7.github.io/2021/01/24/source-code-spring-boot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="gudqs7">
      <meta itemprop="description" content="å¿ƒç´¯æ²¡é’±èººå°¸ä¸­">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="gudqs7's note">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/24/source-code-spring-boot/" class="post-title-link" itemprop="url">Spring Boot æºç ç¬”è®°</a>
        </h2>

        <div class="post-meta">
			
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-01-24 02:04:22" itemprop="dateCreated datePublished" datetime="2021-01-24T02:04:22+08:00">2021-01-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-01-25 23:17:48" itemprop="dateModified" datetime="2021-01-25T23:17:48+08:00">2021-01-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SourceCode/" itemprop="url" rel="index"><span itemprop="name">SourceCode</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring-Boot/" itemprop="url" rel="index"><span itemprop="name">Spring Boot</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/2021/01/24/source-code-spring-boot/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/01/24/source-code-spring-boot/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Spring-Boot-æºç åˆ†æ"><a href="#Spring-Boot-æºç åˆ†æ" class="headerlink" title="Spring Boot æºç åˆ†æ"></a>Spring Boot æºç åˆ†æ</h1><h2 id="run-æµç¨‹"><a href="#run-æµç¨‹" class="headerlink" title="run æµç¨‹"></a>run æµç¨‹</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1.StopWatch æä¾›çš„è®¡ç®—è€—æ—¶çš„åŠŸèƒ½, åˆ›å»ºä¸€ä¸ªåç«‹å³å¼€å§‹è®¡æ—¶.</span><br><span class="line">2.åˆ›å»ºä¸€ä¸ªå¼•å¯¼å®¹å™¨, å¹¶åœ¨æ­¤æ—¶(å®¹å™¨æœªä½¿ç”¨å‰)æŠŠ spring.factories æ‰¾åˆ° Bootstrapper æ¥å£çš„ç±»å¯¹åº”çš„æ–¹æ³•è§¦å‘, æ¥ç»™å¼•å¯¼å®¹å™¨é‡Œæ³¨å†Œä¸€äº›ä¸œè¥¿(å¦‚æœæœ‰éœ€è¦)</span><br><span class="line">3.ä» spring.factories æ‰¾ SpringApplicationRunListener çš„ç±», å®ä¾‹åŒ–åå­˜åˆ° SpringApplicationRunListeners ä¸­.</span><br><span class="line">4.è§¦å‘æ‰€æœ‰å­˜å…¥çš„ SpringApplicationRunListener çš„ starting äº‹ä»¶.</span><br><span class="line">5.å°† args å†…å®¹ä¸­çš„å‚æ•°ä»¬(ç±»ä¼¼ --spring.port=9999)è§£ææˆé”®å€¼å¯¹å­˜åˆ° applicationArguments å¯¹è±¡ä¸­.</span><br><span class="line">6.åˆ›å»ºäº†ä¸€ä¸ª environment å¯¹è±¡, æ·»åŠ äº†å¥½å‡ ä¸ªåŠŸèƒ½å„å¼‚çš„ PropertySource, è§¦å‘æ‰€æœ‰å­˜å…¥çš„ SpringApplicationRunListener çš„ environmentPrepared äº‹ä»¶</span><br><span class="line">7.æ ¹æ® this.bannerMode åˆ¤æ–­æ˜¯å¦æ‰“å° Banner, ä»¥åŠæ‰“å°åœ¨å“ªé‡Œ, æ ¹æ® this.banner åˆ¤æ–­æ‰“å°ä»€ä¹ˆæ ·çš„ Banner (ä½›ç¥–ä¿ä½‘.png)</span><br><span class="line">8.æ ¹æ® web ç±»å‹åˆ›å»ºä¸åŒçš„ ApplicationContext, è¿™é‡Œçš„åˆ›å»º, ä»…å®ä¾‹åŒ–è€Œå·², æ²¡æœ‰ä»æ„é€ æ–¹æ³•è°ƒç”¨ loadBeanDefinitions å’Œ refresh çš„é€»è¾‘</span><br><span class="line">9.å°† applicationStartup (æ­¥éª¤è®°å½•å™¨)èµ‹å€¼ç»™ context.</span><br><span class="line">10.å¯¹å®¹å™¨åšäº›é…ç½®, ç„¶åå‘å¸ƒ contextPrepared äº‹ä»¶, æ¥ç€å…³é—­å¼•å¯¼å®¹å™¨; ç„¶åä½¿ç”¨ BeanDefinitionLoader æ‰«æè§£æ getAllSources (å¦‚Class) å¹¶å°†å¾—åˆ°çš„ BeanDefinition æ³¨å†Œåˆ°å®¹å™¨, æœ€åå‘å¸ƒ contextLoaded äº‹ä»¶</span><br><span class="line">11.æ³¨å†Œä¸€ä¸ªé’©å­, å½“ JVM å…³é—­æ—¶, ç›¸åº”çš„å…³é—­ context, ç„¶åè°ƒç”¨å®¹å™¨çš„ refresh æ–¹æ³•(ç„¶åè¿›å…¥åˆ° Spring æºç åˆ†æé‚£æ®µ, è‡ªè¡Œè„‘è¡¥)</span><br><span class="line">12.StopWatch è®¡æ—¶å™¨åœæ­¢è®¡æ—¶, æ¥ç€æ‰“å°è®¡æ—¶æ•°æ®</span><br><span class="line">13.å‘å¸ƒ started äº‹ä»¶</span><br><span class="line">14.ä»å®¹å™¨ä¸­å–å‡º ApplicationRunner/CommandLineRunner ä¸¤ç±» bean, å¹¶è°ƒç”¨å®ƒä»¬çš„ run æ–¹æ³•.</span><br><span class="line">15.catch åˆ°å¼‚å¸¸åˆ™å‘å¸ƒ failed äº‹ä»¶</span><br><span class="line">16.å‘å¸ƒ running äº‹ä»¶</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä»æ•´ä½“ç»“æ„ä¸‹æ¥, æˆ‘ä»¬å‘ç°, å…¶ä¸»è¦æ˜¯åˆ›å»ºäº†ä¸€ä¸ªå¼•å¯¼å®¹å™¨(ä¼¼ä¹ä¹Ÿå°±æ˜¯äº‹ä»¶ç›‘å¬ç”¨åˆ°äº†, å…¶ä»–åœ°æ–¹å®Œå…¨æ— ç“œ), ç„¶åæ‰«æå¾—åˆ°ä¸€äº› SpringApplicationRunListener å­˜èµ·æ¥, ä¹‹ååœ¨åˆé€‚çš„åœ°æ–¹å‘å¸ƒäº‹ä»¶, ç„¶ååˆ›å»ºä»¥åŠé…ç½® environment å¯¹è±¡, åˆ›å»ºä»¥åŠé…ç½® ApplicationContext å¯¹è±¡, è§£æ primarySources æ¥åŠ è½½ BeanDefinition åˆ°å®¹å™¨, ç„¶åè°ƒç”¨å®¹å™¨çš„ refresh æ–¹æ³•è¿›å…¥ Spring çš„åŠ è½½æµç¨‹, æœ€åå¤„ç†äº‹ä»¶å’Œè°ƒç”¨ ApplicationRunner/CommandLineRunner çš„ bean. å…¶ä¸­ åŠ è½½ BeanDefinition å’Œæ‰§è¡Œ  refresh æ–¹æ³•å…¶å®å°±æ˜¯ä¸ Spring ä¸€æ ·çš„é€»è¾‘.</p>
</blockquote>
<h3 id="SpringApplication-ä¸-ApplicationContext-çš„å…³ç³»ä¸è”ç³»"><a href="#SpringApplication-ä¸-ApplicationContext-çš„å…³ç³»ä¸è”ç³»" class="headerlink" title="SpringApplication ä¸ ApplicationContext çš„å…³ç³»ä¸è”ç³»"></a>SpringApplication ä¸ ApplicationContext çš„å…³ç³»ä¸è”ç³»</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.SpringApplication æœ‰ç‹¬ç‰¹çš„ environment å¯¹è±¡, è¿™æ˜¯å› ä¸º application.xml é…ç½®ä»¥åŠ Spring Cloud Config è¿™äº›éƒ½éœ€è¦åœ¨å®¹å™¨åˆ›å»ºå‰åŠ è½½é…ç½®æ–‡ä»¶.</span><br><span class="line">2.ApplicationContext æ˜¯ new çš„æ—¶å€™å°±ä¼šç«‹åˆ»è§¦å‘ åŠ è½½ BeanDefinition å’Œ refresh(), è€Œ SpringApplication åˆ™æ˜¯å…ˆ new ä¸€ä¸ª, é…ç½®å¥½å, æ‰åˆ†åˆ«è°ƒç”¨æ–¹æ³•å» åŠ è½½ BeanDefinition å’Œ refresh().</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æ€»å¾—æ¥è®², SpringApplication ç›¸æ¯” ApplicationContext å¤šå‡ºçš„å°±æ˜¯ SpringApplicationRunListener çš„äº‹ä»¶ç®¡ç†, environment å¯¹è±¡åŠ è½½ä¸é…ç½®, ä»¥åŠ run æ–¹æ³•çš„ç”Ÿå‘½å‘¨æœŸ.</span><br></pre></td></tr></table></figure>



<h3 id="è¿™äº›-SpringApplicationRunListener-äº‹ä»¶éƒ½è¢«è°ç›‘å¬äº†-æœ‰ä»€ä¹ˆä½œç”¨"><a href="#è¿™äº›-SpringApplicationRunListener-äº‹ä»¶éƒ½è¢«è°ç›‘å¬äº†-æœ‰ä»€ä¹ˆä½œç”¨" class="headerlink" title="è¿™äº› SpringApplicationRunListener äº‹ä»¶éƒ½è¢«è°ç›‘å¬äº†, æœ‰ä»€ä¹ˆä½œç”¨?"></a>è¿™äº› SpringApplicationRunListener äº‹ä»¶éƒ½è¢«è°ç›‘å¬äº†, æœ‰ä»€ä¹ˆä½œç”¨?</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨ spring-boot-project/spring-boot/src/main/resources/META-INF/spring.factories</span></span><br><span class="line"><span class="comment">#   æœ‰ä¸€ä¸ª SpringApplicationRunListener, å…¶ä½œç”¨æ˜¯:</span></span><br><span class="line">org.springframework.boot.context.event.EventPublishingRunListener</span><br><span class="line">1.æ„é€ æ–¹æ³•: åˆå§‹åŒ–ä¸€ä¸ªäº‹ä»¶å¹¿æ’­å™¨, å¹¶å°† SpringApplication çš„ listeners æ³¨å†Œè¿›å». (listeners æ˜¯åœ¨æ„é€ æ–¹æ³•ä¸­ä» spring.factories åŠ è½½ ApplicationListener å¾—åˆ°çš„æ•°æ®)</span><br><span class="line">2.è½¬å‘ starting,environmentPrepared,contextPrepared,contextLoaded äº‹ä»¶ç»™ ApplicationListener</span><br><span class="line">3.åœ¨ contextLoaded äº‹ä»¶æ—¶, éå†æ‰€æœ‰çš„ ApplicationListener å¯¹è±¡, è‹¥å…¶å®ç°äº† ApplicationContextAware æ¥å£, åˆ™å°† context æ³¨å…¥.</span><br><span class="line">4.started,running,failed äº‹ä»¶å‡ç›´æ¥ç”¨ context.publishEvent å‘å¸ƒäº‹ä»¶, ä¸ listeners æ— å…³ (è€Œä¸” listeners è¿™äº›ä¸œè¥¿å¦‚æœä»…é…ç½®åœ¨ spring.factories è€Œæ²¡æœ‰è¢«æ‰«æåˆ°å®¹å™¨å†…, é‚£ä¹ˆå°±æ˜¯çœŸçš„æ— å…³äº†)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ€»ç»“: é…ç½®åœ¨ spring.factories çš„ ApplicationListener å¹¶ä¸ä¼šè§¦å‘æ‰€æœ‰ run ç”Ÿå‘½å‘¨æœŸçš„äº‹ä»¶. å› æ­¤æœ‰æ—¶å®ç° SpringApplicationRunListener è¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„) å½“ç„¶, è‹¥ä½ å†™çš„ ApplicationListener å³é…ç½®åœ¨ spring.factories ä¸­ä¹Ÿä¼šè¢«æ‰«æåˆ°å®¹å™¨å†…, åˆ™æ— æ­¤å¿§è™‘.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¥ç€çœ‹ ApplicationListener çš„ä½œç”¨</span></span><br><span class="line">1.ClearCachesApplicationListener: åœ¨ ContextRefreshedEvent(å®¹å™¨åŠ è½½å®Œå) æ¸…ç©ºç¼“å­˜</span><br><span class="line">2.ParentContextCloserApplicationListener: ç»™å­å®¹å™¨åŠ ä¸€ä¸ªç›‘å¬, ä½¿å¾—çˆ¶å®¹å™¨å…³é—­å, å­å®¹å™¨ä¹Ÿè·Ÿç€å…³é—­(è¿˜ä¼šé€’å½’å­å®¹å™¨çš„å®¹å™¨å§.png)</span><br><span class="line">3.FileEncodingApplicationListener: å¯¹æ¯”é…ç½®çš„ç¼–ç æ ¼å¼, ä¸ç¬¦åˆåˆ™æŠ¥å¼‚å¸¸(è‹¥é…ç½®äº†)</span><br><span class="line">4.DelegatingApplicationListener: æ–°å»ºä¸€ä¸ªäº‹ä»¶å¹¿æ’­å™¨, å°†é…ç½®æ–‡ä»¶ä¸­ context.listener.classes çš„ class å®ä¾‹åŒ–å¹¶ä½œä¸ºç›‘å¬è€…æ³¨å†Œåˆ°å¹¿æ’­å™¨, ç„¶åè½¬å‘æ‰€æœ‰äº‹ä»¶.</span><br><span class="line">5.EnvironmentPostProcessorApplicationListener</span><br><span class="line">    æ¥å— ApplicationEnvironmentPreparedEvent äº‹ä»¶, ç„¶åæŠŠä» spring.factories è·å¾—çš„ EnvironmentPostProcessor çš„ classNames å®ä¾‹åŒ–, ç„¶åéå†æ‰§è¡Œ postProcessEnvironment(), å…¶ä¸­ ConfigFileApplicationListener ç”¨äºåŠ è½½ application.xxx(yml,xml,properties) æ–‡ä»¶çš„é…ç½®åˆ° environment ä¸­çš„ PropertySource é‡Œ. (å¦å¤–ä¸€æ, Spring Cloud Config åº”è¯¥ä¹Ÿæ˜¯è¿™é‡Œå®ç°çš„)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ€»ç»“: åŸæ¥é…ç½®æ–‡ä»¶æ˜¯è¿™ä¹ˆè¢«åŠ è½½è¿›å»çš„, æ²¡æœ‰åœ¨ä¸»æµç¨‹ä¸­å†™, è€Œæ˜¯ç›‘å¬äº‹ä»¶, å†è°ƒç”¨ EnvironmentPostProcessor, å±‚å±‚å°è£…, æ‰©å±•æ€§å¥½å¼º(è¯»èµ·æ¥ä¹Ÿå¥½è“).</span></span><br></pre></td></tr></table></figure>



<h3 id="è¶…é•¿æºç æ³¨é‡Š"><a href="#è¶…é•¿æºç æ³¨é‡Š" class="headerlink" title="è¶…é•¿æºç æ³¨é‡Š"></a>è¶…é•¿æºç æ³¨é‡Š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æˆ‘ä»¬ä»æºç çš„ spring-boot/spring-boot-tests/spring-boot-smoke-tests/spring-boot-smoke-test-tomcat ä¸‹, æ‰¾åˆ° SampleTomcatApplication.java ç±», ç›´æ¥çœ‹å®ƒçš„ main æ–¹æ³•.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  SpringApplication.run(SampleTomcatApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€, æˆ‘ä»¬ç‚¹è¿› run æ–¹æ³•, ç§ç§é‡Œé¢å¹²äº†å•¥</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// çœ‹èµ·æ¥ä¸å¤šå˜›......(çœ‹å‰å¦‚æ˜¯å†™é“, çœ‹å®Œå·²æ˜¯å‡Œæ™¨å››ç‚¹)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 1.StopWatch æä¾›çš„è®¡ç®—è€—æ—¶çš„åŠŸèƒ½, åˆ›å»ºä¸€ä¸ªåç«‹å³å¼€å§‹è®¡æ—¶.</span></span><br><span class="line">  <span class="comment">// 2.åˆ›å»ºä¸€ä¸ªå¼•å¯¼å®¹å™¨, å¹¶åœ¨æ­¤æ—¶(å®¹å™¨æœªä½¿ç”¨å‰)æŠŠ spring.factories æ‰¾åˆ° Bootstrapper æ¥å£çš„ç±»å¯¹åº”çš„æ–¹æ³•è§¦å‘, æ¥ç»™å¼•å¯¼å®¹å™¨é‡Œæ³¨å†Œä¸€äº›ä¸œè¥¿(å¦‚æœæœ‰éœ€è¦)</span></span><br><span class="line">  <span class="comment">// 3.ä» spring.factories æ‰¾ SpringApplicationRunListener çš„ç±», å®ä¾‹åŒ–åå­˜åˆ° SpringApplicationRunListeners ä¸­.</span></span><br><span class="line">  <span class="comment">// 4.è§¦å‘æ‰€æœ‰å­˜å…¥çš„ SpringApplicationRunListener çš„ starting äº‹ä»¶.</span></span><br><span class="line">  <span class="comment">// 5.å°† args å†…å®¹ä¸­çš„å‚æ•°ä»¬(ç±»ä¼¼ --spring.port=9999)è§£ææˆé”®å€¼å¯¹å­˜åˆ° applicationArguments å¯¹è±¡ä¸­.</span></span><br><span class="line">  <span class="comment">// 6.åˆ›å»ºäº†ä¸€ä¸ª environment å¯¹è±¡, æ·»åŠ äº†å¥½å‡ ä¸ªåŠŸèƒ½å„å¼‚çš„ PropertySource, è§¦å‘æ‰€æœ‰å­˜å…¥çš„ SpringApplicationRunListener çš„ environmentPrepared äº‹ä»¶</span></span><br><span class="line">  <span class="comment">// 7.æ ¹æ® this.bannerMode åˆ¤æ–­æ˜¯å¦æ‰“å° Banner, ä»¥åŠæ‰“å°åœ¨å“ªé‡Œ, æ ¹æ® this.banner åˆ¤æ–­æ‰“å°ä»€ä¹ˆæ ·çš„ Banner (ä½›ç¥–ä¿ä½‘.png)</span></span><br><span class="line">  <span class="comment">// 8.æ ¹æ® web ç±»å‹åˆ›å»ºä¸åŒçš„ ApplicationContext, è¿™é‡Œçš„åˆ›å»º, ä»…å®ä¾‹åŒ–è€Œå·², æ²¡æœ‰ä»æ„é€ æ–¹æ³•è°ƒç”¨ loadBeanDefinitions å’Œ refresh çš„é€»è¾‘</span></span><br><span class="line">  <span class="comment">// 9.å°† applicationStartup (æ­¥éª¤è®°å½•å™¨)èµ‹å€¼ç»™ context.</span></span><br><span class="line">  <span class="comment">//10.å¯¹å®¹å™¨åšäº›é…ç½®, ç„¶åå‘å¸ƒ contextPrepared äº‹ä»¶, æ¥ç€å…³é—­å¼•å¯¼å®¹å™¨; ç„¶åæ ¹æ® primarySource ä½¿ç”¨ BeanDefinitionLoader åŠ è½½ BeanDefinition åˆ°å®¹å™¨, æœ€åå‘å¸ƒ contextLoaded äº‹ä»¶</span></span><br><span class="line">  <span class="comment">//11.æ³¨å†Œä¸€ä¸ªé’©å­, å½“ JVM å…³é—­æ—¶, ç›¸åº”çš„å…³é—­ context, ç„¶åè°ƒç”¨å®¹å™¨çš„ refresh æ–¹æ³•(ç„¶åè¿›å…¥åˆ° Spring æºç åˆ†æé‚£æ®µ, è‡ªè¡Œè„‘è¡¥)</span></span><br><span class="line">  <span class="comment">//12.è®¡æ—¶å™¨åœæ­¢è®¡æ—¶, æ¥ç€æ‰“å°è®¡æ—¶æ•°æ®</span></span><br><span class="line">  <span class="comment">//13.å‘å¸ƒ started äº‹ä»¶</span></span><br><span class="line">  <span class="comment">//14.ä»å®¹å™¨ä¸­å–å‡º ApplicationRunner/CommandLineRunner ä¸¤ç±» bean, å¹¶è°ƒç”¨å®ƒä»¬çš„ run æ–¹æ³•.</span></span><br><span class="line">  <span class="comment">//15.catch åˆ°å¼‚å¸¸åˆ™å‘å¸ƒ failed äº‹ä»¶</span></span><br><span class="line">  <span class="comment">//16.å‘å¸ƒ running äº‹ä»¶</span></span><br><span class="line"></span><br><span class="line">  StopWatch stopWatch = <span class="keyword">new</span> StopWatch();</span><br><span class="line">  stopWatch.start();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºä¸€ä¸ªå¼•å¯¼å®¹å™¨, å¹¶åœ¨æ­¤æ—¶(å®¹å™¨æœªä½¿ç”¨å‰)ä» spring.factories æ‰«æä¸€äº›å®ç°äº† Bootstrapper æ¥å£çš„ç±», æ¥ç»™å¼•å¯¼å®¹å™¨é‡Œæ³¨å†Œä¸€äº›ä¸œè¥¿(å¦‚æœæœ‰éœ€è¦)</span></span><br><span class="line">  DefaultBootstrapContext bootstrapContext = createBootstrapContext();</span><br><span class="line">  ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¾€ç³»ç»Ÿå˜é‡é‡Œè®¾ç½®ä¸€ä¸ªå˜é‡ headless, çœ‹ä¸Šå»å’Œ AWT æœ‰å…³, æš‚ä¸”å¿½ç•¥ä¹‹</span></span><br><span class="line">  configureHeadlessProperty();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‰«æ spring.factories ä¸­é…ç½®çš„å®ç°äº† SpringApplicationRunListener çš„ç±»ä»¬</span></span><br><span class="line">  <span class="comment">//   å®ä¾‹åŒ–åæ”¾åˆ° SpringApplicationRunListeners (å…¶å°±æ˜¯ä¸ªå®¹å™¨ç®¡ç†ç±») å­˜èµ·æ¥.</span></span><br><span class="line">  SpringApplicationRunListeners listeners = getRunListeners(args);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§¦å‘æ‰€æœ‰å­˜å…¥çš„ SpringApplicationRunListener çš„ starting äº‹ä»¶.</span></span><br><span class="line">  listeners.starting(bootstrapContext, <span class="keyword">this</span>.mainApplicationClass);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// å°† args å†…å®¹ä¸­çš„å‚æ•°(ç±»ä¼¼ --spring.port=9999)è§£ææˆé”®å€¼å¯¹å­˜åˆ° applicationArguments å¯¹è±¡ä¸­.</span></span><br><span class="line">    ApplicationArguments applicationArguments = <span class="keyword">new</span> DefaultApplicationArguments(args);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºäº†ä¸€ä¸ª environment å¯¹è±¡, æ·»åŠ äº†å¥½å‡ ä¸ªåŠŸèƒ½å„å¼‚çš„ PropertySource,</span></span><br><span class="line">    <span class="comment">//   è§¦å‘æ‰€æœ‰å­˜å…¥çš„ SpringApplicationRunListener çš„ environmentPrepared äº‹ä»¶</span></span><br><span class="line">    <span class="comment">//   å°† environment ä¸­ spring.main å¼€å¤´çš„é…ç½®æ•°æ®, ä¸€ä¸€å¯¹åº”ç»‘å®šåˆ° SpringApplication(å³this)çš„å­—æ®µä¸Šå»</span></span><br><span class="line">    ConfigurableEnvironment environment = prepareEnvironment(listeners, bootstrapContext, applicationArguments);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† environment çš„ spring.beaninfo.ignore é…ç½®å¤åˆ¶åˆ° System.Property å»(è‹¥ä¸å­˜åœ¨)</span></span><br><span class="line">    configureIgnoreBeanInfo(environment);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ® this.bannerMode åˆ¤æ–­æ˜¯å¦æ‰“å° Banner, ä»¥åŠæ‰“å°åœ¨å“ªé‡Œ, æ ¹æ® this.banner åˆ¤æ–­æ‰“å°ä»€ä¹ˆæ ·çš„ Banner (ä½›ç¥–ä¿ä½‘.png)</span></span><br><span class="line">    Banner printedBanner = printBanner(environment);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ® web ç±»å‹åˆ›å»ºä¸åŒçš„ ApplicationContext, ä½†å…¶å®å·®åˆ«ä¸å¤§, å°±æ—¶å¤šäº† web å®¹å™¨çš„ç‰¹å¾(å¦‚å¯åŠ¨ tomcat)</span></span><br><span class="line">    <span class="comment">// å¦å¤–ä¸ Spring æºç åˆ†ææ—¶ä¸åŒ, è¿™é‡Œçš„åˆ›å»º, ä»…å®ä¾‹åŒ–è€Œå·², æ²¡æœ‰ä»æ„é€ æ–¹æ³•è°ƒç”¨ loadBeanDefinitions å’Œ refresh çš„é€»è¾‘</span></span><br><span class="line">    context = createApplicationContext();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† applicationStartup (æ­¥éª¤è®°å½•å™¨)èµ‹å€¼ç»™ context.</span></span><br><span class="line">    context.setApplicationStartup(<span class="keyword">this</span>.applicationStartup);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯¹ context åšä¸€äº›é…ç½®, æ‰§è¡Œ initializers çš„ initialize()</span></span><br><span class="line">    <span class="comment">// å‘å¸ƒ contextPrepared äº‹ä»¶</span></span><br><span class="line">    <span class="comment">// å…³é—­å¼•å¯¼å®¹å™¨, å³å‘å¸ƒ BootstrapContextClosedEvent äº‹ä»¶ç»™ä¹‹å‰åŠ çš„ closeListener (ç›‘å¬è€…)</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ BeanDefinitionLoader æ ¹æ® sources å’Œ run æ–¹æ³•å‚æ•° primarySource åŠ è½½ BeanDefinition åˆ°å®¹å™¨ä¸­.</span></span><br><span class="line">    <span class="comment">// å‘å¸ƒ contextLoaded äº‹ä»¶</span></span><br><span class="line">    prepareContext(bootstrapContext, context, environment, listeners, applicationArguments, printedBanner);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨å†Œä¸€ä¸ªé’©å­, å½“ JVM å…³é—­æ—¶, ç›¸åº”çš„å…³é—­ context, ç„¶åè°ƒç”¨å®¹å™¨çš„ refresh æ–¹æ³•(ç„¶åè¿›å…¥åˆ° Spring æºç åˆ†æé‚£æ®µ, è‡ªè¡Œè„‘è¡¥)</span></span><br><span class="line">    refreshContext(context);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç•™ç»™å­ç±»æ‰©å±•å§</span></span><br><span class="line">    afterRefresh(context, applicationArguments);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¡æ—¶å™¨åœæ­¢è®¡æ—¶, æ¥ç€æ‰“å°è®¡æ—¶æ•°æ®</span></span><br><span class="line">    stopWatch.stop();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) &#123;</span><br><span class="line">      <span class="keyword">new</span> StartupInfoLogger(<span class="keyword">this</span>.mainApplicationClass).logStarted(getApplicationLog(), stopWatch);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘å¸ƒ started äº‹ä»¶</span></span><br><span class="line">    listeners.started(context);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»å®¹å™¨ä¸­å–å‡º ApplicationRunner/CommandLineRunner ä¸¤ç±» bean, å¹¶è°ƒç”¨å®ƒä»¬çš„ run æ–¹æ³•.</span></span><br><span class="line">    callRunners(context, applicationArguments);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">    <span class="comment">// å‘å¸ƒ failed äº‹ä»¶</span></span><br><span class="line">    handleRunFailure(context, ex, listeners);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// å‘å¸ƒ running äº‹ä»¶</span></span><br><span class="line">    listeners.running(context);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">    <span class="comment">// å‘å¸ƒ failed äº‹ä»¶</span></span><br><span class="line">    handleRunFailure(context, ex, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ¸©é¦¨æç¤º: å…ˆåœ¨æƒ³çœ‹çš„åœ°æ–¹æ‰“æ–­ç‚¹, åœ¨æ‰“å¼€è°ƒè¯•æ¨¡å¼, å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°å¯¹åº”çš„å˜é‡å˜åŒ–æƒ…å†µ, ä»¥æ­¤ç†è§£ä»£ç !</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¥çœ‹çœ‹æ‰€æœ‰è¿‡ç¨‹æ¶‰åŠæ–¹æ³•çš„æ³¨é‡Š(å¤§å¤šæ•°)</span></span><br><span class="line">org.springframework.boot.SpringApplication#createBootstrapContext</span><br><span class="line">    <span class="comment">// 1.åˆ›å»ºä¸€ä¸ªå¼•å¯¼å®¹å™¨(è¿™ä¸ªå®¹å™¨ä½œç”¨å’Œ BeanFactory ç±»ä¼¼, ä½†æ›´ç®€å•å¾—å¤š, ä»…æœ‰è·å–/æ³¨å†Œ bean å¯¹è±¡ç­‰çš„åŠŸèƒ½)</span></span><br><span class="line">		<span class="comment">//   è§¦å‘å­˜äº this.bootstrappers çš„å¯¹è±¡çš„ intitialize æ–¹æ³•æ¥å¯¹å¼•å¯¼å®¹å™¨è¿›è¡Œåˆå§‹åŒ–(å³å¯ä»¥åœ¨å¼•å¯¼å®¹å™¨æœªä½¿ç”¨å‰å¾€é‡Œé¢æ³¨å†Œ bean å¯¹è±¡)</span></span><br><span class="line">		<span class="comment">//   ç„¶å this.bootstrappers çš„æ•°æ®æœ‰ä¸€éƒ¨åˆ†æ˜¯ä» spring.factories æ‰¾ Bootstrapper çš„ç±»å®ä¾‹åŒ–åå¾—åˆ°çš„, ç„¶åä¹Ÿå¯ä»¥ä»£ç æ‰‹åŠ¨æ·»åŠ </span></span><br><span class="line">		</span><br><span class="line">  </span><br><span class="line">org.springframework.boot.SpringApplication#getRunListeners</span><br><span class="line">    <span class="comment">// æ‰«æ spring.factories ä¸­é…ç½®çš„å®ç°äº† SpringApplicationRunListener çš„ç±», å¹¶è°ƒç”¨å½¢å¦‚ types çš„å‚æ•°çš„æ„é€ å‡½æ•°æ¥å®ä¾‹åŒ–å¾—åˆ°å¯¹è±¡é›†åˆ</span></span><br><span class="line">		<span class="comment">//   å†å°†è¿™äº›å¯¹è±¡é›†åˆæ”¾åˆ° SpringApplicationRunListeners(å…¶å°±æ˜¯ä¸ªå®¹å™¨ç®¡ç†ç±»)ä¸­.</span></span><br><span class="line">		<span class="comment">// å¹¶ç»‘å®š applicationStartup (æ­¥éª¤è®°å½•å™¨)</span></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">org.springframework.boot.SpringApplicationRunListeners#doWithListeners(java.lang.String, java.util.function.Consumer&lt;org.springframework.boot.SpringApplicationRunListener&gt;, java.util.function.Consumer&lt;org.springframework.core.metrics.StartupStep&gt;)</span><br><span class="line">    <span class="comment">// éå†æŒæœ‰çš„æ‰€æœ‰ SpringApplicationRunListener, è§¦å‘å¯¹åº”äº‹ä»¶</span></span><br><span class="line">		<span class="comment">// åœ¨è§¦å‘ç›‘å¬äº‹ä»¶å‰ååŠ å…¥ StartupStep ç›‘å¬æ‰€è€—æ—¶é—´</span></span><br><span class="line">		<span class="comment">// æ­¥éª¤ç›‘å¬å™¨çš„ accept å¤„ç†</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">org.springframework.boot.SpringApplication#prepareEnvironment</span><br><span class="line">    <span class="comment">// 1.æ ¹æ® web ç±»å‹åˆ›å»ºä¸€ä¸ª environment å¯¹è±¡</span></span><br><span class="line">		<span class="comment">// 2.é…ç½® environment</span></span><br><span class="line">		<span class="comment">//     é€šè¿‡ ConversionService ç±»æ·»åŠ ä¸€äº›ç±»å‹è½¬æ¢æ”¯æŒ(å¦‚æ–‡ä»¶å¤§å°1024k=1Mç­‰)</span></span><br><span class="line">		<span class="comment">//     å°†ç”¨æˆ·è®¾ç½®çš„ defaultProperties æ·»åŠ åˆ° environment çš„ sources ä¸­, å°† args è§£ææˆä¸€ä¸ª PropertySource ååŠ å…¥åˆ° environment ä¸­</span></span><br><span class="line">		<span class="comment">// 3.ä¸º environment æ·»åŠ ä¸€ä¸ªåä¸º configurationProperties çš„æº, å…¶ä½œç”¨æ˜¯å°†æ¯ä¸€ä¸ª PropertySource é€‚é…æˆ ConfigurationPropertySource.</span></span><br><span class="line">		<span class="comment">// 4.è§¦å‘æ‰€æœ‰å­˜å…¥çš„ SpringApplicationRunListener çš„ environmentPrepared äº‹ä»¶.</span></span><br><span class="line">		<span class="comment">// 5.å°†åä¸º defaultProperties çš„ Property æºç§»æœ€å(é™ä½ä¼˜å…ˆçº§), å¦æ­¤ defaultProperties ä¸æ˜¯ this.defaultProperties</span></span><br><span class="line">		<span class="comment">// 6.å°†ç”¨æˆ·é€šè¿‡ä»£ç è®¾ç½®çš„è¦é™„åŠ çš„ profile è®¾ç½®åˆ° activeProfiles ä¸­å» (è‹¥å­˜åœ¨ä¸” environment ä¸­ä¸å­˜åœ¨)</span></span><br><span class="line">		<span class="comment">// 7.å°† environment ä¸­ spring.main å¼€å¤´çš„é…ç½®æ•°æ®, ä¸€ä¸€å¯¹åº”ç»‘å®šåˆ° SpringApplication(å³this)çš„å­—æ®µä¸Šå»</span></span><br><span class="line">		<span class="comment">// 8.è‹¥ä¸å¼€å¯è‡ªå®šä¹‰ environment, åˆ™å°† environment è½¬æ¢æˆ StandardEnvironment(é»˜è®¤è¡Œä¸º)</span></span><br><span class="line">		<span class="comment">// 9.ç”±äºä¸Šä¸€æ­¥å¯èƒ½åšäº†è½¬æ¢, æ‰€ä»¥éœ€è¦é‡æ–° attach ä¸€æ¬¡.</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">org.springframework.boot.SpringApplication#getOrCreateEnvironment</span><br><span class="line">    <span class="comment">// 1.è‹¥å­˜åœ¨ä¸€ä¸ª environment, åˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">		<span class="comment">// 2.è‹¥ä¸å­˜åœ¨, åˆ™æ ¹æ®ä¹‹å‰æ¨æ–­å¾—å‡ºçš„ webApplicationType æ¥åˆ›å»ºå¯¹åº”çš„ Environment å¯¹è±¡.</span></span><br><span class="line">		<span class="comment">// 3.è¿™å‡ ä¸ªä¸åŒçš„ç±»å‹åŒºåˆ«ä¹Ÿä¸å¤§, å°± StandardServletEnvironment å¤šäº†3ä¸ª propertySources(å…¶ä¸­ä¸€ä¸ªæ˜¯ JDNI, æ¯”è¾ƒé‡è¦)</span></span><br><span class="line">		</span><br><span class="line">  </span><br><span class="line">org.springframework.boot.SpringApplication#configureEnvironment</span><br><span class="line">    <span class="comment">// 1.é€šè¿‡ ConversionService ç±»æ·»åŠ ä¸€äº›ç±»å‹è½¬æ¢æ”¯æŒ(å¦‚æ–‡ä»¶å¤§å°1024k=1Mç­‰)</span></span><br><span class="line">		<span class="comment">// 2.å°†ç”¨æˆ·è®¾ç½®çš„ defaultProperties æ·»åŠ åˆ° environment çš„ sources ä¸­, å°† args è§£ææˆä¸€ä¸ª PropertySource ååŠ å…¥åˆ° environment ä¸­.</span></span><br><span class="line">		<span class="comment">// 3. configureProfiles æ˜¯ä¸€ä¸ªç©ºæ–¹æ³•, çœ‹æ¥æ˜¯ç•™ç»™æˆ‘ä»¬å®ç°å­ç±»æ—¶æ‰©å±•çš„.</span></span><br><span class="line">		</span><br><span class="line">  </span><br><span class="line">org.springframework.boot.context.properties.source.ConfigurationPropertySources#attach</span><br><span class="line">    <span class="comment">// ä¸º environment æ·»åŠ ä¸€ä¸ªåä¸º configurationProperties çš„æº, å…¶ä½œç”¨æ˜¯å°†æ¯ä¸€ä¸ª PropertySource é€‚é…æˆ ConfigurationPropertySource.</span></span><br><span class="line">		</span><br><span class="line">  </span><br><span class="line">org.springframework.boot.SpringApplication#configureAdditionalProfiles</span><br><span class="line">    <span class="comment">// å°†ç”¨æˆ·é€šè¿‡ä»£ç è®¾ç½®çš„è¦é™„åŠ çš„ profile è®¾ç½®åˆ° activeProfiles ä¸­å» (è‹¥å­˜åœ¨ä¸” environment ä¸­ä¸å­˜åœ¨)</span></span><br><span class="line">		</span><br><span class="line">  </span><br><span class="line">org.springframework.boot.SpringApplication#bindToSpringApplication</span><br><span class="line">    <span class="comment">// å°† environment ä¸­çš„é…ç½®æ•°æ®, ç»‘å®šåˆ° SpringApplication(å³this)çš„ä¸€äº›å­—æ®µä¸Šå»</span></span><br><span class="line">		<span class="comment">// ç»‘å®šè§„åˆ™æ˜¯ spring.main å¼€å¤´çš„é…ç½®æ•°æ®ä¸ SpringApplication ä¸€ä¸€å¯¹åº”, å¦‚è‹¥å­˜åœ¨ spring.main.banner-mode=OFF, åˆ™ this.bannerMode=OFF</span></span><br><span class="line">		</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">org.springframework.boot.SpringApplication#printBanner</span><br><span class="line">    <span class="comment">// æ ¹æ® this.bannerMode åˆ¤æ–­æ˜¯å¦æ‰“å° Banner, ä»¥åŠæ‰“å°åœ¨å“ªé‡Œ</span></span><br><span class="line">		<span class="comment">//   this.banner ä¸ºæ–‡ä»¶è·¯å¾„, è‹¥ä¸ºç©º, åˆ™æ‰“å° Spring Boot é»˜è®¤å‡†å¤‡çš„æ–‡æœ¬(è¿™ä¸æ¢ä¸ªä½›ç¥–ä¿ä½‘?)</span></span><br><span class="line">		</span><br><span class="line">  </span><br><span class="line">org.springframework.boot.SpringApplication#createApplicationContext</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// æ ¹æ® web ç±»å‹åˆ›å»ºä¸åŒçš„ ApplicationContext, ä½†å…¶å®å·®åˆ«ä¸å¤§, å°±å‡ ä¸ªç»†èŠ‚ä¸åŒç½¢äº†</span></span><br><span class="line">		<span class="comment">// ä»¥ AnnotationConfigServletWebServerApplicationContext ä¸ºä¾‹, ä¸ AnnotationConfigApplicationContext çš„åŒºåˆ«å¤§è‡´ä¸º</span></span><br><span class="line">		<span class="comment">//   å¤šåŠ äº†ä¸€ä¸ª BeanPostProcessor ç”¨äºç»™ ServletContextAware/ServletConfigAware æ¥å£æ³¨å…¥ servletContext/servletConfig å¯¹è±¡</span></span><br><span class="line">		<span class="comment">//   onRefresh() æ—¶, è°ƒç”¨ createWebServer() å¯åŠ¨ tomcat/jetty/undertow</span></span><br><span class="line">		</span><br><span class="line">  </span><br><span class="line">org.springframework.boot.SpringApplication#prepareContext</span><br><span class="line">    <span class="comment">// 1.è®¾ç½® environment å¯¹è±¡</span></span><br><span class="line">		<span class="comment">// 2.å°† beanNameGenerator æ³¨å†Œåˆ°å®¹å™¨ä¸­ (è‹¥å­˜åœ¨), é…ç½®å®¹å™¨çš„ resourceLoader å’Œ conversionService (ä» SpringApplication è·å–)</span></span><br><span class="line">		<span class="comment">// 3.å°† initializers æ ¹æ® @Order é…ç½®æ’åºå, éå†æ‰§è¡Œå…¶ initialize æ–¹æ³•.</span></span><br><span class="line">		<span class="comment">// 4.å‘å¸ƒ contextPrepared äº‹ä»¶</span></span><br><span class="line">		<span class="comment">// 5.å…³é—­é”€æ¯å¼•å¯¼å®¹å™¨(æ¯•ç«ŸçœŸæ­£çš„å®¹å™¨å·²ç»å‡†å¤‡å¥½äº†, è¿™ç©æ„å°±æ²¡ç”¨äº†)</span></span><br><span class="line">		<span class="comment">// 6.ä¸ºå®¹å™¨æ·»åŠ ä¸€äº›ç‰¹æ®Šçš„ bean, å¯¹ beanFactory åšç‚¹å°è®¾ç½®; ç„¶åæ·»åŠ ä¸€ä¸ªæ‡’åŠ è½½åŠŸèƒ½çš„ BeanFactoryPostProcessor, ä½œç”¨æ˜¯å°†æ‰€æœ‰çš„ BeanDefinition çš„ lazyInit è®¾ç½®ä¸º true</span></span><br><span class="line">		<span class="comment">// 7.åˆ›å»ºä¸€ä¸ª BeanDefinitionLoader, è§£æ sources å¾—åˆ° BeanDefinition å†æ³¨å†Œåˆ°å®¹å™¨ä¸­. å’Œ Spring çš„ new å®¹å™¨æ—¶çš„ load è¿‡ç¨‹ç±»ä¼¼.</span></span><br><span class="line">		<span class="comment">// 8.å‘å¸ƒ contextLoaded äº‹ä»¶</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">org.springframework.boot.SpringApplication#postProcessApplicationContext</span><br><span class="line">    <span class="comment">// 1.å°† beanNameGenerator æ³¨å†Œåˆ°å®¹å™¨ä¸­ (è‹¥å­˜åœ¨)</span></span><br><span class="line">		<span class="comment">// 2.å°† SpringApplication çš„ resourceLoader èµ‹å€¼ç»™å®¹å™¨ (è‹¥å­˜åœ¨)</span></span><br><span class="line">		<span class="comment">// 3.ä¸ºå®¹å™¨è®¾ç½® ConversionService(ç±»å‹è½¬æ¢å·¥å…·)å¯¹è±¡ (è‹¥é…ç½®äº†å…è®¸)</span></span><br><span class="line">		</span><br><span class="line">  </span><br><span class="line">org.springframework.boot.SpringApplication#load</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ª BeanDefinitionLoader, è§£æ sources å¾—åˆ° BeanDefinition å†æ³¨å†Œåˆ°å®¹å™¨ä¸­. å’Œ Spring çš„ new å®¹å™¨æ—¶çš„ load è¿‡ç¨‹ç±»ä¼¼.</span></span><br><span class="line">		</span><br><span class="line"></span><br><span class="line">org.springframework.boot.SpringApplication#refreshContext</span><br><span class="line">    <span class="comment">// 1.æ³¨å†Œä¸€ä¸ªé’©å­, å½“ JVM å…³é—­æ—¶, ç›¸åº”çš„å…³é—­ context</span></span><br><span class="line">		<span class="comment">// 2.è°ƒç”¨å®¹å™¨çš„ refresh æ–¹æ³•</span></span><br><span class="line">		</span><br><span class="line">  </span><br><span class="line">org.springframework.boot.SpringApplication#callRunners</span><br><span class="line">    <span class="comment">// ä»å®¹å™¨ä¸­å–å‡º ApplicationRunner/CommandLineRunner ä¸¤ç±» bean, å¹¶è°ƒç”¨å®ƒä»¬çš„ run æ–¹æ³•.</span></span><br><span class="line">		<span class="comment">// è¿™é‡Œæœ‰ä¸¤ä¸ªä¸åŒç‚¹</span></span><br><span class="line">		<span class="comment">//    1. XxxRunner å’Œ ApplicationListener æœ‰ä½•ä¸åŒ?</span></span><br><span class="line">		<span class="comment">//       ç­”æ¡ˆæ˜¯ XxxRunner çš„ run æ–¹æ³•å¯ä»¥ç›´æ¥å–åˆ°ç¨‹åºå¯åŠ¨çš„ args å‚æ•°, è€Œç›‘å¬å™¨è¦å–åˆ™è¿˜éœ€å€ŸåŠ© environment</span></span><br><span class="line">		<span class="comment">//    2.ApplicationRunner å’Œ CommandLineRunner æœ‰ä½•ä¸åŒ?</span></span><br><span class="line">		<span class="comment">//       ç­”æ¡ˆæ˜¯ run æ–¹æ³•æ¥å—çš„å‚æ•°å½¢å¼ä¸åŒ, ä¸€ä¸ªæ˜¯ å­—ç¬¦ä¸²æ•°ç»„(åŸå§‹çš„), ä¸€ä¸ªæ˜¯è§£æå¥½çš„ key:value æ–¹ä¾¿ç›´æ¥å–ç”¨.</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>è§„çŸ©æˆ‘æ‡‚å¾—, GitHubåœ¨è¿™ <a href="https://github.com/gudqs7/spring-boot/tree/wq-comment" target="_blank" rel="noopener">æ³¨æ„åˆ†æ”¯å“¦</a> </p>
</blockquote>
<h2 id="å„ç§å®ç°çš„åŸç†"><a href="#å„ç§å®ç°çš„åŸç†" class="headerlink" title="å„ç§å®ç°çš„åŸç†"></a>å„ç§å®ç°çš„åŸç†</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.application.properties æ˜¯å¦‚ä½•è¢«åŠ è½½åˆ° Environment ä¸­çš„?</span><br><span class="line">2.@ConfigurationProperties å¦‚ä½•å®ç°è‡ªåŠ¨æ³¨å…¥`application.properties/application.yml`ä¸­é…ç½®çš„å€¼?</span><br><span class="line">3.ä¸€äº›åªéœ€è¦æ”¹æ”¹ä¾èµ–jarå°±å¯ä»¥åˆ‡æ¢(å¦‚tomcat-&gt;undertow)æ˜¯æ€ä¹ˆåšåˆ°çš„? (@ConditionalXxx çš„å®ç°åŸç†)</span><br><span class="line">4.JdbcTemplateAutoConfigurationå¦‚ä½•ç¡®ä¿èƒ½å¤Ÿè·å–åˆ° DataSource? (@AutoConfigureAfter çš„å®ç°åŸç†)</span><br><span class="line">5.ä¸ºä»€ä¹ˆ Spring Boot å¯åŠ¨ main æ–¹æ³•å°±èƒ½è®¿é—® Tomcat? (SpringApplication.run() å¯åŠ¨ tomcat å®ç°åŸç†)</span><br></pre></td></tr></table></figure>



<h3 id="application-properties-æ˜¯å¦‚ä½•è¢«åŠ è½½åˆ°-Environment-ä¸­çš„"><a href="#application-properties-æ˜¯å¦‚ä½•è¢«åŠ è½½åˆ°-Environment-ä¸­çš„" class="headerlink" title="application.properties æ˜¯å¦‚ä½•è¢«åŠ è½½åˆ° Environment ä¸­çš„?"></a>application.properties æ˜¯å¦‚ä½•è¢«åŠ è½½åˆ° Environment ä¸­çš„?</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">1) runæ–¹æ³•ä¸­åˆ›å»ºäº† Environment å¯¹è±¡, å½“åˆå§‹åŒ–å¥½ä¸€äº›ä¸œè¥¿åä¼šè§¦å‘ environmentPrepared äº‹ä»¶</span><br><span class="line">2) é€šè¿‡ SpringApplicationRunListener çš„ EventPublishingRunListener è½¬å‘äº‹ä»¶ç»™ ApplicationListener è¿™ç±»ç›‘å¬è€…, å³ EnvironmentPostProcessorApplicationListener.</span><br><span class="line">3) è¿™ä¸ªç±»æ¥æ”¶äº‹ä»¶å, éå†ä» spring.factories è·å¾—çš„ EnvironmentPostProcessor å¯¹è±¡, æ‰§è¡Œå…¶ postProcessEnvironment()</span><br><span class="line">4) å…¶ä¸­ ConfigFileApplicationListener<span class="comment">#postProcessEnvironment() å®ç°äº†é…ç½®æ–‡ä»¶çš„åŠ è½½</span></span><br><span class="line">5) å…·ä½“ä¸º postProcessEnvironment ä¸‹çš„ addPropertySources()</span><br><span class="line">6) æ­¤æ–¹æ³•å°†ä¼šæ‰«ææŒ‡å®šçš„è·¯å¾„ä¸‹æŒ‡å®šçš„æŸäº›æ–‡ä»¶</span><br><span class="line">7) ç„¶åä½¿ç”¨ spring.factories ä¸‹çš„ PropertySourceLoader ä¸€ä¸€å°è¯•è§£æ</span><br><span class="line">8) æ–‡ä»¶å­˜åœ¨ä¸”è§£ææ­£ç¡®åˆ™åŠ å…¥åˆ° environment çš„ sources é›†åˆä¸­.</span><br><span class="line">	æŸäº›è·¯å¾„: getSearchLocations() ,é»˜è®¤: classpath:/,classpath:/config/ ...</span><br><span class="line">	æŸäº›æ–‡ä»¶: getSearchNames() ,é»˜è®¤: application</span><br><span class="line"></span><br><span class="line"><span class="comment"># PS: </span></span><br><span class="line">PropertySourceLoader æœ‰ PropertiesPropertySourceLoader/YamlPropertySourceLoader</span><br><span class="line">ä¸€ä¸ªå°è¯•åç¼€æœ‰ xml/properties, å¦ä¸€ä¸ªæ˜¯ yml/yaml, å› ä¸ºæ˜¯éå†å load, æ‰€ä»¥æ‰€æœ‰å¯èƒ½æ€§æœ‰:</span><br><span class="line">    classpath:/application.xml; classpath:/application.properties</span><br><span class="line">	classpath:/application.yml; classpath:/application.yaml</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure>



<h3 id="ConfigurationProperties-å¦‚ä½•å®ç°è‡ªåŠ¨æ³¨å…¥application-properties-application-ymlä¸­é…ç½®çš„å€¼"><a href="#ConfigurationProperties-å¦‚ä½•å®ç°è‡ªåŠ¨æ³¨å…¥application-properties-application-ymlä¸­é…ç½®çš„å€¼" class="headerlink" title="@ConfigurationProperties å¦‚ä½•å®ç°è‡ªåŠ¨æ³¨å…¥application.properties/application.ymlä¸­é…ç½®çš„å€¼?"></a>@ConfigurationProperties å¦‚ä½•å®ç°è‡ªåŠ¨æ³¨å…¥<code>application.properties/application.yml</code>ä¸­é…ç½®çš„å€¼?</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1) é¦–å…ˆåŠ äº† @EnableConfigurationProperties ä¹Ÿä¼šè§£æé‡Œé¢çš„ @Import </span><br><span class="line">2) @Import åˆ™å¼•å…¥äº† EnableConfigurationPropertiesRegistrar.class</span><br><span class="line">3) è¿™æ˜¯ä¸€ä¸ª ImportBeanDefinitionRegistrar çš„å®ç°ç±», å› æ­¤è°ƒç”¨æŒ‡å®šæ–¹æ³• registerBeanDefinitions</span><br><span class="line">4) æŒ‡å®šæ–¹æ³• registerBeanDefinitions() ä¼šå°† @EnableConfigurationProperties æ³¨è§£çš„å€¼å¯¹åº”çš„ç±»æ³¨å†Œåˆ°å®¹å™¨ä¸­, å¦‚ @EnableConfigurationProperties(RabbitProperties.class) åˆ™ä¼šåŠ è½½ RabbitProperties.class</span><br><span class="line">5) æŒ‡å®šæ–¹æ³•è¿˜æ³¨å†Œäº†ä¸€äº›å·¥å…· bean å’Œä¸€ä¸ªé‡è¦çš„ BeanPostProcessor åœ¨ registerInfrastructureBeans()ä¸­</span><br><span class="line">6) å³ ConfigurationPropertiesBindingPostProcessor, å½“æˆ‘ä»¬è¦ä½¿ç”¨é…ç½®æ–‡ä»¶ bean(å¦‚ RabbitProperties)æ—¶,ä¼šå®ä¾‹åŒ– bean å¹¶è§¦å‘ postProcessorBeforeInitialization()</span><br><span class="line">7) åœ¨ postProcessorBeforeInitialization() ä¸­, é€šè¿‡ org.springframework.boot.context.properties.ConfigurationPropertiesBinder<span class="comment">#bind() æ¥å®Œæˆå®é™…çš„ç»‘å®š</span></span><br><span class="line">8) å…¶æœ¬è´¨å°±æ˜¯ Binder çš„ <span class="built_in">bind</span> æ–¹æ³•, è®¾å®šé…ç½®æ–‡ä»¶å‰ç¼€å³å¯å°†é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®å¯¹åº”çš„ç»‘å®šåˆ° bean(å¦‚ rabbitProperties å¯¹è±¡) ä¸­.</span><br><span class="line"></span><br><span class="line"><span class="comment"># PS</span></span><br><span class="line">è¿™é‡Œçš„ Binder å’Œ SpringApplication é‡Œç»‘å®š spring.main å¼€å¤´é…ç½®æ–‡ä»¶é‚£ä¸ªç±»æ˜¯åŒä¸€ä¸ª.</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ€»ç»“</span></span><br><span class="line">å°±æ˜¯å…ˆå°† XxxProperties ç±»æ³¨å†Œåˆ°å®¹å™¨ä¸­, è¿™æ ·å°±å¯ä»¥é€šè¿‡ BeanPostProcessor å†å®ä¾‹åŒ–åå°†é…ç½®æ–‡ä»¶ä¸å±æ€§ç»‘å®š.</span><br></pre></td></tr></table></figure>



<h3 id="ä¸€äº›åªéœ€è¦æ”¹æ”¹ä¾èµ–jarå°±å¯ä»¥åˆ‡æ¢-å¦‚tomcatâ€“-gt-undertow-æ˜¯æ€ä¹ˆåšåˆ°çš„-ConditionalXxx-çš„å®ç°åŸç†"><a href="#ä¸€äº›åªéœ€è¦æ”¹æ”¹ä¾èµ–jarå°±å¯ä»¥åˆ‡æ¢-å¦‚tomcatâ€“-gt-undertow-æ˜¯æ€ä¹ˆåšåˆ°çš„-ConditionalXxx-çš„å®ç°åŸç†" class="headerlink" title="ä¸€äº›åªéœ€è¦æ”¹æ”¹ä¾èµ–jarå°±å¯ä»¥åˆ‡æ¢(å¦‚tomcatâ€“&gt;undertow)æ˜¯æ€ä¹ˆåšåˆ°çš„? (@ConditionalXxx çš„å®ç°åŸç†)"></a>ä¸€äº›åªéœ€è¦æ”¹æ”¹ä¾èµ–jarå°±å¯ä»¥åˆ‡æ¢(å¦‚tomcatâ€“&gt;undertow)æ˜¯æ€ä¹ˆåšåˆ°çš„? (@ConditionalXxx çš„å®ç°åŸç†)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">1) åœ¨ç±»ä¸ŠåŠ ä¸Šæ³¨è§£ @Conditional æˆ–å¸¦æœ‰ @Conditional çš„å…¶ä»–æ³¨è§£(å³æ³¨è§£çš„å­ç±»äº¦ä¼šæ‰«æ)</span><br><span class="line">2) åœ¨æ‰€æœ‰çš„æ‰«æç±»å’Œæ³¨è§£çš„åœ°æ–¹,å¦‚è§£æ@Configuration, AnotatedBeanDefinitionReader ç­‰ reader</span><br><span class="line">    ä¼šä½¿ç”¨ ConditionEvaluator çš„ shouldSkip() åˆ¤æ–­æ˜¯å¦å¯ä»¥åŠ è½½, æ—¶æœºç‚¹å¦‚ä¸‹</span><br><span class="line">    AnnotatedBeanDefinitionReader<span class="comment">#doRegisterBean() çš„ç¬¬äºŒè¡Œä»£ç </span></span><br><span class="line">    ConfigurationClassBeanDefinitionReader<span class="comment">#loadBeanDefinitionsForBeanMethod() ç¬¬å››è¡Œ</span></span><br><span class="line">    ConfigurationClassBeanDefinitionReader<span class="comment">#loadBeanDefinitionsForConfigurationClass()</span></span><br><span class="line">    ConfigurationClassParser<span class="comment">#doProcessConfigurationClass() å¤„ç† ComponentScan é‚£æ®µ</span></span><br><span class="line">3) ç„¶åå† shouldSkip ä¸­åˆ¤æ–­ï¼Œ åˆ¤æ–­é€»è¾‘å¤§è‡´å¦‚ä¸‹ï¼š</span><br><span class="line">    å…ˆéå†æ‰€æœ‰æ³¨è§£å–å¾—æ‰€æœ‰çš„ @Conditional çš„ value, è¿™ä¸ª value æ˜¯å…·ä½“çš„ Condition å®ç°, å¦‚ OnClassCondition(å®ç°äº† Condition çš„ matches æ¥å£, å¾ˆå¤šæŠ½è±¡ç±»ç”¨ä»¥å¢å¼ºä»£ç æ‰©å±•æ€§), ç„¶åå…¶åŠ å…¥åˆ° conditions ä¸­, æ’åºåéå†è°ƒç”¨ matches(), ä¸€ä¸ªä¸åŒ¹é…åˆ™è¿”å› <span class="literal">true</span>, ä»£è¡¨åº”è¯¥è·³è¿‡.</span><br><span class="line"></span><br><span class="line"><span class="comment"># TIPS:</span></span><br><span class="line">ConditionOutcome å°è£…äº†æ˜¯å¦åŒ¹é…å’ŒåŒ¹é…æ—¥å¿—ä¿¡æ¯[ä¸ºå•¥æˆåŠŸ/ä¸ºå•¥å¤±è´¥]</span><br><span class="line">SpringBootCondition æä¾›äº†é€šç”¨çš„æ ¹æ® ConditionOutcome åˆ¤æ–­æ˜¯å¦åŒ¹é…å¹¶è®°å½•æ—¥å¿—ä¿¡æ¯çš„æŠ½è±¡ç±».</span><br><span class="line">    å­ç±»åªéœ€å®ç° getMatchOutcome(): æ ¹æ® metadata[æ³¨è§£ä¿¡æ¯] è¿”å› ConditionOutcome å¯¹è±¡.</span><br><span class="line">    å› æ­¤, å¦‚æœæˆ‘ä»¬è¦å®ç°è‡ªå·±çš„ Condition, å¯ä»¥ç»§æ‰¿å®ƒ.</span><br></pre></td></tr></table></figure>



<h3 id="JdbcTemplateAutoConfiguration-å¦‚ä½•ç¡®ä¿èƒ½å¤Ÿè·å–åˆ°-DataSource-AutoConfigureAfter-çš„å®ç°åŸç†"><a href="#JdbcTemplateAutoConfiguration-å¦‚ä½•ç¡®ä¿èƒ½å¤Ÿè·å–åˆ°-DataSource-AutoConfigureAfter-çš„å®ç°åŸç†" class="headerlink" title="JdbcTemplateAutoConfiguration å¦‚ä½•ç¡®ä¿èƒ½å¤Ÿè·å–åˆ° DataSource? (@AutoConfigureAfter çš„å®ç°åŸç†)"></a>JdbcTemplateAutoConfiguration å¦‚ä½•ç¡®ä¿èƒ½å¤Ÿè·å–åˆ° DataSource? (@AutoConfigureAfter çš„å®ç°åŸç†)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1) é¦–å…ˆæ‰€æœ‰çš„ XxxAutoConfiguration éƒ½æ˜¯å€ŸåŠ© AutoConfigurationImportSelector åŠ è½½çš„, å…¶ç»§æ‰¿äº† DeferredImportSelector.  </span><br><span class="line">2) è¿™ç§ DeferredImportSelector ä¼šå»¶è¿ŸåŠ è½½, åŸç†æ˜¯ parse åå†åŠ è½½, è€Œé parse æ‰§è¡Œè¿‡ç¨‹ä¸­å°±åŠ è½½.</span><br><span class="line">3) å»¶è¿ŸåŠ è½½æœºåˆ¶ ä¼šå…ˆè°ƒç”¨ process æ–¹æ³•, å°†è¦åŠ è½½çš„ class ä¿å­˜èµ·æ¥, ç„¶åå†è°ƒç”¨ selectImports è¿”å›.</span><br><span class="line">4) æ­¤æ—¶ AutoConfigurationImportSelector.AutoConfigurationGroup çš„ selectImports() ä¼šè°ƒç”¨ sortAutoConfigurations(), ä¹Ÿå°±æ˜¯è°ƒç”¨äº† AutoConfigurationSorter.getInPriorityOrder()</span><br><span class="line">5) getInPriorityOrder() è°ƒç”¨äº† sortByAnnotation() è¿™ä¸ªæ–¹æ³•æ ¹æ®2ä¸ªæ³¨è§£ @AutoConfigureBefore/@AutoConfigureAfter æ’åº.</span><br><span class="line">6) æœ€åè¿”å›çš„å°±æ˜¯æœ‰åºçš„äº†. å¦å¤–, è¿™ä¸¤ä¸ªæ³¨è§£åªèƒ½ä½œç”¨åœ¨ spring.factories ä¸­ EnableAutoConfiguration çš„ç±»ä¸Šæ‰æœ‰æ•ˆ.</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ€»ç»“:</span></span><br><span class="line">åˆ©ç”¨ DeferredImportSelector çš„å»¶è¿ŸåŠ è½½, å°†æ‰€æœ‰çš„ AutoConfiguration æ‰€å¼•å…¥çš„ class å…ˆå­˜èµ·æ¥ä¸åŠ è½½, ç„¶ååˆåŠ å…¥æ’åºçš„é€»è¾‘, ä½¿å¾—çœŸæ­£åŠ è½½æ—¶ä¼šæ ¹æ®æ’åºç»“æœä¾æ¬¡åŠ è½½.</span><br></pre></td></tr></table></figure>



<h3 id="ä¸ºä»€ä¹ˆ-Spring-Boot-å¯åŠ¨-main-æ–¹æ³•å°±èƒ½è®¿é—®-Tomcat-SpringApplication-run-å¯åŠ¨-tomcat-å®ç°åŸç†"><a href="#ä¸ºä»€ä¹ˆ-Spring-Boot-å¯åŠ¨-main-æ–¹æ³•å°±èƒ½è®¿é—®-Tomcat-SpringApplication-run-å¯åŠ¨-tomcat-å®ç°åŸç†" class="headerlink" title="ä¸ºä»€ä¹ˆ Spring Boot å¯åŠ¨ main æ–¹æ³•å°±èƒ½è®¿é—® Tomcat? (SpringApplication.run() å¯åŠ¨ tomcat å®ç°åŸç†)"></a>ä¸ºä»€ä¹ˆ Spring Boot å¯åŠ¨ main æ–¹æ³•å°±èƒ½è®¿é—® Tomcat? (SpringApplication.run() å¯åŠ¨ tomcat å®ç°åŸç†)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1) main æ–¹æ³•ä¼šè°ƒç”¨ SpringApplication çš„ run æ–¹æ³•, é‡Œé¢ä¼šåˆ›å»º applicationContext, å¦‚æ˜¯ webApplicationType = SERVLET, åˆ™å®ç°ç±»ä¸º AnnotationConfigServletWebServerApplicationContext</span><br><span class="line">    å¦å¤–ä¸€æ, webApplicationType æ˜¯æ ¹æ® classpath ä¸‹æ˜¯å¦æœ‰å“ªäº›ç±»æ¥æ¨æ–­çš„.</span><br><span class="line">2) è¿™ä¸ªç±»ç»§æ‰¿äº† ServletWebServerApplicationContext</span><br><span class="line">3) ServletWebServerApplicationContext å®ç°äº† onRefresh()</span><br><span class="line">4) onRefresh() è°ƒç”¨äº† createWebServer()</span><br><span class="line">5) createWebServer() ä½¿ç”¨ ServletWebServerFactory.getWebServer() è·å– webServer å¯¹è±¡</span><br><span class="line">6) ServletWebServerFactory çš„å…·ä½“å®ç°ç±»ç”± ServletWebServerFactoryAutoConfiguration å¼•å…¥</span><br><span class="line">    è¯¦ç»†è§ ServletWebServerFactoryConfiguration.EmbeddedTomcat.class</span><br><span class="line">7) å¼•å…¥åè°ƒç”¨ getWebServer(), å¤§æ¦‚ä¸º new Tomcat(), ç»‘å®šé…ç½®æ–‡ä»¶åˆ° Tomcat çš„ä¸€äº›å±æ€§ä¸Š, ç„¶åå¯åŠ¨å®ƒ.</span><br><span class="line">8) è‡³æ­¤, run() å¯åŠ¨äº† tomcat/jetty/undertow.</span><br><span class="line"> </span><br><span class="line"><span class="comment"># TIPS:</span></span><br><span class="line">Spring ä½¿ç”¨å·¥å‚æ¨¡å¼è·å–ä¸åŒçš„ webServer, è€Œä¸åŒçš„ webServer å®ç°ç±»å…¶å®æ˜¯ç”¨ XxxAutoConfiguration æ¥è‡ªåŠ¨æ³¨å…¥çš„(è¿˜å¯ä»¥é…åˆ @Conditional å†³å®šä½•æ—¶åŠ è½½).</span><br><span class="line">è¿™æ ·å¦‚æœæ–°å¢ä¸€ç§ webServer, åªéœ€è¦åœ¨å†™ä¸€ä¸ª XxxAutoConfiguration æ³¨å†Œä¸€ä¸ª webServer å®ç°ç±»çš„ bean å³å¯, éå¸¸çµæ´»(éå¸¸ nice).</span><br></pre></td></tr></table></figure>





<h2 id="å¸¸è§çš„-XxxAutoConfiguration"><a href="#å¸¸è§çš„-XxxAutoConfiguration" class="headerlink" title="å¸¸è§çš„ XxxAutoConfiguration"></a>å¸¸è§çš„ XxxAutoConfiguration</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1.è¿æ¥æ± </span><br><span class="line">   DataSourceAutoConfiguration ä¼š Import DataSourceConfiguration.Hikari.class</span><br><span class="line">2.Mybatis</span><br><span class="line">   MybatisAutoConfiguration: æ³¨å†Œå¹¶é…ç½®äº† SqlSessionFactory/SqlSessionTemplate</span><br><span class="line">3.Spring MVC</span><br><span class="line">   DispatcherServletAutoConfiguration: é…ç½®å‰ç«¯æ§åˆ¶å™¨å’Œæ–‡ä»¶ä¸Šä¼ å¤„ç†å™¨</span><br><span class="line">   ServletWebServerFactoryAutoConfiguration: æ³¨å†Œ WebServerFactory çš„å®ç°ç±» bean</span><br><span class="line">4.RocketMQ</span><br><span class="line">   RabbitAutoConfiguration: æ³¨å†Œå¹¶é…ç½® RabbitTemplate</span><br><span class="line">5.Redis</span><br><span class="line">   RedisAutoConfiguration: æ³¨å†Œå¹¶é…ç½® RedisTemplate/StringRedisTemplate</span><br><span class="line">6.é‚®ä»¶å‘é€</span><br><span class="line">   MailSenderAutoConfiguration: æ³¨å†Œå¹¶é…ç½® JavaMailSenderImpl</span><br><span class="line">7.MyBatis-Plus</span><br><span class="line">   MybatisPlusAutoConfiguration: æ³¨å†Œ SqlSessionFactory, å¹¶é…ç½®äº†å…¶ plugins, ä½¿ Mybatis-Plus ç”Ÿæ•ˆ</span><br><span class="line">8.å®šæ—¶ä»»åŠ¡</span><br><span class="line">   TaskSchedulingAutoConfiguration: æ³¨å†Œ ThreadPoolTaskScheduler</span><br><span class="line">9.AOP</span><br><span class="line">   AopAutoConfiguration: é€šè¿‡é™æ€å†…éƒ¨ç±»åŠ è½½äº† @EnableAspectJAutoProxy</span><br></pre></td></tr></table></figure>



<h2 id="æˆ‘æ‰€è§åˆ°çš„è®¾è®¡æ¨¡å¼"><a href="#æˆ‘æ‰€è§åˆ°çš„è®¾è®¡æ¨¡å¼" class="headerlink" title="æˆ‘æ‰€è§åˆ°çš„è®¾è®¡æ¨¡å¼"></a>æˆ‘æ‰€è§åˆ°çš„è®¾è®¡æ¨¡å¼</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1.é€‚é…å™¨æ¨¡å¼: SpringConfigurationPropertySources</span><br><span class="line">    è¦å°† Iterable&lt;PropertySource&lt;?&gt;&gt;</span><br><span class="line">    é€‚é…æˆ Iterable&lt;ConfigurationPropertySource&gt;</span><br><span class="line">    ä¹Ÿå³æ˜¯ PropertySource --&gt; ConfigurationPropertySource</span><br><span class="line">  <span class="comment">#å…¶å®ä¸»è¦å·¥ä½œæ˜¯: ConfigurationPropertySource#getConfigurationProperty() é‡Œé¢è°ƒç”¨äº† PropertySource#getProperty(), ä»¥æ­¤å®Œæˆé€‚é…... å¾ˆé€‚é…å™¨æ¨¡å¼, å­˜ä¸€ä¸ªæœªé€‚é…çš„å¯¹è±¡, åœ¨é€‚é…çš„æ–¹æ³•ä¸­è°ƒç”¨å­˜å‚¨çš„å¯¹è±¡çš„è¦é€‚é…çš„æ–¹æ³•. </span></span><br><span class="line">  </span><br><span class="line">2.ç®€å•å·¥å‚æ¨¡å¼: org.springframework.boot.ApplicationContextFactory<span class="comment">#create</span></span><br><span class="line">    æ ¹æ® webApplicationType åˆ›å»ºä¸åŒçš„ ConfigurableApplicationContext</span><br><span class="line">  </span><br><span class="line">3.è§‚å¯Ÿè€…æ¨¡å¼: </span><br><span class="line">	ç›‘å¬è€…: SpringApplicationRunListener</span><br><span class="line">  è§‚å¯Ÿå¯¹è±¡: SpringApplication çš„ç”Ÿå‘½å‘¨æœŸ(starting/environmentPrepared/contextPrepared/contextLoaded/started/running/failed)</span><br><span class="line">  ç®¡ç†è€…: SpringApplicationRunListeners, è´Ÿè´£éå†ç›‘å¬è€…å¹¿æ’­å¯¹åº”äº‹ä»¶</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="gudqs7"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">gudqs7</p>
  <div class="site-description" itemprop="description">å¿ƒç´¯æ²¡é’±èººå°¸ä¸­</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">19</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/gudqs7" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;gudqs7" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:gudqs7@gmail.com" title="E-Mail â†’ mailto:gudqs7@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">gudqs7</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> å¼ºåŠ›é©±åŠ¨
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://gudqs7s-note.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
