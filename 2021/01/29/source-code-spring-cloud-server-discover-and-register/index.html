<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"gudqs7.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Spring Cloud 服务注册与发现源码笔记 (Nacos&#x2F;Consul&#x2F;Eureka)Eureka关键类123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869# 服务注册1.EurekaCl">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Cloud 服务注册与发现源码笔记 (Nacos&#x2F;Consul&#x2F;Eureka)">
<meta property="og:url" content="https://gudqs7.github.io/2021/01/29/source-code-spring-cloud-server-discover-and-register/index.html">
<meta property="og:site_name" content="gudqs7&#39;s note">
<meta property="og:description" content="Spring Cloud 服务注册与发现源码笔记 (Nacos&#x2F;Consul&#x2F;Eureka)Eureka关键类123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869# 服务注册1.EurekaCl">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/gudqs7/many-images/raw/master/Mac-PicGo/20210129172741.png">
<meta property="og:image" content="https://gitee.com/gudqs7/many-images/raw/master/Mac-PicGo/20210129171241.png">
<meta property="og:image" content="https://gitee.com/gudqs7/many-images/raw/master/Mac-PicGo/20210129233856.png">
<meta property="og:image" content="https://gitee.com/gudqs7/many-images/raw/master/Mac-PicGo/20210130001118.png">
<meta property="article:published_time" content="2021-01-29T05:21:23.000Z">
<meta property="article:modified_time" content="2021-03-28T11:49:43.863Z">
<meta property="article:author" content="gudqs7">
<meta property="article:tag" content="service-discover">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/gudqs7/many-images/raw/master/Mac-PicGo/20210129172741.png">

<link rel="canonical" href="https://gudqs7.github.io/2021/01/29/source-code-spring-cloud-server-discover-and-register/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Spring Cloud 服务注册与发现源码笔记 (Nacos/Consul/Eureka) | gudqs7's note</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">gudqs7's note</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">心累没钱躺尸中</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://gudqs7.github.io/2021/01/29/source-code-spring-cloud-server-discover-and-register/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="gudqs7">
      <meta itemprop="description" content="心累没钱躺尸中">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="gudqs7's note">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Spring Cloud 服务注册与发现源码笔记 (Nacos/Consul/Eureka)
        </h1>

        <div class="post-meta">
			
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-29 13:21:23" itemprop="dateCreated datePublished" datetime="2021-01-29T13:21:23+08:00">2021-01-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-03-28 19:49:43" itemprop="dateModified" datetime="2021-03-28T19:49:43+08:00">2021-03-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/source-code/" itemprop="url" rel="index"><span itemprop="name">source-code</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/spring-cloud/" itemprop="url" rel="index"><span itemprop="name">spring-cloud</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2021/01/29/source-code-spring-cloud-server-discover-and-register/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/01/29/source-code-spring-cloud-server-discover-and-register/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Spring-Cloud-服务注册与发现源码笔记-Nacos-Consul-Eureka"><a href="#Spring-Cloud-服务注册与发现源码笔记-Nacos-Consul-Eureka" class="headerlink" title="Spring Cloud 服务注册与发现源码笔记 (Nacos/Consul/Eureka)"></a>Spring Cloud 服务注册与发现源码笔记 (Nacos/Consul/Eureka)</h1><h2 id="Eureka"><a href="#Eureka" class="headerlink" title="Eureka"></a>Eureka</h2><h3 id="关键类"><a href="#关键类" class="headerlink" title="关键类"></a>关键类</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务注册</span></span><br><span class="line">1.EurekaClientAutoConfiguration</span><br><span class="line">	注册了众多的 bean</span><br><span class="line">	一部分用于和 Eureka Server 交互</span><br><span class="line">	一部分和 Commons 项目对接</span><br><span class="line">	注册了(EurekaClient/EurekaAutoServiceRegistration/ApplicationInfoManager/EurekaRegistration)</span><br><span class="line">	   </span><br><span class="line">2.EurekaClient</span><br><span class="line">	与 Eureka Server 端交互</span><br><span class="line">	负责向 Eureka Server 端注册/注销服务实例</span><br><span class="line">	在构造方法和 shutdown 方法中根据配置处理自动注册和自动注销.</span><br><span class="line"></span><br><span class="line">3.InstanceInfoReplicator</span><br><span class="line">	负责定义一个注册或更新服务实例的任务</span><br><span class="line">	负责管理任务执行器</span><br><span class="line"></span><br><span class="line">4.RestTemplateEurekaHttpClient</span><br><span class="line">	负责根据服务实例信息构造注册/注销的 Http 请求</span><br><span class="line">	使用 RestTemplate 发送请求</span><br><span class="line">	</span><br><span class="line">5.EurekaAutoServiceRegistration</span><br><span class="line">	负责管理服务实例的自动注册/注销, 与容器生命周期挂钩</span><br><span class="line"></span><br><span class="line">6.ApplicationInfoManager</span><br><span class="line">	负责管理服务实例状态变更事件(即管理监听者并在适当时机触发他们)</span><br><span class="line"></span><br><span class="line">7.ApplicationInfoManager.StatusChangeListener</span><br><span class="line">	状态改变事件监听者类</span><br><span class="line">	</span><br><span class="line">8.EurekaHealthCheckHandler</span><br><span class="line">	服务实例状态健康检查类, 注册/注销服务实例前会调用此类进行检查其状态</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务发现</span></span><br><span class="line">1.BlockingLoadBalancer (Commons 项目上)</span><br><span class="line">	负责调用实际的负载均衡器去选择一个服务实例</span><br><span class="line">	负责调度负载均衡整个过程, 触发相应的生命周期.</span><br><span class="line">	</span><br><span class="line">2.RoundRobinLoadBalancer (Commons 项目上)</span><br><span class="line">	实际的负载均衡策略算法类</span><br><span class="line">	负责连接 ServiceInstanceListSupplier 从其中获取服务实例列表</span><br><span class="line"></span><br><span class="line">3.ServiceInstanceListSupplier</span><br><span class="line">	定义了获取服务实例实例列表的接口(任意方式)</span><br><span class="line"></span><br><span class="line">4.DiscoveryClient</span><br><span class="line">	定义了从服务端获取服务实例列表的接口(更明确了)</span><br><span class="line"></span><br><span class="line">4.DiscoveryClientServiceInstanceListSupplier</span><br><span class="line">	ServiceInstanceListSupplier 的实现类</span><br><span class="line">	连接 ReactiveDiscoveryClient 类, 将服务端获取道德服务实例列表返回出去</span><br><span class="line">	</span><br><span class="line">5.EurekaDiscoveryClient</span><br><span class="line">	实现了 DiscoveryClient 接口</span><br><span class="line">	负责调用 EurekaClient 从 Eureka Server 端获取服务实例列表.</span><br><span class="line"></span><br><span class="line">6.EurekaClient</span><br><span class="line">	与 Eureka Server 端交互</span><br><span class="line">	负责向 Eureka Server 端获取服务实例列表</span><br><span class="line">	在构造方法和 shutdown 方法中根据配置处理自动注册和自动注销.</span><br><span class="line"></span><br><span class="line">7.EurekaServiceInstance</span><br><span class="line">	服务实例信息对象</span><br><span class="line">	实现 ServiceInstance, 与 Commons 对接</span><br><span class="line"></span><br><span class="line"><span class="comment"># 总结</span></span><br><span class="line">实现了 Commons 的 DiscoveryClient 接口(即 EurekaDiscoveryClient), 于是服务发现实现了;</span><br><span class="line">实现了 Commons 的 ServiceRegisty 接口(即 EurekaServiceRegistry), 于是服务注册也实现了.</span><br><span class="line">再总结: Commons 大发好.</span><br></pre></td></tr></table></figure>





<h3 id="服务注册流程"><a href="#服务注册流程" class="headerlink" title="服务注册流程"></a>服务注册流程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EurekaClient 构造方法触发(前提 shouldRegisterWithEureka 为 true)</span></span><br><span class="line">1.EurekaClientAutoConfiguration 让容器里注册了一个 EurekaClient</span><br><span class="line">2.EurekaClient 这个类在构造方法中的 initScheduledTasks() 生成了一个 InstanceInfoReplicator 对象</span><br><span class="line">3.然后调用其 instanceInfoReplicator.start(), 逻辑是添加一个定时任务(仅执行一次), 定时任务执行 run()</span><br><span class="line">4.run() 里面会执行 discoveryClient.register() 也就是注册实例信息到 Eureka 上去.</span><br><span class="line">5.register() 里面会调用 RestTemplateEurekaHttpClient<span class="comment">#register() </span></span><br><span class="line">6.这个方法是构造一个 HTTP 请求, 地址为 serviceUrl + <span class="string">"apps/"</span> + info.getAppName(), Method 为 POST, 即 Eureka server 的ip/apps/服务实例名称(如spring.application.name), 当然请求 body 还会带上实例信息 info 对象.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据容器生命周期触发</span></span><br><span class="line">1.EurekaClientAutoConfiguration 让容器里注册了一个 EurekaAutoServiceRegistration.</span><br><span class="line">2.这个类即是 SmartLifecycle(与容器生命周期绑定), 也是 SmartApplicationListener(监听容器加载/关闭事件)</span><br><span class="line">3.因此其对应的 start()/stop() 和 onApplicationEvent() 都实现了对应的逻辑.</span><br><span class="line">4.如 start() 的逻辑为调用 EurekaServiceRegistry<span class="comment">#register()</span></span><br><span class="line">5.register() 先修改本地服务实例的装填, 再通过 com.netflix.discovery.DiscoveryClient<span class="comment">#registerHealthCheck() 来往任务管理器中提交一个任务, 后台执行, 任务 InstanceInfoReplicator#onDemandUpdate()</span></span><br><span class="line">6.此任务就是最终也会调用前面提到的 (4) 中的 run(). 然后就注册上去了.</span><br><span class="line"></span><br><span class="line"><span class="comment"># PS</span></span><br><span class="line">(6) 中的任务, 与状态监听是一致的</span><br></pre></td></tr></table></figure>

<blockquote>
<p>总结: 容器注册 EurekaClient, 调用构造方法完成大量初始化工作后, 另起一个线程调用 restTemplate 发送 HTTP 请求将当前服务实例信息发送给 Eureka server. 完成服务注册工作.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line"></span><br><span class="line">A(EurekaClientAutoConfiguration)</span><br><span class="line">A1(EurekaClient)</span><br><span class="line">A2(InstanceInfoReplicator)</span><br><span class="line">A3(EurekaClient#register)</span><br><span class="line">A4(RestTemplateEurekaHttpClient)</span><br><span class="line">A5(RestTemplate)</span><br><span class="line">A6(Eureka Server)</span><br><span class="line">A7(EurekaHttpResponse)</span><br><span class="line"></span><br><span class="line">A--让容器里注册一个--&gt;A1</span><br><span class="line">A1--在构造方法中生成一个--&gt;A2</span><br><span class="line">A2--在 run 方法中调用--&gt;A3</span><br><span class="line">A3--又把服务实例信息交给--&gt;A4</span><br><span class="line">A4--根据服务实例信息构造HTTP请求--&gt;A5</span><br><span class="line">A5--将服务实例信息发送给--&gt;A6</span><br><span class="line">A6--返回一个--&gt;A7</span><br></pre></td></tr></table></figure>



<p><img src="https://gitee.com/gudqs7/many-images/raw/master/Mac-PicGo/20210129172741.png" alt="image-20210129171345329"></p>
<h3 id="服务注销流程"><a href="#服务注销流程" class="headerlink" title="服务注销流程"></a>服务注销流程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 容器关闭(配置了容器 shouldUnregisterOnShutdown=true)</span></span><br><span class="line">1.在 DiscoveryClient<span class="comment">#shutdown() 中根据 shouldUnregisterOnShutdown 判断是否需要注销</span></span><br><span class="line">2.然后在 unregister() 中调用 RestTemplateEurekaHttpClient<span class="comment">#cancel() </span></span><br><span class="line">3.cancel() 中使用 restTemplate 构造 Method 为 DELETE, URL 为 serviceUrl + <span class="string">"apps/"</span> + appName + <span class="string">'/'</span> + id 的请求并发送给 Eureka server 告知其注销 appName 下对应的服务实例(根据 id).</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接收到容器关闭事件</span></span><br><span class="line">1.EurekaClientAutoConfiguration 让容器里注册了一个 EurekaAutoServiceRegistration.</span><br><span class="line">2.这个类即是 SmartLifecycle(与容器生命周期绑定), 也是 SmartApplicationListener(监听容器加载/关闭事件)</span><br><span class="line">3.因此其对应的 start()/stop() 和 onApplicationEvent() 都实现了对应的逻辑.</span><br><span class="line">4.如 stop() 的逻辑为调用 EurekaServiceRegistry<span class="comment">#deregister()</span></span><br><span class="line">5.deregister() 的作用是执行 ApplicationInfoManager<span class="comment">#setInstanceStatus() 将状态改为 DOWN</span></span><br><span class="line">6.因为 ApplicationInfoManager 这个类专门管理状态变化事件, 因此还会将事件发布出去. </span><br><span class="line">7.而在 initScheduledTasks 中就添加了这样的一个监听者, 起作用为调用 InstanceInfoReplicator<span class="comment">#onDemandUpdate()</span></span><br><span class="line">8.接着会调用 InstanceInfoReplicator<span class="comment">#run(), 第一行代码 refreshInstanceInfo() 会确保状态为最新的(那也还是 DOWN)</span></span><br><span class="line">9.但是其最终并不是调用 cancel 注销, 而 register 注册, 不过其中的状态是 DOWN, 因此会有 server 那边判断; 所以容器关闭事件并不会触发 cancel, 但效果应是一样的.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>总结: 要么是 shutdown() 中 unregister 调用了 cancel(), 发出了 Method 为 DELETE 的请求来注销; 要么就是 EurekaClientAutoConfiguration 中与容器生命周期做关联, 全程使用 register 接口来更新状态.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line"></span><br><span class="line">A(容器关闭#close)</span><br><span class="line">A1(DiscoveryClient#shutdown)</span><br><span class="line">A2(DiscoveryClient#unregister)</span><br><span class="line">A3(RestTemplateEurekaHttpClient#cancel)</span><br><span class="line">A4(RestTemplate)</span><br><span class="line">A5(Eureka Server) </span><br><span class="line"></span><br><span class="line">A--触发--&gt;A1</span><br><span class="line">A1--调用--&gt;A2</span><br><span class="line">A2--调用--&gt;A3</span><br><span class="line">A3--构造HTTP请求交给--&gt;A4</span><br><span class="line">A4--发送注销申请给--&gt;A5</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/gudqs7/many-images/raw/master/Mac-PicGo/20210129171241.png" alt="image-20210129171237603"></p>
<h3 id="服务发现流程"><a href="#服务发现流程" class="headerlink" title="服务发现流程"></a>服务发现流程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.Spring Cloud Commons 中注册了一个 ServiceInstanceListSupplier, 具体为(DiscoveryClientServiceInstanceListSupplier)</span><br><span class="line">2.这个类的作用是借助 ReactiveDiscoveryClient 的 getInstances(String serviceId) 方法向 LoadBalancer 提供从具体的 server(如Eureka) 获取服务实例对象列表, 这样只要实现 ReactiveDiscoveryClient 并放入容器就可以和 Spring cloud LoadBalancer 对接了.</span><br><span class="line">3.在 EurekaDiscoveryClientConfiguration 中让容器注册了一个 DiscoveryClient(具体为 EurekaDiscoveryClient).</span><br><span class="line">4.因为 Spring Cloud Commons 做了大量的预备对接工作, 所以对接其实就结束了.</span><br><span class="line">5.那再简单说下 EurekaDiscoveryClient 的实现, 即注入一个 EurekaClient eurekaClient, 然后调用 DiscoveryClient<span class="comment">#getInstancesByVipAddress() 就获取到了 ServiceInstance 列表.</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>总结: Commons 中准备好了对接的方式: 实现 DiscoveryClient 接口, 接着我们的确实现了 DiscoveryClient 接口, 即 EurekaDiscoveryClient, 而这这个类则会调用 EurekaClient 的 getInstancesByVipAddress 从 Eureka Server 端获取注册了的服务实例信息.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line"></span><br><span class="line">A1(BlockingLoadBalancerClient#位于Commons项目)</span><br><span class="line">A2(RoundRobinLoadBalancer#位于Commons项目)</span><br><span class="line">A4(LoadBalancerClientConfiguration#位于Commons项目)</span><br><span class="line">A5(DiscoveryClientServiceInstanceListSupplier)</span><br><span class="line">A6(EurekaDiscoveryClient#getInstances)</span><br><span class="line">A7(EurekaClient#getInstancesByVipAddress)</span><br><span class="line">A9(Eureka Server)</span><br><span class="line">A8(ServiceInstance 集合)</span><br><span class="line"></span><br><span class="line">A1--choose 方法调用--&gt;A2</span><br><span class="line">A2--choose 方法调用--&gt;A5</span><br><span class="line">A4--注入一个--&gt;A5</span><br><span class="line">A5--调用--&gt;A6</span><br><span class="line">A6--调用--&gt;A7</span><br><span class="line">A7--从--&gt;A9</span><br><span class="line">A9--获取--&gt;A8</span><br><span class="line">A10(EurekaDiscoveryClientConfiguration)--注入一个--&gt;A6</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/gudqs7/many-images/raw/master/Mac-PicGo/20210129233856.png" alt="image-20210129233854498"></p>
<h2 id="Consul"><a href="#Consul" class="headerlink" title="Consul"></a>Consul</h2><h3 id="关键类-1"><a href="#关键类-1" class="headerlink" title="关键类"></a>关键类</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务注册</span></span><br><span class="line">1.ConsulAutoServiceRegistrationAutoConfiguration</span><br><span class="line">	负责添加自动注册/注销相关的 bean</span><br><span class="line">	注册了 ConsulAutoServiceRegistration/ConsulAutoServiceRegistrationListener/ConsulAutoRegistration</span><br><span class="line">	</span><br><span class="line">2.ConsulServiceRegistryAutoConfiguration</span><br><span class="line">	负责注册服务注册相关的 bean</span><br><span class="line">	注册了 ConsulServiceRegistry</span><br><span class="line">	</span><br><span class="line">3.ConsulDiscoveryClientConfiguration</span><br><span class="line">	负责注册服务发现相关的 bean</span><br><span class="line">	注册了 ConsulDiscoveryClient</span><br><span class="line">	</span><br><span class="line">4.ConsulServiceRegistry</span><br><span class="line">	负责与 ConsulClient 对接, 再提供注册/注销功能</span><br><span class="line"></span><br><span class="line">5.ConsulClient</span><br><span class="line">	与 Consul Server 端交互</span><br><span class="line">	负责向 Consul Server 端注册/注销服务实例</span><br><span class="line"></span><br><span class="line">6.AgentConsulClient</span><br><span class="line">	负责根据服务实例信息构造注册/注销的 Http 请求</span><br><span class="line">	</span><br><span class="line">7.ConsulAutoServiceRegistration/ConsulAutoServiceRegistrationListener</span><br><span class="line">	负责管理服务实例的自动注册/注销, 与容器生命周期挂钩</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务发现</span></span><br><span class="line">1.BlockingLoadBalancer (Commons 项目上)</span><br><span class="line">	负责调用实际的负载均衡器去选择一个服务实例</span><br><span class="line">	负责调度负载均衡整个过程, 触发相应的生命周期.</span><br><span class="line">	</span><br><span class="line">2.RoundRobinLoadBalancer (Commons 项目上)</span><br><span class="line">	实际的负载均衡策略算法类</span><br><span class="line">	负责连接 ServiceInstanceListSupplier 从其中获取服务实例列表</span><br><span class="line"></span><br><span class="line">3.ServiceInstanceListSupplier</span><br><span class="line">	定义了获取服务实例实例列表的接口(任意方式)</span><br><span class="line"></span><br><span class="line">4.DiscoveryClient</span><br><span class="line">	定义了从服务端获取服务实例列表的接口(更明确了)</span><br><span class="line"></span><br><span class="line">4.DiscoveryClientServiceInstanceListSupplier</span><br><span class="line">	ServiceInstanceListSupplier 的实现类</span><br><span class="line">	连接 ReactiveDiscoveryClient 类, 将服务端获取道德服务实例列表返回出去</span><br><span class="line">	</span><br><span class="line">5.ConsulDiscoveryClient</span><br><span class="line">	实现了 DiscoveryClient 接口</span><br><span class="line">	负责调用 ConsulClient 从 Consul Server 端获取服务实例列表.</span><br><span class="line"></span><br><span class="line">6.ConsulClient</span><br><span class="line">	与 Consul Server 端交互</span><br><span class="line">	负责向 Consul Server 端获取服务实例列表</span><br><span class="line"></span><br><span class="line">7.ConsulServiceInstance</span><br><span class="line">	服务实例信息对象</span><br><span class="line">	实现 ServiceInstance, 与 Commons 对接</span><br><span class="line"></span><br><span class="line"><span class="comment"># 总结</span></span><br><span class="line">实现了 Commons 的 DiscoveryClient 接口(即 ConsulDiscoveryClient), 于是服务发现实现了;</span><br><span class="line">实现了 Commons 的 ServiceRegisty 接口(即 ConsulServiceRegistry), 于是服务注册也实现了.</span><br><span class="line">再总结: Commons 大发好.</span><br></pre></td></tr></table></figure>

<h3 id="服务注册流程-1"><a href="#服务注册流程-1" class="headerlink" title="服务注册流程"></a>服务注册流程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.ConsulAutoServiceRegistration 调用 org.springframework.cloud.consul.serviceregistry.ConsulServiceRegistry<span class="comment">#register() 完成注册</span></span><br><span class="line">2.接着 register() 调用 ConsulClient<span class="comment">#agentServiceRegister()</span></span><br><span class="line">3.然后会调用 AgentConsulClient<span class="comment">#agentServiceRegister()</span></span><br><span class="line">4.生成并发送请求, 请求地址为 /v1/agent/service/register</span><br></pre></td></tr></table></figure>

<blockquote>
<p>总结: 其实和 Eureka 差不多, 只是我跳过了一点点细节. 基本是就是 与 ServiceRegistry 交互了, 非常的配合 Commons 项目, 就像一个人写的一样…</p>
</blockquote>
<h3 id="服务发现流程-1"><a href="#服务发现流程-1" class="headerlink" title="服务发现流程"></a>服务发现流程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.首先是 DiscoveryClientServiceInstanceListSupplier 会调用 ConsulDiscoveryClient<span class="comment">#getInstances()</span></span><br><span class="line">2.接着 getInstances() 会调用 ConsulClient<span class="comment">#getHealthServices()</span></span><br><span class="line">3.然后就是发送 HTTP 请求了, 请求地址为 /v1/health/service/, 返回的对象封装处理下得到 ServiceInstance 的实现类 ConsulServiceInstance.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>总结: 这次真的是和 Eureka 类似, 从 Commons 到 ConsulDiscoveryClient, 流程是一样的. 而其实 ConsulDiscoveryClient 的逻辑也和 EurekaDiscoverClient 类似… 只能说其实服务注册发现这个框架, 我们关注的功能其实并不是难点. 难点是 server 端的管理.</p>
</blockquote>
<h2 id="Nacos"><a href="#Nacos" class="headerlink" title="Nacos"></a>Nacos</h2><h3 id="关键类-2"><a href="#关键类-2" class="headerlink" title="关键类"></a>关键类</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务注册</span></span><br><span class="line">1.NacosServiceRegistryAutoConfiguration</span><br><span class="line">	负责添加自动注册/注销相关的 bean</span><br><span class="line">	注册了 NacosAutoServiceRegistration/NacosServiceRegistry/NacosRegistration</span><br><span class="line">	</span><br><span class="line">2.NacosDiscoveryClientConfiguration</span><br><span class="line">	负责注册服务发现相关的 bean</span><br><span class="line">	注册了 NacosDiscoveryClient</span><br><span class="line">	</span><br><span class="line">3.NacosServiceRegistry</span><br><span class="line">	负责与 NamingService 对接, 再提供注册/注销功能</span><br><span class="line"></span><br><span class="line">4.NamingService</span><br><span class="line">	与 Nacos Server 端交互</span><br><span class="line">	负责向 Nacos Server 端注册/注销服务实例</span><br><span class="line">	调用 NamingProxy</span><br><span class="line"></span><br><span class="line">5.NamingProxy</span><br><span class="line">	负责根据服务实例信息构造注册/注销的 Http 请求</span><br><span class="line">	</span><br><span class="line">6.NacosAutoServiceRegistration</span><br><span class="line">	负责管理服务实例的自动注册/注销, 与容器生命周期挂钩</span><br><span class="line"></span><br><span class="line">7.NacosRegistration</span><br><span class="line">	本地实例对象, 相比服务实例数据更多</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务发现</span></span><br><span class="line">1.BlockingLoadBalancer (Commons 项目上)</span><br><span class="line">	负责调用实际的负载均衡器去选择一个服务实例</span><br><span class="line">	负责调度负载均衡整个过程, 触发相应的生命周期.</span><br><span class="line">	</span><br><span class="line">2.RoundRobinLoadBalancer (Commons 项目上)</span><br><span class="line">	实际的负载均衡策略算法类</span><br><span class="line">	负责连接 ServiceInstanceListSupplier 从其中获取服务实例列表</span><br><span class="line"></span><br><span class="line">3.ServiceInstanceListSupplier</span><br><span class="line">	定义了获取服务实例实例列表的接口(任意方式)</span><br><span class="line"></span><br><span class="line">4.DiscoveryClient</span><br><span class="line">	定义了从服务端获取服务实例列表的接口(更明确了)</span><br><span class="line"></span><br><span class="line">4.DiscoveryClientServiceInstanceListSupplier</span><br><span class="line">	ServiceInstanceListSupplier 的实现类</span><br><span class="line">	连接 ReactiveDiscoveryClient 类, 将服务端获取道德服务实例列表返回出去</span><br><span class="line">	</span><br><span class="line">5.NacosDiscoveryClient</span><br><span class="line">	实现了 DiscoveryClient 接口</span><br><span class="line">	负责调用 NamingService 从 Nacos Server 端获取服务实例列表.</span><br><span class="line"></span><br><span class="line">6.NamingService</span><br><span class="line">	与 Nacos Server 端交互</span><br><span class="line">	负责向 Nacos Server 端获取服务实例列表</span><br><span class="line"></span><br><span class="line">7.NacosServiceInstance</span><br><span class="line">	服务实例信息对象</span><br><span class="line">	实现 ServiceInstance, 与 Commons 对接</span><br><span class="line"></span><br><span class="line"><span class="comment"># 总结</span></span><br><span class="line">实现了 Commons 的 DiscoveryClient 接口(即 NacosDiscoveryClient), 于是服务发现实现了;</span><br><span class="line">实现了 Commons 的 ServiceRegisty 接口(即 ConsulServiceRegistry), 于是服务注册也实现了.</span><br><span class="line">再总结: Commons 大发好.</span><br></pre></td></tr></table></figure>



<h3 id="服务注册流程-2"><a href="#服务注册流程-2" class="headerlink" title="服务注册流程"></a>服务注册流程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.NacosAutoServiceRegistration 调用 NacosServiceRegistry<span class="comment">#register 完成注册</span></span><br><span class="line">2.接着 register() 调用 NacosNamingService<span class="comment">#registerInstance()</span></span><br><span class="line">3.然后会调用 NamingProxy<span class="comment">#registerService()</span></span><br><span class="line">4.生成并发送请求, 请求地址为 /nacos/v1/ns/instance</span><br></pre></td></tr></table></figure>

<blockquote>
<p>总结: 这和 Consul 差不多; 还是继承 AbstractAutoServiceRegistration 来与 ServiceRegistry 交互了, 也是非常的配合 Commons 项目啊!!</p>
</blockquote>
<h3 id="服务发现流程-2"><a href="#服务发现流程-2" class="headerlink" title="服务发现流程"></a>服务发现流程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.首先是 DiscoveryClientServiceInstanceListSupplier 会调用 NacosDiscoveryClient<span class="comment">#getInstances()</span></span><br><span class="line">2.接着 getInstances() 会调用 NacosServiceDiscovery<span class="comment">#getInstances()</span></span><br><span class="line">3.然后就是发送 HTTP 请求了, 请求地址为 /nacos/v1/ns/instance/list, 返回的对象封装处理下得到 ServiceInstance 的实现类 NacosServiceInstance.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>总结: 依然是和 Eureka/Consul 类似, 从 Commons 到 NacosDiscoveryClient, 流程是一样的. 而其实 NacosDiscoveryClient 的逻辑也和 ConsulDiscoveryClient/EurekaDiscoverClient 类似, 最终总是发起 HTTP 查询 server 端, 所以 server 端的代码才比较有趣啊.</p>
</blockquote>
<h2 id="Nacos-Config"><a href="#Nacos-Config" class="headerlink" title="Nacos Config"></a>Nacos Config</h2><h3 id="Nacos-Config-Client-加载-nacos-server-配置原理"><a href="#Nacos-Config-Client-加载-nacos-server-配置原理" class="headerlink" title="Nacos Config Client 加载 nacos server 配置原理"></a>Nacos Config Client 加载 nacos server 配置原理</h3><h4 id="关键类-3"><a href="#关键类-3" class="headerlink" title="关键类"></a>关键类</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1.NacosConfigBootstrapConfiguration</span><br><span class="line">	注册了一个 NacosPropertySourceLocator</span><br><span class="line"></span><br><span class="line">2.NacosPropertySourceLocator</span><br><span class="line">	用于从 nacos server 上加载 dataId 对应的配置文件到 environment 的 PropertySource 集合中.</span><br><span class="line">	</span><br><span class="line">3.ConfigService</span><br><span class="line">	用于与 nacos server 通信, 获取配置文件, 乃至订阅更新</span><br><span class="line">	</span><br><span class="line">4.NacosPropertySourceBuilder</span><br><span class="line">	借助 ConfigService 与 NacosDataParserHandler 从 nacos 获取 NacosPropertySource</span><br><span class="line">	</span><br><span class="line">5.NacosDataParserHandler</span><br><span class="line">	用于序列化(转码)服务端的配置文件数据为一个 PropertySource(即 NacosPropertySource)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自动刷新</span></span><br><span class="line">1.NacosConfigAutoConfiguration</span><br><span class="line">2.NacosContextRefresher</span><br></pre></td></tr></table></figure>

<blockquote>
<p>总结: ConfigService 与 NacosDataParserHandler 是两个干事的, 其他都是渣渣!!!</p>
</blockquote>
<h4 id="从-server-获取配置流程"><a href="#从-server-获取配置流程" class="headerlink" title="从 server 获取配置流程"></a>从 server 获取配置流程</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1.在 NacosConfigBootstrapConfiguration 中注册了一个 PropertySourceLocator(即 NacosPropertySourceLocator), 可用于为 environment 添加 PropertySource</span><br><span class="line">2.然后实现 locate 方法, 即 NacosPropertySourceLocator<span class="comment">#locate()</span></span><br><span class="line">3.在 locate() 的最后面, 调用了 loadApplicationConfiguration()</span><br><span class="line">4.这个方法通过多次调用 loadNacosDataIfPresent() 加载 dataId 和不同文件后缀以及profile 组和得到不同的 dataId.</span><br><span class="line">5.loadNacosDataIfPresent() 调用了 loadNacosPropertySource()</span><br><span class="line">6.其最终调用了 NacosPropertySourceBuilder<span class="comment">#loadNacosData()</span></span><br><span class="line">7.loadNacosData() 调用 ConfigService<span class="comment">#getConfig() </span></span><br><span class="line">8.getConfig() 会使用 ClientWorker<span class="comment">#getServerConfig() 发起 HTTP 请求从 nacos server 获取配置文件. 其请求地址是 /v1/cs/configs</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p> 还是挺简单的, 发个 HTTP 获取配置文件, 然后转化成一个 PropertySource, 再在 NacosPropertySourceLocator 的 locate 中扔进 environment 中去. Bingo!!!</p>
</blockquote>
<h4 id="从-server-实时更新原理"><a href="#从-server-实时更新原理" class="headerlink" title="从 server 实时更新原理"></a>从 server 实时更新原理</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1.在 NacosConfigAutoConfiguration 注册了一个 NacosContextRefresher</span><br><span class="line">2.其实现了 ApplicationListener&lt;ApplicationReadyEvent&gt;, 也就是会在容器准备事件触发后调用 NacosContextRefresher<span class="comment">#registerNacosListenersForApplications()</span></span><br><span class="line">3.在进行两个配置判断后(即 isRefreshEnabled() 和 PropertySource 的 isRefreshable), 调用 NacosContextRefresher<span class="comment">#registerNacosListener() </span></span><br><span class="line">4.这个方法通过 NacosConfigService<span class="comment">#addListener() 注册一个 AbstractSharedListener 监听者到 cacheData.</span></span><br><span class="line">5.而 ClientWorker<span class="comment">#checkConfigInfo() 中添加的 LongPollingRunnable 任务, 会在 run() 中执行 getServerConfig() 获取服务配置文件, 然后与当前缓存对比 md5, 若更新则通过 cacheData 取出刚刚添加的 listener, 触发事件(即 receiveConfigInfo() )</span></span><br><span class="line">6.触发后又会再发布一个 RefreshEvent 事件</span><br><span class="line">7.接着流转到 RefreshEventListener.onApplicationEvent()</span><br><span class="line">8.然后又会调用 ContextRefresher.refresh(), 这个方法中的 refreshEnvironment() 会调用 addConfigFilesToEnvironment(), 这方法先复制一个 StandardEnvironment, 将其放入到 SpringApplication 中, 再调用 SpringApplication 的 run() 走一遍, 会触发 NacosPropertySourceLocator.locate(), 于是复制的 environment 里面有新数据了, 再将其拷贝替换到当前的 environment. 完成 environment 的刷新. </span><br><span class="line">9.接着发布一个 EnvironmentChangeEvent 事件, 用来刷新 @ConfigurationProperties 注解的 Bean. (这么喜欢事件?不愧是写出 RocketMQ 的阿里啊!!!)</span><br><span class="line">10.接着在 ConfigurationPropertiesRebinder 中接收到这个事件, 触发 onApplicationEvent()</span><br><span class="line">11.然后会执行 ConfigurationPropertiesRebinder<span class="comment">#rebind()</span></span><br><span class="line">12.其逻辑是将 postProcessBeforeInitialization 中存起来的 ConfigurationPropertiesBean 类型的 map 遍历, 进行重新绑定(即 destroyBean 后再 initializeBean, 则会从新配置重新赋值).</span><br></pre></td></tr></table></figure>

<blockquote>
<p>总结: 有的地方(NacosContextRefresher)监听容器初始化添加配置更新的监听者, 自己不干活只发布配置刷新事件;</p>
<p>有的地方(ClientWorker)添加轮询任务获取服务端配置文件与本地 cacheData 对比 md5 来判断是否触发配置更新的监听者;</p>
<p>然后有的地方(RefreshEventListener)监听配置刷新事件然后用 SpringApplication.run() 通过触发 NacosPropertySourceLocator#locate() 为一个复制出来的 environment 对象添加从服务端获取最新配置, 再拷贝到当前的 environment 对象, 完成 environment 配置的刷新, 之后发布 environment 刷新事件;</p>
<p>有的地方(ConfigurationPropertiesRebinder)监听 environment 刷新事件, 然后为 @ConfigurationProperties 注解生成的 bean 重新绑定配置.</p>
<p>再总结: 挺好的, 奥运火炬手啊这是, 不停传递!!!!!</p>
</blockquote>
<h4 id="关键类-4"><a href="#关键类-4" class="headerlink" title="关键类"></a>关键类</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">1.NacosConfigAutoConfiguration</span><br><span class="line">	注册一个监听容器初始化事件的 bean (NacosContextRefresher)</span><br><span class="line"></span><br><span class="line">2.NacosContextRefresher</span><br><span class="line">	再初始化事件触发后添加一个 AbstractSharedListener 监听者到 cacheData</span><br><span class="line"></span><br><span class="line">3.AbstractSharedListener</span><br><span class="line">	当服务端配置与本地不同后触发</span><br><span class="line">	触发后发布 RefreshEvent 事件</span><br><span class="line"></span><br><span class="line">4.CacheData</span><br><span class="line">	管理配置更新事件监听者</span><br><span class="line">	对比服务端配置与本地配置的 md5</span><br><span class="line">	md5 不同则触发 AbstractSharedListener</span><br><span class="line">	</span><br><span class="line">5.RefreshEvent</span><br><span class="line">	通过容器发布</span><br><span class="line">	当服务端配置发送更新触发</span><br><span class="line">	触发后调用 ContextRefresher<span class="comment">#refresh()</span></span><br><span class="line">	</span><br><span class="line">6.LongPollingRunnable</span><br><span class="line">	轮询任务, 获取服务端最新配置, 与 cacheData 对比</span><br><span class="line"></span><br><span class="line">7.ClientWorker</span><br><span class="line">	管理轮询任务(LongPollingRunnable)</span><br><span class="line">	负责与 nacos 服务端通信</span><br><span class="line">	</span><br><span class="line">8.ContextRefresher</span><br><span class="line">	监听 RefreshEvent 事件</span><br><span class="line">	负责获取服务端最新配置到 environment 对象中</span><br><span class="line">	发布 EnvironmentChangeEvent 事件</span><br><span class="line">	</span><br><span class="line">9.EnvironmentChangeEvent</span><br><span class="line">	通过容器发布</span><br><span class="line">	当 environment 对象更新后触发</span><br><span class="line">	触发后调用 ConfigurationPropertiesRebinder<span class="comment">#rebind()</span></span><br><span class="line">	</span><br><span class="line">10.ConfigurationPropertiesRebinder</span><br><span class="line">	监听 EnvironmentChangeEvent 事件</span><br><span class="line">	负责重新绑定用了 @ConfigurationProperties 注解的 Bean 的值</span><br></pre></td></tr></table></figure>





<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line"></span><br><span class="line">A1(NacosConfigAutoConfiguration)</span><br><span class="line">A2(NacosContextRefresher)</span><br><span class="line">A3(ApplicationReadyEvent)</span><br><span class="line">A4(NacosContextRefresher#registerNacosListener)</span><br><span class="line">A5(NacosConfigService#addListener)</span><br><span class="line"> </span><br><span class="line">A7(ClientWorker)</span><br><span class="line">A8(LongPollingRunnable#轮询任务)</span><br><span class="line">A9(NacosConfigService#getServerConfig)</span><br><span class="line">B1(AbstractSharedListener#配置更新事件的监听者)</span><br><span class="line">B2(cacheData)</span><br><span class="line">B3(RefreshEvent)</span><br><span class="line">B4(RefreshEventListener)</span><br><span class="line">B5(ContextRefresher#refresh)</span><br><span class="line">B6(ContextRefresher#refreshEnvironment)</span><br><span class="line">B7(ContextRefresher#addConfigFilesToEnvironment)</span><br><span class="line">B8(SpringApplication#run)</span><br><span class="line">B9(StandardEnvironment)</span><br><span class="line">C1(NacosPropertySourceLocator#locate)</span><br><span class="line">C2(当前容器的 environment 对象)</span><br><span class="line">C3(EnvironmentChangeEvent)</span><br><span class="line">C4(ConfigurationPropertiesRebinder#onApplicationEvent)</span><br><span class="line">C5(ConfigurationPropertiesRebinder#rebind)</span><br><span class="line">C6(用了 ConfigurationProperties 注解 Bean)</span><br><span class="line"></span><br><span class="line">A1--注册了一个--&gt;A2</span><br><span class="line">A2--监听了--&gt;A3</span><br><span class="line">A3--事件触发后调用--&gt;A4</span><br><span class="line">A4--通过--&gt;A5</span><br><span class="line">A5--注册了一个--&gt;B1</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">A7--构造方法中创建了一个--&gt;A8</span><br><span class="line">A8--run 方法中调用--&gt;A9</span><br><span class="line">A9--获取最新配置与--&gt;B2</span><br><span class="line"></span><br><span class="line">B2--比较 md5, 不同则触发--&gt;B1</span><br><span class="line">B1--事件触发后发布--&gt;B3</span><br><span class="line">B4--监听了--&gt;B3</span><br><span class="line">B3--事件触发后调用--&gt;B5</span><br><span class="line">B5--调用--&gt;B6</span><br><span class="line">B6--调用--&gt;B7</span><br><span class="line">B7--利用--&gt;B8</span><br><span class="line">B7--复制当前容器 environment 对象到--&gt;B9</span><br><span class="line">B8--触发--&gt;C1</span><br><span class="line">C1--获取了最新配置到--&gt;B9</span><br><span class="line">B9--复制最新配置回到--&gt;C2</span><br><span class="line"></span><br><span class="line">C2--更新完配置后发布--&gt;C3</span><br><span class="line">G1(ConfigurationPropertiesRebinder)--监听了--&gt;C3</span><br><span class="line">C3--事件触发后调用--&gt;C4</span><br><span class="line">C4--调用--&gt;C5</span><br><span class="line">C5--获取新配置绑定到--&gt;C6</span><br></pre></td></tr></table></figure>





<p><img src="https://gitee.com/gudqs7/many-images/raw/master/Mac-PicGo/20210130001118.png" alt=""></p>

    </div>

    
    
    
        <div class="reward-container">
  <div>下次一定</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.png" alt="gudqs7 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/bitcoin.png" alt="gudqs7 比特币">
        <p>比特币</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/service-discover/" rel="tag"># service-discover</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/01/28/source-code-spring-cloud-openfeign/" rel="prev" title="Spring Cloud Openfeign 源码笔记">
      <i class="fa fa-chevron-left"></i> Spring Cloud Openfeign 源码笔记
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/01/30/source-code-spring-cloud-alibaba-sentinel/" rel="next" title="Spring Cloud Alibaba Sentinel 源码笔记">
      Spring Cloud Alibaba Sentinel 源码笔记 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-Cloud-服务注册与发现源码笔记-Nacos-Consul-Eureka"><span class="nav-number">1.</span> <span class="nav-text">Spring Cloud 服务注册与发现源码笔记 (Nacos&#x2F;Consul&#x2F;Eureka)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Eureka"><span class="nav-number">1.1.</span> <span class="nav-text">Eureka</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#关键类"><span class="nav-number">1.1.1.</span> <span class="nav-text">关键类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务注册流程"><span class="nav-number">1.1.2.</span> <span class="nav-text">服务注册流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务注销流程"><span class="nav-number">1.1.3.</span> <span class="nav-text">服务注销流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务发现流程"><span class="nav-number">1.1.4.</span> <span class="nav-text">服务发现流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Consul"><span class="nav-number">1.2.</span> <span class="nav-text">Consul</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#关键类-1"><span class="nav-number">1.2.1.</span> <span class="nav-text">关键类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务注册流程-1"><span class="nav-number">1.2.2.</span> <span class="nav-text">服务注册流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务发现流程-1"><span class="nav-number">1.2.3.</span> <span class="nav-text">服务发现流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nacos"><span class="nav-number">1.3.</span> <span class="nav-text">Nacos</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#关键类-2"><span class="nav-number">1.3.1.</span> <span class="nav-text">关键类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务注册流程-2"><span class="nav-number">1.3.2.</span> <span class="nav-text">服务注册流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务发现流程-2"><span class="nav-number">1.3.3.</span> <span class="nav-text">服务发现流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nacos-Config"><span class="nav-number">1.4.</span> <span class="nav-text">Nacos Config</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Nacos-Config-Client-加载-nacos-server-配置原理"><span class="nav-number">1.4.1.</span> <span class="nav-text">Nacos Config Client 加载 nacos server 配置原理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#关键类-3"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">关键类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从-server-获取配置流程"><span class="nav-number">1.4.1.2.</span> <span class="nav-text">从 server 获取配置流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从-server-实时更新原理"><span class="nav-number">1.4.1.3.</span> <span class="nav-text">从 server 实时更新原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#关键类-4"><span class="nav-number">1.4.1.4.</span> <span class="nav-text">关键类</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="gudqs7"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">gudqs7</p>
  <div class="site-description" itemprop="description">心累没钱躺尸中</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">25</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/gudqs7" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;gudqs7" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:gudqs7@gmail.com" title="E-Mail → mailto:gudqs7@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">gudqs7</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://gudqs7s-note.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "https://gudqs7.github.io/2021/01/29/source-code-spring-cloud-server-discover-and-register/";
    this.page.identifier = "2021/01/29/source-code-spring-cloud-server-discover-and-register/";
    this.page.title = "Spring Cloud 服务注册与发现源码笔记 (Nacos/Consul/Eureka)";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://gudqs7s-note.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
